import React, { useState, useEffect, useRef, useCallback } from 'react';
import { MapPin, Users, Building2, TrendingUp, ChevronRight, Menu, X, Home, Map, Database, BarChart3, FileText, Settings, AlertTriangle, Target, Layers, BookOpen, Shield, Award, Activity, Download, Printer, Share2, Image, FileSpreadsheet, PieChart, AlertCircle, CheckCircle, Clock, Filter, Calendar, ChevronDown, Eye, RefreshCw, Mail, Navigation, Search } from 'lucide-react';
import { BarChart, Bar, LineChart, Line, PieChart as RechartsPie, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, AreaChart, Area, ComposedChart } from 'recharts';

// ==============================================
// MAIN APP COMPONENT
// ==============================================
export default function MBGWebGISSystem() {
  const [currentPage, setCurrentPage] = useState('landing');
  const [sidebarOpen, setSidebarOpen] = useState(false);

  const renderPage = () => {
    switch(currentPage) {
      case 'landing': return <LandingPage onEnter={() => setCurrentPage('dashboard')} />;
      case 'dashboard': return <DashboardPage />;
      case 'webgis': return <WebGISPage />;
      case 'sekolah': return <SekolahPage />;
      case 'sppg': return <SPPGPage />;
      case 'analisis-gizi': return <AnalisisGiziPage />;
      case 'analisis-kapasitas': return <AnalisisKapasitasPage />;
      case 'analisis-jarak': return <AnalisisJarakPage />;
      case 'optimasi': return <OptimasiPage />;
      case 'simulasi': return <SimulasiPage />;
      case 'rekomendasi': return <RekomendasiPage />;
      case 'laporan': return <LaporanPage />;
      case 'monitoring': return <MonitoringPage />;
      case 'kualitas-data': return <KualitasDataPage />;
      case 'sensitivitas': return <SensitivitasPage />;
      case 'risiko': return <RisikoPage />;
      case 'equity': return <EquityPage />;
      case 'kinerja': return <KinerjaPage />;
      case 'skenario': return <SkenarioPage />;
      case 'benchmarking': return <BenchmarkingPage />;
      case 'indeks': return <IndeksPage />;
      case 'profil': return <ProfilPage />;
      case 'help': return <HelpPage />;
      default: return <LandingPage onEnter={() => setCurrentPage('dashboard')} />;
    }
  };

  if (currentPage === 'landing') {
    return renderPage();
  }

  return (
    <div className="flex h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      <Sidebar 
        currentPage={currentPage} 
        setCurrentPage={setCurrentPage}
        sidebarOpen={sidebarOpen}
        setSidebarOpen={setSidebarOpen}
      />
      
      <div className="flex-1 flex flex-col overflow-hidden">
        <TopNav 
          setSidebarOpen={setSidebarOpen}
          currentPage={currentPage}
        />
        
        <main className="flex-1 overflow-y-auto">
          {renderPage()}
        </main>
      </div>
    </div>
  );
}

// ==============================================
// SIDEBAR COMPONENT - SINTA 1 LEVEL
// ==============================================
function Sidebar({ currentPage, setCurrentPage, sidebarOpen, setSidebarOpen }) {
  const menuGroups = [
    {
      title: 'Overview',
      items: [
        { id: 'dashboard', label: 'Dashboard Utama', icon: Home },
        { id: 'webgis', label: 'WebGIS Interaktif', icon: Map, badge: 'Core' }
      ]
    },
    {
      title: 'Data & Manajemen',
      items: [
        { id: 'sekolah', label: 'Data Sekolah', icon: Building2 },
        { id: 'sppg', label: 'Data SPPG', icon: Database },
        { id: 'kualitas-data', label: 'Kualitas Data', icon: Shield }
      ]
    },
    {
      title: 'Analisis & Optimasi',
      items: [
        { id: 'analisis-gizi', label: 'Kebutuhan Gizi', icon: BarChart3 },
        { id: 'analisis-kapasitas', label: 'Kapasitas Produksi', icon: TrendingUp },
        { id: 'analisis-jarak', label: 'Jarak & Waktu', icon: MapPin },
        { id: 'optimasi', label: 'Optimasi Pelayanan', icon: Target },
        { id: 'sensitivitas', label: 'Analisis Sensitivitas', icon: Activity },
        { id: 'risiko', label: 'Penilaian Risiko', icon: AlertTriangle }
      ]
    },
    {
      title: 'Kebijakan & Evaluasi',
      items: [
        { id: 'rekomendasi', label: 'Rekomendasi Kebijakan', icon: FileText },
        { id: 'simulasi', label: 'Simulasi What-If', icon: Settings },
        { id: 'kinerja', label: 'Evaluasi Kinerja', icon: Award },
        { id: 'equity', label: 'Analisis Pemerataan', icon: Users },
        { id: 'indeks', label: 'Indeks Kelayakan', icon: Target, badge: 'New' },
        { id: 'skenario', label: 'Skenario Kebijakan', icon: Layers },
        { id: 'benchmarking', label: 'Benchmarking', icon: BarChart3 }
      ]
    },
    {
      title: 'Laporan & Sistem',
      items: [
        { id: 'laporan', label: 'Laporan & Visualisasi', icon: FileText },
        { id: 'monitoring', label: 'Monitoring & Evaluasi', icon: Activity },
        { id: 'profil', label: 'Profil Sistem', icon: BookOpen },
        { id: 'help', label: 'Dokumentasi', icon: BookOpen }
      ]
    }
  ];

  return (
    <>
      {sidebarOpen && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden backdrop-blur-sm"
          onClick={() => setSidebarOpen(false)}
        />
      )}
      
      <div className={`${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 fixed lg:static inset-y-0 left-0 z-50 w-72 bg-white shadow-2xl transition-all duration-300 flex flex-col`}>
        {/* Logo Section */}
        <div className="h-20 flex items-center justify-between px-6 border-b border-gray-100 bg-gradient-to-r from-blue-600 to-blue-700">
          <div className="flex items-center gap-3">
            <div className="w-11 h-11 bg-white rounded-xl flex items-center justify-center shadow-lg">
              <Map className="w-6 h-6 text-blue-600" />
            </div>
            <div>
              <div className="text-sm font-bold text-white">WebGIS MBG</div>
              <div className="text-xs text-blue-100">Research Platform</div>
            </div>
          </div>
          <button 
            onClick={() => setSidebarOpen(false)}
            className="lg:hidden text-white hover:bg-white hover:bg-opacity-20 p-1.5 rounded-lg transition-colors"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* Navigation */}
        <nav className="flex-1 overflow-y-auto p-4 space-y-6">
          {menuGroups.map((group, idx) => (
            <div key={idx}>
              <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 px-3 flex items-center gap-2">
                <div className="h-px flex-1 bg-gradient-to-r from-gray-200 to-transparent"></div>
                <span>{group.title}</span>
                <div className="h-px flex-1 bg-gradient-to-l from-gray-200 to-transparent"></div>
              </div>
              <div className="space-y-1">
                {group.items.map(item => {
                  const Icon = item.icon;
                  const isActive = currentPage === item.id;
                  return (
                    <button
                      key={item.id}
                      onClick={() => {
                        setCurrentPage(item.id);
                        setSidebarOpen(false);
                      }}
                      className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm transition-all duration-200 group ${
                        isActive 
                          ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg shadow-blue-200 scale-[1.02]' 
                          : 'text-gray-700 hover:bg-gray-50 hover:scale-[1.01]'
                      }`}
                    >
                      <Icon className={`w-4 h-4 transition-transform duration-200 ${isActive ? '' : 'group-hover:scale-110'}`} />
                      <span className="flex-1 text-left font-medium">{item.label}</span>
                      {item.badge && (
                        <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${
                          isActive 
                            ? 'bg-white bg-opacity-25 text-white' 
                            : 'bg-blue-100 text-blue-700'
                        }`}>
                          {item.badge}
                        </span>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          ))}
        </nav>

        {/* Footer Info */}
        <div className="p-4 border-t border-gray-100 bg-gradient-to-b from-transparent to-gray-50">
          <div className="bg-blue-50 border border-blue-100 rounded-xl p-3">
            <div className="flex items-center gap-2 mb-2">
              <Shield className="w-4 h-4 text-blue-600" />
              <span className="text-xs font-semibold text-blue-900">Rendiajona Grade</span>
            </div>
            <p className="text-xs text-gray-600 leading-relaxed">
              Research-grade analytical system for academic publication
            </p>
          </div>
        </div>
      </div>
    </>
  );
}

// ==============================================
// TOP NAVIGATION - ENHANCED
// ==============================================
function TopNav({ setSidebarOpen, currentPage }) {
  const pageNames = {
    dashboard: 'Dashboard Utama',
    webgis: 'WebGIS Interaktif',
    sekolah: 'Data Sekolah Sasaran',
    sppg: 'Data SPPG',
    'analisis-gizi': 'Analisis Kebutuhan Gizi',
    'analisis-kapasitas': 'Analisis Kapasitas Produksi',
    'analisis-jarak': 'Analisis Jarak & Waktu Tempuh',
    optimasi: 'Optimasi Pelayanan',
    simulasi: 'Simulasi What-If Analysis',
    rekomendasi: 'Rekomendasi Kebijakan',
    laporan: 'Laporan & Visualisasi',
    monitoring: 'Monitoring & Evaluasi',
    'kualitas-data': 'Kualitas & Validasi Data',
    sensitivitas: 'Analisis Sensitivitas',
    risiko: 'Penilaian Risiko Pelayanan',
    equity: 'Analisis Keadilan & Pemerataan',
    kinerja: 'Evaluasi Kinerja Wilayah',
    skenario: 'Skenario Kebijakan',
    benchmarking: 'Benchmarking Regional',
    indeks: 'Indeks Kelayakan MBG',
    profil: 'Profil Sistem',
    help: 'Dokumentasi & Bantuan'
  };

  return (
    <header className="h-20 bg-white shadow-sm border-b border-gray-100 flex items-center justify-between px-6">
      <div className="flex items-center gap-4">
        <button 
          onClick={() => setSidebarOpen(true)}
          className="lg:hidden p-2 hover:bg-gray-100 rounded-lg transition-colors"
        >
          <Menu className="w-6 h-6" />
        </button>
        <div>
          <div className="flex items-center gap-3">
            <h1 className="text-xl font-bold text-gray-900">
              {pageNames[currentPage] || 'Dashboard'}
            </h1>
            <div className="hidden sm:flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-full">
              <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
              <span className="text-xs font-semibold text-blue-700">Live Data</span>
            </div>
          </div>
          <p className="text-xs text-gray-500 mt-1">
            Optimalisasi Pelayanan Pemenuhan Gizi - Program MBG
          </p>
        </div>
      </div>
      <div className="flex items-center gap-4">
        <div className="hidden md:block text-right">
          <div className="text-xs text-gray-500 font-medium">Last Update</div>
          <div className="text-sm font-bold text-gray-900">14 Des 2025, 09:30</div>
        </div>
        <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center shadow-lg">
          <span className="text-white font-bold text-sm">A</span>
        </div>
      </div>
    </header>
  );
}

// ==============================================
// IMPORT & SETUP LEAFLET
// ==============================================
// CATATAN: Pastikan sudah ada di HTML <head>:
// <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
// <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

// Dummy data untuk map
const dummySekolah = [
  { id: 1, lat: -7.0050, lng: 107.6500, nama: 'SDN Bandung 1', siswa: 450, status: 'Layak', sppg: 'SPPG Pusat' },
  { id: 2, lat: -7.0150, lng: 107.6400, nama: 'SDN Bandung 2', siswa: 380, status: 'Layak', sppg: 'SPPG Pusat' },
  { id: 3, lat: -6.9950, lng: 107.6600, nama: 'SDN Cimahi', siswa: 520, status: 'Waspada', sppg: 'SPPG Utara' },
  { id: 4, lat: -7.0250, lng: 107.6300, nama: 'SDN Lembang', siswa: 290, status: 'Kritis', sppg: 'SPPG Selatan' },
  { id: 5, lat: -6.9850, lng: 107.6700, nama: 'SDN Cibeunying', siswa: 410, status: 'Layak', sppg: 'SPPG Utara' },
  { id: 6, lat: -7.0350, lng: 107.6200, nama: 'SDN Soreang', siswa: 340, status: 'Waspada', sppg: 'SPPG Selatan' },
  { id: 7, lat: -7.0050, lng: 107.6800, nama: 'SDN Ujungjaya', siswa: 480, status: 'Layak', sppg: 'SPPG Timur' },
  { id: 8, lat: -7.0450, lng: 107.6100, nama: 'SDN Pengalengan', siswa: 310, status: 'Kritis', sppg: 'SPPG Barat' }
];

const dummySPPG = [
  { id: 1, lat: -7.0274, lng: 107.5192, nama: 'SPPG Soreang', kapasitas: 50000, produksi: 48500 },
  { id: 2, lat: -6.9900, lng: 107.6350, nama: 'SPPG Dayeuh Kolot', kapasitas: 45000, produksi: 43200 },
  { id: 3, lat: -6.9050, lng: 107.4050, nama: 'SPPG Cipongkor', kapasitas: 38000, produksi: 36800 },
  { id: 4, lat: -7.0470, lng: 107.7550, nama: 'SPPG Majalaya', kapasitas: 42000, produksi: 40100 }
];

// ==============================================
// LANDING PAGE - SINTA 1 LEVEL
// ==============================================
function LandingPage({ onEnter }) {
  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
      {/* Animated Background */}
      <div className="fixed inset-0 opacity-20">
        <div className="absolute top-0 left-0 w-96 h-96 bg-blue-500 rounded-full blur-3xl animate-pulse"></div>
        <div className="absolute bottom-0 right-0 w-96 h-96 bg-purple-500 rounded-full blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
      </div>

      {/* Content */}
      <div className="relative z-10">
        {/* Header */}
        <header className="bg-white bg-opacity-95 backdrop-blur-lg border-b border-gray-200 sticky top-0 z-50 shadow-sm">
          <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center shadow-lg">
                <Map className="w-7 h-7 text-white" />
              </div>
              <div>
                <div className="font-bold text-gray-900 text-lg">Sistem WebGIS MBG</div>
                <div className="text-xs text-gray-500 font-medium">Research-Grade Analytical Platform</div>
              </div>
            </div>
            <button
              onClick={onEnter}
              className="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:shadow-xl hover:scale-105 transition-all duration-200 text-sm font-semibold flex items-center gap-2 shadow-lg shadow-blue-200"
            >
              Akses Sistem
              <ChevronRight className="w-4 h-4" />
            </button>
          </div>
        </header>

        {/* Hero Section */}
        <section className="max-w-7xl mx-auto px-6 py-20">
          <div className="text-center mb-16">
            <div className="inline-flex items-center gap-2 px-4 py-2 bg-white bg-opacity-10 backdrop-blur-lg border border-white border-opacity-20 rounded-full text-sm font-semibold text-white mb-6 shadow-lg">
              <Award className="w-4 h-4" />
              Penelitian Akademik - akademic Standard
            </div>
            <h1 className="text-5xl md:text-6xl font-black text-white mb-6 leading-tight tracking-tight">
              Optimalisasi Pelayanan<br/>
              Pemenuhan Gizi
            </h1>
            <div className="text-xl text-blue-200 font-medium mb-4">
              Berdasarkan Sebaran Sekolah Sasaran Program MBG
            </div>
            <div className="text-lg text-blue-300 mb-8">
              Berbasis Sistem Informasi Geografis
            </div>
            <p className="text-lg text-gray-300 max-w-3xl mx-auto leading-relaxed">
              Platform analisis spasial terintegrasi dengan multi-criteria decision analysis
              untuk mendukung evidence-based policy making dalam distribusi 
              Makanan Bergizi Gratis nasional
            </p>
          </div>

          {/* Stats Grid */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-16">
            <MetricCard
              icon={Building2}
              value="1,247"
              label="Sekolah Sasaran"
              sublabel="Tingkat SD/MI"
              color="blue"
              trend="+12%"
            />
            <MetricCard
              icon={Users}
              value="342,891"
              label="Total Siswa MBG"
              sublabel="Data terkini"
              color="green"
              trend="+8%"
            />
            <MetricCard
              icon={Database}
              value="47"
              label="Satuan Produksi"
              sublabel="SPPG Aktif"
              color="purple"
              trend="+3"
            />
            <MetricCard
              icon={TrendingUp}
              value="87.3%"
              label="Tingkat Kelayakan"
              sublabel="Nasional"
              color="orange"
              trend="+5.2%"
            />
          </div>

          {/* Map Preview - REAL MAP */}
          <div className="bg-white bg-opacity-95 backdrop-blur-lg rounded-2xl border border-gray-200 p-8 mb-16 shadow-2xl">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h3 className="text-2xl font-bold text-gray-900 mb-2">
                  Sebaran Geografis Terintegrasi
                </h3>
                <p className="text-sm text-gray-600">
                  Visualisasi spasial real-time dengan analisis hotspot dan clustering
                </p>
              </div>
              <div className="flex gap-2">
                <span className="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-semibold">Layak</span>
                <span className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-xs font-semibold">Waspada</span>
                <span className="px-3 py-1 bg-red-100 text-red-700 rounded-lg text-xs font-semibold">Kritis</span>
              </div>
            </div>
            
            {/* REAL MINI MAP COMPONENT */}
            <LandingMiniMap />
          </div>

          {/* Features Grid */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-16">
            <FeatureCard
              icon={Target}
              title="Spatial Analysis"
              description="Network analysis, proximity measurement, dan service area delineation"
              color="blue"
            />
            <FeatureCard
              icon={Activity}
              title="Predictive Modeling"
              description="Machine learning untuk forecasting demand dan capacity planning"
              color="green"
            />
            <FeatureCard
              icon={Shield}
              title="Data Quality Control"
              description="Automated validation, anomaly detection, dan data completeness metrics"
              color="purple"
            />
          </div>

          {/* Methodology & Output */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <InfoPanel
              title="Metodologi Penelitian"
              icon={BookOpen}
              items={[
                'Spatial analysis dengan algoritma network routing',
                'Multi-criteria decision analysis (MCDA)',
                'Spatial statistics & hotspot detection (Getis-Ord Gi*)',
                'Optimization modeling dengan linear programming',
                'Sensitivity analysis & scenario planning'
              ]}
            />
            <InfoPanel
              title="Output Sistem"
              icon={Award}
              items={[
                'Peta tematik interaktif dengan layer switching',
                'Indeks kelayakan pelayanan MBG (0-100)',
                'Evidence-based policy recommendations',
                'Real-time monitoring dashboard',
                'Automated reporting & visualization export'
              ]}
            />
          </div>
        </section>

        {/* Footer */}
        <footer className="bg-white bg-opacity-5 backdrop-blur-lg border-t border-white border-opacity-10 mt-20">
          <div className="max-w-7xl mx-auto px-6 py-8">
            <div className="flex flex-col md:flex-row justify-between items-center gap-4 text-sm text-gray-300">
              <div className="flex items-center gap-2">
                <Shield className="w-4 h-4" />
                <span>© 2025 Research Project - WebGIS MBG System</span>
              </div>
              <div className="flex items-center gap-6">
                <span className="flex items-center gap-2">
                  <Award className="w-4 h-4" />
                  SINTA 1 Standard
                </span>
                <span>•</span>
                <span>Research-Grade Platform</span>
                <span>•</span>
                <span>Academic Publication Ready</span>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
  );
}

// ==============================================
// LANDING PAGE COMPONENTS
// ==============================================
function MetricCard({ icon: Icon, value, label, sublabel, color, trend }) {
  const colors = {
    blue: 'from-blue-600 to-blue-700',
    green: 'from-green-600 to-green-700',
    purple: 'from-purple-600 to-purple-700',
    orange: 'from-orange-600 to-orange-700'
  };

  return (
    <div className="bg-white bg-opacity-95 backdrop-blur-lg rounded-xl border border-gray-200 p-6 hover:shadow-2xl transition-all duration-300 hover:scale-105">
      <div className={`w-14 h-14 bg-gradient-to-br ${colors[color]} rounded-xl flex items-center justify-center mb-4 shadow-lg`}>
        <Icon className="w-7 h-7 text-white" />
      </div>
      <div className="text-3xl font-black text-gray-900 mb-1">{value}</div>
      <div className="text-sm font-semibold text-gray-700 mb-1">{label}</div>
      <div className="flex items-center justify-between">
        <div className="text-xs text-gray-500">{sublabel}</div>
        <div className="text-xs font-bold text-green-600">{trend}</div>
      </div>
    </div>
  );
}

function FeatureCard({ icon: Icon, title, description, color }) {
  const colors = {
    blue: 'from-blue-600 to-blue-700',
    green: 'from-green-600 to-green-700',
    purple: 'from-purple-600 to-purple-700'
  };

  return (
    <div className="bg-white bg-opacity-95 backdrop-blur-lg rounded-xl border border-gray-200 p-6 hover:shadow-2xl transition-all duration-300">
      <div className={`w-12 h-12 bg-gradient-to-br ${colors[color]} rounded-xl flex items-center justify-center mb-4 shadow-lg`}>
        <Icon className="w-6 h-6 text-white" />
      </div>
      <h4 className="font-bold text-gray-900 text-lg mb-2">{title}</h4>
      <p className="text-sm text-gray-600 leading-relaxed">{description}</p>
    </div>
  );
}

function InfoPanel({ title, icon: Icon, items }) {
  return (
    <div className="bg-white bg-opacity-95 backdrop-blur-lg rounded-xl border border-gray-200 p-6 hover:shadow-2xl transition-all duration-300">
      <div className="flex items-center gap-3 mb-4">
        <Icon className="w-6 h-6 text-blue-600" />
        <h4 className="font-bold text-gray-900 text-lg">{title}</h4>
      </div>
      <ul className="space-y-3">
        {items.map((item, idx) => (
          <li key={idx} className="flex items-start gap-3 text-sm text-gray-700">
            <div className="w-1.5 h-1.5 bg-blue-600 rounded-full mt-2 flex-shrink-0"></div>
            <span className="leading-relaxed">{item}</span>
          </li>
        ))}
      </ul>
    </div>
  );
}

// ==============================================
// PLACEHOLDER PAGES (PART 2+)
// ==============================================
// ==============================================
// DASHBOARD PAGE - SINTA 1 LEVEL
// ==============================================
function DashboardPage() {
  const [selectedKecamatan, setSelectedKecamatan] = useState('all');

  const kecamatanList = ['Semua Kecamatan', 'Bandung', 'Cimahi', 'Lembang', 'Cibeunying', 'Soreang'];

  return (
    <div className="p-6 space-y-6">
      {/* Page Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Dashboard Monitoring MBG</h2>
          <p className="text-sm text-gray-600 mt-1">
            Ringkasan eksekutif sistem pelayanan Makanan Bergizi Gratis
          </p>
        </div>
        <div className="flex items-center gap-3">
          <select 
            value={selectedKecamatan}
            onChange={(e) => setSelectedKecamatan(e.target.value)}
            className="px-4 py-2 border border-gray-300 rounded-xl text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            {kecamatanList.map((kec, idx) => (
              <option key={idx} value={idx === 0 ? 'all' : kec.toLowerCase()}>{kec}</option>
            ))}
          </select>
          <button className="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all">
            Export Data
          </button>
        </div>
      </div>

      {/* Key Metrics Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <DashboardMetricCard
          icon={Building2}
          title="Total Sekolah"
          value="1,247"
          subtitle="Sekolah sasaran aktif"
          change="+12"
          changeLabel="vs bulan lalu"
          color="blue"
          trend="up"
        />
        <DashboardMetricCard
          icon={Users}
          title="Total Siswa MBG"
          value="342,891"
          subtitle="Penerima manfaat"
          change="+8.3%"
          changeLabel="pertumbuhan"
          color="green"
          trend="up"
        />
        <DashboardMetricCard
          icon={Database}
          title="Total SPPG"
          value="47"
          subtitle="Unit produksi aktif"
          change="+3"
          changeLabel="unit baru"
          color="purple"
          trend="up"
        />
        <DashboardMetricCard
          icon={Target}
          title="Tingkat Kelayakan"
          value="87.3%"
          subtitle="Standar pelayanan"
          change="+5.2%"
          changeLabel="improvement"
          color="orange"
          trend="up"
        />
      </div>

      {/* Charts Row */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Distribution Chart */}
        <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h3 className="text-lg font-bold text-gray-900">Distribusi Status Kelayakan</h3>
              <p className="text-xs text-gray-500 mt-1">Per kecamatan dalam wilayah studi</p>
            </div>
            <div className="flex gap-2">
              <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold">Layak</span>
              <span className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-semibold">Waspada</span>
              <span className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold">Kritis</span>
            </div>
          </div>
          <BarChartComponent />
        </div>

        {/* Trend Chart */}
        <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
          <div className="mb-6">
            <h3 className="text-lg font-bold text-gray-900">Tren Pelayanan MBG</h3>
            <p className="text-xs text-gray-500 mt-1">6 bulan terakhir (Jul - Des 2025)</p>
          </div>
          <LineChartComponent />
        </div>
      </div>

      {/* Map & Capacity Row */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Mini Map */}
        <div className="lg:col-span-2 bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h3 className="text-lg font-bold text-gray-900">Peta Sebaran Sekolah & SPPG</h3>
              <p className="text-xs text-gray-500 mt-1">Visualisasi geografis distribusi pelayanan</p>
            </div>
            <button className="px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-xs font-semibold hover:bg-blue-100 transition-colors">
              Lihat WebGIS Lengkap →
            </button>
          </div>
          <MiniMapPlaceholder />
        </div>

        {/* Capacity Summary */}
        <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
          <h3 className="text-lg font-bold text-gray-900 mb-4">Kapasitas Produksi</h3>
          <div className="space-y-4">
            <CapacityBar
              label="Kapasitas SPPG"
              current={342891}
              max={400000}
              color="blue"
            />
            <CapacityBar
              label="Target Harian"
              current={285742}
              max={342891}
              color="green"
            />
            <CapacityBar
              label="Utilization Rate"
              current={83.4}
              max={100}
              color="purple"
              isPercentage
            />
          </div>
          <div className="mt-6 p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200">
            <div className="flex items-center gap-2 mb-2">
              <AlertTriangle className="w-4 h-4 text-blue-700" />
              <span className="text-xs font-bold text-blue-900">Status Operasional</span>
            </div>
            <p className="text-xs text-gray-700 leading-relaxed">
              Kapasitas produksi mencukupi kebutuhan. 3 SPPG memerlukan perhatian untuk maintenance rutin.
            </p>
          </div>
        </div>
      </div>

      {/* Recent Activity & Alerts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Recent Updates */}
        <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
          <h3 className="text-lg font-bold text-gray-900 mb-4">Update Terkini</h3>
          <div className="space-y-3">
            <ActivityItem
              title="Data sekolah diperbarui"
              time="2 jam yang lalu"
              icon={Building2}
              color="blue"
            />
            <ActivityItem
              title="Analisis kelayakan selesai"
              time="5 jam yang lalu"
              icon={Target}
              color="green"
            />
            <ActivityItem
              title="Laporan bulanan generated"
              time="1 hari yang lalu"
              icon={FileText}
              color="purple"
            />
            <ActivityItem
              title="SPPG baru ditambahkan"
              time="2 hari yang lalu"
              icon={Database}
              color="orange"
            />
          </div>
        </div>

        {/* Critical Alerts */}
        <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
          <h3 className="text-lg font-bold text-gray-900 mb-4">Peringatan Sistem</h3>
          <div className="space-y-3">
            <AlertItem
              title="3 Sekolah butuh reassignment"
              description="Jarak melebihi threshold 15 km"
              severity="high"
            />
            <AlertItem
              title="SPPG Kec. Bandung Pusat overload"
              description="Kapasitas 95% - perlu monitoring"
              severity="medium"
            />
            <AlertItem
              title="Data quality check needed"
              description="12 records memerlukan validasi"
              severity="low"
            />
          </div>
        </div>
      </div>

      {/* Output Info Panel */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-start gap-4">
          <div className="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center flex-shrink-0">
            <Award className="w-6 h-6" />
          </div>
          <div className="flex-1">
            <h3 className="font-bold text-lg mb-2">Output Modul Dashboard</h3>
            <p className="text-blue-100 text-sm leading-relaxed mb-3">
              Modul ini menghasilkan ringkasan eksekutif kondisi pelayanan MBG secara real-time, 
              mencakup indikator kinerja utama (KPI), distribusi geografis, dan status kelayakan pelayanan 
              untuk mendukung pengambilan keputusan berbasis data.
            </p>
            <div className="flex flex-wrap gap-2">
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">KPI Metrics</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Trend Analysis</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Capacity Monitoring</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Alert System</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Dashboard Helper Components
function DashboardMetricCard({ icon: Icon, title, value, subtitle, change, changeLabel, color, trend }) {
  const colors = {
    blue: { bg: 'from-blue-600 to-blue-700', light: 'bg-blue-50', text: 'text-blue-700' },
    green: { bg: 'from-green-600 to-green-700', light: 'bg-green-50', text: 'text-green-700' },
    purple: { bg: 'from-purple-600 to-purple-700', light: 'bg-purple-50', text: 'text-purple-700' },
    orange: { bg: 'from-orange-600 to-orange-700', light: 'bg-orange-50', text: 'text-orange-700' }
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-lg transition-all duration-300">
      <div className="flex items-start justify-between mb-4">
        <div className={`w-12 h-12 bg-gradient-to-br ${colors[color].bg} rounded-xl flex items-center justify-center shadow-md`}>
          <Icon className="w-6 h-6 text-white" />
        </div>
        <div className={`px-2 py-1 ${colors[color].light} ${colors[color].text} rounded-lg text-xs font-bold flex items-center gap-1`}>
          {trend === 'up' ? '↑' : '↓'} {change}
        </div>
      </div>
      <div className="text-3xl font-black text-gray-900 mb-1">{value}</div>
      <div className="text-sm font-semibold text-gray-700 mb-1">{title}</div>
      <div className="text-xs text-gray-500">{subtitle}</div>
      <div className="mt-3 pt-3 border-t border-gray-100">
        <span className="text-xs text-gray-600">{changeLabel}</span>
      </div>
    </div>
  );
}

function BarChartComponent() {
  const data = [
    { name: 'Bandung', layak: 45, waspada: 12, kritis: 3 },
    { name: 'Cimahi', layak: 38, waspada: 8, kritis: 2 },
    { name: 'Lembang', layak: 52, waspada: 15, kritis: 5 },
    { name: 'Cibeunying', layak: 41, waspada: 10, kritis: 4 },
    { name: 'Soreang', layak: 35, waspada: 9, kritis: 2 }
  ];

  const maxValue = Math.max(...data.map(d => d.layak + d.waspada + d.kritis));

  return (
    <div className="space-y-4">
      {data.map((item, idx) => (
        <div key={idx}>
          <div className="flex items-center justify-between mb-2">
            <span className="text-xs font-semibold text-gray-700">{item.name}</span>
            <span className="text-xs text-gray-500">{item.layak + item.waspada + item.kritis} sekolah</span>
          </div>
          <div className="flex h-8 rounded-lg overflow-hidden border border-gray-200">
            <div 
              className="bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center text-white text-xs font-bold"
              style={{ width: `${(item.layak / maxValue) * 100}%` }}
            >
              {item.layak > 0 && item.layak}
            </div>
            <div 
              className="bg-gradient-to-r from-yellow-500 to-yellow-600 flex items-center justify-center text-white text-xs font-bold"
              style={{ width: `${(item.waspada / maxValue) * 100}%` }}
            >
              {item.waspada > 0 && item.waspada}
            </div>
            <div 
              className="bg-gradient-to-r from-red-500 to-red-600 flex items-center justify-center text-white text-xs font-bold"
              style={{ width: `${(item.kritis / maxValue) * 100}%` }}
            >
              {item.kritis > 0 && item.kritis}
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}

function LineChartComponent() {
  const months = ['Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
  const values = [82.5, 83.8, 84.2, 85.1, 86.4, 87.3];

  return (
    <div className="h-48 flex items-end justify-between gap-4 pb-8">
      {months.map((month, idx) => {
        const height = (values[idx] / 100) * 100;
        return (
          <div key={idx} className="flex-1 flex flex-col items-center">
            <div className="text-xs font-bold text-blue-700 mb-2">{values[idx]}%</div>
            <div 
              className="w-full bg-gradient-to-t from-blue-600 to-blue-400 rounded-t-lg hover:from-blue-700 hover:to-blue-500 transition-all"
              style={{ height: `${height}%` }}
            />
            <div className="text-xs font-semibold text-gray-600 mt-2">{month}</div>
          </div>
        );
      })}
    </div>
  );
}

function MiniMapPlaceholder() {
  return (
    <div className="bg-gradient-to-br from-blue-50 via-green-50 to-blue-50 rounded-xl h-72 flex items-center justify-center border-2 border-gray-200 relative overflow-hidden">
      <div className="absolute inset-0 opacity-10">
        <div className="absolute top-10 left-10 w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <div className="absolute top-20 right-20 w-3 h-3 bg-blue-500 rounded-full animate-pulse" style={{animationDelay: '0.5s'}}></div>
        <div className="absolute bottom-20 left-1/3 w-3 h-3 bg-yellow-500 rounded-full animate-pulse" style={{animationDelay: '1s'}}></div>
        <div className="absolute bottom-10 right-1/4 w-3 h-3 bg-red-500 rounded-full animate-pulse" style={{animationDelay: '1.5s'}}></div>
      </div>
      <div className="text-center relative z-10">
        <Map className="w-16 h-16 text-gray-400 mx-auto mb-3" />
        <p className="text-sm font-semibold text-gray-700">Peta Interaktif</p>
        <p className="text-xs text-gray-500 mt-1">Klik "Lihat WebGIS Lengkap" untuk akses penuh</p>
      </div>
    </div>
  );
}

function CapacityBar({ label, current, max, color, isPercentage }) {
  const percentage = isPercentage ? current : (current / max) * 100;
  const colors = {
    blue: 'from-blue-600 to-blue-700',
    green: 'from-green-600 to-green-700',
    purple: 'from-purple-600 to-purple-700'
  };

  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <span className="text-xs font-semibold text-gray-700">{label}</span>
        <span className="text-xs font-bold text-gray-900">
          {isPercentage ? `${current.toFixed(1)}%` : current.toLocaleString()}
        </span>
      </div>
      <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className={`h-full bg-gradient-to-r ${colors[color]} transition-all duration-500 rounded-full`}
          style={{ width: `${Math.min(percentage, 100)}%` }}
        />
      </div>
      {!isPercentage && (
        <div className="text-xs text-gray-500 mt-1">Target: {max.toLocaleString()}</div>
      )}
    </div>
  );
}

function ActivityItem({ title, time, icon: Icon, color }) {
  const colors = {
    blue: 'bg-blue-100 text-blue-700',
    green: 'bg-green-100 text-green-700',
    purple: 'bg-purple-100 text-purple-700',
    orange: 'bg-orange-100 text-orange-700'
  };

  return (
    <div className="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
      <div className={`w-10 h-10 ${colors[color]} rounded-lg flex items-center justify-center flex-shrink-0`}>
        <Icon className="w-5 h-5" />
      </div>
      <div className="flex-1 min-w-0">
        <div className="text-sm font-semibold text-gray-900">{title}</div>
        <div className="text-xs text-gray-500">{time}</div>
      </div>
    </div>
  );
}

function AlertItem({ title, description, severity }) {
  const severityConfig = {
    high: { color: 'red', icon: AlertTriangle, label: 'Tinggi' },
    medium: { color: 'yellow', icon: AlertTriangle, label: 'Sedang' },
    low: { color: 'blue', icon: AlertTriangle, label: 'Rendah' }
  };

  const config = severityConfig[severity];
  const Icon = config.icon;

  return (
    <div className={`p-4 rounded-lg border-l-4 ${
      severity === 'high' ? 'bg-red-50 border-red-500' :
      severity === 'medium' ? 'bg-yellow-50 border-yellow-500' :
      'bg-blue-50 border-blue-500'
    }`}>
      <div className="flex items-start gap-3">
        <Icon className={`w-5 h-5 flex-shrink-0 ${
          severity === 'high' ? 'text-red-600' :
          severity === 'medium' ? 'text-yellow-600' :
          'text-blue-600'
        }`} />
        <div className="flex-1">
          <div className="text-sm font-bold text-gray-900">{title}</div>
          <div className="text-xs text-gray-600 mt-1">{description}</div>
          <div className={`inline-block mt-2 px-2 py-0.5 rounded text-xs font-semibold ${
            severity === 'high' ? 'bg-red-200 text-red-800' :
            severity === 'medium' ? 'bg-yellow-200 text-yellow-800' :
            'bg-blue-200 text-blue-800'
          }`}>
            Prioritas {config.label}
          </div>
        </div>
      </div>
    </div>
  );
}

// ==============================================
// LEAFLET LOADER - Dynamic CDN Loading
// ==============================================
const LeafletLoader = () => {
  useEffect(() => {
    // Load Leaflet CSS
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css';
    document.head.appendChild(link);

    // Load Leaflet JS
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js';
    document.head.appendChild(script);

    // Load Leaflet.markercluster CSS
    const clusterCSS = document.createElement('link');
    clusterCSS.rel = 'stylesheet';
    clusterCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css';
    document.head.appendChild(clusterCSS);

    const clusterDefaultCSS = document.createElement('link');
    clusterDefaultCSS.rel = 'stylesheet';
    clusterDefaultCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css';
    document.head.appendChild(clusterDefaultCSS);

    // Load Leaflet.markercluster JS
    const clusterScript = document.createElement('script');
    clusterScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js';
    document.head.appendChild(clusterScript);

    // Load Leaflet.heat JS
    const heatScript = document.createElement('script');
    heatScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js';
    document.head.appendChild(heatScript);

    return () => {
      try {
        document.head.removeChild(link);
        document.head.removeChild(script);
        document.head.removeChild(clusterCSS);
        document.head.removeChild(clusterDefaultCSS);
        document.head.removeChild(clusterScript);
        document.head.removeChild(heatScript);
      } catch (e) {
        // Elements may have been removed already
      }
    };
  }, []);

  return null;
};

// ==============================================
// WEBGIS PAGE - SINTA 1 LEVEL (CORE MODULE)
// ==============================================
function WebGISPage() {
  const [activeLayer, setActiveLayer] = useState({
    sekolah: true,
    sppg: true,
    wilayah: true,
    rute: false
  });
  const [selectedFilter, setSelectedFilter] = useState({
    jenjang: 'all',
    status: 'all'
  });
  const [mapMode, setMapMode] = useState('overview');
  const [selectedSchool, setSelectedSchool] = useState(null);
  const [selectedSPPG, setSelectedSPPG] = useState(null);
  const [mapStyle, setMapStyle] = useState('street');
  const [showMapStyles, setShowMapStyles] = useState(false);
  const [measureMode, setMeasureMode] = useState(false);
  const [measureType, setMeasureType] = useState('distance'); // 'distance' or 'area'
  const [coordinates, setCoordinates] = useState(null);
  const [analysisResults, setAnalysisResults] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [lastUpdated, setLastUpdated] = useState(new Date());

  const toggleLayer = (layer) => {
    setActiveLayer(prev => ({ ...prev, [layer]: !prev[layer] }));
  };

  useEffect(() => {
    // Simulate analysis when mode changes
    if (mapMode === 'cluster') {
      setAnalysisResults({
        clusters: 5,
        silhouette: 0.73,
        avgSize: 249
      });
    } else if (mapMode === 'heatmap') {
      setAnalysisResults({
        hotspot: 'Kec. Lembang',
        coldspot: 'Kec. Soreang',
        bandwidth: '2 km'
      });
    } else if (mapMode === 'network') {
      setAnalysisResults({
        routes: 547,
        avgDistance: '8.3 km',
        maxTime: '45 min'
      });
    }
  }, [mapMode]);

  return (
    <div className="h-screen flex flex-col bg-gray-50">
      <LeafletLoader />
      
      {/* Header */}
      <div className="bg-white border-b border-gray-200 shadow-sm">
        <div className="px-6 py-4">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center shadow-lg">
                  <Map className="w-6 h-6 text-white" />
                </div>
                WebGIS Interaktif - Analisis Spasial MBG
              </h2>
              <p className="text-sm text-gray-600 mt-1 ml-13">
                Real-time geospatial analysis dengan clustering, heatmap & network routing optimization
              </p>
            </div>
            <div className="flex items-center gap-2">
              <button className="px-4 py-2 bg-white border-2 border-gray-300 rounded-xl hover:bg-gray-50 text-sm font-medium flex items-center gap-2 transition-colors">
                <Download className="w-4 h-4" />
                Export PNG
              </button>
              <button className="px-4 py-2 bg-white border-2 border-gray-300 rounded-xl hover:bg-gray-50 text-sm font-medium flex items-center gap-2 transition-colors">
                <FileSpreadsheet className="w-4 h-4" />
                Export CSV
              </button>
            </div>
          </div>

          {/* Map Mode Selector & Style Selector - DALAM 1 BARIS */}
          <div className="flex items-center justify-between gap-4 pb-2">
            {/* Mode Buttons - Kiri */}
            <div className="flex gap-2 overflow-x-auto">
              <MapModeButton
                mode="overview"
                label="Overview Map"
                icon={Map}
                isActive={mapMode === 'overview'}
                onClick={() => setMapMode('overview')}
              />
              <MapModeButton
                mode="cluster"
                label="Cluster Analysis"
                icon={Layers}
                isActive={mapMode === 'cluster'}
                onClick={() => setMapMode('cluster')}
              />
              <MapModeButton
                mode="heatmap"
                label="Heatmap Density"
                icon={Activity}
                isActive={mapMode === 'heatmap'}
                onClick={() => setMapMode('heatmap')}
              />
              <MapModeButton
                mode="network"
                label="Network Routing"
                icon={MapPin}
                isActive={mapMode === 'network'}
                onClick={() => setMapMode('network')}
              />
            </div>

            {/* Style Selector - Kanan */}
            <div className="relative">
              <button
                onClick={() => setShowMapStyles(!showMapStyles)}
                className="flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow border-2 border-gray-200 hover:border-blue-500 transition-all whitespace-nowrap"
              >
                <span className="text-lg">
                  {mapStyle === 'street' && '🗺️'}
                  {mapStyle === 'satellite' && '🛰️'}
                  {mapStyle === 'terrain' && '⛰️'}
                  {mapStyle === 'cartodb' && '📄'}
                  {mapStyle === 'dark' && '🌙'}
                  {mapStyle === 'topo' && '🗻'}
                </span>
                <span className="text-xs font-bold text-gray-700 capitalize">{mapStyle}</span>
                <ChevronDown className={`w-3 h-3 text-gray-600 transition-transform ${showMapStyles ? 'rotate-180' : ''}`} />
              </button>

              {/* Dropdown */}
              {showMapStyles && (
                <div className="absolute top-full right-0 mt-2 w-56 bg-white rounded-xl shadow-2xl border-2 border-gray-200 overflow-hidden animate-slide-down">
                  <MapStyleOptionCompact
                    name="Street"
                    icon="🗺️"
                    active={mapStyle === 'street'}
                    onClick={() => {
                      setMapStyle('street');
                      setShowMapStyles(false);
                    }}
                  />
                  <MapStyleOptionCompact
                    name="Satellite"
                    icon="🛰️"
                    active={mapStyle === 'satellite'}
                    onClick={() => {
                      setMapStyle('satellite');
                      setShowMapStyles(false);
                    }}
                  />
                  <MapStyleOptionCompact
                    name="Terrain"
                    icon="⛰️"
                    active={mapStyle === 'terrain'}
                    onClick={() => {
                      setMapStyle('terrain');
                      setShowMapStyles(false);
                    }}
                  />
                  <MapStyleOptionCompact
                    name="CartoDB"
                    icon="📄"
                    active={mapStyle === 'cartodb'}
                    onClick={() => {
                      setMapStyle('cartodb');
                      setShowMapStyles(false);
                    }}
                  />
                  <MapStyleOptionCompact
                    name="Dark"
                    icon="🌙"
                    active={mapStyle === 'dark'}
                    onClick={() => {
                      setMapStyle('dark');
                      setShowMapStyles(false);
                    }}
                  />
                  <MapStyleOptionCompact
                    name="Topo"
                    icon="🗻"
                    active={mapStyle === 'topo'}
                    onClick={() => {
                      setMapStyle('topo');
                      setShowMapStyles(false);
                    }}
                  />
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 flex overflow-hidden">
        {/* Map Container */}
        <div className="flex-1 relative">
          <InteractiveLeafletMap
            mode={mapMode}
            layers={activeLayer}
            filters={selectedFilter}
            mapStyle={mapStyle}
            measureMode={measureMode}
            onSelectSchool={setSelectedSchool}
            onSelectSPPG={setSelectedSPPG}
          />

          {/* Loading Overlay */}
          {isLoading && (
            <div className="absolute inset-0 bg-white/80 flex items-center justify-center" style={{ zIndex: 2000 }}>
              <div className="text-center">
                <RefreshCw className="w-12 h-12 text-blue-600 animate-spin mx-auto mb-3" />
                <p className="text-sm font-bold text-gray-700">Loading map data...</p>
              </div>
            </div>
          )}


          {/* Measure Tool */}
          <button
            onClick={() => setMeasureMode(!measureMode)}
            className={`absolute top-4 left-64 px-4 py-2 rounded-xl shadow-xl text-xs font-bold transition-all flex items-center gap-2 ${
              measureMode ? 'bg-orange-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'
            }`}
            style={{ zIndex: 1000 }}
          >
            <Navigation className="w-4 h-4" />
            Measure Distance
          </button>

          {/* Legend */}
          <MapLegend mode={mapMode} layers={activeLayer} activeLayer={activeLayer} />
        </div>

        {/* Right Sidebar */}
        <div className="w-96 bg-white border-l border-gray-200 flex flex-col overflow-hidden shadow-xl">
          {/* Search/Locate Feature */}
          <div className="p-5 border-b border-gray-200">
            <div className="relative">
              <input 
                type="text" 
                placeholder="Cari sekolah atau SPPG..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full px-4 py-2.5 pl-10 border-2 border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              />
              <Search className="w-4 h-4 absolute left-3 top-3.5 text-gray-400" />
            </div>
          </div>

          {/* Layer Control */}
          <div className="p-5 border-b border-gray-200">
            <h3 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
              <Layers className="w-5 h-5 text-blue-600" />
              Layer Control
            </h3>
            <div className="space-y-2">
              <LayerToggle
                label="Sekolah Sasaran"
                isActive={activeLayer.sekolah}
                onChange={() => toggleLayer('sekolah')}
              />
              <LayerToggle
                label="Satuan Produksi (SPPG)"
                isActive={activeLayer.sppg}
                onChange={() => toggleLayer('sppg')}
              />
              <LayerToggle
                label="Batas Wilayah"
                isActive={activeLayer.wilayah}
                onChange={() => toggleLayer('wilayah')}
              />
              <LayerToggle
                label="Network Routes"
                isActive={activeLayer.rute}
                onChange={() => toggleLayer('rute')}
              />
            </div>
          </div>

          {/* Filters */}
          <div className="p-5 border-b border-gray-200">
            <h3 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
              <Settings className="w-5 h-5 text-blue-600" />
              Filter & Query
            </h3>
            <div className="space-y-4">
              <div>
                <label className="text-xs font-bold text-gray-700 block mb-2">
                  Jenjang Sekolah
                </label>
                <select 
                  value={selectedFilter.jenjang}
                  onChange={(e) => setSelectedFilter(prev => ({ ...prev, jenjang: e.target.value }))}
                  className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                >
                  <option value="all">Semua Jenjang</option>
                  <option value="sd">SD</option>
                  <option value="mi">MI</option>
                </select>
              </div>
              <div>
                <label className="text-xs font-bold text-gray-700 block mb-2">
                  Status Kelayakan
                </label>
                <select 
                  value={selectedFilter.status}
                  onChange={(e) => setSelectedFilter(prev => ({ ...prev, status: e.target.value }))}
                  className="w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                >
                  <option value="all">Semua Status</option>
                  <option value="layak">✓ Layak</option>
                  <option value="waspada">⚠ Waspada</option>
                  <option value="kritis">✕ Kritis</option>
                </select>
              </div>
              <button className="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-sm font-bold hover:shadow-lg transition-all">
                Apply Filter
              </button>
            </div>
          </div>

          {/* Spatial Query Tools */}
          <div className="p-5 border-b border-gray-200">
            <h3 className="text-sm font-bold text-gray-900 mb-4">Spatial Query</h3>
            <div className="space-y-2">
              <button className="w-full px-4 py-2.5 bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 rounded-xl text-xs font-bold text-left transition-all text-blue-900">
                📍 Find Nearest SPPG
              </button>
              <button className="w-full px-4 py-2.5 bg-gradient-to-r from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 rounded-xl text-xs font-bold text-left transition-all text-green-900">
                🎯 Buffer Analysis
              </button>
              <button className="w-full px-4 py-2.5 bg-gradient-to-r from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 rounded-xl text-xs font-bold text-left transition-all text-orange-900">
                🔍 Hotspot Detection
              </button>
              <button className="w-full px-4 py-2.5 bg-gradient-to-r from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 rounded-xl text-xs font-bold text-left transition-all text-purple-900">
                📊 Cluster Statistics
              </button>
            </div>
          </div>

          {/* Statistics & Analysis Results */}
          <div className="flex-1 overflow-y-auto p-5">
            <h3 className="text-sm font-bold text-gray-900 mb-4">Map Statistics</h3>
            <div className="space-y-3">
              <StatItem label="Visible Features" value="1,294" color="blue" />
              <StatItem label="Selected Objects" value="0" color="green" />
              <StatItem label="Active Filters" value="2" color="orange" />
              <StatItem label="Zoom Level" value="12" color="purple" />
            </div>

            {/* Dynamic Analysis Results */}
            {analysisResults && mapMode === 'cluster' && (
              <div className="mt-6 p-4 bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl">
                <div className="flex items-center gap-2 mb-3">
                  <TrendingUp className="w-5 h-5 text-blue-700" />
                  <div className="text-sm font-bold text-blue-900">Cluster Analysis</div>
                </div>
                <div className="space-y-2">
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700 font-medium">Clusters Detected</span>
                    <span className="font-bold text-blue-900">{analysisResults.clusters}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700 font-medium">Silhouette Score</span>
                    <span className="font-bold text-blue-900">{analysisResults.silhouette}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700 font-medium">Avg Cluster Size</span>
                    <span className="font-bold text-blue-900">{analysisResults.avgSize} schools</span>
                  </div>
                </div>
              </div>
            )}

            {analysisResults && mapMode === 'heatmap' && (
              <div className="mt-6 p-4 bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-300 rounded-xl">
                <div className="flex items-center gap-2 mb-3">
                  <Activity className="w-5 h-5 text-orange-700" />
                  <div className="text-sm font-bold text-orange-900">Density Analysis</div>
                </div>
                <div className="space-y-2">
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700 font-medium">Hotspot Area</span>
                    <span className="font-bold text-orange-900">{analysisResults.hotspot}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700 font-medium">Coldspot Area</span>
                    <span className="font-bold text-orange-900">{analysisResults.coldspot}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700 font-medium">Kernel Bandwidth</span>
                    <span className="font-bold text-orange-900">{analysisResults.bandwidth}</span>
                  </div>
                </div>
              </div>
            )}

            {analysisResults && mapMode === 'network' && (
              <div className="mt-6 p-4 bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-300 rounded-xl">
                <div className="flex items-center gap-2 mb-3">
                  <MapPin className="w-5 h-5 text-green-700" />
                  <div className="text-sm font-bold text-green-900">Network Analysis</div>
                </div>
                <div className="space-y-2">
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700 font-medium">Total Routes</span>
                    <span className="font-bold text-green-900">{analysisResults.routes}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700 font-medium">Avg Distance</span>
                    <span className="font-bold text-green-900">{analysisResults.avgDistance}</span>
                  </div>
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700 font-medium">Max Travel Time</span>
                    <span className="font-bold text-green-900">{analysisResults.maxTime}</span>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Detail Panel */}
      {(selectedSchool || selectedSPPG) && (
        <DetailPanel
          type={selectedSchool ? 'sekolah' : 'sppg'}
          data={selectedSchool || selectedSPPG}
          onClose={() => {
            setSelectedSchool(null);
            setSelectedSPPG(null);
          }}
        />
      )}

      {/* Output Info */}
      <div className="bg-gradient-to-r from-blue-600 via-blue-700 to-blue-800 p-5 text-white">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-start gap-4 flex-1">
            <Award className="w-6 h-6 flex-shrink-0 mt-1" />
            <div className="flex-1">
              <div className="font-bold text-base mb-2">Output Modul WebGIS Interaktif</div>
              <div className="text-sm text-blue-100 leading-relaxed">
                Modul ini menghasilkan: (1) Peta interaktif real-time dengan OpenStreetMap, (2) Clustering otomatis dengan marker aggregation, 
                (3) Heatmap density visualization, (4) Network routing analysis dengan distance calculation, (5) Multi-layer spatial query tools, 
                (6) Interactive popup dengan data visualization.
              </div>
            </div>
          </div>
          <div className="flex items-center gap-2 px-4 py-2 bg-white/20 rounded-full">
            <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse" />
            <span className="text-xs font-bold text-white">Live Data</span>
            <span className="text-xs text-blue-100">Updated now</span>
          </div>
        </div>
      </div>
    </div>
  );
}



// ==============================================
// INTERACTIVE LEAFLET MAP COMPONENT
// ==============================================
function InteractiveLeafletMap({ mode, layers, filters, mapStyle, measureMode, onSelectSchool, onSelectSPPG }) {
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const markersRef = useRef({ sekolah: null, sppg: null, routes: [] });
  const heatLayerRef = useRef(null);
  const clustersRef = useRef(null);

  // Sample Bandung schools data
  const sekolahData = [
    { id: 1, nama: 'SDN 1 Soreang', lat: -7.0274, lng: 107.5192, siswa: 245, status: 'layak', jenjang: 'sd', sppg: 'SPPG Soreang' },
    { id: 2, nama: 'MIN 1 Soreang', lat: -7.0300, lng: 107.5220, siswa: 198, status: 'waspada', jenjang: 'mi', sppg: 'SPPG Soreang' },
    { id: 3, nama: 'SDN 2 Dayeuh Kolot', lat: -6.9900, lng: 107.6350, siswa: 312, status: 'layak', jenjang: 'sd', sppg: 'SPPG Dayeuh Kolot' },
    { id: 4, nama: 'SDN 3 Bandung Kidul', lat: -6.9850, lng: 107.6200, siswa: 278, status: 'kritis', jenjang: 'sd', sppg: 'SPPG Bandung Kidul' },
    { id: 5, nama: 'MIN 2 Cipongkor', lat: -6.9050, lng: 107.4050, siswa: 189, status: 'layak', jenjang: 'mi', sppg: 'SPPG Cipongkor' },
    { id: 6, nama: 'SDN 4 Cicalengka', lat: -7.0330, lng: 107.7360, siswa: 156, status: 'waspada', jenjang: 'sd', sppg: 'SPPG Cicalengka' },
    { id: 7, nama: 'MIN 3 Majalaya', lat: -7.0470, lng: 107.7550, siswa: 223, status: 'layak', jenjang: 'mi', sppg: 'SPPG Majalaya' },
    { id: 8, nama: 'SDN 5 Rancaekek', lat: -6.9690, lng: 107.7770, siswa: 267, status: 'layak', jenjang: 'sd', sppg: 'SPPG Rancaekek' },
  ];

  // Sample SPPG data
  const sppgData = [
    { id: 1, nama: 'SPPG Soreang', lat: -7.0274, lng: 107.5192, kapasitas: 15000, produksi: 12500, sekolah: 28 },
    { id: 2, nama: 'SPPG Dayeuh Kolot', lat: -6.9900, lng: 107.6350, kapasitas: 12000, produksi: 11200, sekolah: 22 },
    { id: 3, nama: 'SPPG Cipongkor', lat: -6.9050, lng: 107.4050, kapasitas: 18000, produksi: 17100, sekolah: 35 },
    { id: 4, nama: 'SPPG Majalaya', lat: -7.0470, lng: 107.7550, kapasitas: 14000, produksi: 11900, sekolah: 26 },
  ];

  const getStatusColor = (status) => {
    switch(status) {
      case 'layak': return { color: '#22c55e', hex: '#22c55e' };
      case 'waspada': return { color: '#eab308', hex: '#eab308' };
      case 'kritis': return { color: '#ef4444', hex: '#ef4444' };
      default: return { color: '#6b7280', hex: '#6b7280' };
    }
  };

  const getStatusBg = (status) => {
    switch(status) {
      case 'layak': return 'bg-green-500';
      case 'waspada': return 'bg-yellow-500';
      case 'kritis': return 'bg-red-500';
      default: return 'bg-gray-500';
    }
  };

  // Initialize map
  const initMap = useCallback(() => {
    if (!mapRef.current || mapInstanceRef.current) return;

    // Wait for Leaflet to load
    if (typeof window.L === 'undefined') {
      console.log('Leaflet not loaded yet, retrying...');
      setTimeout(initMap, 100);
      return;
    }

    const L = window.L;
    const map = L.map(mapRef.current).setView([-7.02, 107.50], 11);

    // Base layers
    const baseLayers = {
      street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }),
      satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri',
        maxZoom: 19
      }),
      terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '© OpenTopoMap'
      }),
      cartodb: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '© CartoDB'
      }),
      dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '© CartoDB'
      }),
      topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '© OpenTopoMap'
      })
    };

    // Add default layer
    baseLayers.street.addTo(map);

    mapInstanceRef.current = map;
    mapInstanceRef.current.baseLayers = baseLayers;
    mapInstanceRef.current.mapStyle = mapStyle;

    // Add markers
    updateMarkers(map);

    // Handle map click for measure tool
    if (measureMode) {
      map.on('click', (e) => {
        console.log('Map clicked at:', e.latlng);
      });
    }
  }, [mapStyle, measureMode]);

  // Update base layer
  const updateBaseLayer = useCallback((map, style) => {
    if (!map || !map.baseLayers) return;

    const { street, satellite, terrain, cartodb, dark, topo } = map.baseLayers;

    // Remove all layers
    [street, satellite, terrain, cartodb, dark, topo].forEach(layer => {
      if (map._layers[layer._leaflet_id]) map.removeLayer(layer);
    });

    // Add selected layer
    switch(style) {
      case 'street':
        street.addTo(map);
        break;
      case 'satellite':
        satellite.addTo(map);
        break;
      case 'terrain':
        terrain.addTo(map);
        break;
      case 'cartodb':
        cartodb.addTo(map);
        break;
      case 'dark':
        dark.addTo(map);
        break;
      case 'topo':
        topo.addTo(map);
        break;
      default:
        street.addTo(map);
    }
  }, []);

  // Update markers based on mode and filters
  const updateMarkers = useCallback((map) => {
    if (!map) map = mapInstanceRef.current;
    if (!map) return;

    const L = window.L;
    if (!L) return;

    // Clear existing markers
    if (markersRef.current.sekolah) map.removeLayer(markersRef.current.sekolah);
    if (markersRef.current.sppg) map.removeLayer(markersRef.current.sppg);
    markersRef.current.routes.forEach(route => map.removeLayer(route));
    markersRef.current.routes = [];
    if (heatLayerRef.current) map.removeLayer(heatLayerRef.current);
    if (clustersRef.current) map.removeLayer(clustersRef.current);

    if (mode === 'cluster' && layers.sekolah) {
      // Cluster mode
      const markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        disableClusteringAtZoom: 16
      });

      sekolahData.forEach(sekolah => {
        if (filters.jenjang !== 'all' && sekolah.jenjang !== filters.jenjang) return;
        if (filters.status !== 'all' && sekolah.status !== filters.status) return;

        const color = getStatusColor(sekolah.status);
        const marker = L.circleMarker([sekolah.lat, sekolah.lng], {
          radius: 8,
          fillColor: color.hex,
          color: '#fff',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        });

        marker.bindPopup(`
          <div style="font-weight: bold; margin-bottom: 5px;">${sekolah.nama}</div>
          <div style="font-size: 12px; color: #666;">Siswa: ${sekolah.siswa}</div>
          <div style="font-size: 12px; color: #666;">Status: ${sekolah.status}</div>
        `);

        marker.on('click', () => onSelectSchool(sekolah));
        markerClusterGroup.addLayer(marker);
      });

      map.addLayer(markerClusterGroup);
      clustersRef.current = markerClusterGroup;
    } else if (mode === 'heatmap' && layers.sekolah) {
      // Heatmap mode
      const heatData = sekolahData
        .filter(s => filters.jenjang === 'all' || s.jenjang === filters.jenjang)
        .filter(s => filters.status === 'all' || s.status === filters.status)
        .map(s => [s.lat, s.lng, 0.5]);

      const heatLayer = L.heatLayer(heatData, {
        radius: 25,
        blur: 15,
        maxZoom: 1,
        gradient: { 0.4: 'blue', 0.55: 'lime', 0.7: 'yellow', 0.85: 'orange', 1.0: 'red' }
      });

      map.addLayer(heatLayer);
      heatLayerRef.current = heatLayer;
    } else if (mode === 'network' && layers.rute) {
      // Network mode - draw routes
      sekolahData.forEach(sekolah => {
        if (filters.jenjang !== 'all' && sekolah.jenjang !== filters.jenjang) return;
        if (filters.status !== 'all' && sekolah.status !== filters.status) return;

        const sppg = sppgData.find(s => s.nama === sekolah.sppg);
        if (!sppg) return;

        const color = getStatusColor(sekolah.status);
        const polyline = L.polyline([
          [sekolah.lat, sekolah.lng],
          [sppg.lat, sppg.lng]
        ], {
          color: color.hex,
          weight: 2,
          opacity: 0.7,
          dashArray: '5, 5'
        });

        map.addLayer(polyline);
        markersRef.current.routes.push(polyline);
      });
    }

    // Add sekolah markers (not in cluster mode)
    if (mode !== 'cluster' && layers.sekolah) {
      const sekolahGroup = L.featureGroup();

      sekolahData.forEach(sekolah => {
        if (filters.jenjang !== 'all' && sekolah.jenjang !== filters.jenjang) return;
        if (filters.status !== 'all' && sekolah.status !== filters.status) return;

        const color = getStatusColor(sekolah.status);
        const marker = L.circleMarker([sekolah.lat, sekolah.lng], {
          radius: 8,
          fillColor: color.hex,
          color: '#fff',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        });

        marker.bindPopup(`
          <div style="font-weight: bold; margin-bottom: 5px;">${sekolah.nama}</div>
          <div style="font-size: 12px; color: #666;">Siswa: ${sekolah.siswa}</div>
          <div style="font-size: 12px; color: #666;">SPPG: ${sekolah.sppg}</div>
          <div style="font-size: 12px; color: #666;">Status: ${sekolah.status}</div>
        `);

        marker.on('click', () => onSelectSchool(sekolah));
        sekolahGroup.addLayer(marker);
      });

      map.addLayer(sekolahGroup);
      markersRef.current.sekolah = sekolahGroup;
    }

    // Add SPPG markers
    if (layers.sppg) {
      const sppgGroup = L.featureGroup();

      sppgData.forEach(sppg => {
        const marker = L.marker([sppg.lat, sppg.lng], {
          icon: L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHJ4PSI2IiBmaWxsPSIjOUI1Q0Y2Ii8+PHRleHQgeD0iMTYiIHk9IjIwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wn4yhPC90ZXh0Pjwvc3ZnPg==',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
          })
        });

        marker.bindPopup(`
          <div style="font-weight: bold; margin-bottom: 5px;">${sppg.nama}</div>
          <div style="font-size: 12px; color: #666;">Kapasitas: ${sppg.kapasitas.toLocaleString()}</div>
          <div style="font-size: 12px; color: #666;">Produksi: ${sppg.produksi.toLocaleString()}</div>
        `);

        marker.on('click', () => onSelectSPPG(sppg));
        sppgGroup.addLayer(marker);
      });

      map.addLayer(sppgGroup);
      markersRef.current.sppg = sppgGroup;
    }

    // Add wilayah boundaries (simplified)
    if (layers.wilayah) {
      const polygon = L.polygon([
        [-6.9500, 107.3500],
        [-7.1500, 107.3500],
        [-7.1500, 107.7000],
        [-6.9500, 107.7000]
      ], {
        color: '#3b82f6',
        weight: 2,
        opacity: 0.5,
        fillOpacity: 0.1,
        dashArray: '5, 5'
      });

      map.addLayer(polygon);
    }
  }, [mode, layers, filters, onSelectSchool, onSelectSPPG]);

  // Initialize on mount
  useEffect(() => {
    setTimeout(() => {
      initMap();
    }, 100);

    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, []);

  // Update markers when mode, layers, or filters change
  useEffect(() => {
    if (mapInstanceRef.current) {
      updateMarkers(mapInstanceRef.current);
    }
  }, [mode, layers, filters, updateMarkers]);

  // Update base layer when mapStyle changes
  useEffect(() => {
    if (mapInstanceRef.current) {
      updateBaseLayer(mapInstanceRef.current, mapStyle);
    }
  }, [mapStyle, updateBaseLayer]);

  return (
    <div 
      ref={mapRef} 
      className="w-full h-full bg-gradient-to-br from-blue-100 to-green-100"
      style={{ minHeight: '400px' }}
    />
  );
}

// ==============================================
// MAP MODE BUTTON COMPONENT
// ==============================================
function MapModeButton({ icon: Icon, label, isActive, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all transform hover:scale-105 ${
        isActive
          ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg'
          : 'bg-white text-gray-700 border border-gray-300 hover:border-blue-500'
      }`}
    >
      <Icon className="w-4 h-4" />
      <span>{label}</span>
    </button>
  );
}

// ==============================================
// MAP STYLE OPTION COMPACT COMPONENT (Simpler version for inline)
// ==============================================
function MapStyleOptionCompact({ name, icon, active, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`w-full flex items-center gap-3 px-4 py-2.5 hover:bg-blue-50 transition-all border-b border-gray-100 last:border-b-0 ${
        active ? 'bg-blue-50 border-l-4 border-l-blue-600' : ''
      }`}
    >
      <span className="text-xl">{icon}</span>
      <span className={`text-sm font-bold flex-1 text-left ${active ? 'text-blue-900' : 'text-gray-900'}`}>
        {name}
      </span>
      {active && (
        <div className="w-2 h-2 bg-blue-600 rounded-full"></div>
      )}
    </button>
  );
}

// ==============================================
// MAP STYLE OPTION COMPONENT (Full version with descriptions)
// ==============================================
function MapStyleOption({ name, icon, description, active, onClick, gradient }) {
  return (
    <button
      onClick={onClick}
      className={`w-full flex items-center gap-3 p-3 hover:bg-blue-50 transition-all border-b border-gray-100 last:border-b-0 ${
        active ? 'bg-blue-50 border-l-4 border-l-blue-600' : ''
      }`}
    >
      <div className={`w-12 h-12 rounded-lg bg-gradient-to-br ${gradient} flex items-center justify-center text-2xl border-2 ${
        active ? 'border-blue-500 shadow-lg' : 'border-gray-300'
      }`}>
        {icon}
      </div>
      <div className="flex-1 text-left">
        <div className={`text-sm font-bold ${active ? 'text-blue-900' : 'text-gray-900'}`}>
          {name}
        </div>
        <div className="text-xs text-gray-500">{description}</div>
      </div>
      {active && (
        <div className="w-2 h-2 bg-blue-600 rounded-full"></div>
      )}
    </button>
  );
}

// ==============================================
// MAP STYLE BUTTON COMPONENT
// ==============================================
// LAYER TOGGLE COMPONENT
// ==============================================
function LayerToggle({ label, isActive, onChange }) {
  return (
    <label className="flex items-center gap-3 p-2 cursor-pointer hover:bg-blue-50 rounded-lg transition-colors">
      <input
        type="checkbox"
        checked={isActive}
        onChange={(e) => onChange(e.target.checked)}
        className="w-4 h-4 text-blue-600 rounded cursor-pointer accent-blue-600"
      />
      <span className={`text-sm font-medium ${isActive ? 'text-blue-900' : 'text-gray-700'}`}>
        {label}
      </span>
    </label>
  );
}

// ==============================================
// STAT ITEM COMPONENT
// ==============================================
function StatItem({ label, value, trend }) {
  return (
    <div className="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-3 border border-gray-200">
      <div className="text-xs text-gray-600 font-medium mb-1">{label}</div>
      <div className="text-xl font-bold bg-gradient-to-r from-blue-600 to-blue-700 bg-clip-text text-transparent">
        {value}
      </div>
      {trend && (
        <div className={`text-xs font-semibold mt-1 ${trend > 0 ? 'text-green-700' : 'text-red-700'}`}>
          {trend > 0 ? '↑' : '↓'} {Math.abs(trend)}%
        </div>
      )}
    </div>
  );
}

// ==============================================
// MAP LEGEND COMPONENT (ENHANCED)
// ==============================================
function MapLegend({ mode, layers, activeLayer }) {
  return (
    <div className="absolute top-4 left-4 bg-white rounded-xl shadow-2xl border border-gray-200 p-4 w-72 max-h-96 overflow-y-auto" style={{ zIndex: 20 }}>
      <div className="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
        <Layers className="w-4 h-4 text-blue-600" />
        <h4 className="text-sm font-bold text-gray-900">Legend</h4>
      </div>

      {/* Mode Info */}
      <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
        <div className="text-xs font-semibold text-blue-900 mb-1">Current Mode</div>
        <div className="text-sm font-bold text-blue-700 capitalize">{mode}</div>
      </div>

      {/* Sekolah Legend */}
      {layers.sekolah && (
        <div className="mb-4">
          <div className="text-xs font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <Building2 className="w-3 h-3" />
            Sekolah Status
          </div>
          <div className="space-y-2">
            <LegendItem color="bg-green-500" label="Layak" />
            <LegendItem color="bg-yellow-500" label="Waspada" />
            <LegendItem color="bg-red-500" label="Kritis" />
          </div>
        </div>
      )}

      {/* SPPG Legend */}
      {layers.sppg && (
        <div className="mb-4 pb-4 border-b border-gray-200">
          <div className="text-xs font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <Database className="w-3 h-3" />
            SPPG
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-purple-600 rounded"></div>
            <span className="text-xs text-gray-600">Satuan Produksi Pangan</span>
          </div>
        </div>
      )}

      {/* Routes Legend */}
      {layers.rute && mode === 'network' && (
        <div className="mb-4 pb-4 border-b border-gray-200">
          <div className="text-xs font-semibold text-gray-700 mb-2">Network Routes</div>
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <div className="w-6 h-0.5 bg-green-500"></div>
              <span className="text-xs text-gray-600">Layak</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-0.5 bg-yellow-500"></div>
              <span className="text-xs text-gray-600">Waspada</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-0.5 bg-red-500"></div>
              <span className="text-xs text-gray-600">Kritis</span>
            </div>
          </div>
        </div>
      )}

      {/* Wilayah Legend */}
      {layers.wilayah && (
        <div>
          <div className="text-xs font-semibold text-gray-700 mb-2">Boundaries</div>
          <div className="flex items-center gap-2">
            <div className="w-6 h-0.5 border-2 border-blue-500" style={{ borderStyle: 'dashed' }}></div>
            <span className="text-xs text-gray-600">Kecamatan</span>
          </div>
        </div>
      )}
    </div>
  );
}

function LegendItem({ color, label }) {
  return (
    <div className="flex items-center gap-2">
      <div className={`w-4 h-4 ${color} rounded-full border-2 border-white shadow`}></div>
      <span className="text-xs text-gray-700 font-medium">{label}</span>
    </div>
  );
}

// ==============================================
// DETAIL PANEL COMPONENT (ENHANCED)
// ==============================================
function DetailPanel({ type, data, onClose }) {
  if (!data) return null;

  return (
    <div className="absolute bottom-6 right-[25rem] w-96 bg-white rounded-2xl shadow-2xl border-2 border-blue-500 overflow-hidden animate-slide-up" style={{ zIndex: 1100 }}>
      {/* Header dengan gradient */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-4 flex items-start justify-between">
        <div className="flex items-center gap-3 flex-1">
          {type === 'sekolah' ? (
            <div className={`w-12 h-12 ${
              data.status === 'layak' ? 'bg-green-400' :
              data.status === 'waspada' ? 'bg-yellow-400' :
              'bg-red-400'
            } rounded-xl flex items-center justify-center shadow-lg`}>
              <Building2 className="w-6 h-6 text-white" />
            </div>
          ) : (
            <div className="w-12 h-12 bg-purple-400 rounded-xl flex items-center justify-center shadow-lg">
              <Database className="w-6 h-6 text-white" />
            </div>
          )}
          <div className="flex-1">
            <h3 className="text-base font-bold text-white truncate">{data.nama}</h3>
            <p className="text-xs text-blue-100">
              {type === 'sekolah' ? `${data.jenjang?.toUpperCase()} - ${data.siswa} siswa` : `${data.sekolah} sekolah dilayani`}
            </p>
          </div>
        </div>
        <button 
          onClick={onClose}
          className="p-1.5 hover:bg-white/20 rounded-lg transition-colors"
        >
          <X className="w-5 h-5 text-white" />
        </button>
      </div>

      {/* Content */}
      <div className="p-4">
        {type === 'sekolah' ? (
          <div className="grid grid-cols-2 gap-3">
            <DetailMetricCompact label="Siswa" value={data.siswa?.toString()} icon={Users} />
            <DetailMetricCompact label="Jenjang" value={data.jenjang?.toUpperCase()} icon={Building2} />
            <DetailMetricCompact label="Status" value={data.status?.toUpperCase()} icon={Award} color={data.status} />
            <DetailMetricCompact label="SPPG" value={data.sppg?.split(' ').slice(-2).join(' ')} icon={Database} />
          </div>
        ) : (
          <div className="grid grid-cols-2 gap-3">
            <DetailMetricCompact label="Kapasitas" value={data.kapasitas?.toLocaleString()} icon={BarChart3} />
            <DetailMetricCompact label="Produksi" value={data.produksi?.toLocaleString()} icon={TrendingUp} />
            <DetailMetricCompact label="Utilization" value={`${((data.produksi / data.kapasitas) * 100).toFixed(1)}%`} icon={Activity} color="blue" />
            <DetailMetricCompact label="Sekolah" value={data.sekolah?.toString()} icon={Building2} />
          </div>
        )}
      </div>
    </div>
  );
}

function DetailMetricCompact({ label, value, icon: Icon, color }) {
  const colorStyles = {
    layak: { bg: 'bg-green-50', text: 'text-green-700', border: 'border-green-200' },
    waspada: { bg: 'bg-yellow-50', text: 'text-yellow-700', border: 'border-yellow-200' },
    kritis: { bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-200' },
    blue: { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200' },
    default: { bg: 'bg-gray-50', text: 'text-gray-700', border: 'border-gray-200' }
  };

  const style = colorStyles[color] || colorStyles.default;

  return (
    <div className={`p-3 rounded-lg border-2 ${style.bg} ${style.border}`}>
      <div className="flex items-center gap-1.5 mb-1">
        {Icon && <Icon className={`w-3.5 h-3.5 ${style.text}`} />}
        <div className="text-[10px] font-bold text-gray-600 uppercase tracking-wide">{label}</div>
      </div>
      <div className={`text-base font-black ${style.text} truncate`}>
        {value || '-'}
      </div>
    </div>
  );
}

function DetailMetric({ label, value, icon: Icon, color }) {
  const colorStyles = {
    green: { bg: 'bg-green-50', text: 'text-green-700', border: 'border-green-200' },
    yellow: { bg: 'bg-yellow-50', text: 'text-yellow-700', border: 'border-yellow-200' },
    red: { bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-200' },
    blue: { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200' },
    default: { bg: 'bg-gray-50', text: 'text-gray-900', border: 'border-gray-200' }
  };

  const style = colorStyles[color] || colorStyles.default;

  return (
    <div className={`p-3 rounded-lg border ${style.bg} ${style.border}`}>
      <div className="flex items-center gap-2 mb-1">
        {Icon && <Icon className={`w-3 h-3 ${style.text}`} />}
        <div className="text-xs font-medium text-gray-600">{label}</div>
      </div>
      <div className={`text-lg font-bold ${style.text}`}>
        {value}
      </div>
    </div>
  );
}

// ==============================================
// DATA SEKOLAH PAGE - SINTA 1 LEVEL
// ===============================================
function SekolahPage() {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterJenjang, setFilterJenjang] = useState('all');
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterKecamatan, setFilterKecamatan] = useState('all');
  const [sortBy, setSortBy] = useState('nama');
  const [sortOrder, setSortOrder] = useState('asc');
  const [selectedSchool, setSelectedSchool] = useState(null);
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 10;

  // Sample comprehensive data
  const sekolahDataFull = [
    { id: 1, npsn: '20203001', nama: 'SDN 1 Bandung', jenjang: 'SD', kecamatan: 'Bandung', siswa: 245, sppg: 'SPPG Bandung Pusat', jarak: 7.2, waktu: 18, status: 'layak', lat: -7.0050, lng: 107.6500 },
    { id: 2, npsn: '20203002', nama: 'MIN 1 Bandung', jenjang: 'MI', kecamatan: 'Bandung', siswa: 198, sppg: 'SPPG Bandung Pusat', jarak: 12.4, waktu: 28, status: 'waspada', lat: -7.0100, lng: 107.6550 },
    { id: 3, npsn: '20203003', nama: 'SDN 2 Cimahi', jenjang: 'SD', kecamatan: 'Cimahi', siswa: 312, sppg: 'SPPG Bandung Utara', jarak: 5.8, waktu: 14, status: 'layak', lat: -6.9950, lng: 107.6600 },
    { id: 4, npsn: '20203004', nama: 'SDN 3 Lembang', jenjang: 'SD', kecamatan: 'Lembang', siswa: 278, sppg: 'SPPG Bandung Selatan', jarak: 16.7, waktu: 42, status: 'kritis', lat: -7.0250, lng: 107.6300 },
    { id: 5, npsn: '20203005', nama: 'MIN 2 Cimahi', jenjang: 'MI', kecamatan: 'Cimahi', siswa: 189, sppg: 'SPPG Bandung Utara', jarak: 8.1, waktu: 20, status: 'layak', lat: -6.9900, lng: 107.6650 },
    { id: 6, npsn: '20203006', nama: 'SDN 4 Cibeunying', jenjang: 'SD', kecamatan: 'Cibeunying', siswa: 156, sppg: 'SPPG Bandung Utara', jarak: 11.9, waktu: 26, status: 'waspada', lat: -6.9850, lng: 107.6700 },
    { id: 7, npsn: '20203007', nama: 'SDN 5 Soreang', jenjang: 'SD', kecamatan: 'Soreang', siswa: 223, sppg: 'SPPG Bandung Selatan', jarak: 6.4, waktu: 16, status: 'layak', lat: -7.0350, lng: 107.6200 },
    { id: 8, npsn: '20203008', nama: 'MIN 3 Lembang', jenjang: 'MI', kecamatan: 'Lembang', siswa: 201, sppg: 'SPPG Bandung Selatan', jarak: 18.2, waktu: 48, status: 'kritis', lat: -7.0300, lng: 107.6250 },
    { id: 9, npsn: '20203009', nama: 'SDN 6 Ujungjaya', jenjang: 'SD', kecamatan: 'Ujungjaya', siswa: 267, sppg: 'SPPG Bandung Timur', jarak: 9.3, waktu: 22, status: 'layak', lat: -7.0050, lng: 107.6800 },
    { id: 10, npsn: '20203010', nama: 'SDN 7 Pengalengan', jenjang: 'SD', kecamatan: 'Pengalengan', siswa: 289, sppg: 'SPPG Bandung Barat', jarak: 13.1, waktu: 30, status: 'waspada', lat: -7.0450, lng: 107.6100 },
    { id: 11, npsn: '20203011', nama: 'MIN 4 Ujungjaya', jenjang: 'MI', kecamatan: 'Ujungjaya', siswa: 178, sppg: 'SPPG Bandung Timur', jarak: 7.8, waktu: 19, status: 'layak', lat: -7.0100, lng: 107.6850 },
    { id: 12, npsn: '20203012', nama: 'SDN 8 Bandung', jenjang: 'SD', kecamatan: 'Bandung', siswa: 234, sppg: 'SPPG Bandung Pusat', jarak: 15.3, waktu: 38, status: 'kritis', lat: -7.0150, lng: 107.6450 },
  ];

  // Filtering & Sorting Logic
  const filteredData = sekolahDataFull.filter(school => {
    const matchSearch = school.nama.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        school.npsn.includes(searchTerm);
    const matchJenjang = filterJenjang === 'all' || school.jenjang === filterJenjang;
    const matchStatus = filterStatus === 'all' || school.status === filterStatus;
    const matchKecamatan = filterKecamatan === 'all' || school.kecamatan === filterKecamatan;
    
    return matchSearch && matchJenjang && matchStatus && matchKecamatan;
  }).sort((a, b) => {
    let comparison = 0;
    if (sortBy === 'nama') comparison = a.nama.localeCompare(b.nama);
    else if (sortBy === 'siswa') comparison = a.siswa - b.siswa;
    else if (sortBy === 'jarak') comparison = a.jarak - b.jarak;
    else if (sortBy === 'status') comparison = a.status.localeCompare(b.status);
    
    return sortOrder === 'asc' ? comparison : -comparison;
  });

  // Pagination
  const totalPages = Math.ceil(filteredData.length / itemsPerPage);
  const paginatedData = filteredData.slice(
    (currentPage - 1) * itemsPerPage,
    currentPage * itemsPerPage
  );

  // Statistics
  const stats = {
    total: filteredData.length,
    layak: filteredData.filter(s => s.status === 'layak').length,
    waspada: filteredData.filter(s => s.status === 'waspada').length,
    kritis: filteredData.filter(s => s.status === 'kritis').length,
    totalSiswa: filteredData.reduce((sum, s) => sum + s.siswa, 0),
    avgJarak: (filteredData.reduce((sum, s) => sum + s.jarak, 0) / filteredData.length).toFixed(1)
  };

  return (
    <div className="p-6 space-y-6">
      {/* Page Header */}
      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Data Sekolah Sasaran MBG</h2>
          <p className="text-sm text-gray-600 mt-1">
            Pengelolaan data sekolah penerima manfaat Makanan Bergizi Gratis
          </p>
        </div>
        <div className="flex gap-2">
          <button className="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all flex items-center gap-2">
            <FileText className="w-4 h-4" />
            Export Excel
          </button>
          <button className="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all flex items-center gap-2">
            <Database className="w-4 h-4" />
            Import Data
          </button>
        </div>
      </div>

      {/* Statistics Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-6 gap-4">
        <StatCard label="Total Sekolah" value={stats.total} color="blue" icon={Building2} />
        <StatCard label="Status Layak" value={stats.layak} color="green" icon={Target} />
        <StatCard label="Waspada" value={stats.waspada} color="yellow" icon={AlertTriangle} />
        <StatCard label="Kritis" value={stats.kritis} color="red" icon={AlertTriangle} />
        <StatCard label="Total Siswa" value={stats.totalSiswa.toLocaleString()} color="purple" icon={Users} />
        <StatCard label="Avg Jarak" value={`${stats.avgJarak} km`} color="orange" icon={MapPin} />
      </div>

      {/* Search & Filter Panel */}
      <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
        <div className="flex items-center gap-2 mb-4">
          <Settings className="w-5 h-5 text-gray-700" />
          <h3 className="text-lg font-bold text-gray-900">Filter & Pencarian</h3>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
          {/* Search */}
          <div className="lg:col-span-2">
            <label className="text-xs font-semibold text-gray-700 block mb-2">
              Cari Sekolah
            </label>
            <input
              type="text"
              placeholder="Nama sekolah atau NPSN..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          {/* Filter Jenjang */}
          <div>
            <label className="text-xs font-semibold text-gray-700 block mb-2">
              Jenjang
            </label>
            <select
              value={filterJenjang}
              onChange={(e) => setFilterJenjang(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">Semua Jenjang</option>
              <option value="SD">SD</option>
              <option value="MI">MI</option>
            </select>
          </div>

          {/* Filter Status */}
          <div>
            <label className="text-xs font-semibold text-gray-700 block mb-2">
              Status Kelayakan
            </label>
            <select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">Semua Status</option>
              <option value="layak">✓ Layak</option>
              <option value="waspada">⚠ Waspada</option>
              <option value="kritis">✕ Kritis</option>
            </select>
          </div>

          {/* Filter Kecamatan */}
          <div>
            <label className="text-xs font-semibold text-gray-700 block mb-2">
              Kecamatan
            </label>
            <select
              value={filterKecamatan}
              onChange={(e) => setFilterKecamatan(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">Semua Kecamatan</option>
              <option value="Bandung">Bandung</option>
              <option value="Cimahi">Cimahi</option>
              <option value="Lembang">Lembang</option>
              <option value="Cibeunying">Cibeunying</option>
              <option value="Soreang">Soreang</option>
            </select>
          </div>
        </div>

        {/* Sort Controls */}
        <div className="flex items-center gap-4 mt-4 pt-4 border-t border-gray-200">
          <span className="text-xs font-semibold text-gray-700">Urutkan:</span>
          <div className="flex gap-2">
            <SortButton label="Nama" value="nama" current={sortBy} onClick={setSortBy} />
            <SortButton label="Jumlah Siswa" value="siswa" current={sortBy} onClick={setSortBy} />
            <SortButton label="Jarak" value="jarak" current={sortBy} onClick={setSortBy} />
            <SortButton label="Status" value="status" current={sortBy} onClick={setSortBy} />
          </div>
          <button
            onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
            className="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs font-semibold transition-colors"
          >
            {sortOrder === 'asc' ? '↑ A-Z' : '↓ Z-A'}
          </button>
        </div>
      </div>

      {/* Data Table */}
      <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">No</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">NPSN</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Nama Sekolah</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Jenjang</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Kecamatan</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Siswa</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">SPPG Terdekat</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Jarak</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Waktu</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {paginatedData.map((school, idx) => (
                <tr 
                  key={school.id}
                  className="hover:bg-blue-50 transition-colors"
                >
                  <td className="px-4 py-3 text-sm text-gray-600">
                    {(currentPage - 1) * itemsPerPage + idx + 1}
                  </td>
                  <td className="px-4 py-3 text-sm font-mono text-gray-700">
                    {school.npsn}
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <Building2 className="w-4 h-4 text-blue-700" />
                      </div>
                      <div>
                        <div className="text-sm font-semibold text-gray-900">{school.nama}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-semibold">
                      {school.jenjang}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-700">
                    {school.kecamatan}
                  </td>
                  <td className="px-4 py-3 text-sm font-bold text-gray-900">
                    {school.siswa}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-700">
                    {school.sppg}
                  </td>
                  <td className="px-4 py-3 text-sm font-semibold text-gray-900">
                    {school.jarak} km
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-700">
                    {school.waktu} mnt
                  </td>
                  <td className="px-4 py-3">
                    <StatusBadge status={school.status} />
                  </td>
                  <td className="px-4 py-3">
                    <button
                      onClick={() => setSelectedSchool(school)}
                      className="px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-xs font-semibold transition-colors"
                    >
                      Detail
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* Pagination */}
        <div className="bg-gray-50 px-6 py-4 flex items-center justify-between border-t border-gray-200">
          <div className="text-sm text-gray-700">
            Menampilkan <span className="font-semibold">{(currentPage - 1) * itemsPerPage + 1}</span> - 
            <span className="font-semibold"> {Math.min(currentPage * itemsPerPage, filteredData.length)}</span> dari 
            <span className="font-semibold"> {filteredData.length}</span> data
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
              disabled={currentPage === 1}
              className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Previous
            </button>
            {[...Array(totalPages)].map((_, i) => (
              <button
                key={i}
                onClick={() => setCurrentPage(i + 1)}
                className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
                  currentPage === i + 1
                    ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white'
                    : 'bg-white border border-gray-300 hover:bg-gray-50'
                }`}
              >
                {i + 1}
              </button>
            ))}
            <button
              onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
              disabled={currentPage === totalPages}
              className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Next
            </button>
          </div>
        </div>
      </div>

      {/* Output Info Panel */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-start gap-4">
          <Award className="w-6 h-6 flex-shrink-0 mt-1" />
          <div>
            <h3 className="font-bold text-lg mb-2">Output Modul Data Sekolah</h3>
            <p className="text-blue-100 text-sm leading-relaxed mb-3">
              Modul ini menyediakan: (1) Database komprehensif sekolah sasaran dengan atribut spasial dan non-spasial,
              (2) Sistem query dan filtering multi-kriteria, (3) Statistik deskriptif status kelayakan pelayanan,
              (4) Export data untuk analisis lanjutan, (5) Interface manajemen data terintegrasi dengan modul WebGIS.
            </p>
            <div className="flex flex-wrap gap-2">
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Database Management</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Multi-Filter Query</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Descriptive Stats</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Data Export</span>
            </div>
          </div>
        </div>
      </div>

      {/* Detail Modal */}
      {selectedSchool && (
        <SchoolDetailModal
          school={selectedSchool}
          onClose={() => setSelectedSchool(null)}
        />
      )}
    </div>
  );
}

// Helper Components
function StatCard({ label, value, color, icon: Icon }) {
  const colors = {
    blue: 'from-blue-600 to-blue-700',
    green: 'from-green-600 to-green-700',
    yellow: 'from-yellow-600 to-yellow-700',
    red: 'from-red-600 to-red-700',
    purple: 'from-purple-600 to-purple-700',
    orange: 'from-orange-600 to-orange-700'
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-4 shadow-sm hover:shadow-md transition-shadow">
      <div className={`w-10 h-10 bg-gradient-to-br ${colors[color]} rounded-lg flex items-center justify-center mb-3 shadow-md`}>
        <Icon className="w-5 h-5 text-white" />
      </div>
      <div className="text-2xl font-black text-gray-900 mb-1">{value}</div>
      <div className="text-xs font-semibold text-gray-600">{label}</div>
    </div>
  );
}

function SortButton({ label, value, current, onClick }) {
  return (
    <button
      onClick={() => onClick(value)}
      className={`px-3 py-1 rounded-lg text-xs font-semibold transition-all ${
        current === value
          ? 'bg-blue-600 text-white shadow-md'
          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
      }`}
    >
      {label}
    </button>
  );
}

function StatusBadge({ status }) {
  const config = {
    layak: { bg: 'bg-green-100', text: 'text-green-700', label: '✓ Layak' },
    waspada: { bg: 'bg-yellow-100', text: 'text-yellow-700', label: '⚠ Waspada' },
    kritis: { bg: 'bg-red-100', text: 'text-red-700', label: '✕ Kritis' }
  };

  const style = config[status];

  return (
    <span className={`px-3 py-1 ${style.bg} ${style.text} rounded-lg text-xs font-bold`}>
      {style.label}
    </span>
  );
}

// ==============================================
// SCHOOL DETAIL MODAL
// ==============================================
function SchoolDetailModal({ school, onClose }) {
  const [activeTab, setActiveTab] = useState('info');

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
      <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        {/* Modal Header */}
        <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white">
          <div className="flex items-start justify-between">
            <div className="flex items-center gap-4">
              <div className={`w-16 h-16 rounded-2xl flex items-center justify-center shadow-lg ${
                school.status === 'layak' ? 'bg-green-500' :
                school.status === 'waspada' ? 'bg-yellow-500' :
                'bg-red-500'
              }`}>
                <Building2 className="w-8 h-8 text-white" />
              </div>
              <div>
                <h3 className="text-2xl font-bold mb-1">{school.nama}</h3>
                <div className="flex items-center gap-3 text-blue-100 text-sm">
                  <span>NPSN: {school.npsn}</span>
                  <span>•</span>
                  <span>{school.jenjang}</span>
                  <span>•</span>
                  <span>{school.kecamatan}</span>
                </div>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors"
            >
              <X className="w-6 h-6" />
            </button>
          </div>

          {/* Tabs */}
          <div className="flex gap-2 mt-6">
            <TabButton label="Informasi" value="info" active={activeTab} onClick={setActiveTab} />
            <TabButton label="Analisis" value="analisis" active={activeTab} onClick={setActiveTab} />
            <TabButton label="Rekomendasi" value="rekomendasi" active={activeTab} onClick={setActiveTab} />
            <TabButton label="Lokasi" value="lokasi" active={activeTab} onClick={setActiveTab} />
          </div>
        </div>

        {/* Modal Body */}
        <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 200px)' }}>
          {activeTab === 'info' && <InfoTab school={school} />}
          {activeTab === 'analisis' && <AnalisisTab school={school} />}
          {activeTab === 'rekomendasi' && <RekomendasiTab school={school} />}
          {activeTab === 'lokasi' && <LokasiTab school={school} />}
        </div>

        {/* Modal Footer */}
        <div className="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-6 py-2 border border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-100 transition-colors"
          >
            Tutup
          </button>
          <button className="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg text-sm font-semibold hover:shadow-lg transition-all">
            Export Detail
          </button>
        </div>
      </div>
    </div>
  );
}

function TabButton({ label, value, active, onClick }) {
  return (
    <button
      onClick={() => onClick(value)}
      className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
        active === value
          ? 'bg-white text-blue-700 shadow-lg'
          : 'text-blue-100 hover:bg-white hover:bg-opacity-20'
      }`}
    >
      {label}
    </button>
  );
}

// Tab Content Components
function InfoTab({ school }) {
  return (
    <div className="space-y-6">
      {/* Basic Info Grid */}
      <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
        <InfoItem label="NPSN" value={school.npsn} icon={Building2} />
        <InfoItem label="Jenjang" value={school.jenjang} icon={BookOpen} />
        <InfoItem label="Kecamatan" value={school.kecamatan} icon={MapPin} />
        <InfoItem label="Jumlah Siswa" value={school.siswa} icon={Users} />
        <InfoItem label="SPPG Terdekat" value={school.sppg} icon={Database} />
        <InfoItem label="Status" value={school.status.toUpperCase()} icon={Target} color={
          school.status === 'layak' ? 'green' : school.status === 'waspada' ? 'yellow' : 'red'
        } />
      </div>

      {/* Distance & Time Info */}
      <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
        <h4 className="text-sm font-bold text-blue-900 mb-4 flex items-center gap-2">
          <MapPin className="w-4 h-4" />
          Analisis Jarak & Waktu Tempuh
        </h4>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <div className="text-xs text-gray-600 mb-1">Jarak ke SPPG</div>
            <div className="text-2xl font-black text-blue-900">{school.jarak} km</div>
            <div className="text-xs text-gray-600 mt-2">
              {school.jarak <= 10 ? '✓ Memenuhi standar' : '⚠ Melebihi threshold'}
            </div>
          </div>
          <div>
            <div className="text-xs text-gray-600 mb-1">Estimasi Waktu</div>
            <div className="text-2xl font-black text-blue-900">{school.waktu} menit</div>
            <div className="text-xs text-gray-600 mt-2">
              {school.waktu <= 30 ? '✓ Tepat waktu' : '⚠ Risiko keterlambatan'}
            </div>
          </div>
        </div>
      </div>

      {/* Kebutuhan Gizi */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
          <Users className="w-4 h-4" />
          Kebutuhan Pangan Harian
        </h4>
        <div className="space-y-3">
          <KebutuhanBar label="Nasi (kg)" value={school.siswa * 0.15} max={50} color="orange" />
          <KebutuhanBar label="Lauk Pauk (kg)" value={school.siswa * 0.1} max={30} color="red" />
          <KebutuhanBar label="Sayur (kg)" value={school.siswa * 0.08} max={25} color="green" />
          <KebutuhanBar label="Buah (kg)" value={school.siswa * 0.05} max={15} color="purple" />
        </div>
        <div className="mt-4 p-3 bg-gray-50 rounded-lg">
          <div className="text-xs text-gray-600">Total Kebutuhan Harian</div>
          <div className="text-lg font-bold text-gray-900">
            {(school.siswa * 0.38).toFixed(1)} kg/hari
          </div>
        </div>
      </div>

      {/* Koordinat */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
          <Target className="w-4 h-4" />
          Koordinat Geografis
        </h4>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <div className="text-xs text-gray-600 mb-1">Latitude</div>
            <div className="text-sm font-mono font-bold text-gray-900">{school.lat}</div>
          </div>
          <div>
            <div className="text-xs text-gray-600 mb-1">Longitude</div>
            <div className="text-sm font-mono font-bold text-gray-900">{school.lng}</div>
          </div>
        </div>
      </div>
    </div>
  );
}

function AnalisisTab({ school }) {
  // Calculate scores
  const jarakScore = school.jarak <= 10 ? 100 : school.jarak <= 15 ? 70 : 40;
  const waktuScore = school.waktu <= 30 ? 100 : school.waktu <= 45 ? 60 : 30;
  const kapasitasScore = 85; // Sample
  const kelayakanScore = Math.round((jarakScore + waktuScore + kapasitasScore) / 3);

  return (
    <div className="space-y-6">
      {/* Kelayakan Score */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white">
        <div className="text-center">
          <div className="text-sm font-semibold mb-2">Indeks Kelayakan Pelayanan</div>
          <div className="text-6xl font-black mb-2">{kelayakanScore}</div>
          <div className="text-sm text-blue-100">dari 100</div>
          <div className="mt-4">
            <span className={`px-4 py-2 rounded-lg font-bold ${
              kelayakanScore >= 80 ? 'bg-green-500' :
              kelayakanScore >= 60 ? 'bg-yellow-500' :
              'bg-red-500'
            }`}>
              {kelayakanScore >= 80 ? '✓ LAYAK' : kelayakanScore >= 60 ? '⚠ WASPADA' : '✕ KRITIS'}
            </span>
          </div>
        </div>
      </div>

      {/* Score Breakdown */}
      <div className="space-y-4">
        <ScoreItem
          label="Skor Jarak"
          score={jarakScore}
          description={`${school.jarak} km ke SPPG terdekat`}
        />
        <ScoreItem
          label="Skor Waktu Tempuh"
          score={waktuScore}
          description={`${school.waktu} menit estimasi perjalanan`}
        />
        <ScoreItem
          label="Skor Kapasitas SPPG"
          score={kapasitasScore}
          description="SPPG masih memiliki kapasitas memadai"
        />
      </div>

      {/* Risk Analysis */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
          <AlertTriangle className="w-4 h-4" />
          Analisis Risiko
        </h4>
        <div className="space-y-3">
          <RiskItem
            risk="Risiko Keterlambatan"
            level={school.waktu > 30 ? 'high' : school.waktu > 20 ? 'medium' : 'low'}
            description={school.waktu > 30 ? 'Waktu tempuh melebihi 30 menit' : 'Waktu tempuh dalam batas normal'}
          />
          <RiskItem
            risk="Risiko Kualitas Makanan"
            level={school.jarak > 15 ? 'high' : school.jarak > 10 ? 'medium' : 'low'}
            description={school.jarak > 15 ? 'Jarak jauh dapat mempengaruhi kesegaran' : 'Jarak masih dalam toleransi'}
          />
          <RiskItem
            risk="Risiko Operasional"
            level="low"
            description="Tidak ada kendala operasional signifikan"
          />
        </div>
      </div>

      {/* Comparative Analysis */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-sm font-bold text-gray-900 mb-4">Perbandingan dengan Rata-rata</h4>
        <div className="space-y-3">
          <ComparisonBar label="Jarak" value={school.jarak} avg={8.3} unit="km" />
          <ComparisonBar label="Waktu" value={school.waktu} avg={22} unit="mnt" />
          <ComparisonBar label="Siswa" value={school.siswa} avg={220} unit="siswa" />
        </div>
      </div>
    </div>
  );
}

function RekomendasiTab({ school }) {
  const recommendations = [];

  // Generate smart recommendations
  if (school.jarak > 15) {
    recommendations.push({
      priority: 'high',
      title: 'Reassignment SPPG',
      description: `Pertimbangkan reassignment ke SPPG yang lebih dekat. Jarak saat ini ${school.jarak} km melebihi threshold 15 km.`,
      action: 'Lakukan analisis proximity untuk menemukan SPPG alternatif'
    });
  }

  if (school.waktu > 30) {
    recommendations.push({
      priority: 'high',
      title: 'Optimasi Rute Distribusi',
      description: `Waktu tempuh ${school.waktu} menit berisiko terhadap kualitas makanan. Perlu optimasi rute atau penjadwalan ulang.`,
      action: 'Gunakan modul Network Analysis untuk rute optimal'
    });
  }

  if (school.siswa > 250) {
    recommendations.push({
      priority: 'medium',
      title: 'Monitoring Kapasitas',
      description: `Jumlah siswa ${school.siswa} tergolong besar. Pastikan kapasitas SPPG mencukupi.`,
      action: 'Lakukan monitoring rutin kapasitas produksi SPPG'
    });
  }

  if (school.status === 'layak') {
    recommendations.push({
      priority: 'low',
      title: 'Maintain Status',
      description: 'Status pelayanan saat ini sudah layak. Pertahankan kualitas pelayanan.',
      action: 'Lakukan evaluasi berkala untuk memastikan konsistensi'
    });
  }

  return (
    <div className="space-y-4">
      {recommendations.map((rec, idx) => (
        <RecommendationCard key={idx} {...rec} />
      ))}

      {/* Action Plan */}
      <div className="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6 border border-green-200 mt-6">
        <h4 className="text-sm font-bold text-green-900 mb-4 flex items-center gap-2">
          <Target className="w-4 h-4" />
          Rencana Aksi
        </h4>
        <ol className="space-y-2 text-sm text-gray-700">
          <li className="flex gap-2">
            <span className="font-bold text-green-700">1.</span>
            <span>Review status kelayakan setiap 3 bulan</span>
          </li>
          <li className="flex gap-2">
            <span className="font-bold text-green-700">2.</span>
            <span>Koordinasi dengan SPPG untuk konfirmasi kapasitas</span>
          </li>
          <li className="flex gap-2">
            <span className="font-bold text-green-700">3.</span>
            <span>Monitor feedback kualitas makanan dari sekolah</span>
          </li>
          <li className="flex gap-2">
            <span className="font-bold text-green-700">4.</span>
            <span>Update data siswa setiap semester</span>
          </li>
        </ol>
      </div>
    </div>
  );
}

function LokasiTab({ school }) {
  return (
    <div className="space-y-6">
      {/* Mini Map */}
      <div className="bg-gradient-to-br from-blue-50 via-green-50 to-blue-50 rounded-xl h-80 flex items-center justify-center border-2 border-gray-200 relative overflow-hidden">
        <div className="absolute inset-0 opacity-10" style={{
          backgroundImage: 'linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px)',
          backgroundSize: '30px 30px'
        }}></div>
        
        {/* School Marker */}
        <div className="absolute" style={{ left: '50%', top: '50%', transform: 'translate(-50%, -50%)' }}>
          <div className="relative">
            <div className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl ${
              school.status === 'layak' ? 'bg-green-500' :
              school.status === 'waspada' ? 'bg-yellow-500' :
              'bg-red-500'
            }`}>
              <Building2 className="w-8 h-8 text-white" />
            </div>
            <div className="absolute -bottom-12 left-1/2 -translate-x-1/2 bg-white px-3 py-1 rounded-lg shadow-lg border border-gray-200 whitespace-nowrap">
              <div className="text-xs font-bold text-gray-900">{school.nama}</div>
            </div>
          </div>
        </div>

        {/* SPPG Direction */}
        <div className="absolute" style={{ left: '70%', top: '30%' }}>
          <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg">
            <Database className="w-6 h-6 text-white" />
          </div>
        </div>

        {/* Route Line */}
        <svg className="absolute inset-0 w-full h-full pointer-events-none">
          <line x1="50%" y1="50%" x2="70%" y2="30%" stroke="#3b82f6" strokeWidth="3" strokeDasharray="5,5" opacity="0.5" />
        </svg>

        <div className="absolute top-4 right-4 bg-white rounded-lg shadow-lg px-3 py-2 text-xs font-semibold text-gray-700">
          {school.jarak} km
        </div>
      </div>

      {/* Coordinate Details */}
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-white rounded-xl border border-gray-200 p-4">
          <div className="text-xs font-semibold text-gray-600 mb-2">Latitude</div>
          <div className="text-xl font-mono font-bold text-gray-900">{school.lat}</div>
        </div>
        <div className="bg-white rounded-xl border border-gray-200 p-4">
          <div className="text-xs font-semibold text-gray-600 mb-2">Longitude</div>
          <div className="text-xl font-mono font-bold text-gray-900">{school.lng}</div>
        </div>
      </div>

      {/* Nearby Features */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-sm font-bold text-gray-900 mb-4">Fasilitas Terdekat</h4>
        <div className="space-y-3">
          <NearbyItem name={school.sppg} distance={school.jarak} type="SPPG" />
          <NearbyItem name="Kantor Kecamatan" distance={3.2} type="Pemerintahan" />
          <NearbyItem name="Puskesmas" distance={1.8} type="Kesehatan" />
        </div>
      </div>
    </div>
  );
}

// Small Helper Components
function InfoItem({ label, value, icon: Icon, color = 'blue' }) {
  const colors = {
    blue: 'bg-blue-100 text-blue-700',
    green: 'bg-green-100 text-green-700',
    yellow: 'bg-yellow-100 text-yellow-700',
    red: 'bg-red-100 text-red-700'
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-4">
      <div className="flex items-center gap-2 mb-2">
        <div className={`w-8 h-8 ${colors[color]} rounded-lg flex items-center justify-center`}>
          <Icon className="w-4 h-4" />
        </div>
        <div className="text-xs font-semibold text-gray-600">{label}</div>
      </div>
      <div className="text-lg font-bold text-gray-900">{value}</div>
    </div>
  );
}

function KebutuhanBar({ label, value, max, color }) {
  const percentage = (value / max) * 100;
  const colors = {
    orange: 'bg-orange-500',
    red: 'bg-red-500',
    green: 'bg-green-500',
    purple: 'bg-purple-500'
  };

  return (
    <div>
      <div className="flex justify-between text-xs mb-1">
        <span className="font-semibold text-gray-700">{label}</span>
        <span className="font-bold text-gray-900">{value.toFixed(1)} kg</span>
      </div>
      <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
        <div className={`h-full ${colors[color]}`} style={{ width: `${percentage}%` }}></div>
      </div>
    </div>
  );
}

function ScoreItem({ label, score, description }) {
  return (
    <div className="bg-white rounded-xl border border-gray-200 p-4">
      <div className="flex items-center justify-between mb-2">
        <span className="text-sm font-semibold text-gray-700">{label}</span>
        <span className={`text-2xl font-black ${
          score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600'
        }`}>
          {score}
        </span>
      </div>
      <div className="h-2 bg-gray-200 rounded-full overflow-hidden mb-2">
        <div className={`h-full ${
          score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-yellow-500' : 'bg-red-500'
        }`} style={{ width: `${score}%` }}></div>
      </div>
      <div className="text-xs text-gray-600">{description}</div>
    </div>
  );
}

function RiskItem({ risk, level, description }) {
  const config = {
    high: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700', label: 'Tinggi' },
    medium: { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-700', label: 'Sedang' },
    low: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-700', label: 'Rendah' }
  };
  
  const style = config[level];

  return (
    <div className={`${style.bg} border ${style.border} rounded-lg p-3`}>
      <div className="flex items-center justify-between mb-1">
        <span className="text-sm font-semibold text-gray-900">{risk}</span>
        <span className={`px-2 py-0.5 ${style.bg} ${style.text} rounded text-xs font-bold border ${style.border}`}>
          {style.label}
        </span>
      </div>
      <div className="text-xs text-gray-600">{description}</div>
    </div>
  );
}

function ComparisonBar({ label, value, avg, unit }) {
  const percentage = (value / (avg * 2)) * 100;
  const avgPercentage = (avg / (avg * 2)) * 100;

  return (
    <div>
      <div className="flex justify-between text-xs mb-1">
        <span className="font-semibold text-gray-700">{label}</span>
        <span className="font-bold text-gray-900">{value} {unit}</span>
      </div>
      <div className="relative h-3 bg-gray-200 rounded-full overflow-hidden">
        <div className="absolute h-full bg-blue-500" style={{ width: `${percentage}%` }}></div>
        <div className="absolute h-full border-l-2 border-gray-700" style={{ left: `${avgPercentage}%` }}></div>
      </div>
      <div className="text-xs text-gray-500 mt-1">Rata-rata: {avg} {unit}</div>
    </div>
  );
}

function RecommendationCard({ priority, title, description, action }) {
  const config = {
    high: { bg: 'from-red-50 to-red-100', border: 'border-red-200', text: 'text-red-700', icon: AlertTriangle },
    medium: { bg: 'from-yellow-50 to-yellow-100', border: 'border-yellow-200', text: 'text-yellow-700', icon: AlertTriangle },
    low: { bg: 'from-blue-50 to-blue-100', border: 'border-blue-200', text: 'text-blue-700', icon: Target }
  };

  const style = config[priority];
  const Icon = style.icon;

  return (
    <div className={`bg-gradient-to-r ${style.bg} rounded-xl p-5 border ${style.border}`}>
      <div className="flex items-start gap-3">
        <Icon className={`w-5 h-5 ${style.text} mt-1`} />
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            <h5 className="font-bold text-gray-900">{title}</h5>
            <span className={`px-2 py-0.5 ${style.text} rounded text-xs font-bold border ${style.border}`}>
              {priority.toUpperCase()}
            </span>
          </div>
          <p className="text-sm text-gray-700 mb-3">{description}</p>
          <div className="bg-white bg-opacity-50 rounded-lg p-3 text-xs">
            <span className="font-semibold text-gray-700">Action: </span>
            <span className="text-gray-600">{action}</span>
          </div>
        </div>
      </div>
    </div>
  );
}

function NearbyItem({ name, distance, type }) {
  return (
    <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
      <div>
        <div className="text-sm font-semibold text-gray-900">{name}</div>
        <div className="text-xs text-gray-600">{type}</div>
      </div>
      <div className="text-sm font-bold text-blue-600">{distance} km</div>
    </div>
  );
}

// ==============================================
// DATA SPPG PAGE - SINTA 1 LEVEL
// ==============================================
function SPPGPage() {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterKecamatan, setFilterKecamatan] = useState('all');
  const [filterStatus, setFilterStatus] = useState('all');
  const [selectedSPPG, setSelectedSPPG] = useState(null);
  const [viewMode, setViewMode] = useState('grid'); // grid or table

  // Comprehensive SPPG Data
  const sppgDataFull = [
    {
      id: 1,
      kode: 'SPPG-001',
      nama: 'SPPG Bandung Pusat',
      kecamatan: 'Bandung',
      alamat: 'Jl. Raya Bandung No. 45',
      kapasitas: 15000,
      produksiHarian: 12500,
      sekolahDilayani: 28,
      totalSiswa: 6845,
      pekerja: 25,
      status: 'operasional',
      utilisasi: 83.3,
      lat: -7.0050,
      lng: 107.6500,
      fasilitas: ['Dapur Utama', 'Cold Storage', 'Packaging Area', 'Quality Control Lab'],
      jamOperasional: '05:00 - 14:00',
      sertifikat: ['Halal', 'PIRT', 'ISO 22000'],
      surplus: 2155
    },
    {
      id: 2,
      kode: 'SPPG-002',
      nama: 'SPPG Bandung Utara',
      kecamatan: 'Cimahi',
      alamat: 'Jl. Cimahi Indah No. 12',
      kapasitas: 12000,
      produksiHarian: 11200,
      sekolahDilayani: 22,
      totalSiswa: 5389,
      pekerja: 20,
      status: 'operasional',
      utilisasi: 93.3,
      lat: -6.9950,
      lng: 107.6600,
      fasilitas: ['Dapur Utama', 'Cold Storage', 'Packaging Area'],
      jamOperasional: '05:30 - 14:30',
      sertifikat: ['Halal', 'PIRT'],
      surplus: 611
    },
    {
      id: 3,
      kode: 'SPPG-003',
      nama: 'SPPG Bandung Selatan',
      kecamatan: 'Lembang',
      alamat: 'Jl. Lembang Sejahtera No. 78',
      kapasitas: 18000,
      produksiHarian: 17100,
      sekolahDilayani: 35,
      totalSiswa: 8956,
      pekerja: 32,
      status: 'operasional',
      utilisasi: 95.0,
      lat: -7.0250,
      lng: 107.6300,
      fasilitas: ['Dapur Utama', 'Cold Storage', 'Packaging Area', 'Quality Control Lab', 'Gudang'],
      jamOperasional: '04:30 - 14:00',
      sertifikat: ['Halal', 'PIRT', 'ISO 22000', 'HACCP'],
      surplus: 144
    },
    {
      id: 4,
      kode: 'SPPG-004',
      nama: 'SPPG Bandung Timur',
      kecamatan: 'Ujungjaya',
      alamat: 'Jl. Ujungjaya Raya No. 34',
      kapasitas: 14000,
      produksiHarian: 11900,
      sekolahDilayani: 26,
      totalSiswa: 6234,
      pekerja: 23,
      status: 'operasional',
      utilisasi: 85.0,
      lat: -7.0050,
      lng: 107.6800,
      fasilitas: ['Dapur Utama', 'Cold Storage', 'Packaging Area', 'Quality Control Lab'],
      jamOperasional: '05:00 - 14:30',
      sertifikat: ['Halal', 'PIRT', 'ISO 22000'],
      surplus: 2100
    },
    {
      id: 5,
      kode: 'SPPG-005',
      nama: 'SPPG Bandung Barat',
      kecamatan: 'Pengalengan',
      alamat: 'Jl. Pengalengan Timur No. 21',
      kapasitas: 10000,
      produksiHarian: 9450,
      sekolahDilayani: 18,
      totalSiswa: 4567,
      pekerja: 18,
      status: 'operasional',
      utilisasi: 94.5,
      lat: -7.0450,
      lng: 107.6100,
      fasilitas: ['Dapur Utama', 'Cold Storage', 'Packaging Area'],
      jamOperasional: '05:30 - 14:00',
      sertifikat: ['Halal', 'PIRT'],
      surplus: 550
    },
    {
      id: 6,
      kode: 'SPPG-006',
      nama: 'SPPG Bandung Pusat 2',
      kecamatan: 'Bandung',
      alamat: 'Jl. Merdeka No. 89',
      kapasitas: 13000,
      produksiHarian: 9800,
      sekolahDilayani: 20,
      totalSiswa: 4890,
      pekerja: 21,
      status: 'maintenance',
      utilisasi: 75.4,
      lat: -7.0100,
      lng: 107.6450,
      fasilitas: ['Dapur Utama', 'Packaging Area'],
      jamOperasional: '05:00 - 14:00',
      sertifikat: ['Halal', 'PIRT'],
      surplus: 3200
    }
  ];

  // Filtering
  const filteredData = sppgDataFull.filter(sppg => {
    const matchSearch = sppg.nama.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        sppg.kode.toLowerCase().includes(searchTerm.toLowerCase());
    const matchKecamatan = filterKecamatan === 'all' || sppg.kecamatan === filterKecamatan;
    const matchStatus = filterStatus === 'all' || sppg.status === filterStatus;
    
    return matchSearch && matchKecamatan && matchStatus;
  });

  // Statistics
  const stats = {
    total: filteredData.length,
    operasional: filteredData.filter(s => s.status === 'operasional').length,
    totalKapasitas: filteredData.reduce((sum, s) => sum + s.kapasitas, 0),
    totalProduksi: filteredData.reduce((sum, s) => sum + s.produksiHarian, 0),
    totalSekolah: filteredData.reduce((sum, s) => sum + s.sekolahDilayani, 0),
    totalSiswa: filteredData.reduce((sum, s) => sum + s.totalSiswa, 0),
    avgUtilisasi: (filteredData.reduce((sum, s) => sum + s.utilisasi, 0) / filteredData.length).toFixed(1)
  };

  return (
    <div className="p-6 space-y-6">
      {/* Page Header */}
      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Data Satuan Produksi Pangan Gratis (SPPG)</h2>
          <p className="text-sm text-gray-600 mt-1">
            Monitoring kapasitas dan kinerja unit produksi makanan bergizi
          </p>
        </div>
        <div className="flex gap-2">
          <button className="px-4 py-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all flex items-center gap-2">
            <Database className="w-4 h-4" />
            Add SPPG
          </button>
          <button className="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all flex items-center gap-2">
            <FileText className="w-4 h-4" />
            Export Report
          </button>
        </div>
      </div>

      {/* Statistics Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-6 gap-4">
        <SPPGStatCard 
          label="Total SPPG" 
          value={stats.total} 
          icon={Database} 
          color="purple" 
        />
        <SPPGStatCard 
          label="Operasional" 
          value={stats.operasional} 
          icon={Activity} 
          color="green" 
        />
        <SPPGStatCard 
          label="Kapasitas Total" 
          value={stats.totalKapasitas.toLocaleString()} 
          icon={TrendingUp} 
          color="blue"
          unit="porsi"
        />
        <SPPGStatCard 
          label="Produksi Harian" 
          value={stats.totalProduksi.toLocaleString()} 
          icon={Target} 
          color="orange"
          unit="porsi"
        />
        <SPPGStatCard 
          label="Sekolah Dilayani" 
          value={stats.totalSekolah} 
          icon={Building2} 
          color="indigo"
        />
        <SPPGStatCard 
          label="Utilisasi Rata-rata" 
          value={`${stats.avgUtilisasi}%`} 
          icon={Activity} 
          color="teal"
        />
      </div>

      {/* Capacity Overview Chart */}
      <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h3 className="text-lg font-bold text-gray-900">Kapasitas vs Produksi SPPG</h3>
            <p className="text-xs text-gray-600 mt-1">Perbandingan kapasitas maksimal dengan produksi aktual</p>
          </div>
          <div className="flex gap-3">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-blue-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">Kapasitas</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-green-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">Produksi</span>
            </div>
          </div>
        </div>
        <SPPGCapacityChart data={filteredData} />
      </div>

      {/* Search & Filter */}
      <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm">
        <div className="flex items-center gap-2 mb-4">
          <Settings className="w-5 h-5 text-gray-700" />
          <h3 className="text-lg font-bold text-gray-900">Filter & Pencarian</h3>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div className="md:col-span-2">
            <label className="text-xs font-semibold text-gray-700 block mb-2">
              Cari SPPG
            </label>
            <input
              type="text"
              placeholder="Nama atau kode SPPG..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            />
          </div>

          <div>
            <label className="text-xs font-semibold text-gray-700 block mb-2">
              Kecamatan
            </label>
            <select
              value={filterKecamatan}
              onChange={(e) => setFilterKecamatan(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
            >
              <option value="all">Semua Kecamatan</option>
              <option value="Bandung">Bandung</option>
              <option value="Cimahi">Cimahi</option>
              <option value="Lembang">Lembang</option>
              <option value="Cibeunying">Cibeunying</option>
              <option value="Soreang">Soreang</option>
            </select>
          </div>

          <div>
            <label className="text-xs font-semibold text-gray-700 block mb-2">
              Status
            </label>
            <select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
            >
              <option value="all">Semua Status</option>
              <option value="operasional">✓ Operasional</option>
              <option value="maintenance">🔧 Maintenance</option>
              <option value="nonaktif">✕ Non-aktif</option>
            </select>
          </div>
        </div>

        <div className="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
          <div className="flex items-center gap-2">
            <span className="text-xs font-semibold text-gray-700">View Mode:</span>
            <button
              onClick={() => setViewMode('grid')}
              className={`px-3 py-1 rounded-lg text-xs font-semibold transition-colors ${
                viewMode === 'grid' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Grid
            </button>
            <button
              onClick={() => setViewMode('table')}
              className={`px-3 py-1 rounded-lg text-xs font-semibold transition-colors ${
                viewMode === 'table' ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Table
            </button>
          </div>
          <div className="text-xs text-gray-600">
            Menampilkan <span className="font-bold text-gray-900">{filteredData.length}</span> SPPG
          </div>
        </div>
      </div>

      {/* Data Display */}
      {viewMode === 'grid' ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredData.map(sppg => (
            <SPPGCard 
              key={sppg.id} 
              sppg={sppg} 
              onDetail={() => setSelectedSPPG(sppg)} 
            />
          ))}
        </div>
      ) : (
        <SPPGTable 
          data={filteredData} 
          onDetail={setSelectedSPPG} 
        />
      )}

      {/* Output Info Panel */}
      <div className="bg-gradient-to-r from-purple-600 to-purple-700 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-start gap-4">
          <Award className="w-6 h-6 flex-shrink-0 mt-1" />
          <div>
            <h3 className="font-bold text-lg mb-2">Output Modul Data SPPG</h3>
            <p className="text-purple-100 text-sm leading-relaxed mb-3">
              Modul ini menghasilkan: (1) Database komprehensif SPPG dengan profil kapasitas produksi,
              (2) Analisis utilisasi dan efisiensi operasional, (3) Monitoring status produksi real-time,
              (4) Identifikasi surplus/defisit kapasitas per wilayah, (5) Dashboard performa untuk optimasi resource allocation.
            </p>
            <div className="flex flex-wrap gap-2">
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Capacity Management</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Production Monitoring</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Utilization Analysis</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Resource Optimization</span>
            </div>
          </div>
        </div>
      </div>

      {/* Detail Modal */}
      {selectedSPPG && (
        <SPPGDetailModal
          sppg={selectedSPPG}
          onClose={() => setSelectedSPPG(null)}
        />
      )}
    </div>
  );
}

// Helper Components
function SPPGStatCard({ label, value, icon: Icon, color, unit }) {
  const colors = {
    purple: 'from-purple-600 to-purple-700',
    green: 'from-green-600 to-green-700',
    blue: 'from-blue-600 to-blue-700',
    orange: 'from-orange-600 to-orange-700',
    indigo: 'from-indigo-600 to-indigo-700',
    teal: 'from-teal-600 to-teal-700'
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-4 shadow-sm hover:shadow-md transition-shadow">
      <div className={`w-10 h-10 bg-gradient-to-br ${colors[color]} rounded-lg flex items-center justify-center mb-3 shadow-md`}>
        <Icon className="w-5 h-5 text-white" />
      </div>
      <div className="text-2xl font-black text-gray-900 mb-1">{value}</div>
      <div className="text-xs font-semibold text-gray-600">
        {label}
        {unit && <span className="text-gray-400 ml-1">({unit})</span>}
      </div>
    </div>
  );
}

function SPPGCapacityChart({ data }) {
  const maxValue = Math.max(...data.map(d => d.kapasitas));

  return (
    <div className="space-y-4">
      {data.map(sppg => (
        <div key={sppg.id}>
          <div className="flex items-center justify-between mb-2">
            <span className="text-xs font-semibold text-gray-700">{sppg.nama}</span>
            <div className="flex items-center gap-3 text-xs">
              <span className="text-gray-600">
                Utilisasi: <span className="font-bold text-gray-900">{sppg.utilisasi}%</span>
              </span>
            </div>
          </div>
          <div className="relative h-12 bg-gray-100 rounded-lg overflow-hidden">
            {/* Capacity Bar (Background) */}
            <div 
              className="absolute h-full bg-gradient-to-r from-blue-400 to-blue-500 opacity-30"
              style={{ width: `${(sppg.kapasitas / maxValue) * 100}%` }}
            />
            {/* Production Bar (Foreground) */}
            <div 
              className="absolute h-full bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-end px-3"
              style={{ width: `${(sppg.produksiHarian / maxValue) * 100}%` }}
            >
              <span className="text-xs font-bold text-white">{sppg.produksiHarian.toLocaleString()}</span>
            </div>
            {/* Capacity Label */}
            <div 
              className="absolute h-full flex items-center px-3"
              style={{ left: `${(sppg.kapasitas / maxValue) * 100}%` }}
            >
              <span className="text-xs font-bold text-blue-700">{sppg.kapasitas.toLocaleString()}</span>
            </div>
          </div>
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>Surplus: {sppg.surplus.toLocaleString()} porsi</span>
            <span>{sppg.sekolahDilayani} sekolah</span>
          </div>
        </div>
      ))}
    </div>
  );
}

function SPPGCard({ sppg, onDetail }) {
  const getStatusColor = () => {
    if (sppg.status === 'operasional') return 'bg-green-100 text-green-700';
    if (sppg.status === 'maintenance') return 'bg-yellow-100 text-yellow-700';
    return 'bg-red-100 text-red-700';
  };

  const getUtilisasiColor = () => {
    if (sppg.utilisasi >= 90) return 'text-red-600';
    if (sppg.utilisasi >= 80) return 'text-yellow-600';
    return 'text-green-600';
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden">
      {/* Card Header */}
      <div className="bg-gradient-to-r from-purple-600 to-purple-700 p-4 text-white">
        <div className="flex items-start justify-between mb-2">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
              <Database className="w-6 h-6" />
            </div>
            <div>
              <h4 className="font-bold text-lg">{sppg.nama}</h4>
              <p className="text-xs text-purple-100">{sppg.kode}</p>
            </div>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <MapPin className="w-3 h-3" />
          <span className="text-xs">{sppg.kecamatan}</span>
        </div>
      </div>

      {/* Card Body */}
      <div className="p-4 space-y-4">
        {/* Status Badge */}
        <div className="flex items-center justify-between">
          <span className={`px-3 py-1 rounded-lg text-xs font-bold ${getStatusColor()}`}>
            {sppg.status.toUpperCase()}
          </span>
          <span className={`text-2xl font-black ${getUtilisasiColor()}`}>
            {sppg.utilisasi}%
          </span>
        </div>

        {/* Key Metrics */}
        <div className="grid grid-cols-2 gap-3">
          <MetricItem label="Kapasitas" value={sppg.kapasitas.toLocaleString()} />
          <MetricItem label="Produksi" value={sppg.produksiHarian.toLocaleString()} />
          <MetricItem label="Sekolah" value={sppg.sekolahDilayani} />
          <MetricItem label="Siswa" value={sppg.totalSiswa.toLocaleString()} />
        </div>

        {/* Capacity Bar */}
        <div>
          <div className="flex justify-between text-xs mb-1">
            <span className="text-gray-600">Utilisasi Kapasitas</span>
            <span className="font-bold text-gray-900">{sppg.utilisasi}%</span>
          </div>
          <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
            <div 
              className={`h-full ${
                sppg.utilisasi >= 90 ? 'bg-red-500' :
                sppg.utilisasi >= 80 ? 'bg-yellow-500' :
                'bg-green-500'
              }`}
              style={{ width: `${sppg.utilisasi}%` }}
            />
          </div>
        </div>

        {/* Action Button */}
        <button
          onClick={onDetail}
          className="w-full px-4 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg text-sm font-semibold transition-colors"
        >
          Lihat Detail
        </button>
      </div>
    </div>
  );
}

function MetricItem({ label, value }) {
  return (
    <div className="bg-gray-50 rounded-lg p-3">
      <div className="text-xs text-gray-600 mb-1">{label}</div>
      <div className="text-lg font-bold text-gray-900">{value}</div>
    </div>
  );
}

// ==============================================
// SPPG TABLE COMPONENT
// ==============================================
function SPPGTable({ data, onDetail }) {
  const [sortBy, setSortBy] = useState('nama');
  const [sortOrder, setSortOrder] = useState('asc');

  const sortedData = [...data].sort((a, b) => {
    let comparison = 0;
    if (sortBy === 'nama') comparison = a.nama.localeCompare(b.nama);
    else if (sortBy === 'kapasitas') comparison = a.kapasitas - b.kapasitas;
    else if (sortBy === 'produksi') comparison = a.produksiHarian - b.produksiHarian;
    else if (sortBy === 'utilisasi') comparison = a.utilisasi - b.utilisasi;
    else if (sortBy === 'sekolah') comparison = a.sekolahDilayani - b.sekolahDilayani;
    
    return sortOrder === 'asc' ? comparison : -comparison;
  });

  const getStatusBadge = (status) => {
    const config = {
      operasional: { bg: 'bg-green-100', text: 'text-green-700', label: '✓ Operasional' },
      maintenance: { bg: 'bg-yellow-100', text: 'text-yellow-700', label: '🔧 Maintenance' },
      nonaktif: { bg: 'bg-red-100', text: 'text-red-700', label: '✕ Non-aktif' }
    };
    const style = config[status] || config.operasional;
    return <span className={`px-3 py-1 ${style.bg} ${style.text} rounded-lg text-xs font-bold`}>{style.label}</span>;
  };

  const getUtilisasiColor = (utilisasi) => {
    if (utilisasi >= 90) return 'text-red-600 bg-red-50';
    if (utilisasi >= 80) return 'text-yellow-600 bg-yellow-50';
    return 'text-green-600 bg-green-50';
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      {/* Table Header Controls */}
      <div className="bg-gray-50 px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <span className="text-xs font-semibold text-gray-700">Urutkan:</span>
          <div className="flex gap-2">
            <TableSortButton label="Nama" value="nama" current={sortBy} onClick={setSortBy} />
            <TableSortButton label="Kapasitas" value="kapasitas" current={sortBy} onClick={setSortBy} />
            <TableSortButton label="Produksi" value="produksi" current={sortBy} onClick={setSortBy} />
            <TableSortButton label="Utilisasi" value="utilisasi" current={sortBy} onClick={setSortBy} />
            <TableSortButton label="Sekolah" value="sekolah" current={sortBy} onClick={setSortBy} />
          </div>
          <button
            onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
            className="px-3 py-1 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg text-xs font-semibold transition-colors"
          >
            {sortOrder === 'asc' ? '↑ A-Z' : '↓ Z-A'}
          </button>
        </div>
        <div className="text-xs text-gray-600">
          <span className="font-bold text-gray-900">{data.length}</span> SPPG
        </div>
      </div>

      {/* Table */}
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead className="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">No</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Kode</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Nama SPPG</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Kecamatan</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Kapasitas</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Produksi</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Utilisasi</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Sekolah</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Siswa</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Aksi</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {sortedData.map((sppg, idx) => (
              <tr key={sppg.id} className="hover:bg-purple-50 transition-colors">
                <td className="px-4 py-3 text-sm text-gray-600">{idx + 1}</td>
                <td className="px-4 py-3">
                  <span className="text-xs font-mono font-semibold text-purple-700 bg-purple-50 px-2 py-1 rounded">
                    {sppg.kode}
                  </span>
                </td>
                <td className="px-4 py-3">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                      <Database className="w-4 h-4 text-purple-700" />
                    </div>
                    <div>
                      <div className="text-sm font-semibold text-gray-900">{sppg.nama}</div>
                      <div className="text-xs text-gray-500">{sppg.pekerja} pekerja</div>
                    </div>
                  </div>
                </td>
                <td className="px-4 py-3 text-sm text-gray-700">{sppg.kecamatan}</td>
                <td className="px-4 py-3">
                  <div className="text-sm font-bold text-gray-900">{sppg.kapasitas.toLocaleString()}</div>
                  <div className="text-xs text-gray-500">porsi/hari</div>
                </td>
                <td className="px-4 py-3">
                  <div className="text-sm font-bold text-gray-900">{sppg.produksiHarian.toLocaleString()}</div>
                  <div className="text-xs text-gray-500">aktual</div>
                </td>
                <td className="px-4 py-3">
                  <div className={`inline-flex items-center gap-1 px-2 py-1 rounded-lg ${getUtilisasiColor(sppg.utilisasi)}`}>
                    <span className="text-sm font-black">{sppg.utilisasi}%</span>
                  </div>
                </td>
                <td className="px-4 py-3 text-sm font-bold text-gray-900">{sppg.sekolahDilayani}</td>
                <td className="px-4 py-3 text-sm font-semibold text-gray-700">{sppg.totalSiswa.toLocaleString()}</td>
                <td className="px-4 py-3">{getStatusBadge(sppg.status)}</td>
                <td className="px-4 py-3">
                  <button
                    onClick={() => onDetail(sppg)}
                    className="px-3 py-1 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg text-xs font-semibold transition-colors"
                  >
                    Detail
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Table Footer */}
      <div className="bg-gray-50 px-6 py-4 border-t border-gray-200">
        <div className="flex items-center justify-between text-xs text-gray-600">
          <div>
            Total Kapasitas: <span className="font-bold text-gray-900">{data.reduce((sum, s) => sum + s.kapasitas, 0).toLocaleString()}</span> porsi/hari
          </div>
          <div>
            Total Produksi: <span className="font-bold text-gray-900">{data.reduce((sum, s) => sum + s.produksiHarian, 0).toLocaleString()}</span> porsi/hari
          </div>
          <div>
            Utilisasi Rata-rata: <span className="font-bold text-gray-900">{(data.reduce((sum, s) => sum + s.utilisasi, 0) / data.length).toFixed(1)}%</span>
          </div>
        </div>
      </div>
    </div>
  );
}

function TableSortButton({ label, value, current, onClick }) {
  return (
    <button
      onClick={() => onClick(value)}
      className={`px-3 py-1 rounded-lg text-xs font-semibold transition-all ${
        current === value
          ? 'bg-purple-600 text-white shadow-md'
          : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'
      }`}
    >
      {label}
    </button>
  );
}

// ==============================================
// SPPG DETAIL MODAL
// ==============================================
function SPPGDetailModal({ sppg, onClose }) {
  const [activeTab, setActiveTab] = useState('overview');

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
      <div className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
        {/* Modal Header */}
        <div className="bg-gradient-to-r from-purple-600 to-purple-700 p-6 text-white">
          <div className="flex items-start justify-between">
            <div className="flex items-center gap-4">
              <div className="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center shadow-lg">
                <Database className="w-8 h-8 text-white" />
              </div>
              <div>
                <h3 className="text-2xl font-bold mb-1">{sppg.nama}</h3>
                <div className="flex items-center gap-3 text-purple-100 text-sm">
                  <span>{sppg.kode}</span>
                  <span>•</span>
                  <span>{sppg.kecamatan}</span>
                  <span>•</span>
                  <span>{sppg.pekerja} pekerja</span>
                </div>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition-colors"
            >
              <X className="w-6 h-6" />
            </button>
          </div>

          {/* Tabs */}
          <div className="flex gap-2 mt-6 overflow-x-auto pb-2">
            <SPPGTabButton label="Overview" value="overview" active={activeTab} onClick={setActiveTab} />
            <SPPGTabButton label="Produksi" value="produksi" active={activeTab} onClick={setActiveTab} />
            <SPPGTabButton label="Sekolah Dilayani" value="sekolah" active={activeTab} onClick={setActiveTab} />
            <SPPGTabButton label="Fasilitas" value="fasilitas" active={activeTab} onClick={setActiveTab} />
            <SPPGTabButton label="Kinerja" value="kinerja" active={activeTab} onClick={setActiveTab} />
            <SPPGTabButton label="Lokasi" value="lokasi" active={activeTab} onClick={setActiveTab} />
          </div>
        </div>

        {/* Modal Body */}
        <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 220px)' }}>
          {activeTab === 'overview' && <SPPGOverviewTab sppg={sppg} />}
          {activeTab === 'produksi' && <SPPGProduksiTab sppg={sppg} />}
          {activeTab === 'sekolah' && <SPPGSekolahTab sppg={sppg} />}
          {activeTab === 'fasilitas' && <SPPGFasilitasTab sppg={sppg} />}
          {activeTab === 'kinerja' && <SPPGKinerjaTab sppg={sppg} />}
          {activeTab === 'lokasi' && <SPPGLokasiTab sppg={sppg} />}
        </div>

        {/* Modal Footer */}
        <div className="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-between items-center">
          <div className="flex items-center gap-2 text-xs text-gray-600">
            <Shield className="w-4 h-4" />
            <span>Terakhir diperbarui: 14 Des 2025</span>
          </div>
          <div className="flex gap-3">
            <button
              onClick={onClose}
              className="px-6 py-2 border border-gray-300 rounded-lg text-sm font-semibold hover:bg-gray-100 transition-colors"
            >
              Tutup
            </button>
            <button className="px-6 py-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg text-sm font-semibold hover:shadow-lg transition-all">
              Export Detail
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

function SPPGTabButton({ label, value, active, onClick }) {
  return (
    <button
      onClick={() => onClick(value)}
      className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all whitespace-nowrap ${
        active === value
          ? 'bg-white text-purple-700 shadow-lg'
          : 'text-purple-100 hover:bg-white hover:bg-opacity-20'
      }`}
    >
      {label}
    </button>
  );
}

// ==============================================
// SPPG MODAL TAB CONTENTS
// ==============================================
function SPPGOverviewTab({ sppg }) {
  const getUtilisasiStatus = () => {
    if (sppg.utilisasi >= 90) return { color: 'red', status: 'Overload - Perlu Perhatian', icon: AlertTriangle };
    if (sppg.utilisasi >= 80) return { color: 'yellow', status: 'High Utilization - Monitor', icon: AlertTriangle };
    return { color: 'green', status: 'Normal Operation', icon: Target };
  };

  const utilisasiStatus = getUtilisasiStatus();
  const StatusIcon = utilisasiStatus.icon;

  return (
    <div className="space-y-6">
      {/* Utilization Score */}
      <div className={`bg-gradient-to-r ${
        utilisasiStatus.color === 'red' ? 'from-red-600 to-red-700' :
        utilisasiStatus.color === 'yellow' ? 'from-yellow-600 to-yellow-700' :
        'from-green-600 to-green-700'
      } rounded-xl p-6 text-white`}>
        <div className="text-center">
          <div className="text-sm font-semibold mb-2">Tingkat Utilisasi Kapasitas</div>
          <div className="text-6xl font-black mb-2">{sppg.utilisasi}%</div>
          <div className="flex items-center justify-center gap-2 text-sm">
            <StatusIcon className="w-5 h-5" />
            <span>{utilisasiStatus.status}</span>
          </div>
        </div>
      </div>

      {/* Key Metrics Grid */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <SPPGMetricCard
          label="Kapasitas Maksimal"
          value={sppg.kapasitas.toLocaleString()}
          unit="porsi/hari"
          icon={Database}
          color="blue"
        />
        <SPPGMetricCard
          label="Produksi Harian"
          value={sppg.produksiHarian.toLocaleString()}
          unit="porsi/hari"
          icon={TrendingUp}
          color="green"
        />
        <SPPGMetricCard
          label="Surplus Kapasitas"
          value={sppg.surplus.toLocaleString()}
          unit="porsi"
          icon={Target}
          color="purple"
        />
        <SPPGMetricCard
          label="Sekolah Dilayani"
          value={sppg.sekolahDilayani}
          unit="sekolah"
          icon={Building2}
          color="orange"
        />
      </div>

      {/* Production Bar */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
          <Activity className="w-4 h-4" />
          Kapasitas vs Produksi
        </h4>
        <div className="relative h-16 bg-gray-100 rounded-xl overflow-hidden">
          {/* Capacity Background */}
          <div className="absolute h-full w-full bg-gradient-to-r from-blue-200 to-blue-300 opacity-40" />
          {/* Production Foreground */}
          <div 
            className="absolute h-full bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-end px-4"
            style={{ width: `${(sppg.produksiHarian / sppg.kapasitas) * 100}%` }}
          >
            <span className="text-sm font-bold text-white">{sppg.produksiHarian.toLocaleString()}</span>
          </div>
          {/* Capacity Marker */}
          <div className="absolute h-full right-0 flex items-center px-4">
            <span className="text-sm font-bold text-blue-700">{sppg.kapasitas.toLocaleString()}</span>
          </div>
        </div>
        <div className="flex justify-between text-xs text-gray-600 mt-3">
          <span>Surplus: <span className="font-bold text-gray-900">{sppg.surplus.toLocaleString()}</span> porsi</span>
          <span>Utilisasi: <span className="font-bold text-gray-900">{sppg.utilisasi}%</span></span>
        </div>
      </div>

      {/* Operational Info */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-white rounded-xl border border-gray-200 p-6">
          <h4 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
            <Users className="w-4 h-4" />
            Informasi Operasional
          </h4>
          <div className="space-y-3">
            <InfoRow label="Jam Operasional" value={sppg.jamOperasional} />
            <InfoRow label="Jumlah Pekerja" value={`${sppg.pekerja} orang`} />
            <InfoRow label="Total Siswa Dilayani" value={sppg.totalSiswa.toLocaleString()} />
            <InfoRow label="Status Operasional" value={sppg.status.toUpperCase()} />
          </div>
        </div>

        <div className="bg-white rounded-xl border border-gray-200 p-6">
          <h4 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
            <MapPin className="w-4 h-4" />
            Informasi Lokasi
          </h4>
          <div className="space-y-3">
            <InfoRow label="Kecamatan" value={sppg.kecamatan} />
            <InfoRow label="Alamat" value={sppg.alamat} />
            <InfoRow label="Koordinat" value={`${sppg.lat}, ${sppg.lng}`} />
          </div>
        </div>
      </div>

      {/* Certification */}
      <div className="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
        <div className="flex items-start gap-3">
          <Shield className="w-6 h-6 text-green-700 mt-1" />
          <div className="flex-1">
            <h4 className="text-sm font-bold text-green-900 mb-3">Sertifikasi & Standar</h4>
            <div className="flex flex-wrap gap-2">
              {sppg.sertifikat.map((cert, idx) => (
                <span key={idx} className="px-3 py-1 bg-white border border-green-300 rounded-lg text-xs font-semibold text-green-800">
                  ✓ {cert}
                </span>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function SPPGMetricCard({ label, value, unit, icon: Icon, color }) {
  const colors = {
    blue: 'from-blue-600 to-blue-700',
    green: 'from-green-600 to-green-700',
    purple: 'from-purple-600 to-purple-700',
    orange: 'from-orange-600 to-orange-700'
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-shadow">
      <div className={`w-10 h-10 bg-gradient-to-br ${colors[color]} rounded-lg flex items-center justify-center mb-3 shadow-md`}>
        <Icon className="w-5 h-5 text-white" />
      </div>
      <div className="text-2xl font-black text-gray-900 mb-1">{value}</div>
      <div className="text-xs font-semibold text-gray-700">{label}</div>
      <div className="text-xs text-gray-500 mt-1">{unit}</div>
    </div>
  );
}

function InfoRow({ label, value }) {
  return (
    <div className="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
      <span className="text-xs font-medium text-gray-600">{label}</span>
      <span className="text-sm font-semibold text-gray-900">{value}</span>
    </div>
  );
}

// ==============================================
// SPPG PRODUKSI TAB
// ==============================================
function SPPGProduksiTab({ sppg }) {
  // Sample production data over time
  const productionHistory = [
    { bulan: 'Jul', target: sppg.produksiHarian, actual: sppg.produksiHarian * 0.95, efisiensi: 95 },
    { bulan: 'Agu', target: sppg.produksiHarian, actual: sppg.produksiHarian * 0.97, efisiensi: 97 },
    { bulan: 'Sep', target: sppg.produksiHarian, actual: sppg.produksiHarian * 0.92, efisiensi: 92 },
    { bulan: 'Okt', target: sppg.produksiHarian, actual: sppg.produksiHarian * 0.98, efisiensi: 98 },
    { bulan: 'Nov', target: sppg.produksiHarian, actual: sppg.produksiHarian * 0.96, efisiensi: 96 },
    { bulan: 'Des', target: sppg.produksiHarian, actual: sppg.produksiHarian, efisiensi: 100 },
  ];

  const avgEfficiency = (productionHistory.reduce((sum, p) => sum + p.efisiensi, 0) / productionHistory.length).toFixed(1);

  return (
    <div className="space-y-6">
      {/* Production Summary */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-6">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg">
              <Target className="w-6 h-6 text-white" />
            </div>
            <div>
              <div className="text-xs font-semibold text-blue-700">Target Produksi</div>
              <div className="text-2xl font-black text-blue-900">{sppg.produksiHarian.toLocaleString()}</div>
            </div>
          </div>
          <div className="text-xs text-gray-700">porsi per hari</div>
        </div>

        <div className="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-6">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center shadow-lg">
              <TrendingUp className="w-6 h-6 text-white" />
            </div>
            <div>
              <div className="text-xs font-semibold text-green-700">Produksi Aktual</div>
              <div className="text-2xl font-black text-green-900">{sppg.produksiHarian.toLocaleString()}</div>
            </div>
          </div>
          <div className="text-xs text-gray-700">hari ini</div>
        </div>

        <div className="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-6">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg">
              <Activity className="w-6 h-6 text-white" />
            </div>
            <div>
              <div className="text-xs font-semibold text-purple-700">Efisiensi Rata-rata</div>
              <div className="text-2xl font-black text-purple-900">{avgEfficiency}%</div>
            </div>
          </div>
          <div className="text-xs text-gray-700">6 bulan terakhir</div>
        </div>
      </div>

      {/* Production Trend Chart */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h4 className="text-lg font-bold text-gray-900">Tren Produksi 6 Bulan</h4>
            <p className="text-xs text-gray-600 mt-1">Perbandingan target vs aktual produksi harian</p>
          </div>
          <div className="flex gap-3">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-blue-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">Target</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-green-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">Aktual</span>
            </div>
          </div>
        </div>
        <ProductionTrendChart data={productionHistory} />
      </div>

      {/* Efficiency Analysis */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-lg font-bold text-gray-900 mb-4">Analisis Efisiensi Produksi</h4>
        <div className="space-y-3">
          {productionHistory.map((item, idx) => (
            <div key={idx}>
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-semibold text-gray-700">{item.bulan} 2025</span>
                <div className="flex items-center gap-3">
                  <span className="text-xs text-gray-600">
                    {Math.round(item.actual).toLocaleString()} / {item.target.toLocaleString()}
                  </span>
                  <span className={`text-sm font-bold ${
                    item.efisiensi >= 95 ? 'text-green-600' : 
                    item.efisiensi >= 90 ? 'text-yellow-600' : 'text-red-600'
                  }`}>
                    {item.efisiensi}%
                  </span>
                </div>
              </div>
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className={`h-full ${
                    item.efisiensi >= 95 ? 'bg-green-500' : 
                    item.efisiensi >= 90 ? 'bg-yellow-500' : 'bg-red-500'
                  }`}
                  style={{ width: `${item.efisiensi}%` }}
                />
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Production Capacity by Meal Type */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-lg font-bold text-gray-900 mb-4">Distribusi Produksi per Menu</h4>
        <div className="space-y-4">
          <MenuProductionBar label="Nasi & Lauk" percentage={40} color="orange" value={Math.round(sppg.produksiHarian * 0.4)} />
          <MenuProductionBar label="Sayuran" percentage={30} color="green" value={Math.round(sppg.produksiHarian * 0.3)} />
          <MenuProductionBar label="Buah" percentage={20} color="purple" value={Math.round(sppg.produksiHarian * 0.2)} />
          <MenuProductionBar label="Susu/Minuman" percentage={10} color="blue" value={Math.round(sppg.produksiHarian * 0.1)} />
        </div>
      </div>

      {/* Production Notes */}
      <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-5 border border-blue-200">
        <div className="flex items-start gap-3">
          <AlertTriangle className="w-5 h-5 text-blue-700 mt-1" />
          <div>
            <h5 className="text-sm font-bold text-blue-900 mb-2">Catatan Produksi</h5>
            <ul className="space-y-1 text-xs text-gray-700">
              <li>• Produksi stabil dengan efisiensi rata-rata {avgEfficiency}%</li>
              <li>• Kapasitas surplus {sppg.surplus.toLocaleString()} porsi dapat digunakan untuk ekspansi</li>
              <li>• Monitoring kualitas dilakukan setiap batch produksi</li>
              <li>• Standar keamanan pangan terpenuhi (HACCP compliant)</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}

function ProductionTrendChart({ data }) {
  const maxValue = Math.max(...data.map(d => Math.max(d.target, d.actual)));

  return (
    <div className="h-64 flex items-end justify-between gap-4 pb-8">
      {data.map((item, idx) => {
        const targetHeight = (item.target / maxValue) * 100;
        const actualHeight = (item.actual / maxValue) * 100;
        
        return (
          <div key={idx} className="flex-1 flex flex-col items-center">
            <div className="w-full flex gap-1 items-end h-48">
              {/* Target Bar */}
              <div className="relative flex-1 flex flex-col justify-end">
                <div 
                  className="w-full bg-gradient-to-t from-blue-400 to-blue-500 rounded-t-lg hover:from-blue-500 hover:to-blue-600 transition-all"
                  style={{ height: `${targetHeight}%` }}
                >
                  <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-blue-700 whitespace-nowrap">
                    {Math.round(item.target).toLocaleString()}
                  </div>
                </div>
              </div>
              {/* Actual Bar */}
              <div className="relative flex-1 flex flex-col justify-end">
                <div 
                  className="w-full bg-gradient-to-t from-green-500 to-green-600 rounded-t-lg hover:from-green-600 hover:to-green-700 transition-all"
                  style={{ height: `${actualHeight}%` }}
                >
                  <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-green-700 whitespace-nowrap">
                    {Math.round(item.actual).toLocaleString()}
                  </div>
                </div>
              </div>
            </div>
            <div className="text-xs font-semibold text-gray-700 mt-2">{item.bulan}</div>
            <div className={`text-xs font-bold mt-1 ${
              item.efisiensi >= 95 ? 'text-green-600' : 
              item.efisiensi >= 90 ? 'text-yellow-600' : 'text-red-600'
            }`}>
              {item.efisiensi}%
            </div>
          </div>
        );
      })}
    </div>
  );
}

function MenuProductionBar({ label, percentage, color, value }) {
  const colors = {
    orange: 'bg-orange-500',
    green: 'bg-green-500',
    purple: 'bg-purple-500',
    blue: 'bg-blue-500'
  };

  return (
    <div>
      <div className="flex justify-between text-sm mb-2">
        <span className="font-semibold text-gray-700">{label}</span>
        <span className="font-bold text-gray-900">{value.toLocaleString()} porsi ({percentage}%)</span>
      </div>
      <div className="h-4 bg-gray-200 rounded-full overflow-hidden">
        <div className={`h-full ${colors[color]}`} style={{ width: `${percentage}%` }} />
      </div>
    </div>
  );
}

// ==============================================
// SPPG SEKOLAH TAB
// ==============================================
function SPPGSekolahTab({ sppg }) {
  // Sample school data served by this SPPG
  const sekolahDilayani = [
    { nama: 'SDN 1 Bandung', siswa: 245, jarak: 7.2, status: 'layak', jenjang: 'SD' },
    { nama: 'MIN 1 Bandung', siswa: 198, jarak: 12.4, status: 'waspada', jenjang: 'MI' },
    { nama: 'SDN 2 Cimahi', siswa: 223, jarak: 6.4, status: 'layak', jenjang: 'SD' },
    { nama: 'SDN 3 Lembang', siswa: 312, jarak: 8.8, status: 'layak', jenjang: 'SD' },
    { nama: 'MIN 2 Cimahi', siswa: 189, jarak: 9.5, status: 'layak', jenjang: 'MI' },
  ].slice(0, Math.min(sppg.sekolahDilayani, 10)); // Limit to actual number or 10

  const stats = {
    totalSiswa: sekolahDilayani.reduce((sum, s) => sum + s.siswa, 0),
    avgJarak: (sekolahDilayani.reduce((sum, s) => sum + s.jarak, 0) / sekolahDilayani.length).toFixed(1),
    layak: sekolahDilayani.filter(s => s.status === 'layak').length,
    waspada: sekolahDilayani.filter(s => s.status === 'waspada').length
  };

  return (
    <div className="space-y-6">
      {/* Service Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <StatBox label="Total Sekolah" value={sppg.sekolahDilayani} icon={Building2} color="blue" />
        <StatBox label="Total Siswa" value={sppg.totalSiswa.toLocaleString()} icon={Users} color="green" />
        <StatBox label="Jarak Rata-rata" value={`${stats.avgJarak} km`} icon={MapPin} color="purple" />
        <StatBox label="Status Layak" value={stats.layak} icon={Target} color="orange" />
      </div>

      {/* Distribution Map Preview */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-lg font-bold text-gray-900 mb-4">Sebaran Geografis Sekolah Dilayani</h4>
        <div className="bg-gradient-to-br from-blue-50 via-green-50 to-blue-50 rounded-xl h-64 flex items-center justify-center border-2 border-gray-200 relative overflow-hidden">
          <div className="absolute inset-0 opacity-10" style={{
            backgroundImage: 'linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px)',
            backgroundSize: '30px 30px'
          }}></div>
          
          {/* SPPG Center */}
          <div className="absolute" style={{ left: '50%', top: '50%', transform: 'translate(-50%, -50%)' }}>
            <div className="w-16 h-16 bg-gradient-to-br from-purple-600 to-purple-700 rounded-2xl flex items-center justify-center shadow-2xl">
              <Database className="w-8 h-8 text-white" />
            </div>
          </div>

          {/* Sample School Markers */}
          {[
            { x: '30%', y: '30%', color: 'bg-green-500' },
            { x: '70%', y: '25%', color: 'bg-green-500' },
            { x: '65%', y: '60%', color: 'bg-yellow-500' },
            { x: '40%', y: '70%', color: 'bg-green-500' },
            { x: '25%', y: '55%', color: 'bg-green-500' },
          ].map((marker, idx) => (
            <div key={idx} className="absolute" style={{ left: marker.x, top: marker.y, transform: 'translate(-50%, -50%)' }}>
              <div className={`w-4 h-4 ${marker.color} rounded-full border-2 border-white shadow-lg animate-pulse`} style={{ animationDelay: `${idx * 0.2}s` }}></div>
            </div>
          ))}

          {/* Service Radius */}
          <div className="absolute top-1/2 left-1/2 w-72 h-72 border-4 border-purple-300 border-dashed rounded-full opacity-30" style={{ transform: 'translate(-50%, -50%)' }}></div>
        </div>
        <div className="mt-4 text-center text-xs text-gray-600">
          Radius pelayanan maksimal: <span className="font-bold text-gray-900">15 km</span>
        </div>
      </div>

      {/* School List */}
      <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div className="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
          <h4 className="text-lg font-bold text-gray-900">Daftar Sekolah ({sekolahDilayani.length} dari {sppg.sekolahDilayani})</h4>
        </div>
        <div className="divide-y divide-gray-200">
          {sekolahDilayani.map((sekolah, idx) => (
            <div key={idx} className="p-4 hover:bg-gray-50 transition-colors">
              <div className="flex items-start justify-between">
                <div className="flex items-center gap-3 flex-1">
                  <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <Building2 className="w-5 h-5 text-blue-700" />
                  </div>
                  <div>
                    <div className="font-semibold text-gray-900">{sekolah.nama}</div>
                    <div className="flex items-center gap-3 text-xs text-gray-600 mt-1">
                      <span className="flex items-center gap-1">
                        <Users className="w-3 h-3" />
                        {sekolah.siswa} siswa
                      </span>
                      <span className="flex items-center gap-1">
                        <MapPin className="w-3 h-3" />
                        {sekolah.jarak} km
                      </span>
                      <span className={`px-2 py-0.5 rounded ${
                        sekolah.jenjang === 'SD' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'
                      } font-semibold`}>
                        {sekolah.jenjang}
                      </span>
                    </div>
                  </div>
                </div>
                <span className={`px-3 py-1 rounded-lg text-xs font-bold ${
                  sekolah.status === 'layak' ? 'bg-green-100 text-green-700' :
                  sekolah.status === 'waspada' ? 'bg-yellow-100 text-yellow-700' :
                  'bg-red-100 text-red-700'
                }`}>
                  {sekolah.status.toUpperCase()}
                </span>
              </div>
            </div>
          ))}
        </div>
        {sppg.sekolahDilayani > sekolahDilayani.length && (
          <div className="bg-gray-50 px-6 py-3 text-center text-xs text-gray-600">
            ... dan {sppg.sekolahDilayani - sekolahDilayani.length} sekolah lainnya
          </div>
        )}
      </div>

      {/* Service Quality Analysis */}
      <div className="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-5 border border-green-200">
        <div className="flex items-start gap-3">
          <Target className="w-5 h-5 text-green-700 mt-1" />
          <div>
            <h5 className="text-sm font-bold text-green-900 mb-2">Analisis Kualitas Pelayanan</h5>
            <div className="space-y-1 text-xs text-gray-700">
              <div>• <span className="font-bold">{stats.layak}</span> sekolah dalam status layak ({((stats.layak / sekolahDilayani.length) * 100).toFixed(1)}%)</div>
              <div>• Jarak rata-rata <span className="font-bold">{stats.avgJarak} km</span> masih dalam radius optimal</div>
              <div>• Estimasi waktu tempuh rata-rata: <span className="font-bold">{Math.round(parseFloat(stats.avgJarak) * 2.5)} menit</span></div>
              <div>• Kapasitas SPPG mencukupi untuk {sppg.totalSiswa.toLocaleString()} siswa</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function StatBox({ label, value, icon: Icon, color }) {
  const colors = {
    blue: 'from-blue-600 to-blue-700',
    green: 'from-green-600 to-green-700',
    purple: 'from-purple-600 to-purple-700',
    orange: 'from-orange-600 to-orange-700'
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-4">
      <div className={`w-10 h-10 bg-gradient-to-br ${colors[color]} rounded-lg flex items-center justify-center mb-3 shadow-md`}>
        <Icon className="w-5 h-5 text-white" />
      </div>
      <div className="text-2xl font-black text-gray-900 mb-1">{value}</div>
      <div className="text-xs font-semibold text-gray-600">{label}</div>
    </div>
  );
}

// ==============================================
// SPPG FASILITAS TAB
// ==============================================
function SPPGFasilitasTab({ sppg }) {
  const facilityCategories = [
    {
      title: 'Produksi',
      icon: TrendingUp,
      facilities: sppg.fasilitas.filter(f => 
        f.includes('Dapur') || f.includes('Packaging') || f.includes('Produksi')
      )
    },
    {
      title: 'Penyimpanan',
      icon: Database,
      facilities: sppg.fasilitas.filter(f => 
        f.includes('Storage') || f.includes('Gudang') || f.includes('Freezer')
      )
    },
    {
      title: 'Quality Control',
      icon: Shield,
      facilities: sppg.fasilitas.filter(f => 
        f.includes('Quality') || f.includes('Lab') || f.includes('Testing')
      )
    }
  ];

  return (
    <div className="space-y-6">
      {/* Facilities Overview */}
      <div className="bg-gradient-to-r from-purple-600 to-purple-700 rounded-xl p-6 text-white">
        <div className="flex items-center gap-4 mb-4">
          <div className="w-14 h-14 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
            <Layers className="w-7 h-7" />
          </div>
          <div>
            <div className="text-sm font-semibold text-purple-100">Total Fasilitas</div>
            <div className="text-3xl font-black">{sppg.fasilitas.length} Unit</div>
          </div>
        </div>
        <p className="text-sm text-purple-100">
          Fasilitas lengkap mendukung produksi {sppg.produksiHarian.toLocaleString()} porsi/hari dengan standar keamanan pangan
        </p>
      </div>

      {/* Facility Categories */}
      {facilityCategories.map((category, idx) => (
        category.facilities.length > 0 && (
          <div key={idx} className="bg-white rounded-xl border border-gray-200 p-6">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <category.icon className="w-5 h-5 text-purple-700" />
              </div>
              <h4 className="text-lg font-bold text-gray-900">{category.title}</h4>
              <span className="ml-auto px-3 py-1 bg-purple-50 text-purple-700 rounded-lg text-xs font-bold">
                {category.facilities.length} unit
              </span>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {category.facilities.map((facility, fidx) => (
                <div key={fidx} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                  <div className="w-2 h-2 bg-purple-600 rounded-full"></div>
                  <span className="text-sm font-semibold text-gray-900">{facility}</span>
                  <span className="ml-auto text-xs text-green-600 font-bold">✓ Aktif</span>
                </div>
              ))}
            </div>
          </div>
        )
      ))}

      {/* All Facilities List */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-lg font-bold text-gray-900 mb-4">Daftar Lengkap Fasilitas</h4>
        <div className="space-y-2">
          {sppg.fasilitas.map((facility, idx) => (
            <FacilityItem key={idx} name={facility} status="operational" />
          ))}
        </div>
      </div>

      {/* Certification & Compliance */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center gap-3 mb-4">
          <Shield className="w-6 h-6 text-green-600" />
          <h4 className="text-lg font-bold text-gray-900">Sertifikasi & Kepatuhan</h4>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          {sppg.sertifikat.map((cert, idx) => (
            <div key={idx} className="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-4 text-center">
              <div className="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center mx-auto mb-2 shadow-lg">
                <Award className="w-6 h-6 text-white" />
              </div>
              <div className="text-sm font-bold text-green-900">{cert}</div>
              <div className="text-xs text-gray-600 mt-1">Valid</div>
            </div>
          ))}
        </div>
      </div>

      {/* Facility Maintenance Schedule */}
      <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-xl p-5 border border-yellow-200">
        <div className="flex items-start gap-3">
          <Settings className="w-5 h-5 text-yellow-700 mt-1" />
          <div>
            <h5 className="text-sm font-bold text-yellow-900 mb-2">Jadwal Maintenance</h5>
            <div className="space-y-1 text-xs text-gray-700">
              <div>• Pembersihan menyeluruh: <span className="font-bold">Setiap hari</span></div>
              <div>• Kalibrasi peralatan: <span className="font-bold">Setiap minggu</span></div>
              <div>• Inspeksi fasilitas: <span className="font-bold">Setiap bulan</span></div>
              <div>• Audit keamanan pangan: <span className="font-bold">Setiap 3 bulan</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

const FacilityItem = ({ name, status }) => (
  <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
    <div className="flex items-center gap-3">
      <div className="w-2 h-2 bg-green-500 rounded-full"></div>
      <span className="text-sm font-semibold text-gray-900">{name}</span>
    </div>
    <span className="text-xs font-bold text-green-600">
      {status === 'operational' ? '✓ Operasional' : '🔧 Maintenance'}
    </span>
  </div>
);

// ==============================================
// SPPG KINERJA TAB
// ==============================================
function SPPGKinerjaTab({ sppg }) {
  // Performance metrics calculation
  const performanceMetrics = {
    productionScore: Math.min(100, (sppg.produksiHarian / sppg.kapasitas) * 120), // Bonus if high production
    efficiencyScore: sppg.utilisasi,
    serviceScore: Math.min(100, (sppg.sekolahDilayani / 30) * 100), // Assume 30 is max ideal
    qualityScore: 92, // Sample quality score
  };

  const overallScore = Math.round(
    (performanceMetrics.productionScore * 0.3 +
      performanceMetrics.efficiencyScore * 0.3 +
      performanceMetrics.serviceScore * 0.2 +
      performanceMetrics.qualityScore * 0.2)
  );

  const getScoreColor = (score) => {
    if (score >= 85) return { bg: 'from-green-600 to-green-700', text: 'text-green-700', light: 'bg-green-50' };
    if (score >= 70) return { bg: 'from-yellow-600 to-yellow-700', text: 'text-yellow-700', light: 'bg-yellow-50' };
    return { bg: 'from-red-600 to-red-700', text: 'text-red-700', light: 'bg-red-50' };
  };

  const scoreColor = getScoreColor(overallScore);

  // Monthly performance trend
  const monthlyPerformance = [
    { bulan: 'Jul', score: 82 },
    { bulan: 'Agu', score: 85 },
    { bulan: 'Sep', score: 79 },
    { bulan: 'Okt', score: 88 },
    { bulan: 'Nov', score: 86 },
    { bulan: 'Des', score: overallScore },
  ];

  return (
    <div className="space-y-6">
      {/* Overall Performance Score */}
      <div className={`bg-gradient-to-r ${scoreColor.bg} rounded-xl p-8 text-white text-center shadow-2xl`}>
        <div className="mb-3">
          <Award className="w-16 h-16 mx-auto mb-2 opacity-80" />
          <div className="text-sm font-semibold text-white text-opacity-90">Skor Kinerja Overall</div>
        </div>
        <div className="text-7xl font-black mb-2">{overallScore}</div>
        <div className="text-lg font-semibold">
          {overallScore >= 85 ? '⭐ EXCELLENT' : overallScore >= 70 ? '✓ GOOD' : '⚠ NEEDS IMPROVEMENT'}
        </div>
        <div className="mt-4 text-sm text-white text-opacity-80">
          Berdasarkan 4 indikator utama kinerja SPPG
        </div>
      </div>

      {/* Performance Breakdown */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <PerformanceCard
          title="Skor Produksi"
          score={Math.round(performanceMetrics.productionScore)}
          description="Pencapaian target produksi harian"
          icon={TrendingUp}
          color="blue"
        />
        <PerformanceCard
          title="Skor Efisiensi"
          score={Math.round(performanceMetrics.efficiencyScore)}
          description="Utilisasi kapasitas optimal"
          icon={Target}
          color="green"
        />
        <PerformanceCard
          title="Skor Pelayanan"
          score={Math.round(performanceMetrics.serviceScore)}
          description="Jangkauan sekolah dilayani"
          icon={Building2}
          color="purple"
        />
        <PerformanceCard
          title="Skor Kualitas"
          score={performanceMetrics.qualityScore}
          description="Standar keamanan pangan"
          icon={Shield}
          color="orange"
        />
      </div>

      {/* Performance Trend */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h4 className="text-lg font-bold text-gray-900">Tren Kinerja 6 Bulan</h4>
            <p className="text-xs text-gray-600 mt-1">Perkembangan skor kinerja overall SPPG</p>
          </div>
          <div className={`px-4 py-2 ${scoreColor.light} ${scoreColor.text} rounded-lg text-sm font-bold`}>
            {overallScore >= 85 ? '↑ Trending Up' : overallScore >= 70 ? '→ Stable' : '↓ Needs Focus'}
          </div>
        </div>
        <PerformanceTrendChart data={monthlyPerformance} />
      </div>

      {/* Key Performance Indicators */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-lg font-bold text-gray-900 mb-4">Key Performance Indicators (KPI)</h4>
        <div className="space-y-4">
          <KPIBar
            label="On-Time Delivery Rate"
            value={96}
            target={95}
            unit="%"
            color="green"
          />
          <KPIBar
            label="Food Safety Compliance"
            value={98}
            target={100}
            unit="%"
            color="blue"
          />
          <KPIBar
            label="Customer Satisfaction"
            value={88}
            target={90}
            unit="%"
            color="purple"
          />
          <KPIBar
            label="Waste Reduction"
            value={7}
            target={5}
            unit="%"
            color="orange"
            inverse
          />
        </div>
      </div>

      {/* Strengths & Areas for Improvement */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {/* Strengths */}
        <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-5 border border-green-200">
          <div className="flex items-center gap-2 mb-3">
            <div className="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center">
              <Award className="w-4 h-4 text-white" />
            </div>
            <h5 className="text-sm font-bold text-green-900">Kekuatan</h5>
          </div>
          <ul className="space-y-2 text-xs text-gray-700">
            <li className="flex items-start gap-2">
              <span className="text-green-600 font-bold">✓</span>
              <span>Utilisasi kapasitas tinggi ({sppg.utilisasi}%)</span>
            </li>
            <li className="flex items-start gap-2">
              <span className="text-green-600 font-bold">✓</span>
              <span>Sertifikasi lengkap ({sppg.sertifikat.join(', ')})</span>
            </li>
            <li className="flex items-start gap-2">
              <span className="text-green-600 font-bold">✓</span>
              <span>Jangkauan pelayanan luas ({sppg.sekolahDilayani} sekolah)</span>
            </li>
            <li className="flex items-start gap-2">
              <span className="text-green-600 font-bold">✓</span>
              <span>Tim produksi berpengalaman</span>
            </li>
          </ul>
        </div>

        {/* Areas for Improvement */}
        <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-5 border border-yellow-200">
          <div className="flex items-center gap-2 mb-3">
            <div className="w-8 h-8 bg-yellow-600 rounded-lg flex items-center justify-center">
              <AlertTriangle className="w-4 h-4 text-white" />
            </div>
            <h5 className="text-sm font-bold text-yellow-900">Area Pengembangan</h5>
          </div>
          <ul className="space-y-2 text-xs text-gray-700">
            <li className="flex items-start gap-2">
              <span className="text-yellow-600 font-bold">→</span>
              <span>Optimasi manajemen waste (target &lt;5%)</span>
            </li>
            <li className="flex items-start gap-2">
              <span className="text-yellow-600 font-bold">→</span>
              <span>Peningkatan customer satisfaction score</span>
            </li>
            <li className="flex items-start gap-2">
              <span className="text-yellow-600 font-bold">→</span>
              <span>Diversifikasi menu makanan sehat</span>
            </li>
            <li className="flex items-start gap-2">
              <span className="text-yellow-600 font-bold">→</span>
              <span>Implementasi tracking system real-time</span>
            </li>
          </ul>
        </div>
      </div>

      {/* Recommendations */}
      <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-5 border border-blue-200">
        <div className="flex items-start gap-3">
          <Target className="w-5 h-5 text-blue-700 mt-1" />
          <div>
            <h5 className="text-sm font-bold text-blue-900 mb-2">Rekomendasi Peningkatan Kinerja</h5>
            <ol className="space-y-1 text-xs text-gray-700">
              <li><span className="font-bold text-blue-700">1.</span> Maintain skor kinerja di atas 85 dengan monitoring rutin KPI</li>
              <li><span className="font-bold text-blue-700">2.</span> Fokus pada waste reduction melalui demand forecasting yang lebih akurat</li>
              <li><span className="font-bold text-blue-700">3.</span> Tingkatkan customer satisfaction dengan feedback mechanism yang lebih baik</li>
              <li><span className="font-bold text-blue-700">4.</span> Pertimbangkan ekspansi kapasitas jika utilisasi konsisten &gt;90%</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  );
}

function PerformanceCard({ title, score, description, icon: Icon, color }) {
  const colors = {
    blue: { bg: 'from-blue-600 to-blue-700', light: 'bg-blue-50', text: 'text-blue-700' },
    green: { bg: 'from-green-600 to-green-700', light: 'bg-green-50', text: 'text-green-700' },
    purple: { bg: 'from-purple-600 to-purple-700', light: 'bg-purple-50', text: 'text-purple-700' },
    orange: { bg: 'from-orange-600 to-orange-700', light: 'bg-orange-50', text: 'text-orange-700' }
  };

  const colorStyle = colors[color];

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-shadow">
      <div className="flex items-start justify-between mb-4">
        <div className={`w-12 h-12 bg-gradient-to-br ${colorStyle.bg} rounded-xl flex items-center justify-center shadow-lg`}>
          <Icon className="w-6 h-6 text-white" />
        </div>
        <div className={`text-3xl font-black ${colorStyle.text}`}>{score}</div>
      </div>
      <h5 className="text-sm font-bold text-gray-900 mb-1">{title}</h5>
      <p className="text-xs text-gray-600">{description}</p>
      <div className="mt-3 h-2 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className={`h-full bg-gradient-to-r ${colorStyle.bg}`}
          style={{ width: `${score}%` }}
        />
      </div>
    </div>
  );
}

function PerformanceTrendChart({ data }) {
  const maxScore = Math.max(...data.map(d => d.score));
  const minScore = Math.min(...data.map(d => d.score));

  return (
    <div className="h-48 flex items-end justify-between gap-3">
      {data.map((item, idx) => {
        const height = ((item.score - minScore + 10) / (maxScore - minScore + 20)) * 100;
        const prevScore = idx > 0 ? data[idx - 1].score : item.score;
        const trend = item.score > prevScore ? 'up' : item.score < prevScore ? 'down' : 'stable';

        return (
          <div key={idx} className="flex-1 flex flex-col items-center">
            <div className="text-xs font-bold text-gray-700 mb-1">{item.score}</div>
            <div className="w-full flex flex-col justify-end" style={{ height: '140px' }}>
              <div 
                className={`w-full rounded-t-lg transition-all ${
                  item.score >= 85 ? 'bg-gradient-to-t from-green-500 to-green-600' :
                  item.score >= 70 ? 'bg-gradient-to-t from-yellow-500 to-yellow-600' :
                  'bg-gradient-to-t from-red-500 to-red-600'
                }`}
                style={{ height: `${height}%` }}
              />
            </div>
            <div className="text-xs font-semibold text-gray-700 mt-2">{item.bulan}</div>
            <div className="text-xs mt-1">
              {trend === 'up' && <span className="text-green-600">↑</span>}
              {trend === 'down' && <span className="text-red-600">↓</span>}
              {trend === 'stable' && <span className="text-gray-400">→</span>}
            </div>
          </div>
        );
      })}
    </div>
  );
}

function KPIBar({ label, value, target, unit, color, inverse }) {
  const percentage = (value / target) * 100;
  const isOnTarget = inverse ? value <= target : value >= target;

  const colors = {
    green: 'bg-green-500',
    blue: 'bg-blue-500',
    purple: 'bg-purple-500',
    orange: 'bg-orange-500'
  };

  return (
    <div>
      <div className="flex justify-between text-sm mb-2">
        <span className="font-semibold text-gray-700">{label}</span>
        <div className="flex items-center gap-2">
          <span className="font-bold text-gray-900">{value}{unit}</span>
          <span className="text-xs text-gray-500">/ {target}{unit}</span>
          {isOnTarget ? (
            <span className="text-green-600 font-bold">✓</span>
          ) : (
            <span className="text-yellow-600 font-bold">⚠</span>
          )}
        </div>
      </div>
      <div className="h-3 bg-gray-200 rounded-full overflow-hidden relative">
        <div 
          className={`h-full ${colors[color]} transition-all duration-500`}
          style={{ width: `${Math.min(percentage, 100)}%` }}
        />
        {/* Target line */}
        <div 
          className="absolute top-0 bottom-0 w-0.5 bg-gray-700"
          style={{ left: '100%' }}
        />
      </div>
    </div>
  );
}

// ==============================================
// SPPG LOKASI TAB
// ==============================================
function SPPGLokasiTab({ sppg }) {
  return (
    <div className="space-y-6">
      {/* Location Map */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-lg font-bold text-gray-900 mb-4">Peta Lokasi SPPG</h4>
        <div className="bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 rounded-xl h-96 flex items-center justify-center border-2 border-gray-200 relative overflow-hidden">
          {/* Grid Background */}
          <div className="absolute inset-0 opacity-10" style={{
            backgroundImage: 'linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px)',
            backgroundSize: '40px 40px'
          }}></div>

          {/* SPPG Building Icon */}
          <div className="relative z-10">
            <div className="w-32 h-32 bg-gradient-to-br from-purple-600 to-purple-700 rounded-3xl flex items-center justify-center shadow-2xl mb-4 animate-pulse" style={{ animationDuration: '3s' }}>
              <Database className="w-16 h-16 text-white" />
            </div>
            <div className="bg-white rounded-xl shadow-lg px-6 py-3 text-center border border-gray-200">
              <div className="text-sm font-bold text-gray-900">{sppg.nama}</div>
              <div className="text-xs text-gray-600 mt-1">{sppg.kecamatan}</div>
            </div>
          </div>

          {/* Service Radius Circles */}
          <div className="absolute top-1/2 left-1/2 w-64 h-64 border-4 border-purple-300 rounded-full opacity-20" style={{ transform: 'translate(-50%, -50%)' }}></div>
          <div className="absolute top-1/2 left-1/2 w-96 h-96 border-4 border-purple-400 border-dashed rounded-full opacity-20" style={{ transform: 'translate(-50%, -50%)' }}></div>

          {/* Compass */}
          <div className="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-3 border border-gray-200">
            <div className="text-xs font-bold text-gray-700 text-center mb-1">N</div>
            <div className="w-8 h-8 border-2 border-gray-400 rounded-full relative">
              <div className="absolute top-0 left-1/2 w-0.5 h-3 bg-red-500 -translate-x-1/2"></div>
            </div>
          </div>

          {/* Scale Bar */}
          <div className="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg px-3 py-2 border border-gray-200">
            <div className="flex items-center gap-2">
              <div className="w-16 h-1 bg-gray-700"></div>
              <span className="text-xs font-semibold text-gray-700">5 km</span>
            </div>
          </div>
        </div>
      </div>

      {/* Geographic Coordinates */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-white rounded-xl border border-gray-200 p-6">
          <div className="flex items-center gap-3 mb-4">
            <div className="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
              <MapPin className="w-6 h-6 text-blue-700" />
            </div>
            <div>
              <div className="text-xs font-semibold text-gray-600">Koordinat GPS</div>
              <div className="text-lg font-bold text-gray-900">Lokasi Geografis</div>
            </div>
          </div>
          <div className="space-y-3">
            <CoordinateRow label="Latitude" value={sppg.lat} />
            <CoordinateRow label="Longitude" value={sppg.lng} />
            <div className="pt-3 border-t border-gray-200">
              <button className="w-full px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold transition-colors">
                📍 Buka di Google Maps
              </button>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl border border-gray-200 p-6">
          <div className="flex items-center gap-3 mb-4">
            <div className="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
              <Building2 className="w-6 h-6 text-purple-700" />
            </div>
            <div>
              <div className="text-xs font-semibold text-gray-600">Alamat Lengkap</div>
              <div className="text-lg font-bold text-gray-900">Informasi Kontak</div>
            </div>
          </div>
          <div className="space-y-3">
            <AddressRow label="Alamat" value={sppg.alamat} />
            <AddressRow label="Kecamatan" value={sppg.kecamatan} />
            <AddressRow label="Kota" value="Bandung" />
            <AddressRow label="Provinsi" value="Jawa Barat" />
          </div>
        </div>
      </div>

      {/* Accessibility Analysis */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-lg font-bold text-gray-900 mb-4">Analisis Aksesibilitas</h4>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <AccessibilityCard
            title="Jalan Utama"
            distance="200 m"
            status="Sangat Baik"
            icon={MapPin}
            color="green"
          />
          <AccessibilityCard
            title="Terminal/Stasiun"
            distance="3.5 km"
            status="Mudah Dijangkau"
            icon={TrendingUp}
            color="blue"
          />
          <AccessibilityCard
            title="Jangkauan Sekolah"
            distance="8.3 km avg"
            status="Optimal"
            icon={Target}
            color="purple"
          />
        </div>
      </div>

      {/* Nearby Facilities */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h4 className="text-lg font-bold text-gray-900 mb-4">Fasilitas Terdekat</h4>
        <div className="space-y-3">
          <NearbyFacility name="Pasar Tradisional" type="Supplier" distance={1.2} />
          <NearbyFacility name="Bank/ATM" type="Keuangan" distance={0.8} />
          <NearbyFacility name="Puskesmas" type="Kesehatan" distance={2.1} />
          <NearbyFacility name="Kantor Kecamatan" type="Pemerintahan" distance={1.5} />
          <NearbyFacility name="Pos Polisi" type="Keamanan" distance={1.8} />
        </div>
      </div>

      {/* Service Coverage Area */}
      <div className="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-5 border border-purple-200">
        <div className="flex items-start gap-3">
          <Layers className="w-5 h-5 text-purple-700 mt-1" />
          <div>
            <h5 className="text-sm font-bold text-purple-900 mb-2">Area Layanan</h5>
            <div className="space-y-1 text-xs text-gray-700">
              <div>• Radius layanan maksimal: <span className="font-bold">15 km</span></div>
              <div>• Cakupan wilayah: <span className="font-bold">Kec. {sppg.kecamatan} dan sekitarnya</span></div>
              <div>• Total sekolah terjangkau: <span className="font-bold">{sppg.sekolahDilayani} sekolah</span></div>
              <div>• Estimasi waktu distribusi terjauh: <span className="font-bold">45 menit</span></div>
            </div>
          </div>
        </div>
      </div>

      {/* Location Advantages */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-5 border border-green-200">
          <div className="flex items-center gap-2 mb-3">
            <Award className="w-5 h-5 text-green-700" />
            <h5 className="text-sm font-bold text-green-900">Keunggulan Lokasi</h5>
          </div>
          <ul className="space-y-1 text-xs text-gray-700">
            <li>✓ Dekat dengan jalan utama transportasi</li>
            <li>✓ Mudah diakses dari berbagai arah</li>
            <li>✓ Dekat dengan sumber bahan baku (pasar)</li>
            <li>✓ Infrastruktur pendukung lengkap</li>
          </ul>
        </div>

        <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-5 border border-blue-200">
          <div className="flex items-center gap-2 mb-3">
            <Shield className="w-5 h-5 text-blue-700" />
            <h5 className="text-sm font-bold text-blue-900">Keamanan & Lingkungan</h5>
          </div>
          <ul className="space-y-1 text-xs text-gray-700">
            <li>✓ Area aman dan terpantau 24/7</li>
            <li>✓ Lingkungan bersih dan higienis</li>
            <li>✓ Dekat dengan fasilitas kesehatan</li>
            <li>✓ Akses emergency response cepat</li>
          </ul>
        </div>
      </div>
    </div>
  );
}

function CoordinateRow({ label, value }) {
  return (
    <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
      <span className="text-sm font-semibold text-gray-700">{label}</span>
      <span className="text-sm font-mono font-bold text-gray-900">{value}</span>
    </div>
  );
}

function AddressRow({ label, value }) {
  return (
    <div className="flex items-start justify-between gap-4">
      <span className="text-xs font-semibold text-gray-600 min-w-20">{label}</span>
      <span className="text-sm font-semibold text-gray-900 text-right">{value}</span>
    </div>
  );
}

function AccessibilityCard({ title, distance, status, icon: Icon, color }) {
  const colors = {
    green: { bg: 'from-green-600 to-green-700', light: 'bg-green-50', text: 'text-green-700' },
    blue: { bg: 'from-blue-600 to-blue-700', light: 'bg-blue-50', text: 'text-blue-700' },
    purple: { bg: 'from-purple-600 to-purple-700', light: 'bg-purple-50', text: 'text-purple-700' }
  };

  const colorStyle = colors[color];

  return (
    <div className={`${colorStyle.light} rounded-xl p-4 border border-${color}-200`}>
      <div className={`w-10 h-10 bg-gradient-to-br ${colorStyle.bg} rounded-lg flex items-center justify-center mb-3 shadow-md`}>
        <Icon className="w-5 h-5 text-white" />
      </div>
      <div className="text-sm font-bold text-gray-900 mb-1">{title}</div>
      <div className="text-xl font-black text-gray-900 mb-1">{distance}</div>
      <div className={`text-xs font-semibold ${colorStyle.text}`}>{status}</div>
    </div>
  );
}

function NearbyFacility({ name, type, distance }) 
{
  
  return (
    <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
      <div className="flex items-center gap-3">
        <div className="w-2 h-2 bg-purple-600 rounded-full"></div>
        <div>
          <div className="text-sm font-semibold text-gray-900">{name}</div>
          <div className="text-xs text-gray-600">{type}</div>
        </div>
      </div>
      <div className="text-sm font-bold text-purple-700">{distance} km</div>
    </div>
  );
}
// ==============================================
// ANALISIS KEBUTUHAN GIZI PAGE - SINTA 1 LEVEL
// ==============================================
function AnalisisGiziPage() {
  const [selectedKecamatan, setSelectedKecamatan] = useState('all');
  const [selectedJenjang, setSelectedJenjang] = useState('all');
  const [viewMode, setViewMode] = useState('overview'); // overview, detail, heatmap

  // Comprehensive nutritional requirements data
  const kebutuhanGiziData = {
    perSiswa: {
      energi: 700, // kcal
      protein: 20, // gram
      lemak: 20, // gram
      karbohidrat: 100, // gram
      serat: 10, // gram
      vitaminA: 300, // mcg
      vitaminC: 45, // mg
      kalsium: 400, // mg
      zatBesi: 5, // mg
    },
    distribusiMenu: {
      nasiLauk: 0.40,
      sayuran: 0.30,
      buah: 0.20,
      susu: 0.10,
    }
  };

  // Data kebutuhan per kecamatan
  const kebutuhanPerWilayah = [
    { 
      kecamatan: 'Bandung', 
      sekolah: 45, 
      siswa: 10245, 
      kebutuhanHarian: 10245 * 0.38, // kg
      energiTotal: 10245 * 700,
      proteinTotal: 10245 * 20,
      status: 'terpenuhi'
    },
    { 
      kecamatan: 'Cimahi', 
      sekolah: 38, 
      siswa: 8672, 
      kebutuhanHarian: 8672 * 0.38,
      energiTotal: 8672 * 700,
      proteinTotal: 8672 * 20,
      status: 'terpenuhi'
    },
    { 
      kecamatan: 'Lembang', 
      sekolah: 52, 
      siswa: 11834, 
      kebutuhanHarian: 11834 * 0.38,
      energiTotal: 11834 * 700,
      proteinTotal: 11834 * 20,
      status: 'waspada'
    },
    { 
      kecamatan: 'Cibeunying', 
      sekolah: 41, 
      siswa: 9323, 
      kebutuhanHarian: 9323 * 0.38,
      energiTotal: 9323 * 700,
      proteinTotal: 9323 * 20,
      status: 'terpenuhi'
    },
    { 
      kecamatan: 'Soreang', 
      sekolah: 35, 
      siswa: 7817, 
      kebutuhanHarian: 7817 * 0.38,
      energiTotal: 7817 * 700,
      proteinTotal: 7817 * 20,
      status: 'terpenuhi'
    }
  ];

  // Filtering
  const filteredData = kebutuhanPerWilayah.filter(w => 
    selectedKecamatan === 'all' || w.kecamatan === selectedKecamatan
  );

  // Statistics
  const stats = {
    totalSiswa: filteredData.reduce((sum, w) => sum + w.siswa, 0),
    totalKebutuhan: filteredData.reduce((sum, w) => sum + w.kebutuhanHarian, 0),
    totalEnergi: filteredData.reduce((sum, w) => sum + w.energiTotal, 0),
    totalProtein: filteredData.reduce((sum, w) => sum + w.proteinTotal, 0),
  };

  return (
    <div className="p-6 space-y-6">
      {/* Page Header */}
      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Analisis Kebutuhan Gizi MBG</h2>
          <p className="text-sm text-gray-600 mt-1">
            Perhitungan kebutuhan nutrisi harian siswa berdasarkan standar nasional
          </p>
        </div>
        <div className="flex gap-2">
          <select 
            value={selectedKecamatan}
            onChange={(e) => setSelectedKecamatan(e.target.value)}
            className="px-4 py-2 border border-gray-300 rounded-xl text-sm font-medium focus:ring-2 focus:ring-green-500"
          >
            <option value="all">Semua Kecamatan</option>
            {kebutuhanPerWilayah.map(w => (
              <option key={w.kecamatan} value={w.kecamatan}>{w.kecamatan}</option>
            ))}
          </select>
          <button className="px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all">
            Export Analisis
          </button>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <NutritionStatCard
          label="Total Siswa"
          value={stats.totalSiswa.toLocaleString()}
          icon={Users}
          color="blue"
          unit="siswa"
        />
        <NutritionStatCard
          label="Kebutuhan Harian"
          value={stats.totalKebutuhan.toFixed(0).toLocaleString()}
          icon={TrendingUp}
          color="green"
          unit="kg"
        />
        <NutritionStatCard
          label="Total Energi"
          value={(stats.totalEnergi / 1000000).toFixed(2)}
          icon={Activity}
          color="orange"
          unit="M kcal"
        />
        <NutritionStatCard
          label="Total Protein"
          value={(stats.totalProtein / 1000).toFixed(1)}
          icon={Target}
          color="purple"
          unit="ton"
        />
      </div>

      {/* View Mode Tabs */}
      <div className="bg-white rounded-xl border border-gray-200 p-4">
        <div className="flex gap-2">
          <ViewModeButton 
            label="Overview" 
            value="overview" 
            active={viewMode} 
            onClick={setViewMode}
            icon={BarChart3}
          />
          <ViewModeButton 
            label="Detail Nutrisi" 
            value="detail" 
            active={viewMode} 
            onClick={setViewMode}
            icon={Target}
          />
          <ViewModeButton 
            label="Heatmap Wilayah" 
            value="heatmap" 
            active={viewMode} 
            onClick={setViewMode}
            icon={Map}
          />
        </div>
      </div>

      {/* Content based on view mode */}
      {viewMode === 'overview' && (
        <OverviewNutritionView 
          data={filteredData} 
          kebutuhanGizi={kebutuhanGiziData}
          stats={stats}
        />
      )}
      {viewMode === 'detail' && (
        <DetailNutritionView 
          data={filteredData}
          kebutuhanGizi={kebutuhanGiziData}
        />
      )}
      {viewMode === 'heatmap' && (
        <HeatmapNutritionView 
          data={kebutuhanPerWilayah}
        />
      )}

      {/* Output Info Panel */}
      <div className="bg-gradient-to-r from-green-600 to-green-700 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-start gap-4">
          <Award className="w-6 h-6 flex-shrink-0 mt-1" />
          <div>
            <h3 className="font-bold text-lg mb-2">Output Modul Analisis Kebutuhan Gizi</h3>
            <p className="text-green-100 text-sm leading-relaxed mb-3">
              Modul ini menghasilkan: (1) Kalkulasi kebutuhan nutrisi harian berdasarkan standar nasional per siswa,
              (2) Distribusi kebutuhan makronutrien (karbohidrat, protein, lemak) dan mikronutrien (vitamin, mineral),
              (3) Analisis gap kebutuhan vs kapasitas produksi SPPG, (4) Heatmap spasial kebutuhan per wilayah,
              (5) Rekomendasi menu seimbang untuk optimalisasi gizi.
            </p>
            <div className="flex flex-wrap gap-2">
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Nutritional Calculation</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Macronutrient Analysis</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Spatial Distribution</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Gap Analysis</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Helper Components for Analisis Gizi
function NutritionStatCard({ label, value, icon: Icon, color, unit }) {
  const colors = {
    blue: 'from-blue-600 to-blue-700',
    green: 'from-green-600 to-green-700',
    orange: 'from-orange-600 to-orange-700',
    purple: 'from-purple-600 to-purple-700'
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
      <div className={`w-12 h-12 bg-gradient-to-br ${colors[color]} rounded-xl flex items-center justify-center mb-4 shadow-lg`}>
        <Icon className="w-6 h-6 text-white" />
      </div>
      <div className="text-3xl font-black text-gray-900 mb-1">{value}</div>
      <div className="text-sm font-semibold text-gray-700 mb-1">{label}</div>
      <div className="text-xs text-gray-500">{unit}</div>
    </div>
  );
}

function ViewModeButton({ label, value, active, onClick, icon: Icon }) {
  return (
    <button
      onClick={() => onClick(value)}
      className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
        active === value
          ? 'bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg'
          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
      }`}
    >
      <Icon className="w-4 h-4" />
      {label}
    </button>
  );
}

// ==============================================
// OVERVIEW NUTRITION VIEW
// ==============================================
function OverviewNutritionView({ data, kebutuhanGizi, stats }) {
  return (
    <div className="space-y-6">
      {/* Nutritional Requirements per Student */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h3 className="text-lg font-bold text-gray-900">Kebutuhan Gizi per Siswa</h3>
            <p className="text-xs text-gray-600 mt-1">Berdasarkan standar nasional Angka Kecukupan Gizi (AKG)</p>
          </div>
          <div className="flex items-center gap-2 px-3 py-1 bg-green-50 text-green-700 rounded-lg text-xs font-bold">
            <Shield className="w-4 h-4" />
            Standar Nasional
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <NutrientCard label="Energi" value={kebutuhanGizi.perSiswa.energi} unit="kcal" color="orange" />
          <NutrientCard label="Protein" value={kebutuhanGizi.perSiswa.protein} unit="gram" color="red" />
          <NutrientCard label="Lemak" value={kebutuhanGizi.perSiswa.lemak} unit="gram" color="yellow" />
          <NutrientCard label="Karbohidrat" value={kebutuhanGizi.perSiswa.karbohidrat} unit="gram" color="blue" />
          <NutrientCard label="Serat" value={kebutuhanGizi.perSiswa.serat} unit="gram" color="green" />
        </div>

        <div className="mt-6 p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-lg border border-green-200">
          <div className="flex items-start gap-3">
            <Target className="w-5 h-5 text-green-700 mt-0.5" />
            <div className="flex-1">
              <h4 className="text-sm font-bold text-green-900 mb-2">Standar Referensi</h4>
              <p className="text-xs text-gray-700 leading-relaxed">
                Kebutuhan gizi disesuaikan dengan Peraturan Menteri Kesehatan RI tentang Angka Kecukupan Gizi (AKG) 
                untuk anak usia sekolah dasar (6-12 tahun). Nilai di atas adalah kebutuhan minimal per siswa per hari.
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Total Requirements by Region */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Kebutuhan Total per Wilayah</h3>
          <p className="text-xs text-gray-600 mt-1">Agregasi kebutuhan harian seluruh siswa MBG</p>
        </div>

        <div className="space-y-4">
          {data.map((wilayah, idx) => (
            <RegionalRequirementBar key={idx} wilayah={wilayah} />
          ))}
        </div>

        <div className="mt-6 grid grid-cols-3 gap-4">
          <div className="bg-gray-50 rounded-lg p-4 text-center">
            <div className="text-xs text-gray-600 mb-1">Total Siswa</div>
            <div className="text-2xl font-black text-gray-900">{stats.totalSiswa.toLocaleString()}</div>
          </div>
          <div className="bg-gray-50 rounded-lg p-4 text-center">
            <div className="text-xs text-gray-600 mb-1">Kebutuhan/Hari</div>
            <div className="text-2xl font-black text-gray-900">{stats.totalKebutuhan.toFixed(0).toLocaleString()} kg</div>
          </div>
          <div className="bg-gray-50 rounded-lg p-4 text-center">
            <div className="text-xs text-gray-600 mb-1">Energi Total</div>
            <div className="text-2xl font-black text-gray-900">{(stats.totalEnergi / 1000000).toFixed(1)}M kcal</div>
          </div>
        </div>
      </div>

      {/* Menu Distribution */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Distribusi Kebutuhan Menu</h3>
          <p className="text-xs text-gray-600 mt-1">Proporsi komponen makanan bergizi seimbang</p>
        </div>

        <div className="space-y-4">
          <MenuDistributionBar 
            label="Nasi & Lauk Pauk" 
            percentage={40} 
            value={stats.totalKebutuhan * 0.40}
            color="orange"
            nutrients="Sumber energi & protein utama"
          />
          <MenuDistributionBar 
            label="Sayuran" 
            percentage={30} 
            value={stats.totalKebutuhan * 0.30}
            color="green"
            nutrients="Sumber serat, vitamin & mineral"
          />
          <MenuDistributionBar 
            label="Buah-buahan" 
            percentage={20} 
            value={stats.totalKebutuhan * 0.20}
            color="purple"
            nutrients="Sumber vitamin C & antioksidan"
          />
          <MenuDistributionBar 
            label="Susu/Minuman" 
            percentage={10} 
            value={stats.totalKebutuhan * 0.10}
            color="blue"
            nutrients="Sumber kalsium & protein"
          />
        </div>

        <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div className="flex items-start gap-2">
            <BookOpen className="w-4 h-4 text-blue-700 mt-0.5" />
            <div>
              <h5 className="text-xs font-bold text-blue-900 mb-1">Catatan Gizi</h5>
              <p className="text-xs text-gray-700">
                Distribusi menu mengikuti pedoman Gizi Seimbang dengan prinsip "Isi Piringku" 
                dari Kementerian Kesehatan RI, memastikan kebutuhan makronutrien dan mikronutrien terpenuhi.
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Capacity vs Requirement */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Gap Analysis: Kapasitas vs Kebutuhan</h3>
          <p className="text-xs text-gray-600 mt-1">Perbandingan kapasitas produksi SPPG dengan kebutuhan aktual</p>
        </div>

        <CapacityGapChart totalKebutuhan={stats.totalKebutuhan} />

        <div className="mt-6 grid grid-cols-2 gap-4">
          <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
            <div className="flex items-center gap-2 mb-2">
              <div className="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center">
                <Target className="w-4 h-4 text-white" />
              </div>
              <div className="text-xs font-semibold text-green-700">Status Pemenuhan</div>
            </div>
            <div className="text-2xl font-black text-green-900 mb-1">127.3%</div>
            <div className="text-xs text-gray-700">Kapasitas SPPG melebihi kebutuhan</div>
          </div>

          <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
            <div className="flex items-center gap-2 mb-2">
              <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                <TrendingUp className="w-4 h-4 text-white" />
              </div>
              <div className="text-xs font-semibold text-blue-700">Surplus Kapasitas</div>
            </div>
            <div className="text-2xl font-black text-blue-900 mb-1">4,892 kg</div>
            <div className="text-xs text-gray-700">Per hari untuk ekspansi</div>
          </div>
        </div>
      </div>
    </div>
  );
}

function NutrientCard({ label, value, unit, color }) {
  const colors = {
    orange: 'bg-orange-100 text-orange-700 border-orange-200',
    red: 'bg-red-100 text-red-700 border-red-200',
    yellow: 'bg-yellow-100 text-yellow-700 border-yellow-200',
    blue: 'bg-blue-100 text-blue-700 border-blue-200',
    green: 'bg-green-100 text-green-700 border-green-200'
  };

  return (
    <div className={`${colors[color]} rounded-lg p-4 border`}>
      <div className="text-xs font-semibold mb-2">{label}</div>
      <div className="text-2xl font-black mb-1">{value}</div>
      <div className="text-xs opacity-75">{unit}</div>
    </div>
  );
}

function RegionalRequirementBar({ wilayah }) {
  const maxSiswa = 12000;
  const percentage = (wilayah.siswa / maxSiswa) * 100;

  const statusConfig = {
    terpenuhi: { bg: 'bg-green-500', badge: 'bg-green-100 text-green-700' },
    waspada: { bg: 'bg-yellow-500', badge: 'bg-yellow-100 text-yellow-700' },
    defisit: { bg: 'bg-red-500', badge: 'bg-red-100 text-red-700' }
  };

  const status = statusConfig[wilayah.status];

  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-3">
          <span className="text-sm font-semibold text-gray-900">{wilayah.kecamatan}</span>
          <span className={`px-2 py-0.5 ${status.badge} rounded text-xs font-bold`}>
            {wilayah.status.toUpperCase()}
          </span>
        </div>
        <div className="text-right">
          <div className="text-sm font-bold text-gray-900">{wilayah.siswa.toLocaleString()} siswa</div>
          <div className="text-xs text-gray-600">{wilayah.kebutuhanHarian.toFixed(0)} kg/hari</div>
        </div>
      </div>
      <div className="h-4 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className={`h-full ${status.bg}`}
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
}

function MenuDistributionBar({ label, percentage, value, color, nutrients }) {
  const colors = {
    orange: 'bg-orange-500',
    green: 'bg-green-500',
    purple: 'bg-purple-500',
    blue: 'bg-blue-500'
  };

  return (
    <div>
      <div className="flex items-start justify-between mb-2">
        <div>
          <div className="text-sm font-semibold text-gray-900">{label}</div>
          <div className="text-xs text-gray-600 mt-0.5">{nutrients}</div>
        </div>
        <div className="text-right">
          <div className="text-sm font-bold text-gray-900">{percentage}%</div>
          <div className="text-xs text-gray-600">{value.toFixed(0)} kg</div>
        </div>
      </div>
      <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className={`h-full ${colors[color]}`}
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
}

function CapacityGapChart({ totalKebutuhan }) {
  const totalKapasitas = 18000; // Sample total SPPG capacity
  const kapasitasPercentage = (totalKapasitas / (totalKapasitas + totalKebutuhan)) * 100;
  const kebutuhanPercentage = (totalKebutuhan / (totalKapasitas + totalKebutuhan)) * 100;

  return (
    <div>
      <div className="flex h-16 rounded-xl overflow-hidden border-2 border-gray-200 mb-4">
        <div 
          className="bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center text-white font-bold"
          style={{ width: `${kapasitasPercentage}%` }}
        >
          <span className="text-sm">Kapasitas {totalKapasitas.toLocaleString()} kg</span>
        </div>
        <div 
          className="bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold"
          style={{ width: `${kebutuhanPercentage}%` }}
        >
          <span className="text-sm">Kebutuhan {totalKebutuhan.toFixed(0).toLocaleString()} kg</span>
        </div>
      </div>

      <div className="flex justify-between text-xs text-gray-600">
        <span>Surplus: <span className="font-bold text-green-700">{(totalKapasitas - totalKebutuhan).toFixed(0).toLocaleString()} kg</span></span>
        <span>Utilisasi: <span className="font-bold text-blue-700">{((totalKebutuhan / totalKapasitas) * 100).toFixed(1)}%</span></span>
      </div>
    </div>
  );
} 

// ==============================================
// DETAIL NUTRITION VIEW
// ==============================================
function DetailNutritionView({ data, kebutuhanGizi }) {
  return (
    <div className="space-y-6">
      {/* Micronutrient Requirements */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Kebutuhan Mikronutrien per Siswa</h3>
          <p className="text-xs text-gray-600 mt-1">Vitamin dan mineral esensial untuk pertumbuhan optimal</p>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <MicronutrientCard
            label="Vitamin A"
            value={kebutuhanGizi.perSiswa.vitaminA}
            unit="mcg"
            icon="🥕"
            benefit="Kesehatan mata & imun"
            color="orange"
          />
          <MicronutrientCard
            label="Vitamin C"
            value={kebutuhanGizi.perSiswa.vitaminC}
            unit="mg"
            icon="🍊"
            benefit="Antioksidan & imunitas"
            color="yellow"
          />
          <MicronutrientCard
            label="Kalsium"
            value={kebutuhanGizi.perSiswa.kalsium}
            unit="mg"
            icon="🥛"
            benefit="Pertumbuhan tulang"
            color="blue"
          />
          <MicronutrientCard
            label="Zat Besi"
            value={kebutuhanGizi.perSiswa.zatBesi}
            unit="mg"
            icon="🥩"
            benefit="Mencegah anemia"
            color="red"
          />
        </div>

        <div className="mt-6 p-4 bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg border border-orange-200">
          <div className="flex items-start gap-3">
            <Shield className="w-5 h-5 text-orange-700 mt-0.5" />
            <div>
              <h5 className="text-sm font-bold text-orange-900 mb-2">Pentingnya Mikronutrien</h5>
              <p className="text-xs text-gray-700 leading-relaxed">
                Mikronutrien (vitamin & mineral) sangat penting untuk mendukung pertumbuhan fisik, 
                perkembangan kognitif, dan sistem kekebalan tubuh anak usia sekolah. Defisiensi mikronutrien 
                dapat menyebabkan stunting, anemia, dan gangguan belajar.
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Detailed Requirements by Region */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Detail Kebutuhan per Wilayah</h3>
          <p className="text-xs text-gray-600 mt-1">Breakdown kebutuhan makronutrien & mikronutrien</p>
        </div>

        <div className="space-y-6">
          {data.map((wilayah, idx) => (
            <DetailedRegionCard key={idx} wilayah={wilayah} kebutuhanGizi={kebutuhanGizi} />
          ))}
        </div>
      </div>

      {/* Nutritional Balance Analysis */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Analisis Keseimbangan Gizi</h3>
          <p className="text-xs text-gray-600 mt-1">Proporsi makronutrien sesuai pedoman gizi seimbang</p>
        </div>

        <NutritionalBalancePieChart />

        <div className="mt-6 grid grid-cols-3 gap-4">
          <div className="text-center p-4 bg-orange-50 rounded-lg border border-orange-200">
            <div className="text-sm font-semibold text-orange-700 mb-1">Karbohidrat</div>
            <div className="text-2xl font-black text-orange-900">55-65%</div>
            <div className="text-xs text-gray-600 mt-1">dari total energi</div>
          </div>
          <div className="text-center p-4 bg-red-50 rounded-lg border border-red-200">
            <div className="text-sm font-semibold text-red-700 mb-1">Protein</div>
            <div className="text-2xl font-black text-red-900">10-15%</div>
            <div className="text-xs text-gray-600 mt-1">dari total energi</div>
          </div>
          <div className="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
            <div className="text-sm font-semibold text-yellow-700 mb-1">Lemak</div>
            <div className="text-2xl font-black text-yellow-900">25-30%</div>
            <div className="text-xs text-gray-600 mt-1">dari total energi</div>
          </div>
        </div>
      </div>

      {/* Food Sources Recommendations */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Rekomendasi Sumber Pangan</h3>
          <p className="text-xs text-gray-600 mt-1">Bahan makanan untuk memenuhi kebutuhan gizi</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <FoodSourceCard
            category="Sumber Karbohidrat"
            foods={['Nasi', 'Roti gandum', 'Kentang', 'Ubi', 'Jagung']}
            color="orange"
            icon="🍚"
          />
          <FoodSourceCard
            category="Sumber Protein"
            foods={['Ayam', 'Ikan', 'Telur', 'Tempe', 'Tahu']}
            color="red"
            icon="🍗"
          />
          <FoodSourceCard
            category="Sumber Vitamin & Mineral"
            foods={['Sayur hijau', 'Wortel', 'Tomat', 'Brokoli', 'Bayam']}
            color="green"
            icon="🥬"
          />
          <FoodSourceCard
            category="Sumber Kalsium"
            foods={['Susu', 'Keju', 'Yogurt', 'Ikan teri', 'Kacang kedelai']}
            color="blue"
            icon="🥛"
          />
        </div>
      </div>
    </div>
  );
}

// Helper Components for Detail View
function MicronutrientCard({ label, value, unit, icon, benefit, color }) {
  const colors = {
    orange: 'from-orange-50 to-orange-100 border-orange-200',
    yellow: 'from-yellow-50 to-yellow-100 border-yellow-200',
    blue: 'from-blue-50 to-blue-100 border-blue-200',
    red: 'from-red-50 to-red-100 border-red-200'
  };

  return (
    <div className={`bg-gradient-to-br ${colors[color]} rounded-xl p-4 border`}>
      <div className="text-3xl mb-2">{icon}</div>
      <div className="text-sm font-bold text-gray-900 mb-1">{label}</div>
      <div className="text-2xl font-black text-gray-900 mb-1">
        {value} <span className="text-sm font-normal">{unit}</span>
      </div>
      <div className="text-xs text-gray-600 mt-2">{benefit}</div>
    </div>
  );
}

function DetailedRegionCard({ wilayah, kebutuhanGizi }) {
  const totalEnergi = wilayah.siswa * kebutuhanGizi.perSiswa.energi;
  const totalProtein = wilayah.siswa * kebutuhanGizi.perSiswa.protein;
  const totalLemak = wilayah.siswa * kebutuhanGizi.perSiswa.lemak;
  const totalKarbo = wilayah.siswa * kebutuhanGizi.perSiswa.karbohidrat;

  return (
    <div className="border border-gray-200 rounded-xl p-5 hover:shadow-md transition-shadow">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h4 className="text-lg font-bold text-gray-900">{wilayah.kecamatan}</h4>
          <p className="text-sm text-gray-600">{wilayah.siswa.toLocaleString()} siswa dari {wilayah.sekolah} sekolah</p>
        </div>
        <div className="text-right">
          <div className="text-sm font-semibold text-gray-700">Total Kebutuhan</div>
          <div className="text-2xl font-black text-gray-900">{wilayah.kebutuhanHarian.toFixed(0)} kg</div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
        <NutrientDetailBox label="Energi" value={totalEnergi} unit="kcal" color="orange" />
        <NutrientDetailBox label="Protein" value={totalProtein} unit="g" color="red" />
        <NutrientDetailBox label="Lemak" value={totalLemak} unit="g" color="yellow" />
        <NutrientDetailBox label="Karbohidrat" value={totalKarbo} unit="g" color="blue" />
      </div>
    </div>
  );
}

function NutrientDetailBox({ label, value, unit, color }) {
  const colors = {
    orange: 'bg-orange-50 text-orange-700',
    red: 'bg-red-50 text-red-700',
    yellow: 'bg-yellow-50 text-yellow-700',
    blue: 'bg-blue-50 text-blue-700'
  };

  return (
    <div className={`${colors[color]} rounded-lg p-3`}>
      <div className="text-xs font-semibold mb-1">{label}</div>
      <div className="text-lg font-black">
        {value >= 1000 ? (value / 1000).toFixed(1) + 'k' : value.toLocaleString()}
      </div>
      <div className="text-xs opacity-75">{unit}</div>
    </div>
  );
}

function NutritionalBalancePieChart() {
  return (
    <div className="flex items-center justify-center">
      <div className="relative w-64 h-64">
        <svg viewBox="0 0 100 100" className="transform -rotate-90">
          {/* Karbohidrat 60% */}
          <circle
            cx="50"
            cy="50"
            r="40"
            fill="none"
            stroke="#f97316"
            strokeWidth="20"
            strokeDasharray="150.8 251.3"
            strokeDashoffset="0"
          />
          {/* Protein 15% */}
          <circle
            cx="50"
            cy="50"
            r="40"
            fill="none"
            stroke="#ef4444"
            strokeWidth="20"
            strokeDasharray="37.7 251.3"
            strokeDashoffset="-150.8"
          />
          {/* Lemak 25% */}
          <circle
            cx="50"
            cy="50"
            r="40"
            fill="none"
            stroke="#eab308"
            strokeWidth="20"
            strokeDasharray="62.8 251.3"
            strokeDashoffset="-188.5"
          />
        </svg>
        <div className="absolute inset-0 flex items-center justify-center">
          <div className="text-center">
            <div className="text-sm font-semibold text-gray-700">Gizi</div>
            <div className="text-lg font-black text-gray-900">Seimbang</div>
          </div>
        </div>
      </div>
      <div className="ml-8 space-y-2">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 bg-orange-500 rounded"></div>
          <span className="text-sm text-gray-700">Karbohidrat (60%)</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 bg-yellow-500 rounded"></div>
          <span className="text-sm text-gray-700">Lemak (25%)</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 bg-red-500 rounded"></div>
          <span className="text-sm text-gray-700">Protein (15%)</span>
        </div>
      </div>
    </div>
  );
}

function FoodSourceCard({ category, foods, color, icon }) {
  const colors = {
    orange: 'from-orange-50 to-orange-100 border-orange-200',
    red: 'from-red-50 to-red-100 border-red-200',
    green: 'from-green-50 to-green-100 border-green-200',
    blue: 'from-blue-50 to-blue-100 border-blue-200'
  };

  return (
    <div className={`bg-gradient-to-br ${colors[color]} rounded-xl p-5 border`}>
      <div className="flex items-center gap-3 mb-4">
        <div className="text-3xl">{icon}</div>
        <h4 className="text-sm font-bold text-gray-900">{category}</h4>
      </div>
      <ul className="space-y-2">
        {foods.map((food, idx) => (
          <li key={idx} className="flex items-center gap-2 text-sm text-gray-700">
            <div className="w-1.5 h-1.5 bg-gray-600 rounded-full"></div>
            <span>{food}</span>
          </li>
        ))}
      </ul>
    </div>
  );
}

// ==============================================
// HEATMAP NUTRITION VIEW
// ==============================================
function HeatmapNutritionView({ data }) {
  const maxKebutuhan = Math.max(...data.map(d => d.kebutuhanHarian));

  return (
    <div className="space-y-6">
      {/* Heatmap Visualization */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Heatmap Kebutuhan Gizi per Wilayah</h3>
          <p className="text-xs text-gray-600 mt-1">Visualisasi spasial intensitas kebutuhan pangan</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          {data.map((wilayah, idx) => {
            const intensity = (wilayah.kebutuhanHarian / maxKebutuhan) * 100;
            const heatColor = 
              intensity > 80 ? 'from-red-500 to-red-600' :
              intensity > 60 ? 'from-orange-500 to-orange-600' :
              intensity > 40 ? 'from-yellow-500 to-yellow-600' :
              'from-green-500 to-green-600';

            return (
              <div key={idx} className="relative group">
                <div className={`bg-gradient-to-br ${heatColor} rounded-xl p-6 text-white shadow-lg hover:scale-105 transition-transform cursor-pointer`}>
                  <div className="text-sm font-semibold mb-2">{wilayah.kecamatan}</div>
                  <div className="text-3xl font-black mb-2">
                    {wilayah.kebutuhanHarian.toFixed(0)}
                  </div>
                  <div className="text-xs opacity-90">kg/hari</div>
                  <div className="mt-3 pt-3 border-t border-white border-opacity-30">
                    <div className="text-xs">{wilayah.siswa.toLocaleString()} siswa</div>
                  </div>
                </div>
                {/* Tooltip */}
                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white rounded-lg text-xs whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                  Intensitas: {intensity.toFixed(1)}%
                  <div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-4 border-transparent border-t-gray-900"></div>
                </div>
              </div>
            );
          })}
        </div>

        {/* Legend */}
        <div className="flex items-center justify-center gap-2">
          <span className="text-xs font-semibold text-gray-700">Intensitas Kebutuhan:</span>
          <div className="flex items-center gap-1">
            <div className="w-12 h-4 bg-gradient-to-r from-green-500 to-yellow-500 rounded-l"></div>
            <div className="w-12 h-4 bg-gradient-to-r from-yellow-500 to-orange-500"></div>
            <div className="w-12 h-4 bg-gradient-to-r from-orange-500 to-red-500 rounded-r"></div>
          </div>
          <div className="flex gap-4 text-xs text-gray-600 ml-2">
            <span>Rendah</span>
            <span>Sedang</span>
            <span>Tinggi</span>
          </div>
        </div>
      </div>

      {/* Spatial Statistics */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="bg-white rounded-xl border border-gray-200 p-6">
          <h4 className="text-lg font-bold text-gray-900 mb-4">Distribusi Kebutuhan</h4>
          <div className="space-y-3">
            {data.map((wilayah, idx) => {
              const percentage = (wilayah.kebutuhanHarian / data.reduce((sum, w) => sum + w.kebutuhanHarian, 0)) * 100;
              return (
                <div key={idx}>
                  <div className="flex justify-between text-sm mb-1">
                    <span className="font-semibold text-gray-700">{wilayah.kecamatan}</span>
                    <span className="font-bold text-gray-900">{percentage.toFixed(1)}%</span>
                  </div>
                  <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div 
                      className="h-full bg-gradient-to-r from-blue-500 to-blue-600"
                      style={{ width: `${percentage}%` }}
                    />
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        <div className="bg-white rounded-xl border border-gray-200 p-6">
          <h4 className="text-lg font-bold text-gray-900 mb-4">Ranking Wilayah</h4>
          <div className="space-y-3">
            {[...data].sort((a, b) => b.kebutuhanHarian - a.kebutuhanHarian).map((wilayah, idx) => (
              <div key={idx} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${
                  idx === 0 ? 'bg-yellow-500' :
                  idx === 1 ? 'bg-gray-400' :
                  idx === 2 ? 'bg-orange-600' :
                  'bg-gray-300'
                }`}>
                  {idx + 1}
                </div>
                <div className="flex-1">
                  <div className="text-sm font-semibold text-gray-900">{wilayah.kecamatan}</div>
                  <div className="text-xs text-gray-600">{wilayah.siswa.toLocaleString()} siswa</div>
                </div>
                <div className="text-right">
                  <div className="text-sm font-bold text-gray-900">{wilayah.kebutuhanHarian.toFixed(0)}</div>
                  <div className="text-xs text-gray-600">kg/hari</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Spatial Insights */}
      <div className="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-5 border border-purple-200">
        <div className="flex items-start gap-3">
          <Map className="w-5 h-5 text-purple-700 mt-1" />
          <div>
            <h5 className="text-sm font-bold text-purple-900 mb-2">Insight Spasial</h5>
            <ul className="space-y-1 text-xs text-gray-700">
              <li>• Lembang memiliki kebutuhan tertinggi ({data.find(d => d.kecamatan === 'Lembang')?.kebutuhanHarian.toFixed(0)} kg/hari)</li>
              <li>• Soreang kebutuhan terendah namun perlu monitoring jarak distribusi</li>
              <li>• Distribusi kebutuhan relatif merata antar wilayah (CV &lt; 20%)</li>
              <li>• Rekomendasi: Optimasi rute distribusi dari SPPG terdekat untuk efisiensi</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}
// ==============================================
// ANALISIS KAPASITAS PRODUKSI PAGE - SINTA 1 LEVEL
// ==============================================
function AnalisisKapasitasPage() {
  const [selectedSPPG, setSelectedSPPG] = useState('all');
  const [viewMode, setViewMode] = useState('overview'); // overview, detail, projection
  const [timeframe, setTimeframe] = useState('current'); // current, monthly, yearly

  // Comprehensive SPPG capacity data
  const sppgCapacityData = [
    {
      id: 1,
      nama: 'SPPG Bandung Pusat',
      kecamatan: 'Bandung',
      kapasitas: 15000,
      produksiAktual: 12500,
      utilisasi: 83.3,
      sekolahDilayani: 28,
      siswa: 6845,
      kebutuhanHarian: 6845 * 0.38,
      pekerja: 25,
      shiftKerja: 2,
      jamOperasional: 9,
      status: 'optimal',
      proyeksiDemand: 13200,
      surplus: 2500
    },
    {
      id: 2,
      nama: 'SPPG Cimahi',
      kecamatan: 'Cimahi',
      kapasitas: 12000,
      produksiAktual: 11200,
      utilisasi: 93.3,
      sekolahDilayani: 22,
      siswa: 5389,
      kebutuhanHarian: 5389 * 0.38,
      pekerja: 20,
      shiftKerja: 2,
      jamOperasional: 9,
      status: 'waspada',
      proyeksiDemand: 11800,
      surplus: 200
    },
    {
      id: 3,
      nama: 'SPPG Lembang',
      kecamatan: 'Lembang',
      kapasitas: 18000,
      produksiAktual: 17100,
      utilisasi: 95.0,
      sekolahDilayani: 35,
      siswa: 8956,
      kebutuhanHarian: 8956 * 0.38,
      pekerja: 32,
      shiftKerja: 2,
      jamOperasional: 9.5,
      status: 'high',
      proyeksiDemand: 17800,
      surplus: 200
    },
    {
      id: 4,
      nama: 'SPPG Cibeunying',
      kecamatan: 'Cibeunying',
      kapasitas: 14000,
      produksiAktual: 11900,
      utilisasi: 85.0,
      sekolahDilayani: 26,
      siswa: 6234,
      kebutuhanHarian: 6234 * 0.38,
      pekerja: 23,
      shiftKerja: 2,
      jamOperasional: 9,
      status: 'optimal',
      proyeksiDemand: 12400,
      surplus: 1600
    },
    {
      id: 5,
      nama: 'SPPG Soreang',
      kecamatan: 'Soreang',
      kapasitas: 10000,
      produksiAktual: 9450,
      utilisasi: 94.5,
      sekolahDilayani: 18,
      siswa: 4567,
      kebutuhanHarian: 4567 * 0.38,
      pekerja: 18,
      shiftKerja: 2,
      jamOperasional: 8.5,
      status: 'waspada',
      proyeksiDemand: 9800,
      surplus: 200
    }
  ];

  // Filtering
  const filteredData = sppgCapacityData.filter(sppg =>
    selectedSPPG === 'all' || sppg.nama === selectedSPPG
  );

  // Statistics
  const stats = {
    totalKapasitas: filteredData.reduce((sum, s) => sum + s.kapasitas, 0),
    totalProduksi: filteredData.reduce((sum, s) => sum + s.produksiAktual, 0),
    totalKebutuhan: filteredData.reduce((sum, s) => sum + s.kebutuhanHarian, 0),
    avgUtilisasi: (filteredData.reduce((sum, s) => sum + s.utilisasi, 0) / filteredData.length).toFixed(1),
    totalSurplus: filteredData.reduce((sum, s) => sum + s.surplus, 0),
    sppgOverload: filteredData.filter(s => s.utilisasi >= 90).length
  };

  return (
    <div className="p-6 space-y-6">
      {/* Page Header */}
      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Analisis Kapasitas Produksi SPPG</h2>
          <p className="text-sm text-gray-600 mt-1">
            Monitoring utilisasi dan optimasi kapasitas produksi makanan bergizi
          </p>
        </div>
        <div className="flex gap-2">
          <select 
            value={selectedSPPG}
            onChange={(e) => setSelectedSPPG(e.target.value)}
            className="px-4 py-2 border border-gray-300 rounded-xl text-sm font-medium focus:ring-2 focus:ring-blue-500"
          >
            <option value="all">Semua SPPG</option>
            {sppgCapacityData.map(sppg => (
              <option key={sppg.id} value={sppg.nama}>{sppg.nama}</option>
            ))}
          </select>
          <button className="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all">
            Export Analisis
          </button>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-6 gap-4">
        <CapacityStatCard
          label="Total Kapasitas"
          value={stats.totalKapasitas.toLocaleString()}
          icon={Database}
          color="blue"
          unit="kg/hari"
        />
        <CapacityStatCard
          label="Produksi Aktual"
          value={stats.totalProduksi.toLocaleString()}
          icon={TrendingUp}
          color="green"
          unit="kg/hari"
        />
        <CapacityStatCard
          label="Total Kebutuhan"
          value={stats.totalKebutuhan.toFixed(0).toLocaleString()}
          icon={Target}
          color="orange"
          unit="kg/hari"
        />
        <CapacityStatCard
          label="Utilisasi Avg"
          value={`${stats.avgUtilisasi}%`}
          icon={Activity}
          color="purple"
        />
        <CapacityStatCard
          label="Surplus Total"
          value={stats.totalSurplus.toLocaleString()}
          icon={TrendingUp}
          color="teal"
          unit="kg/hari"
        />
        <CapacityStatCard
          label="SPPG Overload"
          value={stats.sppgOverload}
          icon={AlertTriangle}
          color="red"
          unit="unit"
        />
      </div>

      {/* View Mode Tabs */}
      <div className="bg-white rounded-xl border border-gray-200 p-4">
        <div className="flex gap-2">
          <CapacityViewButton 
            label="Overview" 
            value="overview" 
            active={viewMode} 
            onClick={setViewMode}
            icon={BarChart3}
          />
          <CapacityViewButton 
            label="Detail Analisis" 
            value="detail" 
            active={viewMode} 
            onClick={setViewMode}
            icon={Target}
          />
          <CapacityViewButton 
            label="Proyeksi Future" 
            value="projection" 
            active={viewMode} 
            onClick={setViewMode}
            icon={TrendingUp}
          />
        </div>
      </div>

      {/* Content based on view mode */}
      {viewMode === 'overview' && (
        <CapacityOverviewView 
          data={filteredData}
          stats={stats}
        />
      )}
      {viewMode === 'detail' && (
        <CapacityDetailView 
          data={filteredData}
        />
      )}
      {viewMode === 'projection' && (
        <CapacityProjectionView 
          data={filteredData}
        />
      )}

      {/* Output Info Panel */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-start gap-4">
          <Award className="w-6 h-6 flex-shrink-0 mt-1" />
          <div>
            <h3 className="font-bold text-lg mb-2">Output Modul Analisis Kapasitas Produksi</h3>
            <p className="text-blue-100 text-sm leading-relaxed mb-3">
              Modul ini menghasilkan: (1) Analisis utilisasi kapasitas real-time per SPPG,
              (2) Identifikasi surplus/defisit produksi vs kebutuhan aktual, (3) Gap analysis untuk capacity planning,
              (4) Proyeksi kebutuhan kapasitas future berdasarkan pertumbuhan siswa, (5) Rekomendasi optimasi
              alokasi produksi dan ekspansi kapasitas untuk mendukung skalabilitas program MBG.
            </p>
            <div className="flex flex-wrap gap-2">
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Utilization Analysis</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Capacity Planning</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Gap Analysis</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Future Projection</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Helper Components
function CapacityStatCard({ label, value, icon: Icon, color, unit }) {
  const colors = {
    blue: 'from-blue-600 to-blue-700',
    green: 'from-green-600 to-green-700',
    orange: 'from-orange-600 to-orange-700',
    purple: 'from-purple-600 to-purple-700',
    teal: 'from-teal-600 to-teal-700',
    red: 'from-red-600 to-red-700'
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-4 shadow-sm hover:shadow-md transition-shadow">
      <div className={`w-10 h-10 bg-gradient-to-br ${colors[color]} rounded-xl flex items-center justify-center mb-3 shadow-lg`}>
        <Icon className="w-5 h-5 text-white" />
      </div>
      <div className="text-2xl font-black text-gray-900 mb-1">{value}</div>
      <div className="text-xs font-semibold text-gray-700">{label}</div>
      {unit && <div className="text-xs text-gray-500 mt-1">{unit}</div>}
    </div>
  );
}

function CapacityViewButton({ label, value, active, onClick, icon: Icon }) {
  return (
    <button
      onClick={() => onClick(value)}
      className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
        active === value
          ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg'
          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
      }`}
    >
      <Icon className="w-4 h-4" />
      {label}
    </button>
  );
}

// ==============================================
// CAPACITY OVERVIEW VIEW
// ==============================================
function CapacityOverviewView({ data, stats }) {
  return (
    <div className="space-y-6">
      {/* Capacity vs Production Chart */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h3 className="text-lg font-bold text-gray-900">Kapasitas vs Produksi per SPPG</h3>
            <p className="text-xs text-gray-600 mt-1">Perbandingan kapasitas maksimal dengan produksi aktual harian</p>
          </div>
          <div className="flex gap-3">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-blue-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">Kapasitas</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-green-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">Produksi</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-orange-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">Kebutuhan</span>
            </div>
          </div>
        </div>
        <CapacityProductionChart data={data} />
      </div>

      {/* Utilization Analysis */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Analisis Utilisasi Kapasitas</h3>
          <p className="text-xs text-gray-600 mt-1">Tingkat penggunaan kapasitas produksi terhadap maksimum</p>
        </div>

        <div className="space-y-4">
          {data.map((sppg, idx) => (
            <UtilizationBar key={idx} sppg={sppg} />
          ))}
        </div>

        <div className="mt-6 p-4 bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg border border-yellow-200">
          <div className="flex items-start gap-3">
            <AlertTriangle className="w-5 h-5 text-yellow-700 mt-0.5" />
            <div>
              <h5 className="text-sm font-bold text-yellow-900 mb-2">Peringatan Utilisasi</h5>
              <ul className="space-y-1 text-xs text-gray-700">
                {data.filter(s => s.utilisasi >= 90).map((sppg, idx) => (
                  <li key={idx}>• {sppg.nama}: {sppg.utilisasi}% utilisasi - risiko overload tinggi</li>
                ))}
                {data.filter(s => s.utilisasi >= 90).length === 0 && (
                  <li>• Semua SPPG dalam kondisi utilisasi normal</li>
                )}
              </ul>
            </div>
          </div>
        </div>
      </div>

      {/* Surplus/Deficit Analysis */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="bg-white rounded-xl border border-gray-200 p-6">
          <h4 className="text-lg font-bold text-gray-900 mb-4">Status Kapasitas</h4>
          
          <div className="space-y-3">
            {data.map((sppg, idx) => {
              const surplusPercentage = (sppg.surplus / sppg.kapasitas) * 100;
              return (
                <div key={idx} className="p-4 bg-gray-50 rounded-lg">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-semibold text-gray-900">{sppg.nama}</span>
                    <span className={`px-2 py-1 rounded text-xs font-bold ${
                      sppg.surplus >= 1000 ? 'bg-green-100 text-green-700' :
                      sppg.surplus >= 500 ? 'bg-yellow-100 text-yellow-700' :
                      'bg-red-100 text-red-700'
                    }`}>
                      {sppg.surplus >= 0 ? 'Surplus' : 'Defisit'}
                    </span>
                  </div>
                  <div className="flex items-center justify-between text-xs text-gray-600">
                    <span>Kapasitas: {sppg.kapasitas.toLocaleString()} kg</span>
                    <span className="font-bold text-gray-900">{sppg.surplus >= 0 ? '+' : ''}{sppg.surplus.toLocaleString()} kg</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        <div className="bg-white rounded-xl border border-gray-200 p-6">
          <h4 className="text-lg font-bold text-gray-900 mb-4">Distribusi Status</h4>
          
          <div className="mb-6">
            <CapacityStatusPieChart data={data} />
          </div>

          <div className="space-y-2">
            <StatusLegendItem
              color="bg-green-500"
              label="Optimal"
              count={data.filter(s => s.status === 'optimal').length}
              description="Utilisasi 70-85%"
            />
            <StatusLegendItem
              color="bg-yellow-500"
              label="Waspada"
              count={data.filter(s => s.status === 'waspada').length}
              description="Utilisasi 85-95%"
            />
            <StatusLegendItem
              color="bg-red-500"
              label="High Load"
              count={data.filter(s => s.status === 'high').length}
              description="Utilisasi >95%"
            />
          </div>
        </div>
      </div>

      {/* Operational Efficiency */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Efisiensi Operasional</h3>
          <p className="text-xs text-gray-600 mt-1">Analisis produktivitas tenaga kerja dan waktu operasional</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {data.map((sppg, idx) => (
            <OperationalEfficiencyCard key={idx} sppg={sppg} />
          ))}
        </div>
      </div>

      {/* Summary Insights */}
      <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-5 border border-blue-200">
        <div className="flex items-start gap-3">
          <Target className="w-5 h-5 text-blue-700 mt-1" />
          <div>
            <h5 className="text-sm font-bold text-blue-900 mb-2">Ringkasan Analisis Kapasitas</h5>
            <ul className="space-y-1 text-xs text-gray-700">
              <li>• Total kapasitas sistem: <span className="font-bold">{stats.totalKapasitas.toLocaleString()} kg/hari</span></li>
              <li>• Utilisasi rata-rata: <span className="font-bold">{stats.avgUtilisasi}%</span> (kategori {parseFloat(stats.avgUtilisasi) >= 85 ? 'tinggi' : 'optimal'})</li>
              <li>• Surplus kapasitas total: <span className="font-bold">{stats.totalSurplus.toLocaleString()} kg/hari</span> untuk ekspansi</li>
              <li>• {stats.sppgOverload} SPPG memerlukan monitoring ketat (utilisasi ≥90%)</li>
              <li>• Rekomendasi: {stats.sppgOverload > 0 ? 'Pertimbangkan realokasi atau peningkatan kapasitas' : 'Kapasitas mencukupi untuk kebutuhan saat ini'}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}

// Helper Components for Overview
function CapacityProductionChart({ data }) {
  const maxValue = Math.max(...data.map(d => d.kapasitas));

  return (
    <div className="space-y-4">
      {data.map((sppg, idx) => (
        <div key={idx}>
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-semibold text-gray-900">{sppg.nama}</span>
            <div className="flex items-center gap-3 text-xs text-gray-600">
              <span>Utilisasi: <span className="font-bold text-gray-900">{sppg.utilisasi}%</span></span>
            </div>
          </div>
          <div className="relative h-14 bg-gray-100 rounded-lg overflow-hidden">
            {/* Capacity Background */}
            <div 
              className="absolute h-full bg-gradient-to-r from-blue-300 to-blue-400 opacity-40"
              style={{ width: `${(sppg.kapasitas / maxValue) * 100}%` }}
            />
            {/* Production Bar */}
            <div 
              className="absolute h-full bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-end px-3"
              style={{ width: `${(sppg.produksiAktual / maxValue) * 100}%` }}
            >
              <span className="text-xs font-bold text-white">{sppg.produksiAktual.toLocaleString()}</span>
            </div>
            {/* Demand Line */}
            <div 
              className="absolute h-full border-r-4 border-orange-500 border-dashed"
              style={{ left: `${(sppg.kebutuhanHarian / maxValue) * 100}%` }}
            />
            {/* Capacity Label */}
            <div 
              className="absolute h-full flex items-center px-3"
              style={{ left: `${(sppg.kapasitas / maxValue) * 100}%` }}
            >
              <span className="text-xs font-bold text-blue-700">{sppg.kapasitas.toLocaleString()}</span>
            </div>
          </div>
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>Kebutuhan: {sppg.kebutuhanHarian.toFixed(0).toLocaleString()} kg</span>
            <span>Surplus: {sppg.surplus.toLocaleString()} kg</span>
          </div>
        </div>
      ))}
    </div>
  );
}

function UtilizationBar({ sppg }) {
  const getUtilizationColor = (util) => {
    if (util >= 95) return 'from-red-500 to-red-600';
    if (util >= 85) return 'from-yellow-500 to-yellow-600';
    return 'from-green-500 to-green-600';
  };

  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <div>
          <span className="text-sm font-semibold text-gray-900">{sppg.nama}</span>
          <span className="ml-2 text-xs text-gray-600">({sppg.pekerja} pekerja, {sppg.shiftKerja} shift)</span>
        </div>
        <span className={`text-lg font-black ${
          sppg.utilisasi >= 95 ? 'text-red-600' :
          sppg.utilisasi >= 85 ? 'text-yellow-600' :
          'text-green-600'
        }`}>
          {sppg.utilisasi}%
        </span>
      </div>
      <div className="h-4 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className={`h-full bg-gradient-to-r ${getUtilizationColor(sppg.utilisasi)}`}
          style={{ width: `${sppg.utilisasi}%` }}
        />
      </div>
    </div>
  );
}

function CapacityStatusPieChart({ data }) {
  const optimal = data.filter(s => s.status === 'optimal').length;
  const waspada = data.filter(s => s.status === 'waspada').length;
  const high = data.filter(s => s.status === 'high').length;
  const total = data.length;

  const optimalPercentage = (optimal / total) * 100;
  const waspadaPercentage = (waspada / total) * 100;
  const highPercentage = (high / total) * 100;

  return (
    <div className="flex items-center justify-center">
      <div className="relative w-40 h-40">
        <svg viewBox="0 0 100 100" className="transform -rotate-90">
          {/* Green - Optimal */}
          <circle
            cx="50"
            cy="50"
            r="40"
            fill="none"
            stroke="#22c55e"
            strokeWidth="20"
            strokeDasharray={`${optimalPercentage * 2.513} 251.3`}
            strokeDashoffset="0"
          />
          {/* Yellow - Waspada */}
          <circle
            cx="50"
            cy="50"
            r="40"
            fill="none"
            stroke="#eab308"
            strokeWidth="20"
            strokeDasharray={`${waspadaPercentage * 2.513} 251.3`}
            strokeDashoffset={`-${optimalPercentage * 2.513}`}
          />
          {/* Red - High */}
          <circle
            cx="50"
            cy="50"
            r="40"
            fill="none"
            stroke="#ef4444"
            strokeWidth="20"
            strokeDasharray={`${highPercentage * 2.513} 251.3`}
            strokeDashoffset={`-${(optimalPercentage + waspadaPercentage) * 2.513}`}
          />
        </svg>
        <div className="absolute inset-0 flex items-center justify-center">
          <div className="text-center">
            <div className="text-2xl font-black text-gray-900">{total}</div>
            <div className="text-xs text-gray-600">SPPG</div>
          </div>
        </div>
      </div>
    </div>
  );
}

function StatusLegendItem({ color, label, count, description }) {
  return (
    <div className="flex items-center justify-between p-2 bg-gray-50 rounded">
      <div className="flex items-center gap-2">
        <div className={`w-3 h-3 ${color} rounded`}></div>
        <div>
          <div className="text-sm font-semibold text-gray-900">{label}</div>
          <div className="text-xs text-gray-600">{description}</div>
        </div>
      </div>
      <div className="text-lg font-black text-gray-900">{count}</div>
    </div>
  );
}

function OperationalEfficiencyCard({ sppg }) {
  const produksiPerPekerja = (sppg.produksiAktual / sppg.pekerja).toFixed(0);
  const produksiPerJam = (sppg.produksiAktual / sppg.jamOperasional).toFixed(0);

  return (
    <div className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
      <h5 className="text-sm font-bold text-gray-900 mb-3">{sppg.nama}</h5>
      <div className="space-y-2">
        <div className="flex justify-between text-xs">
          <span className="text-gray-600">Produksi/Pekerja</span>
          <span className="font-bold text-gray-900">{produksiPerPekerja} kg</span>
        </div><div className="flex justify-between text-xs">
          <span className="text-gray-600">Produksi/Jam</span>
          <span className="font-bold text-gray-900">{produksiPerJam} kg</span>
        </div>
        <div className="flex justify-between text-xs">
          <span className="text-gray-600">Jam Operasional</span>
          <span className="font-bold text-gray-900">{sppg.jamOperasional} jam</span>
        </div>
        <div className="flex justify-between text-xs">
          <span className="text-gray-600">Shift Kerja</span>
          <span className="font-bold text-gray-900">{sppg.shiftKerja} shift</span>
        </div>
      </div>
    </div>
  );
}

// ==============================================
// CAPACITY DETAIL VIEW
// ==============================================
function CapacityDetailView({ data }) {
  return (
    <div className="space-y-6">
      {/* Detailed Capacity Cards */}
      <div className="grid grid-cols-1 gap-6">
        {data.map((sppg, idx) => (
          <DetailedCapacityCard key={idx} sppg={sppg} />
        ))}
      </div>

      {/* Bottleneck Analysis */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Analisis Bottleneck Produksi</h3>
          <p className="text-xs text-gray-600 mt-1">Identifikasi kendala dan limitasi kapasitas</p>
        </div>

        <div className="space-y-4">
          {data.map((sppg, idx) => (
            <BottleneckAnalysisCard key={idx} sppg={sppg} />
          ))}
        </div>
      </div>

      {/* Optimization Recommendations */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Rekomendasi Optimasi Kapasitas</h3>
          <p className="text-xs text-gray-600 mt-1">Saran peningkatan efisiensi dan produktivitas</p>
        </div>

        <div className="space-y-4">
          {data.map((sppg, idx) => {
            const recommendations = generateRecommendations(sppg);
            return recommendations.length > 0 && (
              <OptimizationRecommendationCard key={idx} sppg={sppg} recommendations={recommendations} />
            );
          })}
        </div>
      </div>

      {/* Resource Allocation */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Alokasi Sumber Daya</h3>
          <p className="text-xs text-gray-600 mt-1">Distribusi tenaga kerja dan waktu operasional</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Worker Distribution */}
          <div>
            <h4 className="text-sm font-bold text-gray-900 mb-4">Distribusi Tenaga Kerja</h4>
            <div className="space-y-3">
              {data.map((sppg, idx) => (
                <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div>
                    <div className="text-sm font-semibold text-gray-900">{sppg.nama}</div>
                    <div className="text-xs text-gray-600">{sppg.pekerja} pekerja</div>
                  </div>
                  <div className="text-right">
                    <div className="text-sm font-bold text-gray-900">
                      {(sppg.produksiAktual / sppg.pekerja).toFixed(0)} kg
                    </div>
                    <div className="text-xs text-gray-600">per pekerja</div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Time Allocation */}
          <div>
            <h4 className="text-sm font-bold text-gray-900 mb-4">Alokasi Waktu Operasional</h4>
            <div className="space-y-3">
              {data.map((sppg, idx) => (
                <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div>
                    <div className="text-sm font-semibold text-gray-900">{sppg.nama}</div>
                    <div className="text-xs text-gray-600">{sppg.jamOperasional} jam/hari</div>
                  </div>
                  <div className="text-right">
                    <div className="text-sm font-bold text-gray-900">
                      {(sppg.produksiAktual / sppg.jamOperasional).toFixed(0)} kg
                    </div>
                    <div className="text-xs text-gray-600">per jam</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* Comparative Performance */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Perbandingan Kinerja Antar SPPG</h3>
          <p className="text-xs text-gray-600 mt-1">Benchmarking efisiensi dan produktivitas</p>
        </div>

        <ComparativePerformanceChart data={data} />
      </div>
    </div>
  );
}

// Helper Components for Detail View
function DetailedCapacityCard({ sppg }) {
  const gapPercentage = ((sppg.kapasitas - sppg.kebutuhanHarian) / sppg.kapasitas) * 100;
  
  return (
    <div className="bg-white rounded-xl border-2 border-gray-200 p-6 hover:shadow-xl transition-all">
      <div className="flex items-start justify-between mb-6">
        <div>
          <h4 className="text-xl font-bold text-gray-900 mb-1">{sppg.nama}</h4>
          <p className="text-sm text-gray-600">{sppg.kecamatan} • {sppg.sekolahDilayani} sekolah dilayani</p>
        </div>
        <div className={`px-4 py-2 rounded-xl text-sm font-bold ${
          sppg.status === 'optimal' ? 'bg-green-100 text-green-700' :
          sppg.status === 'waspada' ? 'bg-yellow-100 text-yellow-700' :
          'bg-red-100 text-red-700'
        }`}>
          {sppg.status.toUpperCase()}
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <MetricBox label="Kapasitas" value={sppg.kapasitas.toLocaleString()} unit="kg/hari" color="blue" />
        <MetricBox label="Produksi" value={sppg.produksiAktual.toLocaleString()} unit="kg/hari" color="green" />
        <MetricBox label="Kebutuhan" value={sppg.kebutuhanHarian.toFixed(0).toLocaleString()} unit="kg/hari" color="orange" />
        <MetricBox label="Utilisasi" value={`${sppg.utilisasi}%`} unit="kapasitas" color="purple" />
      </div>

      {/* Capacity Bar Visualization */}
      <div className="mb-6">
        <div className="flex justify-between text-xs text-gray-600 mb-2">
          <span>Utilisasi Kapasitas</span>
          <span className="font-bold text-gray-900">{sppg.utilisasi}%</span>
        </div>
        <div className="relative h-8 bg-gray-200 rounded-full overflow-hidden">
          <div 
            className={`absolute h-full ${
              sppg.utilisasi >= 95 ? 'bg-gradient-to-r from-red-500 to-red-600' :
              sppg.utilisasi >= 85 ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' :
              'bg-gradient-to-r from-green-500 to-green-600'
            } flex items-center justify-center text-white text-xs font-bold`}
            style={{ width: `${sppg.utilisasi}%` }}
          >
            {sppg.produksiAktual.toLocaleString()} kg
          </div>
        </div>
        <div className="flex justify-between text-xs text-gray-500 mt-1">
          <span>0 kg</span>
          <span>{sppg.kapasitas.toLocaleString()} kg</span>
        </div>
      </div>

      {/* Additional Metrics */}
      <div className="grid grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
        <div className="text-center">
          <div className="text-xs text-gray-600 mb-1">Surplus</div>
          <div className="text-lg font-black text-gray-900">{sppg.surplus.toLocaleString()}</div>
          <div className="text-xs text-gray-500">kg/hari</div>
        </div>
        <div className="text-center border-l border-r border-gray-300">
          <div className="text-xs text-gray-600 mb-1">Siswa</div>
          <div className="text-lg font-black text-gray-900">{sppg.siswa.toLocaleString()}</div>
          <div className="text-xs text-gray-500">total</div>
        </div>
        <div className="text-center">
          <div className="text-xs text-gray-600 mb-1">Gap</div>
          <div className="text-lg font-black text-gray-900">{gapPercentage.toFixed(1)}%</div>
          <div className="text-xs text-gray-500">kapasitas</div>
        </div>
      </div>
    </div>
  );
}

function MetricBox({ label, value, unit, color }) {
  const colors = {
    blue: 'bg-blue-50 text-blue-700 border-blue-200',
    green: 'bg-green-50 text-green-700 border-green-200',
    orange: 'bg-orange-50 text-orange-700 border-orange-200',
    purple: 'bg-purple-50 text-purple-700 border-purple-200'
  };

  return (
    <div className={`${colors[color]} rounded-lg p-3 border`}>
      <div className="text-xs font-semibold mb-1">{label}</div>
      <div className="text-xl font-black mb-0.5">{value}</div>
      <div className="text-xs opacity-75">{unit}</div>
    </div>
  );
}

function BottleneckAnalysisCard({ sppg }) {
  const bottlenecks = [];
  
  if (sppg.utilisasi >= 90) {
    bottlenecks.push({
      type: 'capacity',
      severity: 'high',
      issue: 'Kapasitas hampir maksimal',
      impact: 'Risiko tidak mampu memenuhi lonjakan permintaan',
      solution: 'Pertimbangkan penambahan shift atau peningkatan kapasitas'
    });
  }

  if (sppg.pekerja < 20) {
    bottlenecks.push({
      type: 'workforce',
      severity: 'medium',
      issue: 'Jumlah pekerja terbatas',
      impact: 'Produktivitas per pekerja tinggi, risiko kelelahan',
      solution: 'Rekrutmen pekerja tambahan atau rotasi shift optimal'
    });
  }

  if (sppg.jamOperasional < 9) {
    bottlenecks.push({
      type: 'time',
      severity: 'low',
      issue: 'Jam operasional dapat dioptimalkan',
      impact: 'Potensi peningkatan produksi belum maksimal',
      solution: 'Evaluasi penambahan jam operasional jika diperlukan'
    });
  }

  if (bottlenecks.length === 0) {
    bottlenecks.push({
      type: 'none',
      severity: 'none',
      issue: 'Tidak ada bottleneck signifikan',
      impact: 'Operasional berjalan optimal',
      solution: 'Pertahankan standar operasional saat ini'
    });
  }

  return (
    <div className="border border-gray-200 rounded-xl p-5">
      <h5 className="text-sm font-bold text-gray-900 mb-4">{sppg.nama}</h5>
      <div className="space-y-3">
        {bottlenecks.map((bottleneck, idx) => (
          <BottleneckItem key={idx} bottleneck={bottleneck} />
        ))}
      </div>
    </div>
  );
}

function BottleneckItem({ bottleneck }) {
  const severityConfig = {
    high: { color: 'red', icon: '🔴', bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700' },
    medium: { color: 'yellow', icon: '🟡', bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-700' },
    low: { color: 'blue', icon: '🔵', bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700' },
    none: { color: 'green', icon: '🟢', bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-700' }
  };

  const config = severityConfig[bottleneck.severity];

  return (
    <div className={`${config.bg} ${config.border} border rounded-lg p-3`}>
      <div className="flex items-start gap-2 mb-2">
        <span className="text-lg">{config.icon}</span>
        <div className="flex-1">
          <div className={`text-sm font-bold ${config.text} mb-1`}>{bottleneck.issue}</div>
          <div className="text-xs text-gray-700 mb-2">{bottleneck.impact}</div>
          <div className="text-xs text-gray-600 bg-white bg-opacity-50 rounded p-2">
            <span className="font-semibold">Solusi:</span> {bottleneck.solution}
          </div>
        </div>
      </div>
    </div>
  );
}

function generateRecommendations(sppg) {
  const recommendations = [];

  if (sppg.utilisasi >= 95) {
    recommendations.push({
      priority: 'high',
      title: 'Peningkatan Kapasitas Urgent',
      description: `Utilisasi ${sppg.utilisasi}% sangat tinggi. Risiko overload dan penurunan kualitas.`,
      actions: [
        'Tambah 1 shift produksi (estimasi +30% kapasitas)',
        'Upgrade peralatan produksi',
        'Rekrutmen 5-8 pekerja tambahan'
      ]
    });
  } else if (sppg.utilisasi >= 85) {
    recommendations.push({
      priority: 'medium',
      title: 'Monitoring & Preventif',
      description: `Utilisasi ${sppg.utilisasi}% mendekati batas optimal. Perlu monitoring ketat.`,
      actions: [
        'Siapkan contingency plan untuk lonjakan permintaan',
        'Optimasi alur produksi untuk efisiensi',
        'Evaluasi penambahan kapasitas dalam 3 bulan'
      ]
    });
  }

  if (sppg.surplus >= 2000) {
    recommendations.push({
      priority: 'low',
      title: 'Peluang Ekspansi',
      description: `Surplus ${sppg.surplus.toLocaleString()} kg dapat dimanfaatkan untuk ekspansi layanan.`,
      actions: [
        'Evaluasi penambahan sekolah sasaran di radius 15-20 km',
        'Pertimbangkan kolaborasi antar-kecamatan',
        'Diversifikasi menu dengan kapasitas tersedia'
      ]
    });
  }

  return recommendations;
}

function OptimizationRecommendationCard({ sppg, recommendations }) {
  return (
    <div className="border border-gray-200 rounded-xl p-5">
      <h5 className="text-sm font-bold text-gray-900 mb-4">{sppg.nama}</h5>
      <div className="space-y-3">
        {recommendations.map((rec, idx) => (
          <RecommendationItem key={idx} recommendation={rec} />
        ))}
      </div>
    </div>
  );
}

function RecommendationItem({ recommendation }) {
  const priorityConfig = {
    high: { bg: 'from-red-50 to-red-100', border: 'border-red-200', text: 'text-red-700', badge: 'bg-red-600' },
    medium: { bg: 'from-yellow-50 to-yellow-100', border: 'border-yellow-200', text: 'text-yellow-700', badge: 'bg-yellow-600' },
    low: { bg: 'from-blue-50 to-blue-100', border: 'border-blue-200', text: 'text-blue-700', badge: 'bg-blue-600' }
  };

  const config = priorityConfig[recommendation.priority];

  return (
    <div className={`bg-gradient-to-r ${config.bg} border ${config.border} rounded-lg p-4`}>
      <div className="flex items-start gap-3 mb-3">
        <div className={`${config.badge} text-white px-2 py-1 rounded text-xs font-bold uppercase`}>
          {recommendation.priority}
        </div>
        <div className="flex-1">
          <h6 className={`text-sm font-bold ${config.text} mb-1`}>{recommendation.title}</h6>
          <p className="text-xs text-gray-700">{recommendation.description}</p>
        </div>
      </div>
      <div className="bg-white bg-opacity-60 rounded-lg p-3">
        <div className="text-xs font-semibold text-gray-700 mb-2">Action Plan:</div>
        <ul className="space-y-1">
          {recommendation.actions.map((action, idx) => (
            <li key={idx} className="text-xs text-gray-700 flex items-start gap-2">
              <span className="text-blue-600 font-bold">→</span>
              <span>{action}</span>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
}

function ComparativePerformanceChart({ data }) {
  const metrics = [
    { label: 'Utilisasi (%)', key: 'utilisasi', max: 100 },
    { label: 'Produktivitas (kg/pekerja)', key: 'prodPerWorker', max: 1000 },
    { label: 'Efisiensi Waktu (kg/jam)', key: 'prodPerHour', max: 2000 }
  ];

  const enrichedData = data.map(sppg => ({
    ...sppg,
    prodPerWorker: sppg.produksiAktual / sppg.pekerja,
    prodPerHour: sppg.produksiAktual / sppg.jamOperasional
  }));

  return (
    <div className="space-y-6">
      {metrics.map((metric, idx) => (
        <div key={idx}>
          <h5 className="text-sm font-semibold text-gray-700 mb-3">{metric.label}</h5>
          <div className="space-y-2">
            {enrichedData.map((sppg, sidx) => {
              const value = sppg[metric.key];
              const percentage = (value / metric.max) * 100;
              const isTop = value === Math.max(...enrichedData.map(s => s[metric.key]));

              return (
                <div key={sidx} className="flex items-center gap-3">
                  <div className="w-32 text-xs font-medium text-gray-700 truncate">{sppg.nama}</div>
                  <div className="flex-1 h-6 bg-gray-200 rounded-full overflow-hidden">
                    <div 
                      className={`h-full flex items-center justify-end px-2 ${
                        isTop ? 'bg-gradient-to-r from-green-500 to-green-600' : 'bg-gradient-to-r from-blue-500 to-blue-600'
                      }`}
                      style={{ width: `${Math.min(percentage, 100)}%` }}
                    >
                      <span className="text-xs font-bold text-white">{value.toFixed(metric.key === 'utilisasi' ? 1 : 0)}</span>
                    </div>
                  </div>
                  {isTop && <span className="text-yellow-500 text-lg">🏆</span>}
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  );
}

// ==============================================
// CAPACITY PROJECTION VIEW
// ==============================================
function CapacityProjectionView({ data }) {
  // Projection scenarios
  const growthScenarios = [
    { name: 'Konservatif', rate: 0.03, label: '+3% siswa/tahun' },
    { name: 'Moderat', rate: 0.05, label: '+5% siswa/tahun' },
    { name: 'Agresif', rate: 0.08, label: '+8% siswa/tahun' }
  ];

  return (
    <div className="space-y-6">
      {/* Projection Summary */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Proyeksi Kebutuhan Kapasitas</h3>
          <p className="text-xs text-gray-600 mt-1">Estimasi kebutuhan 1-5 tahun ke depan berdasarkan pertumbuhan siswa</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {growthScenarios.map((scenario, idx) => (
            <GrowthScenarioCard key={idx} scenario={scenario} data={data} />
          ))}
        </div>
      </div>

      {/* Yearly Projection Chart */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Proyeksi 5 Tahun</h3>
          <p className="text-xs text-gray-600 mt-1">Perbandingan kapasitas vs proyeksi kebutuhan</p>
        </div>
        <YearlyProjectionChart data={data} />
      </div>

      {/* SPPG-Specific Projections */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Proyeksi per SPPG</h3>
          <p className="text-xs text-gray-600 mt-1">Kebutuhan kapasitas individual 3 tahun ke depan</p>
        </div>

        <div className="space-y-6">
          {data.map((sppg, idx) => (
            <SPPGProjectionCard key={idx} sppg={sppg} />
          ))}
        </div>
      </div>

      {/* Investment Recommendations */}
      <div className="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
        <div className="flex items-start gap-4">
          <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center flex-shrink-0">
            <TrendingUp className="w-6 h-6 text-white" />
          </div>
          <div className="flex-1">
            <h4 className="text-lg font-bold text-purple-900 mb-3">Rekomendasi Investasi Kapasitas</h4>
            <div className="space-y-3">
              <InvestmentRecommendation
                priority="Tahun 1-2"
                items={[
                  'SPPG Lembang: Peningkatan kapasitas +2000 kg (investasi ~Rp 500 juta)',
                  'SPPG Soreang: Penambahan 1 shift produksi (investasi ~Rp 200 juta)',
                  'Semua SPPG: Upgrade peralatan produksi untuk efisiensi (investasi ~Rp 300 juta)'
                ]}
              />
              <InvestmentRecommendation
                priority="Tahun 3-5"
                items={[
                  'SPPG Baru di wilayah ekspansi (investasi ~Rp 2-3 miliar)',
                  'Modernisasi sistem produksi dengan automation (investasi ~Rp 800 juta)',
                  'Peningkatan kapasitas penyimpanan cold storage (investasi ~Rp 400 juta)'
                ]}
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Helper Components for Projection View
function GrowthScenarioCard({ scenario, data }) {
  const currentTotal = data.reduce((sum, s) => sum + s.siswa, 0);
  const year3 = Math.round(currentTotal * Math.pow(1 + scenario.rate, 3));
  const year5 = Math.round(currentTotal * Math.pow(1 + scenario.rate, 5));
  
  const currentDemand = data.reduce((sum, s) => sum + s.kebutuhanHarian, 0);
  const year3Demand = currentDemand * Math.pow(1 + scenario.rate, 3);
  const year5Demand = currentDemand * Math.pow(1 + scenario.rate, 5);

  const totalCapacity = data.reduce((sum, s) => sum + s.kapasitas, 0);
  const year3Gap = totalCapacity - year3Demand;
  const year5Gap = totalCapacity - year5Demand;

  return (
    <div className="border-2 border-gray-200 rounded-xl p-5 hover:border-blue-400 transition-colors">
      <div className="flex items-center justify-between mb-4">
        <h5 className="text-sm font-bold text-gray-900">{scenario.name}</h5>
        <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded font-semibold">{scenario.label}</span>
      </div>

      <div className="space-y-4">
        <div>
          <div className="text-xs text-gray-600 mb-1">Proyeksi Siswa (Tahun 3)</div>
          <div className="text-2xl font-black text-gray-900">{year3.toLocaleString()}</div>
          <div className="text-xs text-gray-500">+{(year3 - currentTotal).toLocaleString()} siswa</div>
        </div>

        <div>
          <div className="text-xs text-gray-600 mb-1">Kebutuhan (Tahun 3)</div>
          <div className="text-lg font-bold text-gray-900">{year3Demand.toFixed(0).toLocaleString()} kg</div>
          <div className={`text-xs font-semibold ${year3Gap >= 0 ? 'text-green-600' : 'text-red-600'}`}>
            {year3Gap >= 0 ? 'Surplus' : 'Defisit'}: {Math.abs(year3Gap).toFixed(0).toLocaleString()} kg
          </div>
        </div>

        <div className="pt-3 border-t border-gray-200">
          <div className="text-xs text-gray-600 mb-1">Tahun 5</div>
          <div className="flex justify-between">
            <span className="text-sm font-semibold text-gray-700">{year5.toLocaleString()} siswa</span>
            <span className={`text-xs font-bold ${year5Gap >= 0 ? 'text-green-600' : 'text-red-600'}`}>
              {year5Gap >= 0 ? '+' : ''}{year5Gap.toFixed(0).toLocaleString()} kg
            </span>
          </div>
        </div>
      </div>
    </div>
  );
}

function YearlyProjectionChart({ data }) {
  const totalCapacity = data.reduce((sum, s) => sum + s.kapasitas, 0);
  const currentDemand = data.reduce((sum, s) => sum + s.kebutuhanHarian, 0);
  const years = [2025, 2026, 2027, 2028, 2029, 2030];
  
  const projections = years.map((year, idx) => ({
    year,
    capacity: totalCapacity,
    conservative: currentDemand * Math.pow(1.03, idx),
    moderate: currentDemand * Math.pow(1.05, idx),
    aggressive: currentDemand * Math.pow(1.08, idx)
  }));

  const maxValue = Math.max(...projections.map(p => Math.max(p.capacity, p.aggressive)));

  return (
    <div className="h-80 flex items-end justify-between gap-2 pb-12">
      {projections.map((proj, idx) => (
        <div key={idx} className="flex-1 flex flex-col items-center">
          <div className="w-full h-full flex items-end justify-center gap-1">
            {/* Capacity line */}
            <div className="relative w-full" style={{ height: '100%' }}>
              <div
                className="absolute bottom-0 w-full border-t-2 border-blue-600 border-dashed"
                style={{ bottom: `${(proj.capacity / maxValue) * 100}%` }}
              />
            </div>
            
            {/* Demand bars */}
            <div className="flex gap-1 items-end w-full">
              <div
                className="flex-1 bg-green-400 rounded-t hover:bg-green-500 transition-colors"
                style={{ height: `${(proj.conservative / maxValue) * 100}%` }}
                title={`Konservatif: ${proj.conservative.toFixed(0)}`}
              />
              <div
                className="flex-1 bg-yellow-400 rounded-t hover:bg-yellow-500 transition-colors"
                style={{ height: `${(proj.moderate / maxValue) * 100}%` }}
                title={`Moderat: ${proj.moderate.toFixed(0)}`}
              />
              <div
                className="flex-1 bg-red-400 rounded-t hover:bg-red-500 transition-colors"
                style={{ height: `${(proj.aggressive / maxValue) * 100}%` }}
                title={`Agresif: ${proj.aggressive.toFixed(0)}`}
              />
            </div>
          </div>
          <div className="text-xs font-semibold text-gray-700 mt-2">{proj.year}</div>
        </div>
      ))}
    </div>
  );
}

function SPPGProjectionCard({ sppg }) {
  const years = [1, 2, 3];
  const growthRate = 0.05; // 5% growth per year
  
  return (
    <div className="border border-gray-200 rounded-xl p-5">
      <h5 className="text-sm font-bold text-gray-900 mb-4">{sppg.nama}</h5>
      <div className="grid grid-cols-4 gap-4">
        <div className="text-center">
          <div className="text-xs text-gray-600 mb-1">Saat Ini</div>
          <div className="text-lg font-bold text-gray-900">{sppg.kebutuhanHarian.toFixed(0)}</div>
          <div className="text-xs text-gray-500">kg/hari</div>
          <div className={`mt-2 text-xs font-bold ${
            sppg.surplus >= 0 ? 'text-green-600' : 'text-red-600'
          }`}>
            {sppg.surplus >= 0 ? 'Surplus' : 'Defisit'}
          </div>
        </div>
        
        {years.map(year => {
          const projectedDemand = sppg.kebutuhanHarian * Math.pow(1 + growthRate, year);
          const projectedGap = sppg.kapasitas - projectedDemand;
          
          return (
            <div key={year} className="text-center">
              <div className="text-xs text-gray-600 mb-1">Tahun {year}</div>
              <div className="text-lg font-bold text-gray-900">{projectedDemand.toFixed(0)}</div>
              <div className="text-xs text-gray-500">kg/hari</div>
              <div className={`mt-2 text-xs font-bold ${
                projectedGap >= 0 ? 'text-green-600' : 'text-red-600'
              }`}>
                {projectedGap >= 0 ? '+' : ''}{projectedGap.toFixed(0)}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

function InvestmentRecommendation({ priority, items }) {
  return (
    <div className="bg-white rounded-lg p-4">
      <div className="flex items-center gap-2 mb-3">
        <div className="w-2 h-2 bg-purple-600 rounded-full"></div>
        <h5 className="font-bold text-gray-900">{priority}</h5>
      </div>
      <ul className="space-y-2">
        {items.map((item, idx) => (
          <li key={idx} className="text-sm text-gray-700 pl-4">
            • {item}
          </li>
        ))}
      </ul>
    </div>
  );
}

      



// ==============================================
// ANALISIS JARAK & WAKTU TEMPUH PAGE - SINTA 1 LEVEL
// ==============================================
function AnalisisJarakPage() {
  const [selectedKecamatan, setSelectedKecamatan] = useState('all');
  const [viewMode, setViewMode] = useState('overview'); // overview, matrix, network, risk
  const [thresholdJarak, setThresholdJarak] = useState(15); // km
  const [thresholdWaktu, setThresholdWaktu] = useState(30); // menit
  const [selectedRoute, setSelectedRoute] = useState(null);

  // Comprehensive distance & time data
  const jarakWaktuData = [
    {
      id: 1,
      sekolah: 'SDN 1 Bandung',
      kecamatan: 'Bandung',
      sppg: 'SPPG Bandung Pusat',
      jarak: 7.2,
      waktu: 18,
      status: 'optimal',
      rute: 'Jl. Raya Bandung → Jl. Merdeka',
      jalanKondisi: 'baik',
      lintasKendala: [],
      alternatif: 1,
      siswa: 245,
      prioritas: 'normal'
    },
    {
      id: 2,
      sekolah: 'MIN 2 Bandung',
      kecamatan: 'Bandung',
      sppg: 'SPPG Bandung Pusat',
      jarak: 12.4,
      waktu: 28,
      status: 'waspada',
      rute: 'Jl. Bandung Utara → Jl. Pasar',
      jalanKondisi: 'sedang',
      lintasKendala: ['Padat pagi'],
      alternatif: 2,
      siswa: 198,
      prioritas: 'medium'
    },
    {
      id: 3,
      sekolah: 'SDN 3 Cimahi',
      kecamatan: 'Cimahi',
      sppg: 'SPPG Cimahi',
      jarak: 5.8,
      waktu: 14,
      status: 'optimal',
      rute: 'Jl. Cimahi → Jl. Industri',
      jalanKondisi: 'baik',
      lintasKendala: [],
      alternatif: 1,
      siswa: 312,
      prioritas: 'normal'
    },
    {
      id: 4,
      sekolah: 'SDN 2 Lembang',
      kecamatan: 'Lembang',
      sppg: 'SPPG Lembang',
      jarak: 16.7,
      waktu: 42,
      status: 'kritis',
      rute: 'Jl. Lembang → Jl. Desa → Jl. Puncak',
      jalanKondisi: 'buruk',
      lintasKendala: ['Jalan rusak', 'Tanjakan'],
      alternatif: 0,
      siswa: 278,
      prioritas: 'high'
    },
    {
      id: 5,
      sekolah: 'MIN 1 Cibeunying',
      kecamatan: 'Cibeunying',
      sppg: 'SPPG Cibeunying',
      jarak: 8.1,
      waktu: 20,
      status: 'optimal',
      rute: 'Jl. Cibeunying → Jl. Raya',
      jalanKondisi: 'baik',
      lintasKendala: [],
      alternatif: 2,
      siswa: 189,
      prioritas: 'normal'
    },
    {
      id: 6,
      sekolah: 'SDN 4 Soreang',
      kecamatan: 'Soreang',
      sppg: 'SPPG Soreang',
      jarak: 11.9,
      waktu: 26,
      status: 'waspada',
      rute: 'Jl. Soreang → Jl. Sentral',
      jalanKondisi: 'sedang',
      lintasKendala: ['Pasar tradisional'],
      alternatif: 1,
      siswa: 156,
      prioritas: 'medium'
    },
    {
      id: 7,
      sekolah: 'SDN 5 Bandung',
      kecamatan: 'Bandung',
      sppg: 'SPPG Bandung Pusat',
      jarak: 6.4,
      waktu: 16,
      status: 'optimal',
      rute: 'Jl. Bandung Timur → Jl. Merdeka',
      jalanKondisi: 'baik',
      lintasKendala: [],
      alternatif: 1,
      siswa: 223,
      prioritas: 'normal'
    },
    {
      id: 8,
      sekolah: 'MIN 3 Lembang',
      kecamatan: 'Lembang',
      sppg: 'SPPG Lembang',
      jarak: 18.2,
      waktu: 48,
      status: 'kritis',
      rute: 'Jl. Lembang Jauh → Jl. Pegunungan',
      jalanKondisi: 'buruk',
      lintasKendala: ['Jalan sempit', 'Tanjakan curam', 'Padat pagi'],
      alternatif: 0,
      siswa: 201,
      prioritas: 'high'
    },
    {
      id: 9,
      sekolah: 'SDN 2 Cibeunying',
      kecamatan: 'Cibeunying',
      sppg: 'SPPG Cibeunying',
      jarak: 9.3,
      waktu: 22,
      status: 'optimal',
      rute: 'Jl. Cibeunying Barat → Jl. Utama',
      jalanKondisi: 'baik',
      lintasKendala: [],
      alternatif: 2,
      siswa: 267,
      prioritas: 'normal'
    },
    {
      id: 10,
      sekolah: 'SDN 1 Cimahi',
      kecamatan: 'Cimahi',
      sppg: 'SPPG Cimahi',
      jarak: 13.1,
      waktu: 30,
      status: 'waspada',
      rute: 'Jl. Cimahi Selatan → Jl. Bypass',
      jalanKondisi: 'sedang',
      lintasKendala: ['Traffic light'],
      alternatif: 1,
      siswa: 289,
      prioritas: 'medium'
    }
  ];

  // Filtering
  const filteredData = jarakWaktuData.filter(item =>
    selectedKecamatan === 'all' || item.kecamatan === selectedKecamatan
  );

  // Statistics
  const stats = {
    totalSekolah: filteredData.length,
    avgJarak: (filteredData.reduce((sum, s) => sum + s.jarak, 0) / filteredData.length).toFixed(1),
    avgWaktu: Math.round(filteredData.reduce((sum, s) => sum + s.waktu, 0) / filteredData.length),
    optimal: filteredData.filter(s => s.status === 'optimal').length,
    waspada: filteredData.filter(s => s.status === 'waspada').length,
    kritis: filteredData.filter(s => s.status === 'kritis').length,
    melebihiThreshold: filteredData.filter(s => s.jarak > thresholdJarak).length,
    perluOptimasi: filteredData.filter(s => s.prioritas === 'high').length
  };

  return (
    <div className="p-6 space-y-6">
      {/* Page Header */}
      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Analisis Jarak & Waktu Tempuh</h2>
          <p className="text-sm text-gray-600 mt-1">
            Network analysis untuk optimasi rute distribusi Makanan Bergizi Gratis
          </p>
        </div>
        <div className="flex gap-2">
          <select 
            value={selectedKecamatan}
            onChange={(e) => setSelectedKecamatan(e.target.value)}
            className="px-4 py-2 border border-gray-300 rounded-xl text-sm font-medium focus:ring-2 focus:ring-blue-500"
          >
            <option value="all">Semua Kecamatan</option>
            <option value="Bandung">Bandung</option>
            <option value="Cimahi">Cimahi</option>
            <option value="Lembang">Lembang</option>
            <option value="Cibeunying">Cibeunying</option>
            <option value="Soreang">Soreang</option>
          </select>
          <button className="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all">
            Export Analisis
          </button>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-6 gap-4">
        <DistanceStatCard
          label="Avg Jarak"
          value={`${stats.avgJarak} km`}
          icon={MapPin}
          color="blue"
        />
        <DistanceStatCard
          label="Avg Waktu"
          value={`${stats.avgWaktu} mnt`}
          icon={Activity}
          color="green"
        />
        <DistanceStatCard
          label="Status Optimal"
          value={stats.optimal}
          icon={Target}
          color="green"
        />
        <DistanceStatCard
          label="Waspada"
          value={stats.waspada}
          icon={AlertTriangle}
          color="yellow"
        />
        <DistanceStatCard
          label="Kritis"
          value={stats.kritis}
          icon={AlertTriangle}
          color="red"
        />
        <DistanceStatCard
          label="Perlu Optimasi"
          value={stats.perluOptimasi}
          icon={TrendingUp}
          color="orange"
        />
      </div>

      {/* Threshold Controls */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center gap-2 mb-4">
          <Settings className="w-5 h-5 text-gray-700" />
          <h3 className="text-lg font-bold text-gray-900">Parameter Threshold</h3>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="text-sm font-semibold text-gray-700 block mb-2">
              Threshold Jarak Maksimal (km)
            </label>
            <div className="flex items-center gap-4">
              <input
                type="range"
                min="10"
                max="20"
                value={thresholdJarak}
                onChange={(e) => setThresholdJarak(Number(e.target.value))}
                className="flex-1"
              />
              <span className="text-2xl font-black text-blue-600 w-16 text-right">{thresholdJarak}</span>
              <span className="text-sm text-gray-600">km</span>
            </div>
            <div className="text-xs text-gray-500 mt-2">
              Sekolah dengan jarak &gt; {thresholdJarak} km dianggap berisiko
            </div>
          </div>
          <div>
            <label className="text-sm font-semibold text-gray-700 block mb-2">
              Threshold Waktu Maksimal (menit)
            </label>
            <div className="flex items-center gap-4">
              <input
                type="range"
                min="20"
                max="45"
                value={thresholdWaktu}
                onChange={(e) => setThresholdWaktu(Number(e.target.value))}
                className="flex-1"
              />
              <span className="text-2xl font-black text-green-600 w-16 text-right">{thresholdWaktu}</span>
              <span className="text-sm text-gray-600">mnt</span>
            </div>
            <div className="text-xs text-gray-500 mt-2">
              Waktu tempuh &gt; {thresholdWaktu} menit berisiko terhadap kualitas makanan
            </div>
          </div>
        </div>
      </div>

      {/* View Mode Tabs */}
      <div className="bg-white rounded-xl border border-gray-200 p-4">
        <div className="flex gap-2 overflow-x-auto">
          <DistanceViewButton 
            label="Overview" 
            value="overview" 
            active={viewMode} 
            onClick={setViewMode}
            icon={BarChart3}
          />
          <DistanceViewButton 
            label="Distance Matrix" 
            value="matrix" 
            active={viewMode} 
            onClick={setViewMode}
            icon={Layers}
          />
          <DistanceViewButton 
            label="Network Routes" 
            value="network" 
            active={viewMode} 
            onClick={setViewMode}
            icon={MapPin}
          />
          <DistanceViewButton 
            label="Risk Assessment" 
            value="risk" 
            active={viewMode} 
            onClick={setViewMode}
            icon={AlertTriangle}
          />
        </div>
      </div>

      {/* Content based on view mode */}
      {viewMode === 'overview' && (
        <DistanceOverviewView 
          data={filteredData}
          stats={stats}
          thresholdJarak={thresholdJarak}
          thresholdWaktu={thresholdWaktu}
          onSelectRoute={setSelectedRoute}
        />
      )}
      {viewMode === 'matrix' && (
        <DistanceMatrixView 
          data={filteredData}
        />
      )}
      {viewMode === 'network' && (
        <NetworkRoutesView 
          data={filteredData}
          onSelectRoute={setSelectedRoute}
        />
      )}
      {viewMode === 'risk' && (
        <RiskAssessmentView 
          data={filteredData}
          thresholdJarak={thresholdJarak}
          thresholdWaktu={thresholdWaktu}
        />
      )}

      {/* Route Detail Modal */}
      {selectedRoute && (
        <RouteDetailModal
          route={selectedRoute}
          onClose={() => setSelectedRoute(null)}
        />
      )}

      {/* Output Info Panel */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-start gap-4">
          <Award className="w-6 h-6 flex-shrink-0 mt-1" />
          <div>
            <h3 className="font-bold text-lg mb-2">Output Modul Analisis Jarak & Waktu Tempuh</h3>
            <p className="text-blue-100 text-sm leading-relaxed mb-3">
              Modul ini menghasilkan: (1) Network analysis komprehensif untuk seluruh rute distribusi MBG,
              (2) Distance matrix antar sekolah dan SPPG dengan estimasi waktu tempuh real-world,
              (3) Identifikasi sekolah berisiko (jarak &gt; threshold) yang memerlukan reassignment SPPG,
              (4) Risk assessment kualitas makanan berdasarkan durasi perjalanan, (5) Rekomendasi optimasi
              rute untuk meminimalkan travel time dan memaksimalkan kualitas pelayanan.
            </p>
            <div className="flex flex-wrap gap-2">
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Network Analysis</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Distance Matrix</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Route Optimization</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Risk Assessment</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Helper Components
function DistanceStatCard({ label, value, icon: Icon, color }) {
  const colors = {
    blue: 'from-blue-600 to-blue-700',
    green: 'from-green-600 to-green-700',
    yellow: 'from-yellow-600 to-yellow-700',
    red: 'from-red-600 to-red-700',
    orange: 'from-orange-600 to-orange-700'
  };

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-4 shadow-sm hover:shadow-md transition-shadow">
      <div className={`w-10 h-10 bg-gradient-to-br ${colors[color]} rounded-xl flex items-center justify-center mb-3 shadow-lg`}>
        <Icon className="w-5 h-5 text-white" />
      </div>
      <div className="text-2xl font-black text-gray-900 mb-1">{value}</div>
      <div className="text-xs font-semibold text-gray-600">{label}</div>
    </div>
  );
}

function DistanceViewButton({ label, value, active, onClick, icon: Icon }) {
  return (
    <button
      onClick={() => onClick(value)}
      className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all whitespace-nowrap ${
        active === value
          ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg'
          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
      }`}
    >
      <Icon className="w-4 h-4" />
      {label}
    </button>
  );
}

// ==============================================
// DISTANCE OVERVIEW VIEW
// ==============================================
function DistanceOverviewView({ data, stats, thresholdJarak, thresholdWaktu, onSelectRoute }) {
  return (
    <div className="space-y-6">
      {/* Distance Distribution Chart */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h3 className="text-lg font-bold text-gray-900">Distribusi Jarak Sekolah ke SPPG</h3>
            <p className="text-xs text-gray-600 mt-1">Klasifikasi berdasarkan threshold {thresholdJarak} km</p>
          </div>
          <div className="flex gap-2">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-green-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">≤ 10 km</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-yellow-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">10-15 km</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 bg-red-500 rounded"></div>
              <span className="text-xs font-semibold text-gray-700">&gt; 15 km</span>
            </div>
          </div>
        </div>
        <DistanceDistributionChart data={data} />
      </div>

      {/* Travel Time Analysis */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-900">Analisis Waktu Tempuh</h3>
          <p className="text-xs text-gray-600 mt-1">Estimasi durasi perjalanan dan risiko keterlambatan</p>
        </div>
        <div className="space-y-4">
          {data.map((route, idx) => (
            <TravelTimeBar key={idx} route={route} thresholdWaktu={thresholdWaktu} onSelect={() => onSelectRoute(route)} />
          ))}
        </div>
      </div>

      {/* Critical Routes Alert */}
      {data.filter(r => r.status === 'kritis').length > 0 && (
        <div className="bg-gradient-to-r from-red-50 to-red-100 rounded-xl p-5 border border-red-200">
          <div className="flex items-start gap-3">
            <AlertTriangle className="w-6 h-6 text-red-700 mt-0.5" />
            <div className="flex-1">
              <h4 className="text-sm font-bold text-red-900 mb-2">
                Peringatan: {data.filter(r => r.status === 'kritis').length} Rute Kritis Terdeteksi
              </h4>
              <ul className="space-y-1 text-xs text-gray-700">
                {data.filter(r => r.status === 'kritis').map((route, idx) => (
                  <li key={idx}>
                    • <span className="font-semibold">{route.sekolah}</span>: {route.jarak} km ({route.waktu} menit) - 
                    {route.lintasKendala.length > 0 ? ` Kendala: ${route.lintasKendala.join(', ')}` : ' Jarak melebihi threshold'}
                  </li>
                ))}
              </ul>
              <button 
                onClick={() => onSelectRoute(data.find(r => r.status === 'kritis'))}
                className="mt-3 px-4 py-2 bg-red-600 text-white rounded-lg text-xs font-semibold hover:bg-red-700 transition-colors"
              >
                Lihat Rekomendasi Optimasi
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Route Summary Table */}
      <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div className="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
          <h3 className="text-lg font-bold text-gray-900">Ringkasan Rute Distribusi</h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50 border-b-2 border-gray-200">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Sekolah</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">SPPG</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Jarak</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Waktu</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Kondisi</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Status</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Aksi</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {data.map((route, idx) => (
                <tr key={idx} className="hover:bg-blue-50 transition-colors">
                  <td className="px-4 py-3">
                    <div className="text-sm font-semibold text-gray-900">{route.sekolah}</div>
                    <div className="text-xs text-gray-600">{route.siswa} siswa</div>
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-700">{route.sppg}</td>
                  <td className="px-4 py-3">
                    <span className={`text-sm font-bold ${
                      route.jarak <= 10 ? 'text-green-600' :
                      route.jarak <= 15 ? 'text-yellow-600' :
                      'text-red-600'
                    }`}>
                      {route.jarak} km
                    </span>
                  </td>
                  <td className="px-4 py-3">
                    <span className={`text-sm font-bold ${
                      route.waktu <= 20 ? 'text-green-600' :
                      route.waktu <= 30 ? 'text-yellow-600' :
                      'text-red-600'
                    }`}>
                      {route.waktu} mnt
                    </span>
                  </td>
                  <td className="px-4 py-3">
                    <span className={`px-2 py-1 rounded text-xs font-semibold ${
                      route.jalanKondisi === 'baik' ? 'bg-green-100 text-green-700' :
                      route.jalanKondisi === 'sedang' ? 'bg-yellow-100 text-yellow-700' :
                      'bg-red-100 text-red-700'
                    }`}>
                      {route.jalanKondisi.toUpperCase()}
                    </span>
                  </td>
                  <td className="px-4 py-3">
                    <span className={`px-3 py-1 rounded-lg text-xs font-bold ${
                      route.status === 'optimal' ? 'bg-green-100 text-green-700' :
                      route.status === 'waspada' ? 'bg-yellow-100 text-yellow-700' :
                      'bg-red-100 text-red-700'
                    }`}>
                      {route.status.toUpperCase()}
                    </span>
                  </td>
                  <td className="px-4 py-3">
                    <button
                      onClick={() => onSelectRoute(route)}
                      className="px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-xs font-semibold transition-colors"
                    >
                      Detail
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Summary Insights */}
      <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-5 border border-blue-200">
        <div className="flex items-start gap-3">
          <Target className="w-5 h-5 text-blue-700 mt-1" />
          <div>
            <h5 className="text-sm font-bold text-blue-900 mb-2">Ringkasan Analisis Jarak & Waktu</h5>
            <ul className="space-y-1 text-xs text-gray-700">
              <li>• Rata-rata jarak: <span className="font-bold">{stats.avgJarak} km</span> (threshold: {thresholdJarak} km)</li>
              <li>• Rata-rata waktu tempuh: <span className="font-bold">{stats.avgWaktu} menit</span> (threshold: {thresholdWaktu} menit)</li>
              <li>• Status optimal: <span className="font-bold text-green-700">{stats.optimal} sekolah</span> ({((stats.optimal / stats.totalSekolah) * 100).toFixed(1)}%)</li>
              <li>• Perlu monitoring: <span className="font-bold text-yellow-700">{stats.waspada} sekolah</span></li>
              <li>• Prioritas tinggi: <span className="font-bold text-red-700">{stats.kritis} sekolah</span> memerlukan reassignment atau optimasi rute</li>
              <li>• Rekomendasi: {stats.kritis > 0 ? 'Evaluasi SPPG alternatif untuk sekolah kritis' : 'Rute distribusi sudah optimal'}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}

// Helper Components for Overview
function DistanceDistributionChart({ data }) {
  const ranges = [
    { label: '0-5 km', min: 0, max: 5, color: 'bg-green-500' },
    { label: '5-10 km', min: 5, max: 10, color: 'bg-green-400' },
    { label: '10-15 km', min: 10, max: 15, color: 'bg-yellow-500' },
    { label: '15-20 km', min: 15, max: 20, color: 'bg-red-500' }
  ];

  const distribution = ranges.map(range => ({
    ...range,
    count: data.filter(d => d.jarak > range.min && d.jarak <= range.max).length
  }));

  const maxCount = Math.max(...distribution.map(d => d.count));

  return (
    <div className="space-y-4">
      {distribution.map((range, idx) => (
        <div key={idx}>
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-semibold text-gray-700">{range.label}</span>
            <div className="flex items-center gap-2">
              <span className="text-sm font-bold text-gray-900">{range.count} sekolah</span>
              <span className="text-xs text-gray-500">({((range.count / data.length) * 100).toFixed(1)}%)</span>
            </div>
          </div>
          <div className="h-8 bg-gray-200 rounded-full overflow-hidden">
            <div 
              className={`h-full ${range.color} flex items-center justify-end px-3`}
              style={{ width: `${(range.count / maxCount) * 100}%` }}
            >
              {range.count > 0 && (
                <span className="text-xs font-bold text-white">{range.count}</span>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}

function TravelTimeBar({ route, thresholdWaktu, onSelect }) {
  const percentage = Math.min((route.waktu / thresholdWaktu) * 100, 100);
  const isOverThreshold = route.waktu > thresholdWaktu;

  return (
    <div className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all cursor-pointer" onClick={onSelect}>
      <div className="flex items-center justify-between mb-3">
        <div>
          <div className="text-sm font-semibold text-gray-900">{route.sekolah}</div>
          <div className="text-xs text-gray-600 mt-1">{route.rute}</div>
        </div>
        <div className="text-right">
          <div className={`text-xl font-black ${
            route.waktu <= 20 ? 'text-green-600' :
            route.waktu <= 30 ? 'text-yellow-600' :
            'text-red-600'
          }`}>
            {route.waktu} mnt
          </div>
          <div className="text-xs text-gray-600">{route.jarak} km</div>
        </div>
      </div>

      <div className="relative h-4 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className={`h-full ${
            route.waktu <= 20 ? 'bg-gradient-to-r from-green-500 to-green-600' :
            route.waktu <= 30 ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' :
            'bg-gradient-to-r from-red-500 to-red-600'
          }`}
          style={{ width: `${percentage}%` }}
        />
        <div 
          className="absolute top-0 bottom-0 w-0.5 bg-gray-700"
          style={{ left: '100%' }}
        />
      </div>

      <div className="flex items-center justify-between mt-2 text-xs text-gray-600">
        <span>Threshold: {thresholdWaktu} menit</span>
        {isOverThreshold && (
          <span className="text-red-600 font-bold">⚠ Melebihi {route.waktu - thresholdWaktu} menit</span>
        )}
      </div>

      {route.lintasKendala.length > 0 && (
        <div className="mt-3 flex flex-wrap gap-1">
          {route.lintasKendala.map((kendala, idx) => (
            <span key={idx} className="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-semibold">
              {kendala}
            </span>
          ))}
        </div>
      )}
    </div>
  );
}

// ==============================================
// DISTANCE MATRIX VIEW
// ==============================================
function DistanceMatrixView({ data }) {
  // Group by SPPG
  const sppgGroups = {};
  data.forEach(route => {
    if (!sppgGroups[route.sppg]) {
      sppgGroups[route.sppg] = [];
    }
    sppgGroups[route.sppg].push(route);
  });

  return (
    <div className="space-y-6">
      {/* Matrix Header */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="mb-4">
          <h3 className="text-lg font-bold text-gray-900">Distance Matrix Analysis</h3>
          <p className="text-xs text-gray-600 mt-1">Matriks jarak komprehensif sekolah ke SPPG terdekat</p>
        </div>

        {/* Legend */}
        <div className="flex gap-4 text-xs">
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-green-100 border border-green-300 rounded"></div>
            <span>Optimal (&lt;10 km)</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-yellow-100 border border-yellow-300 rounded"></div>
            <span>Waspada (10-15 km)</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-red-100 border border-red-300 rounded"></div>
            <span>Kritis (&gt;15 km)</span>
          </div>
        </div>
      </div>

      {/* Matrix by SPPG */}
      {Object.entries(sppgGroups).map(([sppgName, routes], idx) => (
        <div key={idx} className="bg-white rounded-xl border border-gray-200 overflow-hidden">
          <div className="bg-gradient-to-r from-purple-600 to-purple-700 p-4 text-white">
            <div className="flex items-center justify-between">
              <div>
                <h4 className="text-lg font-bold">{sppgName}</h4>
                <p className="text-sm text-purple-100 mt-1">{routes.length} sekolah dilayani</p>
              </div>
              <div className="text-right">
                <div className="text-2xl font-black">
                  {(routes.reduce((sum, r) => sum + r.jarak, 0) / routes.length).toFixed(1)} km
                </div>
                <div className="text-xs text-purple-100">rata-rata jarak</div>
              </div>
            </div>
          </div>

          <div className="p-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {routes.map((route, ridx) => (
                <MatrixCell key={ridx} route={route} />
              ))}
            </div>

            {/* Summary Stats */}
            <div className="mt-6 grid grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg">
              <div className="text-center">
                <div className="text-xs text-gray-600 mb-1">Min Distance</div>
                <div className="text-lg font-bold text-gray-900">
                  {Math.min(...routes.map(r => r.jarak)).toFixed(1)} km
                </div>
              </div>
              <div className="text-center">
                <div className="text-xs text-gray-600 mb-1">Max Distance</div>
                <div className="text-lg font-bold text-gray-900">
                  {Math.max(...routes.map(r => r.jarak)).toFixed(1)} km
                </div>
              </div>
              <div className="text-center">
                <div className="text-xs text-gray-600 mb-1">Avg Travel Time</div>
                <div className="text-lg font-bold text-gray-900">
                  {Math.round(routes.reduce((sum, r) => sum + r.waktu, 0) / routes.length)} min
                </div>
              </div>
              <div className="text-center">
                <div className="text-xs text-gray-600 mb-1">Total Siswa</div>
                <div className="text-lg font-bold text-gray-900">
                  {routes.reduce((sum, r) => sum + r.siswa, 0).toLocaleString()}
                </div>
              </div>
            </div>
          </div>
        </div>
      ))}

      {/* Overall Matrix Summary */}
      <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-5 border border-blue-200">
        <div className="flex items-start gap-3">
          <Layers className="w-5 h-5 text-blue-700 mt-1" />
          <div>
            <h5 className="text-sm font-bold text-blue-900 mb-2">Analisis Distance Matrix</h5>
            <ul className="space-y-1 text-xs text-gray-700">
              <li>• Total rute unik: <span className="font-bold">{data.length} koneksi</span></li>
              <li>• Jarak terpendek: <span className="font-bold text-green-700">{Math.min(...data.map(d => d.jarak)).toFixed(1)} km</span></li>
              <li>• Jarak terjauh: <span className="font-bold text-red-700">{Math.max(...data.map(d => d.jarak)).toFixed(1)} km</span></li>
              <li>• Variance jarak: <span className="font-bold">
                {(data.reduce((sum, d) => sum + Math.pow(d.jarak - (data.reduce((s, x) => s + x.jarak, 0) / data.length), 2), 0) / data.length).toFixed(2)} km²
              </span></li>
              <li>• Rekomendasi: Pertimbangkan realokasi untuk sekolah dengan jarak &gt; 15 km</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}

function MatrixCell({ route }) {
  const getCellColor = () => {
    if (route.jarak <= 10) return 'bg-green-50 border-green-200';
    if (route.jarak <= 15) return 'bg-yellow-50 border-yellow-200';
    return 'bg-red-50 border-red-200';
  };

  return (
    <div className={`${getCellColor()} border rounded-lg p-3 hover:shadow-md transition-all`}>
      <div className="flex items-start justify-between mb-2">
        <div className="flex-1">
          <div className="text-sm font-semibold text-gray-900">{route.sekolah}</div>
          <div className="text-xs text-gray-600 mt-0.5">{route.siswa} siswa</div>
        </div>
        <div className="text-right">
          <div className={`text-lg font-black ${
            route.jarak <= 10 ? 'text-green-700' :
            route.jarak <= 15 ? 'text-yellow-700' :
            'text-red-700'
          }`}>
            {route.jarak}
          </div>
          <div className="text-xs text-gray-600">km</div>
        </div>
      </div>
      <div className="flex items-center justify-between text-xs">
        <span className="text-gray-600">⏱ {route.waktu} menit</span>
        <span className={`px-2 py-0.5 rounded font-semibold ${
          route.jalanKondisi === 'baik' ? 'bg-green-200 text-green-800' :
          route.jalanKondisi === 'sedang' ? 'bg-yellow-200 text-yellow-800' :
          'bg-red-200 text-red-800'
        }`}>
          {route.jalanKondisi}
        </span>
      </div>
    </div>
  );
}
// ==============================================
// NETWORK ROUTES VIEW
// ==============================================
function NetworkRoutesView({ data }) {
  const [selectedRoute, setSelectedRoute] = React.useState(null);

  // Calculate route metrics
  const totalRoutes = data.length;
  const avgDistance = (data.reduce((sum, r) => sum + r.jarak, 0) / data.length).toFixed(1);
  const totalStudents = data.reduce((sum, r) => sum + r.siswa, 0);
  const criticalRoutes = data.filter(r => r.jarak > 15).length;

  return (
    <div className="space-y-6">
      {/* Network Summary */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h3 className="text-lg font-bold text-gray-900 mb-6">Network Overview</h3>
        
        <div className="grid grid-cols-4 gap-6">
          <div className="text-center p-4 bg-blue-50 rounded-lg">
            <div className="text-3xl font-black text-blue-600">{totalRoutes}</div>
            <div className="text-xs text-gray-600 mt-1">Total Routes</div>
          </div>
          <div className="text-center p-4 bg-green-50 rounded-lg">
            <div className="text-3xl font-black text-green-600">{avgDistance}</div>
            <div className="text-xs text-gray-600 mt-1">Avg Distance (km)</div>
          </div>
          <div className="text-center p-4 bg-purple-50 rounded-lg">
            <div className="text-3xl font-black text-purple-600">{totalStudents.toLocaleString()}</div>
            <div className="text-xs text-gray-600 mt-1">Total Students</div>
          </div>
          <div className="text-center p-4 bg-red-50 rounded-lg">
            <div className="text-3xl font-black text-red-600">{criticalRoutes}</div>
            <div className="text-xs text-gray-600 mt-1">Critical Routes</div>
          </div>
        </div>
      </div>

      {/* Routes Table */}
      <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div className="p-6">
          <h3 className="text-lg font-bold text-gray-900 mb-4">All Routes</h3>
          
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="border-b border-gray-200">
                  <th className="text-left text-xs font-semibold text-gray-600 pb-3">Sekolah</th>
                  <th className="text-left text-xs font-semibold text-gray-600 pb-3">SPPG</th>
                  <th className="text-center text-xs font-semibold text-gray-600 pb-3">Jarak</th>
                  <th className="text-center text-xs font-semibold text-gray-600 pb-3">Waktu</th>
                  <th className="text-center text-xs font-semibold text-gray-600 pb-3">Siswa</th>
                  <th className="text-center text-xs font-semibold text-gray-600 pb-3">Kondisi</th>
                  <th className="text-center text-xs font-semibold text-gray-600 pb-3">Action</th>
                </tr>
              </thead>
              <tbody>
                {data.map((route, idx) => (
                  <tr key={idx} className="border-b border-gray-100 hover:bg-gray-50">
                    <td className="py-3 text-sm text-gray-900">{route.sekolah}</td>
                    <td className="py-3 text-sm text-gray-600">{route.sppg}</td>
                    <td className="py-3 text-center">
                      <span className={`text-sm font-bold ${
                        route.jarak <= 10 ? 'text-green-600' :
                        route.jarak <= 15 ? 'text-yellow-600' :
                        'text-red-600'
                      }`}>
                        {route.jarak} km
                      </span>
                    </td>
                    <td className="py-3 text-center text-sm text-gray-600">{route.waktu} min</td>
                    <td className="py-3 text-center text-sm text-gray-900">{route.siswa}</td>
                    <td className="py-3 text-center">
                      <span className={`px-2 py-1 rounded text-xs font-semibold ${
                        route.jalanKondisi === 'baik' ? 'bg-green-100 text-green-700' :
                        route.jalanKondisi === 'sedang' ? 'bg-yellow-100 text-yellow-700' :
                        'bg-red-100 text-red-700'
                      }`}>
                        {route.jalanKondisi}
                      </span>
                    </td>
                    <td className="py-3 text-center">
                      <button
                        onClick={() => setSelectedRoute(route)}
                        className="text-xs text-blue-600 hover:text-blue-800 font-semibold"
                      >
                        Detail
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Modal */}
      {selectedRoute && (
        <RouteDetailModal route={selectedRoute} onClose={() => setSelectedRoute(null)} />
      )}
    </div>
  );
}

// ==============================================
// RISK ASSESSMENT VIEW
// ==============================================
function RiskAssessmentView({ data }) {
  // Calculate risks
  const highRisk = data.filter(r => r.jarak > 15 || r.jalanKondisi === 'buruk');
  const mediumRisk = data.filter(r => (r.jarak > 10 && r.jarak <= 15) || r.jalanKondisi === 'sedang');
  const lowRisk = data.filter(r => r.jarak <= 10 && r.jalanKondisi === 'baik');

  return (
    <div className="space-y-6">
      {/* Risk Summary */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h3 className="text-lg font-bold text-gray-900 mb-6">Risk Assessment Summary</h3>
        
        <div className="grid grid-cols-3 gap-6">
          <div className="border-2 border-red-200 rounded-xl p-5 bg-red-50">
            <div className="text-center">
              <div className="text-4xl font-black text-red-600">{highRisk.length}</div>
              <div className="text-sm font-semibold text-red-900 mt-2">High Risk</div>
              <div className="text-xs text-gray-600 mt-1">
                {((highRisk.length / data.length) * 100).toFixed(0)}% of routes
              </div>
            </div>
          </div>
          
          <div className="border-2 border-yellow-200 rounded-xl p-5 bg-yellow-50">
            <div className="text-center">
              <div className="text-4xl font-black text-yellow-600">{mediumRisk.length}</div>
              <div className="text-sm font-semibold text-yellow-900 mt-2">Medium Risk</div>
              <div className="text-xs text-gray-600 mt-1">
                {((mediumRisk.length / data.length) * 100).toFixed(0)}% of routes
              </div>
            </div>
          </div>
          
          <div className="border-2 border-green-200 rounded-xl p-5 bg-green-50">
            <div className="text-center">
              <div className="text-4xl font-black text-green-600">{lowRisk.length}</div>
              <div className="text-sm font-semibold text-green-900 mt-2">Low Risk</div>
              <div className="text-xs text-gray-600 mt-1">
                {((lowRisk.length / data.length) * 100).toFixed(0)}% of routes
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* High Risk Routes */}
      {highRisk.length > 0 && (
        <div className="bg-white rounded-xl border border-red-200 p-6">
          <div className="flex items-center gap-2 mb-4">
            <AlertTriangle className="w-5 h-5 text-red-600" />
            <h3 className="text-lg font-bold text-red-900">High Risk Routes - Immediate Action Required</h3>
          </div>
          
          <div className="space-y-3">
            {highRisk.map((route, idx) => (
              <div key={idx} className="border border-red-200 rounded-lg p-4 bg-red-50">
                <div className="flex items-start justify-between">
                  <div>
                    <div className="font-bold text-gray-900">{route.sekolah}</div>
                    <div className="text-sm text-gray-600 mt-1">→ {route.sppg}</div>
                  </div>
                  <div className="text-right">
                    <div className="text-lg font-black text-red-600">{route.jarak} km</div>
                    <div className="text-xs text-gray-600">{route.waktu} menit</div>
                  </div>
                </div>
                <div className="mt-3 flex gap-2 text-xs">
                  <span className="px-2 py-1 bg-red-200 text-red-800 rounded font-semibold">
                    {route.jalanKondisi}
                  </span>
                  <span className="px-2 py-1 bg-gray-200 text-gray-800 rounded">
                    {route.siswa} siswa
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Recommendations */}
      <div className="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
        <h4 className="text-lg font-bold text-blue-900 mb-4">Risk Mitigation Recommendations</h4>
        <ul className="space-y-2 text-sm text-gray-700">
          <li>• Prioritize road improvements for routes with "buruk" condition</li>
          <li>• Consider establishing new SPPG locations to reduce high-risk routes</li>
          <li>• Implement regular monitoring for medium-risk routes</li>
          <li>• Develop contingency plans for high-risk routes during emergencies</li>
        </ul>
      </div>
    </div>
  );
}

// ==============================================
// ROUTE DETAIL MODAL
// ==============================================
function RouteDetailModal({ route, onClose }) {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white rounded-t-2xl">
          <div className="flex items-start justify-between">
            <div>
              <h3 className="text-xl font-bold">{route.sekolah}</h3>
              <p className="text-blue-100 text-sm mt-1">Route Details</p>
            </div>
            <button
              onClick={onClose}
              className="text-white hover:text-blue-200 transition-colors"
            >
              <X className="w-6 h-6" />
            </button>
          </div>
        </div>

        {/* Content */}
        <div className="p-6 space-y-6">
          {/* Basic Info */}
          <div className="grid grid-cols-2 gap-4">
            <div className="border border-gray-200 rounded-lg p-4">
              <div className="text-xs text-gray-600 mb-1">SPPG</div>
              <div className="text-lg font-bold text-gray-900">{route.sppg}</div>
            </div>
            <div className="border border-gray-200 rounded-lg p-4">
              <div className="text-xs text-gray-600 mb-1">Jarak</div>
              <div className="text-lg font-bold text-blue-600">{route.jarak} km</div>
            </div>
            <div className="border border-gray-200 rounded-lg p-4">
              <div className="text-xs text-gray-600 mb-1">Waktu Tempuh</div>
              <div className="text-lg font-bold text-gray-900">{route.waktu} menit</div>
            </div>
            <div className="border border-gray-200 rounded-lg p-4">
              <div className="text-xs text-gray-600 mb-1">Jumlah Siswa</div>
              <div className="text-lg font-bold text-gray-900">{route.siswa}</div>
            </div>
          </div>

          {/* Road Condition */}
          <div className="border border-gray-200 rounded-lg p-4">
            <div className="text-xs text-gray-600 mb-2">Kondisi Jalan</div>
            <div className="flex items-center gap-2">
              <span className={`px-3 py-1.5 rounded-lg font-bold ${
                route.jalanKondisi === 'baik' ? 'bg-green-100 text-green-700' :
                route.jalanKondisi === 'sedang' ? 'bg-yellow-100 text-yellow-700' :
                'bg-red-100 text-red-700'
              }`}>
                {route.jalanKondisi.toUpperCase()}
              </span>
            </div>
          </div>

          {/* Risk Assessment */}
          <div className={`rounded-lg p-4 ${
            route.jarak > 15 || route.jalanKondisi === 'buruk' ? 'bg-red-50 border border-red-200' :
            route.jarak > 10 || route.jalanKondisi === 'sedang' ? 'bg-yellow-50 border border-yellow-200' :
            'bg-green-50 border border-green-200'
          }`}>
            <div className="text-xs font-semibold text-gray-600 mb-2">Risk Level</div>
            <div className={`text-lg font-bold ${
              route.jarak > 15 || route.jalanKondisi === 'buruk' ? 'text-red-700' :
              route.jarak > 10 || route.jalanKondisi === 'sedang' ? 'text-yellow-700' :
              'text-green-700'
            }`}>
              {route.jarak > 15 || route.jalanKondisi === 'buruk' ? 'HIGH RISK' :
               route.jarak > 10 || route.jalanKondisi === 'sedang' ? 'MEDIUM RISK' :
               'LOW RISK'}
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="border-t border-gray-200 p-6">
          <button
            onClick={onClose}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
}

// ==============================================
// MODUL OPTIMASI PELAYANAN - PART 9 (SINTA 1 LEVEL)
// ==============================================
function OptimasiPage() {
  const [viewMode, setViewMode] = useState('overview'); // overview, optimization, comparison, recommendations
  const [optimizationParams, setOptimizationParams] = useState({
    maxDistance: 15, // km
    maxTravelTime: 30, // minutes
    minUtilization: 70, // %
    maxUtilization: 90, // %
    priorityWeight: {
      distance: 40,
      capacity: 30,
      quality: 20,
      cost: 10
    }
  });
  const [isOptimizing, setIsOptimizing] = useState(false);
  const [optimizationResult, setOptimizationResult] = useState(null);
  const [selectedScenario, setSelectedScenario] = useState('current');

  // Current state data (before optimization)
  const currentState = {
    totalSekolah: 1247,
    totalSPPG: 5,
    avgDistance: 9.8,
    avgTravelTime: 24,
    avgUtilization: 87.3,
    suboptimalRoutes: 127,
    overloadedSPPG: 2,
    totalCost: 2450000000, // per month
    qualityScore: 78.5,
    equity: {
      giniIndex: 0.32,
      coverage: 91.2
    },
    distribution: {
      optimal: 892,
      suboptimal: 228,
      critical: 127
    }
  };

  // Optimization algorithm
  const runOptimization = () => {
    setIsOptimizing(true);
    
    // Simulate optimization process
    setTimeout(() => {
      const optimizedState = {
        totalSekolah: 1247,
        totalSPPG: 6, // +1 new SPPG recommended
        avgDistance: 7.2,
        avgTravelTime: 18,
        avgUtilization: 78.5,
        suboptimalRoutes: 34,
        overloadedSPPG: 0,
        totalCost: 2680000000, // increased due to new SPPG
        qualityScore: 91.8,
        equity: {
          giniIndex: 0.18,
          coverage: 98.7
        },
        distribution: {
          optimal: 1189,
          suboptimal: 46,
          critical: 12
        },
        improvements: {
          distanceReduction: 26.5, // %
          timeReduction: 25.0, // %
          qualityIncrease: 16.9, // %
          equityIncrease: 43.8, // %
          costIncrease: 9.4 // %
        },
        actions: [
          {
            type: 'new_sppg',
            title: 'Pembangunan SPPG Baru',
            location: 'Kec. Lembang Timur',
            impact: 'Melayani 284 sekolah, mengurangi jarak rata-rata 3.2 km',
            priority: 'high',
            cost: 2500000000,
            timeline: '6-8 bulan'
          },
          {
            type: 'reassignment',
            title: 'Realokasi 47 Sekolah',
            description: 'Reassign ke SPPG terdekat',
            impact: 'Pengurangan waktu tempuh rata-rata 8 menit',
            priority: 'high',
            cost: 0,
            timeline: '1 bulan'
          },
          {
            type: 'capacity',
            title: 'Peningkatan Kapasitas SPPG Soreang',
            description: 'Penambahan 1 shift produksi',
            impact: 'Kapasitas +3000 kg/hari',
            priority: 'medium',
            cost: 250000000,
            timeline: '2 bulan'
          },
          {
            type: 'route',
            title: 'Optimasi 12 Rute Kritis',
            description: 'Perbaikan jalan dan alternatif rute',
            impact: 'Pengurangan waktu tempuh 15-20 menit',
            priority: 'medium',
            cost: 180000000,
            timeline: '3-4 bulan'
          }
        ],
        routeChanges: [
          { sekolah: 'SDN 2 Lembang', from: 'SPPG Lembang', to: 'SPPG Lembang Timur (Baru)', distanceBefore: 16.7, distanceAfter: 5.2 },
          { sekolah: 'MIN 3 Lembang', from: 'SPPG Lembang', to: 'SPPG Lembang Timur (Baru)', distanceBefore: 18.2, distanceAfter: 4.8 },
          { sekolah: 'SDN 4 Soreang', from: 'SPPG Soreang', to: 'SPPG Cibeunying', distanceBefore: 11.9, distanceAfter: 8.3 }
        ]
      };

      setOptimizationResult(optimizedState);
      setIsOptimizing(false);
    }, 2500);
  };

  return (
    <div className="p-6 space-y-6">
      {/* Page Header */}
      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Optimasi Pelayanan MBG</h2>
          <p className="text-sm text-gray-600 mt-1">
            Multi-criteria decision analysis untuk optimalisasi distribusi dan alokasi sumber daya
          </p>
        </div>
        <div className="flex gap-2">
          <button 
            onClick={runOptimization}
            disabled={isOptimizing}
            className={`px-6 py-3 rounded-xl text-sm font-semibold transition-all flex items-center gap-2 ${
              isOptimizing 
                ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                : 'bg-gradient-to-r from-green-600 to-green-700 text-white hover:shadow-lg'
            }`}
          >
            <Target className="w-4 h-4" />
            {isOptimizing ? 'Mengoptimasi...' : 'Jalankan Optimasi'}
          </button>
          {optimizationResult && (
            <button className="px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all">
              Export Hasil
            </button>
          )}
        </div>
      </div>

      {/* Optimization Status */}
      {isOptimizing && (
        <div className="bg-white rounded-xl border border-blue-200 p-6">
          <div className="flex items-center gap-4">
            <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
              <Activity className="w-6 h-6 text-blue-600 animate-spin" />
            </div>
            <div className="flex-1">
              <h3 className="text-lg font-bold text-gray-900 mb-1">Proses Optimasi Berjalan...</h3>
              <p className="text-sm text-gray-600">
                Menganalisis {currentState.totalSekolah} sekolah dan {currentState.totalSPPG} SPPG dengan algoritma multi-objective optimization
              </p>
            </div>
          </div>
          <div className="mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
            <div className="h-full bg-gradient-to-r from-blue-500 to-green-500 animate-pulse" style={{ width: '100%' }}></div>
          </div>
        </div>
      )}

      {/* Current State Summary */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center gap-2 mb-4">
          <BarChart3 className="w-5 h-5 text-gray-700" />
          <h3 className="text-lg font-bold text-gray-900">Status Pelayanan Saat Ini</h3>
        </div>
        
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <CurrentStateCard
            label="Avg Jarak"
            value={`${currentState.avgDistance} km`}
            status={currentState.avgDistance > 10 ? 'warning' : 'good'}
            icon={MapPin}
          />
          <CurrentStateCard
            label="Avg Waktu"
            value={`${currentState.avgTravelTime} mnt`}
            status={currentState.avgTravelTime > 25 ? 'warning' : 'good'}
            icon={Activity}
          />
          <CurrentStateCard
            label="Utilisasi"
            value={`${currentState.avgUtilization}%`}
            status={currentState.avgUtilization > 85 ? 'warning' : 'good'}
            icon={TrendingUp}
          />
          <CurrentStateCard
            label="Quality Score"
            value={currentState.qualityScore.toFixed(1)}
            status={currentState.qualityScore < 80 ? 'warning' : 'good'}
            icon={Award}
          />
        </div>

        <div className="mt-4 grid grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
          <div className="text-center">
            <div className="text-2xl font-black text-green-600">{currentState.distribution.optimal}</div>
            <div className="text-xs text-gray-600 mt-1">Optimal</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-black text-yellow-600">{currentState.distribution.suboptimal}</div>
            <div className="text-xs text-gray-600 mt-1">Suboptimal</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-black text-red-600">{currentState.distribution.critical}</div>
            <div className="text-xs text-gray-600 mt-1">Kritis</div>
          </div>
        </div>
      </div>

      {/* Optimization Parameters */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center gap-2 mb-6">
          <Settings className="w-5 h-5 text-gray-700" />
          <h3 className="text-lg font-bold text-gray-900">Parameter Optimasi</h3>
        </div>

        <div className="space-y-6">
          {/* Distance Threshold */}
          <OptimizationSlider
            label="Threshold Jarak Maksimal"
            value={optimizationParams.maxDistance}
            onChange={(val) => setOptimizationParams(prev => ({ ...prev, maxDistance: val }))}
            min={10}
            max={20}
            unit="km"
            description="Batas maksimal jarak sekolah ke SPPG"
          />

          {/* Travel Time Threshold */}
          <OptimizationSlider
            label="Threshold Waktu Tempuh"
            value={optimizationParams.maxTravelTime}
            onChange={(val) => setOptimizationParams(prev => ({ ...prev, maxTravelTime: val }))}
            min={20}
            max={45}
            unit="menit"
            description="Batas maksimal waktu perjalanan untuk menjaga kualitas"
          />

          {/* Utilization Range */}
          <div>
            <label className="text-sm font-semibold text-gray-700 block mb-3">
              Target Range Utilisasi SPPG
            </label>
            <div className="grid grid-cols-2 gap-4">
              <OptimizationSlider
                label="Minimum"
                value={optimizationParams.minUtilization}
                onChange={(val) => setOptimizationParams(prev => ({ ...prev, minUtilization: val }))}
                min={60}
                max={80}
                unit="%"
                description="Utilisasi minimum untuk efisiensi"
              />
              <OptimizationSlider
                label="Maksimum"
                value={optimizationParams.maxUtilization}
                onChange={(val) => setOptimizationParams(prev => ({ ...prev, maxUtilization: val }))}
                min={80}
                max={95}
                unit="%"
                description="Utilisasi maksimum untuk menghindari overload"
              />
            </div>
          </div>

          {/* Priority Weights */}
          <div>
            <label className="text-sm font-semibold text-gray-700 block mb-3">
              Bobot Prioritas Kriteria (Total: 100%)
            </label>
            <div className="grid grid-cols-2 gap-4">
              <PriorityWeightSlider
                label="Jarak & Waktu"
                value={optimizationParams.priorityWeight.distance}
                onChange={(val) => setOptimizationParams(prev => ({
                  ...prev,
                  priorityWeight: { ...prev.priorityWeight, distance: val }
                }))}
                color="blue"
              />
              <PriorityWeightSlider
                label="Kapasitas"
                value={optimizationParams.priorityWeight.capacity}
                onChange={(val) => setOptimizationParams(prev => ({
                  ...prev,
                  priorityWeight: { ...prev.priorityWeight, capacity: val }
                }))}
                color="purple"
              />
              <PriorityWeightSlider
                label="Kualitas"
                value={optimizationParams.priorityWeight.quality}
                onChange={(val) => setOptimizationParams(prev => ({
                  ...prev,
                  priorityWeight: { ...prev.priorityWeight, quality: val }
                }))}
                color="green"
              />
              <PriorityWeightSlider
                label="Biaya"
                value={optimizationParams.priorityWeight.cost}
                onChange={(val) => setOptimizationParams(prev => ({
                  ...prev,
                  priorityWeight: { ...prev.priorityWeight, cost: val }
                }))}
                color="orange"
              />
            </div>
            <div className="mt-3 p-3 bg-gray-50 rounded-lg">
              <div className="text-xs text-gray-600">
                Total Bobot: <span className="font-bold text-gray-900">
                  {Object.values(optimizationParams.priorityWeight).reduce((a, b) => a + b, 0)}%
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Optimization Results */}
      {optimizationResult && (
        <>
          {/* Improvement Summary */}
          <div className="bg-gradient-to-r from-green-600 to-green-700 rounded-xl p-6 text-white shadow-xl">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                <Award className="w-6 h-6" />
              </div>
              <div>
                <h3 className="text-xl font-bold">Hasil Optimasi</h3>
                <p className="text-green-100 text-sm">Peningkatan signifikan pada seluruh metrik pelayanan</p>
              </div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
              <ImprovementCard
                label="Jarak"
                value={`-${optimizationResult.improvements.distanceReduction}%`}
                icon="↓"
              />
              <ImprovementCard
                label="Waktu"
                value={`-${optimizationResult.improvements.timeReduction}%`}
                icon="↓"
              />
              <ImprovementCard
                label="Kualitas"
                value={`+${optimizationResult.improvements.qualityIncrease}%`}
                icon="↑"
              />
              <ImprovementCard
                label="Pemerataan"
                value={`+${optimizationResult.improvements.equityIncrease}%`}
                icon="↑"
              />
              <ImprovementCard
                label="Biaya"
                value={`+${optimizationResult.improvements.costIncrease}%`}
                icon="↑"
              />
            </div>
          </div>

          {/* Before vs After Comparison */}
          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-6">Perbandingan: Sebelum vs Sesudah Optimasi</h3>
            
            <div className="space-y-6">
              <ComparisonMetric
                label="Rata-rata Jarak"
                before={currentState.avgDistance}
                after={optimizationResult.avgDistance}
                unit="km"
                better="lower"
              />
              <ComparisonMetric
                label="Rata-rata Waktu Tempuh"
                before={currentState.avgTravelTime}
                after={optimizationResult.avgTravelTime}
                unit="menit"
                better="lower"
              />
              <ComparisonMetric
                label="Utilisasi SPPG"
                before={currentState.avgUtilization}
                after={optimizationResult.avgUtilization}
                unit="%"
                better="optimal"
                optimal={80}
              />
              <ComparisonMetric
                label="Quality Score"
                before={currentState.qualityScore}
                after={optimizationResult.qualityScore}
                unit="poin"
                better="higher"
              />
              <ComparisonMetric
                label="Gini Index (Pemerataan)"
                before={currentState.equity.giniIndex}
                after={optimizationResult.equity.giniIndex}
                unit=""
                better="lower"
                decimals={2}
              />
            </div>
          </div>

          {/* Distribution Comparison */}
          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-6">Distribusi Status Pelayanan</h3>
            
            <div className="grid grid-cols-2 gap-6">
              <div>
                <h4 className="text-sm font-semibold text-gray-700 mb-4">Sebelum Optimasi</h4>
                <DistributionChart data={currentState.distribution} />
              </div>
              <div>
                <h4 className="text-sm font-semibold text-gray-700 mb-4">Sesudah Optimasi</h4>
                <DistributionChart data={optimizationResult.distribution} />
              </div>
            </div>

            <div className="mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
              <div className="flex items-start gap-2">
                <TrendingUp className="w-5 h-5 text-green-700 mt-0.5" />
                <div>
                  <div className="text-sm font-bold text-green-900 mb-1">Peningkatan Signifikan</div>
                  <div className="text-xs text-gray-700">
                    Status optimal meningkat dari {currentState.distribution.optimal} menjadi {optimizationResult.distribution.optimal} sekolah 
                    (+{optimizationResult.distribution.optimal - currentState.distribution.optimal} sekolah atau +{(((optimizationResult.distribution.optimal - currentState.distribution.optimal) / currentState.distribution.optimal) * 100).toFixed(1)}%)
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Recommended Actions */}
          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-6">Rekomendasi Aksi</h3>
            
            <div className="space-y-4">
              {optimizationResult.actions.map((action, idx) => (
                <ActionCard key={idx} action={action} index={idx + 1} />
              ))}
            </div>

            <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
              <div className="flex items-start gap-3">
                <Target className="w-5 h-5 text-blue-700 mt-0.5" />
                <div>
                  <div className="text-sm font-bold text-blue-900 mb-2">Prioritas Implementasi</div>
                  <ol className="space-y-1 text-xs text-gray-700">
                    <li>1. Realokasi 47 sekolah (dapat dilakukan segera, tanpa biaya)</li>
                    <li>2. Pembangunan SPPG baru di Lembang Timur (dampak terbesar)</li>
                    <li>3. Peningkatan kapasitas SPPG Soreang (menurunkan overload)</li>
                    <li>4. Optimasi rute kritis (perbaikan jalan akses)</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>

          {/* Route Changes Detail */}
          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-6">Perubahan Rute (Sample)</h3>
            
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b-2 border-gray-200">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Sekolah</th>
                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">SPPG Lama</th>
                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">SPPG Baru</th>
                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Jarak Lama</th>
                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Jarak Baru</th>
                    <th className="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase">Improvement</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {optimizationResult.routeChanges.map((change, idx) => (
                    <tr key={idx} className="hover:bg-green-50 transition-colors">
                      <td className="px-4 py-3 text-sm font-semibold text-gray-900">{change.sekolah}</td>
                      <td className="px-4 py-3 text-sm text-gray-700">{change.from}</td>
                      <td className="px-4 py-3 text-sm text-blue-700 font-semibold">{change.to}</td>
                      <td className="px-4 py-3 text-sm text-red-600 font-bold">{change.distanceBefore} km</td>
                      <td className="px-4 py-3 text-sm text-green-600 font-bold">{change.distanceAfter} km</td>
                      <td className="px-4 py-3">
                        <span className="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs font-bold">
                          -{((change.distanceBefore - change.distanceAfter) / change.distanceBefore * 100).toFixed(1)}%
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="mt-4 text-xs text-gray-600 text-center">
              Menampilkan 3 dari {optimizationResult.actions.find(a => a.type === 'reassignment')?.description.match(/\d+/)?.[0] || 0} perubahan rute yang direkomendasikan
            </div>
          </div>

          {/* Cost-Benefit Analysis */}
          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-6">Analisis Biaya-Manfaat</h3>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h4 className="text-sm font-semibold text-gray-700 mb-4">Biaya Implementasi</h4>
                <div className="space-y-3">
                  {optimizationResult.actions.map((action, idx) => (
                    <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-700">{action.title}</div>
                      <div className="text-sm font-bold text-gray-900">
                        Rp {(action.cost / 1000000).toFixed(0)}M
                      </div>
                    </div>
                  ))}
                  <div className="flex items-center justify-between p-3 bg-blue-100 rounded-lg border border-blue-200">
                    <div className="text-sm font-bold text-blue-900">Total Investasi</div>
                    <div className="text-lg font-black text-blue-900">
                      Rp {(optimizationResult.actions.reduce((sum, a) => sum + a.cost, 0) / 1000000).toFixed(0)}M
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <h4 className="text-sm font-semibold text-gray-700 mb-4">Manfaat yang Diperoleh</h4>
                <div className="space-y-3">
                  <BenefitItem
                    label="Peningkatan Kualitas Pelayanan"
                    value={`+${optimizationResult.improvements.qualityIncrease}%`}
                    impact="high"
                  />
                  <BenefitItem
                    label="Pengurangan Jarak Distribusi"
                    value={`-${optimizationResult.improvements.distanceReduction}%`}
                    impact="high"
                  />
                  <BenefitItem
                    label="Pemerataan Layanan"
                    value={`+${optimizationResult.improvements.equityIncrease}%`}
                    impact="high"
                  />
                  <BenefitItem
                    label="Efisiensi Utilisasi SPPG"
                    value="Optimal"
                    impact="medium"
                  />
                  <BenefitItem
                    label="Cakupan Layanan"
                    value={`${optimizationResult.equity.coverage}%`}
                    impact="medium"
                  />
                </div>
              </div>
            </div>

            <div className="mt-6 p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-lg border border-green-200">
              <div className="flex items-start gap-3">
                <Award className="w-5 h-5 text-green-700 mt-0.5" />
                <div>
                  <div className="text-sm font-bold text-green-900 mb-2">Return on Investment (ROI)</div>
                  <div className="text-xs text-gray-700 leading-relaxed">
                    Investasi total Rp {(optimizationResult.actions.reduce((sum, a) => sum + a.cost, 0) / 1000000000).toFixed(2)} miliar 
                    akan menghasilkan peningkatan kualitas pelayanan sebesar {optimizationResult.improvements.qualityIncrease}% dan 
                    menjangkau {(optimizationResult.equity.coverage - currentState.equity.coverage).toFixed(1)}% siswa tambahan.
                    Estimasi ROI tercapai dalam 18-24 bulan melalui efisiensi operasional dan peningkatan outcome gizi siswa.
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Implementation Timeline */}
          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-6">Timeline Implementasi</h3>
            
            <div className="space-y-4">
              {optimizationResult.actions.map((action, idx) => (
                <TimelineItem key={idx} action={action} index={idx} />
              ))}
            </div>
          </div>
        </>
      )}

      {/* Output Info Panel */}
      <div className="bg-gradient-to-r from-green-600 to-green-700 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-start gap-4">
          <Award className="w-6 h-6 flex-shrink-0 mt-1" />
          <div>
            <h3 className="font-bold text-lg mb-2">Output Modul Optimasi Pelayanan</h3>
            <p className="text-green-100 text-sm leading-relaxed mb-3">
              Modul ini menghasilkan: (1) Multi-criteria decision analysis dengan optimasi simultan jarak, kapasitas, kualitas, dan biaya,
              (2) Rekomendasi aksi konkret (pembangunan SPPG baru, realokasi sekolah, peningkatan kapasitas),
              (3) Analisis before-after dengan visualisasi improvement pada seluruh metrik,
              (4) Cost-benefit analysis untuk mendukung pengambilan keputusan investasi,
              (5) Implementation roadmap dengan prioritas dan timeline yang jelas untuk eksekusi optimal.
            </p>
            <div className="flex flex-wrap gap-2">
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Multi-Objective Optimization</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Decision Support</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Cost-Benefit Analysis</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Implementation Planning</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ==============================================
// HELPER COMPONENTS FOR OPTIMIZATION MODULE
// ==============================================
function CurrentStateCard({ label, value, status, icon: Icon }) {
  const statusColors = {
    good: 'bg-green-50 border-green-200 text-green-700',
    warning: 'bg-yellow-50 border-yellow-200 text-yellow-700',
    critical: 'bg-red-50 border-red-200 text-red-700'
  };

  return (
    <div className={`${statusColors[status]} border rounded-xl p-4`}>
      <div className="flex items-center gap-2 mb-2">
        <Icon className="w-4 h-4" />
        <span className="text-xs font-semibold">{label}</span>
      </div>
      <div className="text-2xl font-black">{value}</div>
    </div>
  );
}

function OptimizationSlider({ label, value, onChange, min, max, unit, description }) {
  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <label className="text-sm font-semibold text-gray-700">{label}</label>
        <div className="flex items-center gap-2">
          <span className="text-2xl font-black text-blue-600">{value}</span>
          <span className="text-sm text-gray-600">{unit}</span>
        </div>
      </div>
      <input
        type="range"
        min={min}
        max={max}
        value={value}
        onChange={(e) => onChange(Number(e.target.value))}
        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
      />
      <p className="text-xs text-gray-500 mt-2">{description}</p>
    </div>
  );
}

function PriorityWeightSlider({ label, value, onChange, color }) {
  const colors = {
    blue: 'accent-blue-600',
    purple: 'accent-purple-600',
    green: 'accent-green-600',
    orange: 'accent-orange-600'
  };

  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <label className="text-sm font-semibold text-gray-700">{label}</label>
        <span className="text-lg font-black text-gray-900">{value}%</span>
      </div>
      <input
        type="range"
        min={0}
        max={50}
        value={value}
        onChange={(e) => onChange(Number(e.target.value))}
        className={`w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer ${colors[color]}`}
      />
    </div>
  );
}

function ImprovementCard({ label, value, icon }) {
  return (
    <div className="bg-white bg-opacity-20 rounded-lg p-3 text-center">
      <div className="text-3xl font-black mb-1">{icon} {value}</div>
      <div className="text-xs text-green-100">{label}</div>
    </div>
  );
}

function ComparisonMetric({ label, before, after, unit, better, optimal, decimals = 1 }) {
  const improvement = better === 'lower' 
    ? ((before - after) / before * 100)
    : better === 'higher'
    ? ((after - before) / before * 100)
    : null;

  const isImproved = better === 'optimal' 
    ? Math.abs(after - optimal) < Math.abs(before - optimal)
    : improvement > 0;

  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <span className="text-sm font-semibold text-gray-700">{label}</span>
        {improvement !== null && (
          <span className={`text-sm font-bold ${isImproved ? 'text-green-600' : 'text-red-600'}`}>
            {isImproved ? '↓' : '↑'} {Math.abs(improvement).toFixed(1)}%
          </span>
        )}
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-red-50 border border-red-200 rounded-lg p-3">
          <div className="text-xs text-gray-600 mb-1">Sebelum</div>
          <div className="text-xl font-black text-red-700">
            {typeof before === 'number' ? before.toFixed(decimals) : before} {unit}
          </div>
        </div>
        <div className="bg-green-50 border border-green-200 rounded-lg p-3">
          <div className="text-xs text-gray-600 mb-1">Sesudah</div>
          <div className="text-xl font-black text-green-700">
            {typeof after === 'number' ? after.toFixed(decimals) : after} {unit}
          </div>
        </div>
      </div>
    </div>
  );
}

function DistributionChart({ data }) {
  const total = data.optimal + data.suboptimal + data.critical;
  const percentages = {
    optimal: (data.optimal / total) * 100,
    suboptimal: (data.suboptimal / total) * 100,
    critical: (data.critical / total) * 100
  };

  return (
    <div>
      <div className="h-8 flex rounded-lg overflow-hidden border-2 border-gray-200 mb-4">
        <div 
          className="bg-green-500 flex items-center justify-center text-white text-xs font-bold"
          style={{ width: `${percentages.optimal}%` }}
        >
          {data.optimal > 0 && data.optimal}
        </div>
        <div 
          className="bg-yellow-500 flex items-center justify-center text-white text-xs font-bold"
          style={{ width: `${percentages.suboptimal}%` }}
        >
          {data.suboptimal > 0 && data.suboptimal}
        </div>
        <div 
          className="bg-red-500 flex items-center justify-center text-white text-xs font-bold"
          style={{ width: `${percentages.critical}%` }}
        >
          {data.critical > 0 && data.critical}
        </div>
      </div>

      <div className="space-y-2 text-xs">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 bg-green-500 rounded"></div>
            <span className="text-gray-700">Optimal</span>
          </div>
          <span className="font-bold text-gray-900">{data.optimal} ({percentages.optimal.toFixed(1)}%)</span>
        </div>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 bg-yellow-500 rounded"></div>
            <span className="text-gray-700">Suboptimal</span>
          </div>
          <span className="font-bold text-gray-900">{data.suboptimal} ({percentages.suboptimal.toFixed(1)}%)</span>
        </div>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 bg-red-500 rounded"></div>
            <span className="text-gray-700">Kritis</span>
          </div>
          <span className="font-bold text-gray-900">{data.critical} ({percentages.critical.toFixed(1)}%)</span>
        </div>
      </div>
    </div>
  );
}

function ActionCard({ action, index }) {
  const priorityColors = {
    high: 'border-red-200 bg-red-50',
    medium: 'border-yellow-200 bg-yellow-50',
    low: 'border-blue-200 bg-blue-50'
  };

  const typeIcons = {
    new_sppg: '🏗️',
    reassignment: '🔄',
    capacity: '📈',
    route: '🛣️'
  };

  return (
    <div className={`${priorityColors[action.priority]} border-2 rounded-xl p-5`}>
      <div className="flex items-start gap-4">
        <div className="text-4xl">{typeIcons[action.type]}</div>
        <div className="flex-1">
          <div className="flex items-center gap-3 mb-2">
            <span className="text-lg font-bold text-gray-900">#{index}</span>
            <h4 className="text-lg font-bold text-gray-900">{action.title}</h4>
            <span className={`px-3 py-1 rounded-lg text-xs font-bold ${
              action.priority === 'high' ? 'bg-red-200 text-red-800' :
              action.priority === 'medium' ? 'bg-yellow-200 text-yellow-800' :
              'bg-blue-200 text-blue-800'
            }`}>
              {action.priority.toUpperCase()}
            </span>
          </div>
          
          {action.description && (
            <p className="text-sm text-gray-700 mb-3">{action.description}</p>
          )}
          {action.location && (
            <p className="text-sm text-gray-700 mb-3">📍 {action.location}</p>
          )}
          
          <div className="bg-white bg-opacity-60 rounded-lg p-3 mb-3">
            <div className="text-xs font-semibold text-gray-700 mb-1">Dampak:</div>
            <div className="text-sm text-gray-900">{action.impact}</div>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div className="bg-white bg-opacity-60 rounded-lg p-2">
              <div className="text-xs text-gray-600">Biaya</div>
              <div className="text-sm font-bold text-gray-900">
                Rp {(action.cost / 1000000).toFixed(0)}M
              </div>
            </div>
            <div className="bg-white bg-opacity-60 rounded-lg p-2">
              <div className="text-xs text-gray-600">Timeline</div>
              <div className="text-sm font-bold text-gray-900">{action.timeline}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function BenefitItem({ label, value, impact }) {
  const impactColors = {
    high: 'bg-green-100 border-green-300',
    medium: 'bg-blue-100 border-blue-300',
    low: 'bg-gray-100 border-gray-300'
  };

  return (
    <div className={`${impactColors[impact]} border rounded-lg p-3 flex items-center justify-between`}>
      <span className="text-sm text-gray-700">{label}</span>
      <span className="text-sm font-bold text-gray-900">{value}</span>
    </div>
  );
}

function TimelineItem({ action, index }) {
  return (
    <div className="flex items-start gap-4">
      <div className="flex flex-col items-center">
        <div className="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
          {index + 1}
        </div>
        {index < 3 && <div className="w-0.5 h-16 bg-blue-300"></div>}
      </div>
      <div className="flex-1 pb-6">
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <div className="flex items-center justify-between mb-2">
            <h5 className="font-bold text-gray-900">{action.title}</h5>
            <span className="text-xs font-semibold text-blue-600">{action.timeline}</span>
          </div>
          <p className="text-sm text-gray-600">{action.impact}</p>
        </div>
      </div>
    </div>
  );
}


// ==============================================
// MODUL SIMULASI WHAT-IF ANALYSIS - PART 10 (SINTA 1 LEVEL)
// ==============================================
function SimulasiPage() {
  const [simulationMode, setSimulationMode] = useState('single'); // single, comparison, scenario
  const [activeScenario, setActiveScenario] = useState('scenario1');
  const [savedScenarios, setSavedScenarios] = useState([]);
  const [isSimulating, setIsSimulating] = useState(false);
  
  // Base data (current state)
  const baseData = {
    totalSekolah: 1247,
    totalSiswa: 47891,
    totalSPPG: 5,
    totalPekerja: 118,
    kapasitasProduksi: 69000,
    produksiAktual: 60150,
    utilisasi: 87.2,
    avgJarak: 9.8,
    avgWaktu: 24,
    qualityScore: 78.5,
    biayaBulanan: 2450000000
  };

  // Simulation parameters
  const [scenarios, setScenarios] = useState({
    scenario1: {
      name: 'Skenario 1',
      siswaGrowth: 0, // percentage
      pekerjaTambahan: 0,
      sppgBaru: 0,
      kapasitasUpgrade: 0, // percentage
      waktuOperasional: 0, // additional hours
      color: 'blue'
    },
    scenario2: {
      name: 'Skenario 2',
      siswaGrowth: 0,
      pekerjaTambahan: 0,
      sppgBaru: 0,
      kapasitasUpgrade: 0,
      waktuOperasional: 0,
      color: 'green'
    },
    scenario3: {
      name: 'Skenario 3',
      siswaGrowth: 0,
      pekerjaTambahan: 0,
      sppgBaru: 0,
      kapasitasUpgrade: 0,
      waktuOperasional: 0,
      color: 'purple'
    }
  });

  // Calculate simulated results
  const calculateSimulation = (scenario) => {
    const siswaNew = baseData.totalSiswa * (1 + scenario.siswaGrowth / 100);
    const pekerjaNew = baseData.totalPekerja + scenario.pekerjaTambahan;
    const sppgNew = baseData.totalSPPG + scenario.sppgBaru;
    const kapasitasNew = baseData.kapasitasProduksi * (1 + scenario.kapasitasUpgrade / 100) + (scenario.sppgBaru * 12000);
    const produksiNew = Math.min(kapasitasNew, siswaNew * 0.5); // 0.5 kg per siswa
    const utilisasiNew = (produksiNew / kapasitasNew) * 100;
    
    // Calculate improvements
    const jarakImprovement = scenario.sppgBaru > 0 ? Math.random() * 15 + 10 : 0; // 10-25% improvement
    const waktuImprovement = scenario.sppgBaru > 0 ? Math.random() * 12 + 8 : 0; // 8-20% improvement
    const qualityImprovement = (scenario.kapasitasUpgrade / 10) + (scenario.pekerjaTambahan / 5) + (scenario.sppgBaru * 3);
    
    const avgJarakNew = baseData.avgJarak * (1 - jarakImprovement / 100);
    const avgWaktuNew = baseData.avgWaktu * (1 - waktuImprovement / 100);
    const qualityScoreNew = Math.min(100, baseData.qualityScore + qualityImprovement);
    
    // Calculate costs
    const biayaPekerja = scenario.pekerjaTambahan * 5000000; // 5 juta per pekerja per bulan
    const biayaSPPG = scenario.sppgBaru * 15000000; // 15 juta operational per SPPG per bulan
    const biayaUpgrade = (scenario.kapasitasUpgrade / 100) * 500000000; // upgrade cost
    const biayaBulananNew = baseData.biayaBulanan + biayaPekerja + biayaSPPG + biayaUpgrade;
    
    return {
      totalSekolah: baseData.totalSekolah,
      totalSiswa: Math.round(siswaNew),
      totalSPPG: sppgNew,
      totalPekerja: pekerjaNew,
      kapasitasProduksi: Math.round(kapasitasNew),
      produksiAktual: Math.round(produksiNew),
      utilisasi: utilisasiNew,
      avgJarak: avgJarakNew,
      avgWaktu: Math.round(avgWaktuNew),
      qualityScore: qualityScoreNew,
      biayaBulanan: biayaBulananNew,
      improvements: {
        siswa: ((siswaNew - baseData.totalSiswa) / baseData.totalSiswa * 100),
        kapasitas: ((kapasitasNew - baseData.kapasitasProduksi) / baseData.kapasitasProduksi * 100),
        utilisasi: utilisasiNew - baseData.utilisasi,
        jarak: -jarakImprovement,
        waktu: -waktuImprovement,
        quality: qualityScoreNew - baseData.qualityScore,
        biaya: ((biayaBulananNew - baseData.biayaBulanan) / baseData.biayaBulanan * 100)
      }
    };
  };

  const runSimulation = () => {
    setIsSimulating(true);
    setTimeout(() => {
      setIsSimulating(false);
    }, 1500);
  };

  const saveScenario = (scenarioKey) => {
    const scenario = {
      id: Date.now(),
      name: scenarios[scenarioKey].name,
      timestamp: new Date().toISOString(),
      params: scenarios[scenarioKey],
      results: calculateSimulation(scenarios[scenarioKey])
    };
    setSavedScenarios(prev => [...prev, scenario]);
  };

  const resetScenario = (scenarioKey) => {
    setScenarios(prev => ({
      ...prev,
      [scenarioKey]: {
        ...prev[scenarioKey],
        siswaGrowth: 0,
        pekerjaTambahan: 0,
        sppgBaru: 0,
        kapasitasUpgrade: 0,
        waktuOperasional: 0
      }
    }));
  };

  return (
    <div className="p-6 space-y-6">
      {/* Page Header */}
      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Simulasi What-If Analysis</h2>
          <p className="text-sm text-gray-600 mt-1">
            Analisis dampak perubahan parameter terhadap kinerja sistem pelayanan MBG
          </p>
        </div>
        <div className="flex gap-2">
          <button 
            onClick={runSimulation}
            disabled={isSimulating}
            className={`px-6 py-3 rounded-xl text-sm font-semibold transition-all flex items-center gap-2 ${
              isSimulating 
                ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                : 'bg-gradient-to-r from-blue-600 to-blue-700 text-white hover:shadow-lg'
            }`}
          >
            <Activity className="w-4 h-4" />
            {isSimulating ? 'Mensimulasi...' : 'Jalankan Simulasi'}
          </button>
          <button className="px-4 py-3 border border-gray-300 rounded-xl text-sm font-semibold hover:bg-gray-50 transition-colors">
            Export Hasil
          </button>
        </div>
      </div>

      {/* Simulation Mode Selector */}
      <div className="bg-white rounded-xl border border-gray-200 p-4">
        <div className="flex gap-2">
          <SimulationModeButton
            label="Single Scenario"
            value="single"
            active={simulationMode}
            onClick={setSimulationMode}
            icon={Target}
            description="Simulasi satu skenario"
          />
          <SimulationModeButton
            label="Comparison"
            value="comparison"
            active={simulationMode}
            onClick={setSimulationMode}
            icon={BarChart3}
            description="Bandingkan 3 skenario"
          />
          <SimulationModeButton
            label="Saved Scenarios"
            value="scenario"
            active={simulationMode}
            onClick={setSimulationMode}
            icon={BookOpen}
            description={`${savedScenarios.length} tersimpan`}
          />
        </div>
      </div>

      {/* Current State Display */}
      <div className="bg-gradient-to-r from-gray-600 to-gray-700 rounded-xl p-6 text-white">
        <div className="flex items-center gap-3 mb-4">
          <div className="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
            <Database className="w-6 h-6" />
          </div>
          <div>
            <h3 className="text-xl font-bold">Status Saat Ini (Baseline)</h3>
            <p className="text-gray-200 text-sm">Data aktual sistem sebelum simulasi</p>
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
          <BaselineMetric label="Siswa" value={baseData.totalSiswa.toLocaleString()} />
          <BaselineMetric label="SPPG" value={baseData.totalSPPG} />
          <BaselineMetric label="Pekerja" value={baseData.totalPekerja} />
          <BaselineMetric label="Kapasitas" value={`${(baseData.kapasitasProduksi / 1000).toFixed(0)}k kg`} />
          <BaselineMetric label="Utilisasi" value={`${baseData.utilisasi}%`} />
          <BaselineMetric label="Quality" value={baseData.qualityScore.toFixed(1)} />
        </div>
      </div>

      {/* Simulation Content */}
      {simulationMode === 'single' && (
        <SingleScenarioView
          scenario={scenarios.scenario1}
          setScenario={(updates) => setScenarios(prev => ({
            ...prev,
            scenario1: { ...prev.scenario1, ...updates }
          }))}
          baseData={baseData}
          calculateSimulation={calculateSimulation}
          onSave={() => saveScenario('scenario1')}
          onReset={() => resetScenario('scenario1')}
          isSimulating={isSimulating}
        />
      )}

      {simulationMode === 'comparison' && (
        <ComparisonView
          scenarios={scenarios}
          setScenarios={setScenarios}
          baseData={baseData}
          calculateSimulation={calculateSimulation}
          onSave={saveScenario}
          onReset={resetScenario}
          isSimulating={isSimulating}
        />
      )}

      {simulationMode === 'scenario' && (
        <SavedScenariosView
          savedScenarios={savedScenarios}
          setSavedScenarios={setSavedScenarios}
          baseData={baseData}
        />
      )}

      {/* Output Info Panel */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-start gap-4">
          <Award className="w-6 h-6 flex-shrink-0 mt-1" />
          <div>
            <h3 className="font-bold text-lg mb-2">Output Modul Simulasi What-If</h3>
            <p className="text-blue-100 text-sm leading-relaxed mb-3">
              Modul ini menghasilkan: (1) Interactive simulation dengan real-time parameter adjustment untuk eksplorasi skenario,
              (2) Impact analysis komprehensif menunjukkan perubahan metrik utama (kapasitas, utilisasi, kualitas, biaya),
              (3) Multi-scenario comparison untuk evaluasi trade-off antar opsi kebijakan,
              (4) Scenario management dengan save/load functionality untuk dokumentasi dan sharing,
              (5) Visual prediction dengan grafik dan chart yang update dinamis untuk decision support.
            </p>
            <div className="flex flex-wrap gap-2">
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Interactive Simulation</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Real-time Updates</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Multi-Scenario Analysis</span>
              <span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">What-If Modeling</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ==============================================
// SIMULATION MODE BUTTON
// ==============================================
function SimulationModeButton({ label, value, active, onClick, icon: Icon, description }) {
  return (
    <button
      onClick={() => onClick(value)}
      className={`flex-1 flex flex-col items-center gap-2 px-4 py-4 rounded-xl text-sm font-semibold transition-all ${
        active === value
          ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg scale-105'
          : 'bg-gray-50 text-gray-700 hover:bg-gray-100'
      }`}
    >
      <Icon className="w-6 h-6" />
      <div className="text-center">
        <div className="font-bold">{label}</div>
        <div className={`text-xs mt-1 ${active === value ? 'text-blue-100' : 'text-gray-500'}`}>
          {description}
        </div>
      </div>
    </button>
  );
}

// ==============================================
// BASELINE METRIC
// ==============================================
function BaselineMetric({ label, value }) {
  return (
    <div className="bg-white bg-opacity-10 rounded-lg p-3 text-center">
      <div className="text-xs text-gray-300 mb-1">{label}</div>
      <div className="text-xl font-black">{value}</div>
    </div>
  );
}

// ==============================================
// SINGLE SCENARIO VIEW
// ==============================================
function SingleScenarioView({ scenario, setScenario, baseData, calculateSimulation, onSave, onReset, isSimulating }) {
  const simulatedData = calculateSimulation(scenario);

  return (
    <div className="space-y-6">
      {/* Scenario Name */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <input
              type="text"
              value={scenario.name}
              onChange={(e) => setScenario({ name: e.target.value })}
              className="text-xl font-bold text-gray-900 border-b-2 border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none px-2 py-1"
              placeholder="Nama Skenario"
            />
          </div>
          <div className="flex gap-2">
            <button
              onClick={onSave}
              className="px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-semibold hover:bg-green-200 transition-colors"
            >
              💾 Simpan
            </button>
            <button
              onClick={onReset}
              className="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200 transition-colors"
            >
              🔄 Reset
            </button>
          </div>
        </div>
      </div>

      {/* Parameter Controls */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center gap-2 mb-6">
          <Settings className="w-5 h-5 text-gray-700" />
          <h3 className="text-lg font-bold text-gray-900">Parameter Simulasi</h3>
        </div>

        <div className="space-y-6">
          {/* Student Growth */}
          <SimulationSlider
            label="Pertumbuhan Jumlah Siswa"
            value={scenario.siswaGrowth}
            onChange={(val) => setScenario({ siswaGrowth: val })}
            min={-20}
            max={50}
            step={1}
            unit="%"
            icon={Users}
            description={`Proyeksi: ${Math.round(baseData.totalSiswa * (1 + scenario.siswaGrowth / 100)).toLocaleString()} siswa (${scenario.siswaGrowth >= 0 ? '+' : ''}${Math.round(baseData.totalSiswa * scenario.siswaGrowth / 100).toLocaleString()})`}
            color="blue"
          />

          {/* Additional Workers */}
          <SimulationSlider
            label="Penambahan Pekerja"
            value={scenario.pekerjaTambahan}
            onChange={(val) => setScenario({ pekerjaTambahan: val })}
            min={0}
            max={50}
            step={1}
            unit="orang"
            icon={Users}
            description={`Total pekerja: ${baseData.totalPekerja + scenario.pekerjaTambahan} orang`}
            color="green"
          />

          {/* New SPPG */}
          <SimulationSlider
            label="Pembangunan SPPG Baru"
            value={scenario.sppgBaru}
            onChange={(val) => setScenario({ sppgBaru: val })}
            min={0}
            max={5}
            step={1}
            unit="unit"
            icon={Building2}
            description={`Total SPPG: ${baseData.totalSPPG + scenario.sppgBaru} unit (kapasitas tambahan: ${scenario.sppgBaru * 12000} kg)`}
            color="purple"
          />

          {/* Capacity Upgrade */}
          <SimulationSlider
            label="Upgrade Kapasitas SPPG Existing"
            value={scenario.kapasitasUpgrade}
            onChange={(val) => setScenario({ kapasitasUpgrade: val })}
            min={0}
            max={50}
            step={5}
            unit="%"
            icon={TrendingUp}
            description={`Kapasitas upgrade: +${Math.round(baseData.kapasitasProduksi * scenario.kapasitasUpgrade / 100).toLocaleString()} kg`}
            color="orange"
          />

          {/* Operational Hours */}
          <SimulationSlider
            label="Penambahan Jam Operasional"
            value={scenario.waktuOperasional}
            onChange={(val) => setScenario({ waktuOperasional: val })}
            min={0}
            max={4}
            step={0.5}
            unit="jam"
            icon={Activity}
            description={`Estimasi peningkatan produksi: ${Math.round(scenario.waktuOperasional * 1000)} kg/hari`}
            color="indigo"
          />
        </div>
      </div>

      {/* Simulation Results */}
      {!isSimulating ? (
        <>
          {/* Key Metrics Comparison */}
          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-6">Hasil Simulasi: Metrik Utama</h3>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <ResultComparison
                label="Total Siswa"
                before={baseData.totalSiswa}
                after={simulatedData.totalSiswa}
                unit="siswa"
                improvement={simulatedData.improvements.siswa}
              />
              <ResultComparison
                label="Kapasitas Produksi"
                before={baseData.kapasitasProduksi}
                after={simulatedData.kapasitasProduksi}
                unit="kg"
                improvement={simulatedData.improvements.kapasitas}
              />
              <ResultComparison
                label="Utilisasi SPPG"
                before={baseData.utilisasi}
                after={simulatedData.utilisasi}
                unit="%"
                improvement={simulatedData.improvements.utilisasi}
                optimal={80}
              />
              <ResultComparison
                label="Quality Score"
                before={baseData.qualityScore}
                after={simulatedData.qualityScore}
                unit="poin"
                improvement={simulatedData.improvements.quality}
              />
              <ResultComparison
                label="Avg Jarak"
                before={baseData.avgJarak}
                after={simulatedData.avgJarak}
                unit="km"
                improvement={simulatedData.improvements.jarak}
                better="lower"
              />
              <ResultComparison
                label="Biaya Bulanan"
                before={baseData.biayaBulanan}
                after={simulatedData.biayaBulanan}
                unit="Rp"
                improvement={simulatedData.improvements.biaya}
                format="currency"
              />
            </div>
          </div>

          {/* Visual Impact Chart */}
          <div className="bg-white rounded-xl border border-gray-200 p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-6">Visualisasi Dampak Perubahan</h3>
            <ImpactChart improvements={simulatedData.improvements} />
          </div>

          {/* Capacity Analysis */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Before */}
            <div className="bg-white rounded-xl border border-gray-200 p-6">
              <h4 className="text-sm font-bold text-gray-900 mb-4">Sebelum Simulasi</h4>
              <CapacityVisualization data={baseData} label="Current" />
            </div>

            {/* After */}
            <div className="bg-white rounded-xl border border-gray-200 p-6">
              <h4 className="text-sm font-bold text-gray-900 mb-4">Sesudah Simulasi</h4>
              <CapacityVisualization data={simulatedData} label="Simulated" color="blue" />
            </div>
          </div>

          {/* Insights & Recommendations */}
          <SimulationInsights 
            scenario={scenario}
            baseData={baseData}
            simulatedData={simulatedData}
          />
        </>
      ) : (
        <div className="bg-white rounded-xl border border-blue-200 p-12 text-center">
          <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Activity className="w-8 h-8 text-blue-600 animate-spin" />
          </div>
          <h3 className="text-lg font-bold text-gray-900 mb-2">Menjalankan Simulasi...</h3>
          <p className="text-sm text-gray-600">Menghitung dampak perubahan parameter terhadap sistem</p>
        </div>
      )}
    </div>
  );
}

// ==============================================
// SIMULATION SLIDER
// ==============================================
function SimulationSlider({ label, value, onChange, min, max, step, unit, icon: Icon, description, color }) {
  const colors = {
    blue: 'accent-blue-600',
    green: 'accent-green-600',
    purple: 'accent-purple-600',
    orange: 'accent-orange-600',
    indigo: 'accent-indigo-600'
  };

  const displayColors = {
    blue: 'text-blue-600',
    green: 'text-green-600',
    purple: 'text-purple-600',
    orange: 'text-orange-600',
    indigo: 'text-indigo-600'
  };

  return (
    <div className="border border-gray-200 rounded-xl p-5 hover:shadow-md transition-all">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 bg-${color}-100 rounded-lg flex items-center justify-center`}>
            <Icon className={`w-5 h-5 ${displayColors[color]}`} />
          </div>
          <div>
            <label className="text-sm font-bold text-gray-900 block">{label}</label>
            <p className="text-xs text-gray-600 mt-0.5">{description}</p>
          </div>
        </div>
        <div className="text-right">
          <div className={`text-3xl font-black ${displayColors[color]}`}>
            {value >= 0 && '+'}{value}
          </div>
          <div className="text-xs text-gray-600">{unit}</div>
        </div>
      </div>

      <div className="flex items-center gap-4">
        <span className="text-xs font-semibold text-gray-600 w-12">{min}</span>
        <input
          type="range"
          min={min}
          max={max}
          step={step}
          value={value}
          onChange={(e) => onChange(Number(e.target.value))}
          className={`flex-1 h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer ${colors[color]}`}
        />
        <span className="text-xs font-semibold text-gray-600 w-12 text-right">{max}</span>
      </div>
    </div>
  );
}

// ==============================================
// RESULT COMPARISON
// ==============================================
function ResultComparison({ label, before, after, unit, improvement, better = 'higher', optimal, format }) {
  const formatValue = (val) => {
    if (format === 'currency') {
      return `Rp ${(val / 1000000).toFixed(0)}M`;
    }
    return typeof val === 'number' ? val.toFixed(1) : val;
  };

  const isImproved = better === 'lower' ? after < before : 
                     better === 'optimal' && optimal ? Math.abs(after - optimal) < Math.abs(before - optimal) :
                     after > before;

  const changeColor = improvement > 0 ? 'text-green-600' : improvement < 0 ? 'text-red-600' : 'text-gray-600';

  return (
    <div className="border border-gray-200 rounded-xl p-5">
      <div className="flex items-center justify-between mb-4">
        <h5 className="text-sm font-bold text-gray-900">{label}</h5>
        {improvement !== 0 && (
          <span className={`text-sm font-bold ${changeColor} flex items-center gap-1`}>
            {improvement > 0 ? '↑' : '↓'} {Math.abs(improvement).toFixed(1)}%
          </span>
        )}
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div className="bg-gray-50 rounded-lg p-4">
          <div className="text-xs text-gray-600 mb-2">Sebelum</div>
          <div className="text-2xl font-black text-gray-900">
            {formatValue(before)}
          </div>
          <div className="text-xs text-gray-500 mt-1">{unit}</div>
        </div>

        <div className={`rounded-lg p-4 ${isImproved ? 'bg-green-50' : 'bg-blue-50'}`}>
          <div className="text-xs text-gray-600 mb-2">Sesudah</div>
          <div className={`text-2xl font-black ${isImproved ? 'text-green-700' : 'text-blue-700'}`}>
            {formatValue(after)}
          </div>
          <div className="text-xs text-gray-500 mt-1">{unit}</div>
        </div>
      </div>
    </div>
  );
}

// ==============================================
// IMPACT CHART
// ==============================================
function ImpactChart({ improvements }) {
  const metrics = [
    { label: 'Siswa', value: improvements.siswa, color: 'blue' },
    { label: 'Kapasitas', value: improvements.kapasitas, color: 'green' },
    { label: 'Utilisasi', value: improvements.utilisasi, color: 'purple' },
    { label: 'Quality', value: improvements.quality, color: 'orange' },
    { label: 'Jarak', value: improvements.jarak, color: 'red' },
    { label: 'Biaya', value: improvements.biaya, color: 'indigo' }
  ];

  const maxAbsValue = Math.max(...metrics.map(m => Math.abs(m.value)));

  return (
    <div className="space-y-4">
      {metrics.map((metric, idx) => {
        const percentage = (Math.abs(metric.value) / maxAbsValue) * 100;
        const isPositive = metric.value > 0;

        return (
          <div key={idx}>
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-semibold text-gray-700">{metric.label}</span>
              <span className={`text-sm font-black ${
                isPositive ? 'text-green-600' : metric.value < 0 ? 'text-red-600' : 'text-gray-600'
              }`}>
                {isPositive ? '+' : ''}{metric.value.toFixed(1)}%
              </span>
            </div>
            <div className="relative h-8 bg-gray-100 rounded-lg overflow-hidden">
              <div 
                className={`absolute h-full ${
                  isPositive ? 'bg-gradient-to-r from-green-400 to-green-500' : 
                  metric.value < 0 ? 'bg-gradient-to-r from-red-400 to-red-500' : 
                  'bg-gray-300'
                } transition-all duration-500 flex items-center justify-end px-3`}
                style={{ width: `${percentage}%` }}
              >
                {Math.abs(metric.value) > 0 && (
                  <span className="text-xs font-bold text-white">
                    {isPositive ? '+' : ''}{metric.value.toFixed(1)}%
                  </span>
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}

// ==============================================
// CAPACITY VISUALIZATION
// ==============================================
function CapacityVisualization({ data, label, color = 'gray' }) {
  const utilisasiPercentage = data.utilisasi;
  const surplusPercentage = 100 - utilisasiPercentage;

  const colorScheme = {
    gray: { bg: 'from-gray-400 to-gray-500', light: 'bg-gray-200' },
    blue: { bg: 'from-blue-500 to-blue-600', light: 'bg-blue-200' }
  };

  return (
    <div className="space-y-4">
      {/* Capacity Gauge */}
      <div className="relative h-40">
        <div className="absolute inset-0 flex items-center justify-center">
          <div className="text-center">
            <div className="text-4xl font-black text-gray-900 mb-1">
              {data.utilisasi.toFixed(1)}%
            </div>
            <div className="text-xs text-gray-600">Utilisasi</div>
          </div>
        </div>
        <svg viewBox="0 0 100 50" className="w-full h-full">
          <path
            d="M 10 45 A 40 40 0 0 1 90 45"
            fill="none"
            stroke="#e5e7eb"
            strokeWidth="8"
          />
          <path
            d="M 10 45 A 40 40 0 0 1 90 45"
            fill="none"
            stroke={utilisasiPercentage >= 90 ? '#ef4444' : utilisasiPercentage >= 80 ? '#f59e0b' : '#10b981'}
            strokeWidth="8"
            strokeDasharray={`${utilisasiPercentage * 1.256} 125.6`}
            className="transition-all duration-500"
          />
        </svg>
      </div>

      {/* Metrics Grid */}
      <div className="grid grid-cols-2 gap-3">
        <div className="bg-gray-50 rounded-lg p-3">
          <div className="text-xs text-gray-600 mb-1">Kapasitas</div>
          <div className="text-lg font-bold text-gray-900">
            {(data.kapasitasProduksi / 1000).toFixed(0)}k
          </div>
          <div className="text-xs text-gray-500">kg/hari</div>
        </div>
        <div className="bg-gray-50 rounded-lg p-3">
          <div className="text-xs text-gray-600 mb-1">Produksi</div>
          <div className="text-lg font-bold text-gray-900">
            {(data.produksiAktual / 1000).toFixed(0)}k
          </div>
          <div className="text-xs text-gray-500">kg/hari</div>
        </div>
        <div className="bg-gray-50 rounded-lg p-3">
          <div className="text-xs text-gray-600 mb-1">SPPG</div>
          <div className="text-lg font-bold text-gray-900">{data.totalSPPG}</div>
          <div className="text-xs text-gray-500">unit</div>
        </div>
        <div className="bg-gray-50 rounded-lg p-3">
          <div className="text-xs text-gray-600 mb-1">Pekerja</div>
          <div className="text-lg font-bold text-gray-900">{data.totalPekerja}</div>
          <div className="text-xs text-gray-500">orang</div>
        </div>
      </div>
    </div>
  );
}

// ==============================================
// SIMULATION INSIGHTS
// ==============================================
function SimulationInsights({ scenario, baseData, simulatedData }) {
  const insights = [];

  // Generate insights based on changes
  if (scenario.siswaGrowth > 10) {
    insights.push({
      type: 'warning',
      title: 'Pertumbuhan Siswa Signifikan',
      message: `Pertumbuhan ${scenario.siswaGrowth}% siswa memerlukan peningkatan kapasitas produksi untuk mempertahankan kualitas pelayanan.`,
      recommendation: 'Pertimbangkan pembangunan SPPG baru atau upgrade kapasitas existing.'
    });
  }

  if (simulatedData.utilisasi > 90) {
    insights.push({
      type: 'critical',
      title: 'Utilisasi Tinggi',
      message: `Utilisasi ${simulatedData.utilisasi.toFixed(1)}% mendekati kapasitas maksimal. Risiko overload tinggi.`,
      recommendation: 'Urgent: Tambah kapasitas produksi atau SPPG baru untuk menghindari penurunan kualitas.'
    });
  }

  if (scenario.sppgBaru > 0) {
    insights.push({
      type: 'success',
      title: 'Ekspansi SPPG',
      message: `Penambahan ${scenario.sppgBaru} SPPG baru akan meningkatkan coverage dan mengurangi jarak rata-rata distribusi.`,
      recommendation: `Investasi: Rp ${(scenario.sppgBaru * 2500000000 / 1000000).toFixed(0)}M untuk pembangunan infrastruktur.`
    });
  }

  if (simulatedData.improvements.quality > 10) {
    insights.push({
      type: 'success',
      title: 'Peningkatan Kualitas Signifikan',
      message: `Quality score meningkat ${simulatedData.improvements.quality.toFixed(1)}% dari baseline.`,
      recommendation: 'Konfigurasi parameter ini sangat efektif untuk meningkatkan kualitas pelayanan.'
    });
  }

  if (simulatedData.improvements.biaya > 15) {
    insights.push({
      type: 'warning',
      title: 'Peningkatan Biaya Operasional',
      message: `Biaya bulanan meningkat ${simulatedData.improvements.biaya.toFixed(1)}% (Rp ${((simulatedData.biayaBulanan - baseData.biayaBulanan) / 1000000).toFixed(0)}M).`,
      recommendation: 'Lakukan cost-benefit analysis untuk memastikan ROI yang positif.'
    });
  }

  if (insights.length === 0) {
    insights.push({
      type: 'info',
      title: 'Perubahan Minimal',
      message: 'Parameter simulasi belum menghasilkan perubahan signifikan terhadap sistem.',
      recommendation: 'Coba adjust parameter dengan nilai yang lebih besar untuk melihat dampak yang lebih jelas.'
    });
  }

  return (
    <div className="bg-white rounded-xl border border-gray-200 p-6">
      <div className="flex items-center gap-2 mb-6">
        <AlertTriangle className="w-5 h-5 text-orange-600" />
        <h3 className="text-lg font-bold text-gray-900">Insights & Rekomendasi</h3>
      </div>

      <div className="space-y-4">
        {insights.map((insight, idx) => (
          <InsightCard key={idx} insight={insight} />
        ))}
      </div>
    </div>
  );
}

function InsightCard({ insight }) {
  const typeConfig = {
    success: {
      bg: 'from-green-50 to-green-100',
      border: 'border-green-200',
      icon: '✅',
      titleColor: 'text-green-900'
    },
    warning: {
      bg: 'from-yellow-50 to-yellow-100',
      border: 'border-yellow-200',
      icon: '⚠️',
      titleColor: 'text-yellow-900'
    },
    critical: {
      bg: 'from-red-50 to-red-100',
      border: 'border-red-200',
      icon: '🔴',
      titleColor: 'text-red-900'
    },
    info: {
      bg: 'from-blue-50 to-blue-100',
      border: 'border-blue-200',
      icon: 'ℹ️',
      titleColor: 'text-blue-900'
    }
  };

  const config = typeConfig[insight.type];

  return (
    <div className={`bg-gradient-to-r ${config.bg} border ${config.border} rounded-xl p-5`}>
      <div className="flex items-start gap-3">
        <div className="text-2xl">{config.icon}</div>
        <div className="flex-1">
          <h5 className={`text-sm font-bold ${config.titleColor} mb-2`}>{insight.title}</h5>
          <p className="text-sm text-gray-700 mb-3">{insight.message}</p>
          <div className="bg-white bg-opacity-60 rounded-lg p-3">
            <div className="text-xs font-semibold text-gray-700 mb-1">💡 Rekomendasi:</div>
            <div className="text-xs text-gray-600">{insight.recommendation}</div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ==============================================
// COMPARISON VIEW (untuk comparison mode - shortened for brevity)
// ==============================================
function ComparisonView({ scenarios, setScenarios, baseData, calculateSimulation }) {
  return (
    <div className="space-y-6">
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h3 className="text-lg font-bold text-gray-900 mb-4">Mode Perbandingan Skenario</h3>
        <p className="text-sm text-gray-600">
          Bandingkan hingga 3 skenario berbeda untuk analisis multi-kriteria. 
          (Interface lengkap tersedia di implementasi penuh)
        </p>
      </div>
    </div>
  );
}

// ==============================================
// SAVED SCENARIOS VIEW
// ==============================================
function SavedScenariosView({ savedScenarios, setSavedScenarios, baseData }) {
  return (
    <div className="space-y-6">
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <h3 className="text-lg font-bold text-gray-900 mb-4">Skenario Tersimpan</h3>
        {savedScenarios.length === 0 ? (
          <div className="text-center py-12">
            <BookOpen className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <p className="text-gray-600">Belum ada skenario yang disimpan</p>
            <p className="text-sm text-gray-500 mt-2">
              Jalankan simulasi dan simpan skenario untuk referensi di masa depan
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {savedScenarios.map((scenario) => (
              <SavedScenarioCard 
                key={scenario.id} 
                scenario={scenario}
                onDelete={() => setSavedScenarios(prev => prev.filter(s => s.id !== scenario.id))}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

function SavedScenarioCard({ scenario, onDelete }) {
  return (
    <div className="border border-gray-200 rounded-xl p-5 hover:shadow-md transition-all">
      <div className="flex items-start justify-between mb-3">
        <div>
          <h5 className="font-bold text-gray-900">{scenario.name}</h5>
          <p className="text-xs text-gray-500 mt-1">
            {new Date(scenario.timestamp).toLocaleString('id-ID')}
          </p>
        </div>
        <button
          onClick={onDelete}
          className="text-red-600 hover:text-red-800 text-xs font-semibold"
        >
          Hapus
        </button>
      </div>
      
      <div className="space-y-2 text-xs">
        <div className="flex justify-between">
          <span className="text-gray-600">Siswa Growth:</span>
          <span className="font-bold text-gray-900">{scenario.params.siswaGrowth}%</span>
        </div>
        <div className="flex justify-between">
          <span className="text-gray-600">SPPG Baru:</span>
          <span className="font-bold text-gray-900">{scenario.params.sppgBaru} unit</span>
        </div>
        <div className="flex justify-between">
          <span className="text-gray-600">Quality Improvement:</span>
          <span className="font-bold text-green-600">
            +{scenario.results.improvements.quality.toFixed(1)}%
          </span>
        </div>
      </div>
    </div>
  );
}


// ==============================================
// MODUL REKOMENDASI KEBIJAKAN - PART 11 (SINTA 1 LEVEL - 1000+ LINES)
// ==============================================
function RekomendasiPage() {
  const [viewMode, setViewMode] = useState('executive'); // executive, detailed, timeline, impact
  const [filterPriority, setFilterPriority] = useState('all'); // all, high, medium, low
  const [filterCategory, setFilterCategory] = useState('all'); // all, infrastructure, operational, strategic, policy
  const [filterRisk, setFilterRisk] = useState('all'); // all, low, medium, high
  const [selectedRecommendation, setSelectedRecommendation] = useState(null);
  const [showExportModal, setShowExportModal] = useState(false);
  const [sortBy, setSortBy] = useState('priority'); // priority, impact, cost, timeline

  // Comprehensive Recommendations Data
  const recommendations = [
    {
      id: 'REC-001',
      title: 'Pembangunan 3 SPPG Baru di Wilayah Prioritas',
      category: 'infrastructure',
      priority: 'high',
      riskLevel: 'medium',
      status: 'proposed',
      implementationTime: '8-12 bulan',
      budget: 7500000000,
      expectedImpact: {
        coverage: 25.5,
        quality: 18.3,
        efficiency: 22.1,
        equity: 31.4
      },
      affectedSchools: 284,
      affectedStudents: 68420,
      description: 'Membangun 3 unit SPPG baru di Kec. Lembang Timur, Bandung Selatan, dan Cimahi Utara untuk mengurangi jarak distribusi dan meningkatkan coverage pelayanan.',
      rationale: [
        'Analisis spasial menunjukkan 284 sekolah (22.8%) memiliki jarak > 15 km ke SPPG terdekat',
        'Wilayah prioritas memiliki konsentrasi siswa tinggi dengan pelayanan suboptimal',
        'Pengurangan jarak rata-rata distribusi dari 9.8 km menjadi 6.2 km (36.7% improvement)',
        'ROI tercapai dalam 18-24 bulan melalui efisiensi operasional'
      ],
      benefits: [
        'Peningkatan coverage dari 91.2% menjadi 98.7%',
        'Pengurangan waktu tempuh rata-rata 42%',
        'Peningkatan kualitas makanan dengan distribusi lebih cepat',
        'Penciptaan 75 lapangan kerja baru'
      ],
      risks: [
        {
          type: 'financial',
          level: 'medium',
          description: 'Investasi awal tinggi (Rp 7.5M)',
          mitigation: 'Implementasi bertahap dengan prioritas lokasi tertinggi'
        },
        {
          type: 'operational',
          level: 'low',
          description: 'Waktu konstruksi 8-12 bulan',
          mitigation: 'Project management profesional dengan timeline jelas'
        },
        {
          type: 'political',
          level: 'low',
          description: 'Perlu koordinasi multi-stakeholder',
          mitigation: 'Pembentukan tim koordinasi lintas sektor'
        }
      ],
      timeline: [
        { phase: 'Perencanaan & Desain', duration: '2 bulan', activities: ['Feasibility study', 'Site selection', 'Architectural design'] },
        { phase: 'Perizinan & Pengadaan', duration: '2 bulan', activities: ['Legal permits', 'Tender process', 'Contractor selection'] },
        { phase: 'Konstruksi', duration: '6 bulan', activities: ['Foundation', 'Building construction', 'Equipment installation'] },
        { phase: 'Testing & Commissioning', duration: '1 bulan', activities: ['Quality testing', 'Staff training', 'Pilot operation'] },
        { phase: 'Full Operation', duration: 'Ongoing', activities: ['Regular production', 'Quality monitoring', 'Capacity optimization'] }
      ],
      stakeholders: [
        { name: 'Dinas Pendidikan', role: 'Primary Owner', involvement: 'high' },
        { name: 'Pemda', role: 'Budget Approval', involvement: 'high' },
        { name: 'DPRD', role: 'Legislative Support', involvement: 'medium' },
        { name: 'Kontraktor', role: 'Implementation', involvement: 'high' },
        { name: 'Masyarakat', role: 'Community Support', involvement: 'medium' }
      ],
      successMetrics: [
        { metric: 'Coverage Rate', baseline: 91.2, target: 98.7, unit: '%' },
        { metric: 'Avg Distance', baseline: 9.8, target: 6.2, unit: 'km' },
        { metric: 'Quality Score', baseline: 78.5, target: 92.1, unit: 'poin' },
        { metric: 'Student Satisfaction', baseline: 75, target: 90, unit: '%' }
      ],
      quickWins: false,
      strategicValue: 'very-high',
      evidenceLevel: 'strong'
    },
    {
      id: 'REC-002',
      title: 'Optimasi Rute Distribusi dengan Network Analysis',
      category: 'operational',
      priority: 'high',
      riskLevel: 'low',
      status: 'ready',
      implementationTime: '1-2 bulan',
      budget: 150000000,
      expectedImpact: {
        coverage: 8.2,
        quality: 12.5,
        efficiency: 28.7,
        equity: 15.3
      },
      affectedSchools: 1247,
      affectedStudents: 47891,
      description: 'Implementasi sistem optimasi rute berbasis algoritma network analysis untuk meminimalkan waktu tempuh dan memaksimalkan efisiensi distribusi makanan.',
      rationale: [
        'Analisis rute menunjukkan potensi pengurangan waktu tempuh 25-30%',
        'Real-time routing dapat menghindari kemacetan dan kondisi jalan buruk',
        'Investasi rendah dengan ROI cepat (3-6 bulan)',
        'Teknologi mature dan proven di industri logistik'
      ],
      benefits: [
        'Pengurangan waktu distribusi rata-rata dari 24 menit menjadi 18 menit',
        'Penghematan biaya bahan bakar 15-20%',
        'Peningkatan kualitas makanan dengan pengiriman lebih cepat',
        'Real-time monitoring dan tracking delivery'
      ],
      risks: [
        {
          type: 'technical',
          level: 'low',
          description: 'Integrasi sistem dengan infrastruktur existing',
          mitigation: 'Pilot testing di 1-2 SPPG sebelum full rollout'
        },
        {
          type: 'operational',
          level: 'low',
          description: 'Training driver dan operator',
          mitigation: 'Program pelatihan intensif 2 minggu'
        }
      ],
      timeline: [
        { phase: 'System Procurement', duration: '2 minggu', activities: ['Vendor selection', 'Contract negotiation'] },
        { phase: 'Pilot Implementation', duration: '3 minggu', activities: ['System setup', 'Staff training', 'Trial run'] },
        { phase: 'Full Rollout', duration: '3 minggu', activities: ['All SPPG deployment', 'Monitoring setup'] },
        { phase: 'Optimization', duration: 'Ongoing', activities: ['Performance tuning', 'Continuous improvement'] }
      ],
      stakeholders: [
        { name: 'SPPG Managers', role: 'Primary Users', involvement: 'high' },
        { name: 'IT Department', role: 'Technical Support', involvement: 'high' },
        { name: 'Drivers', role: 'End Users', involvement: 'high' },
        { name: 'Vendor', role: 'System Provider', involvement: 'medium' }
      ],
      successMetrics: [
        { metric: 'Avg Travel Time', baseline: 24, target: 18, unit: 'menit' },
        { metric: 'On-time Delivery', baseline: 87, target: 96, unit: '%' },
        { metric: 'Fuel Efficiency', baseline: 100, target: 115, unit: 'index' },
        { metric: 'Food Quality Score', baseline: 78.5, target: 86.2, unit: 'poin' }
      ],
      quickWins: true,
      strategicValue: 'high',
      evidenceLevel: 'strong'
    },
    {
      id: 'REC-003',
      title: 'Peningkatan Kapasitas SDM: Pelatihan 50 Pekerja SPPG',
      category: 'operational',
      priority: 'high',
      riskLevel: 'low',
      status: 'ready',
      implementationTime: '3 bulan',
      budget: 250000000,
      expectedImpact: {
        coverage: 5.1,
        quality: 24.3,
        efficiency: 18.9,
        equity: 8.2
      },
      affectedSchools: 1247,
      affectedStudents: 47891,
      description: 'Program pelatihan komprehensif untuk 50 pekerja SPPG mencakup food safety, production efficiency, quality control, dan customer service.',
      rationale: [
        'Audit kualitas menunjukkan 23% insiden terkait human error',
        'Peningkatan kompetensi SDM berdampak langsung pada kualitas output',
        'Investasi relatif rendah dengan impact tinggi pada quality score',
        'Meningkatkan employee satisfaction dan retention'
      ],
      benefits: [
        'Peningkatan quality score dari 78.5 menjadi 92.8 (18.2%)',
        'Pengurangan food waste 30%',
        'Peningkatan produktivitas 15-20%',
        'Sertifikasi nasional food safety untuk semua pekerja'
      ],
      risks: [
        {
          type: 'operational',
          level: 'low',
          description: 'Downtime selama pelatihan',
          mitigation: 'Pelatihan bergiliran tanpa mengganggu produksi'
        }
      ],
      timeline: [
        { phase: 'Needs Assessment', duration: '2 minggu', activities: ['Skills gap analysis', 'Training design'] },
        { phase: 'Training Delivery', duration: '8 minggu', activities: ['Batch 1-5 training', 'Practical sessions'] },
        { phase: 'Certification', duration: '2 minggu', activities: ['Exam', 'Certificate issuance'] },
        { phase: 'Follow-up', duration: '2 minggu', activities: ['Performance monitoring', 'Refresher sessions'] }
      ],
      stakeholders: [
        { name: 'SPPG Workers', role: 'Trainees', involvement: 'high' },
        { name: 'Training Provider', role: 'Facilitator', involvement: 'high' },
        { name: 'SPPG Managers', role: 'Supervisors', involvement: 'medium' },
        { name: 'Quality Assurance', role: 'Evaluator', involvement: 'medium' }
      ],
      successMetrics: [
        { metric: 'Quality Score', baseline: 78.5, target: 92.8, unit: 'poin' },
        { metric: 'Food Waste', baseline: 12, target: 8.4, unit: '%' },
        { metric: 'Productivity', baseline: 100, target: 118, unit: 'index' },
        { metric: 'Certified Staff', baseline: 45, target: 100, unit: '%' }
      ],
      quickWins: false,
      strategicValue: 'high',
      evidenceLevel: 'strong'
    },
    {
      id: 'REC-004',
      title: 'Implementasi Real-Time Monitoring Dashboard',
      category: 'strategic',
      priority: 'medium',
      riskLevel: 'low',
      status: 'proposed',
      implementationTime: '2-3 bulan',
      budget: 180000000,
      expectedImpact: {
        coverage: 3.5,
        quality: 8.7,
        efficiency: 22.3,
        equity: 5.1
      },
      affectedSchools: 1247,
      affectedStudents: 47891,
      description: 'Pengembangan dashboard monitoring real-time untuk tracking produksi, distribusi, dan kualitas pelayanan dengan alert system otomatis.',
      rationale: [
        'Data-driven decision making memerlukan visibility real-time',
        'Early warning system untuk mencegah kegagalan pelayanan',
        'Transparansi dan akuntabilitas meningkat',
        'Integrasi dengan sistem existing untuk efisiensi'
      ],
      benefits: [
        'Real-time visibility seluruh operasi SPPG',
        'Pengurangan response time untuk masalah 60%',
        'Peningkatan akuntabilitas dan transparansi',
        'Data analytics untuk continuous improvement'
      ],
      risks: [
        {
          type: 'technical',
          level: 'low',
          description: 'Data integration challenges',
          mitigation: 'Phased implementation dengan API standardization'
        }
      ],
      timeline: [
        { phase: 'Requirements Analysis', duration: '3 minggu', activities: ['Stakeholder consultation', 'System design'] },
        { phase: 'Development', duration: '6 minggu', activities: ['Backend dev', 'Frontend dev', 'Testing'] },
        { phase: 'Deployment', duration: '2 minggu', activities: ['Server setup', 'Data migration', 'Go-live'] },
        { phase: 'Training & Support', duration: '1 minggu', activities: ['User training', 'Documentation'] }
      ],
      stakeholders: [
        { name: 'Management', role: 'Primary Users', involvement: 'high' },
        { name: 'IT Team', role: 'Maintainers', involvement: 'high' },
        { name: 'SPPG Staff', role: 'Data Providers', involvement: 'medium' },
        { name: 'Auditors', role: 'Reviewers', involvement: 'low' }
      ],
      successMetrics: [
        { metric: 'System Uptime', baseline: 0, target: 99.5, unit: '%' },
        { metric: 'Response Time', baseline: 60, target: 24, unit: 'jam' },
        { metric: 'User Adoption', baseline: 0, target: 95, unit: '%' },
        { metric: 'Decision Accuracy', baseline: 75, target: 92, unit: '%' }
      ],
      quickWins: false,
      strategicValue: 'high',
      evidenceLevel: 'moderate'
    },
    {
      id: 'REC-005',
      title: 'Perbaikan Infrastruktur Jalan Akses ke 12 Sekolah Terpencil',
      category: 'infrastructure',
      priority: 'high',
      riskLevel: 'medium',
      status: 'proposed',
      implementationTime: '4-6 bulan',
      budget: 1200000000,
      expectedImpact: {
        coverage: 12.8,
        quality: 16.4,
        efficiency: 14.2,
        equity: 28.9
      },
      affectedSchools: 12,
      affectedStudents: 2847,
      description: 'Perbaikan dan pemeliharaan jalan akses ke 12 sekolah terpencil dengan kondisi jalan buruk yang menyebabkan keterlambatan distribusi dan penurunan kualitas makanan.',
      rationale: [
        '12 sekolah memiliki waktu tempuh > 45 menit karena kondisi jalan buruk',
        'Kualitas makanan menurun signifikan pada rute dengan jalan rusak',
        'Equity concern: siswa di wilayah terpencil mendapat pelayanan inferior',
        'Infrastruktur jalan benefit jangka panjang untuk program lain'
      ],
      benefits: [
        'Pengurangan waktu tempuh 35-50% untuk 12 rute kritis',
        'Peningkatan quality score untuk wilayah terpencil',
        'Akses lebih baik untuk program lain (kesehatan, bantuan sosial)',
        'Stimulus ekonomi lokal'
      ],
      risks: [
        {
          type: 'financial',
          level: 'medium',
          description: 'Budget overrun potensial',
          mitigation: 'Contingency budget 15%'
        },
        {
          type: 'environmental',
          level: 'low',
          description: 'Dampak lingkungan konstruksi',
          mitigation: 'Environmental impact assessment & mitigation plan'
        }
      ],
      timeline: [
        { phase: 'Survey & Design', duration: '1 bulan', activities: ['Route survey', 'Engineering design'] },
        { phase: 'Procurement', duration: '1 bulan', activities: ['Tender', 'Contract award'] },
        { phase: 'Construction', duration: '3-4 bulan', activities: ['Road repair', 'Drainage', 'Signage'] },
        { phase: 'Quality Check', duration: '2 minggu', activities: ['Final inspection', 'Handover'] }
      ],
      stakeholders: [
        { name: 'Dinas PU', role: 'Implementation', involvement: 'high' },
        { name: 'Local Community', role: 'Beneficiaries', involvement: 'high' },
        { name: 'Contractors', role: 'Executors', involvement: 'high' },
        { name: 'Environmental Agency', role: 'Oversight', involvement: 'medium' }
      ],
      successMetrics: [
        { metric: 'Travel Time', baseline: 48, target: 28, unit: 'menit' },
        { metric: 'Road Condition', baseline: 3.2, target: 8.5, unit: '/10' },
        { metric: 'On-time Delivery', baseline: 62, target: 94, unit: '%' },
        { metric: 'Quality Score', baseline: 68, target: 87, unit: 'poin' }
      ],
      quickWins: false,
      strategicValue: 'high',
      evidenceLevel: 'strong'
    },
    {
      id: 'REC-006',
      title: 'Program Menu Diversifikasi untuk Nutrisi Optimal',
      category: 'policy',
      priority: 'medium',
      riskLevel: 'low',
      status: 'proposed',
      implementationTime: '2 bulan',
      budget: 95000000,
      expectedImpact: {
        coverage: 2.1,
        quality: 18.7,
        efficiency: 5.3,
        equity: 6.8
      },
      affectedSchools: 1247,
      affectedStudents: 47891,
      description: 'Pengembangan menu makanan yang lebih bervariasi dan seimbang gizi dengan melibatkan ahli nutrisi untuk memastikan asupan gizi optimal anak usia sekolah.',
      rationale: [
        'Menu existing kurang variasi (only 3-4 menu rotation)',
        'Konsultasi dengan ahli gizi menunjukkan potensi peningkatan nutrisi 25%',
        'Student feedback menunjukkan desire untuk menu lebih bervariasi',
        'Competitive advantage: program MBG lebih menarik'
      ],
      benefits: [
        'Peningkatan nutrisi intake 20-25%',
        'Menu rotation 10 hari (dari sebelumnya 3 hari)',
        'Student satisfaction meningkat',
        'Pembelajaran food literacy untuk siswa'
      ],
      risks: [
        {
          type: 'operational',
          level: 'low',
          description: 'Kompleksitas produksi meningkat',
          mitigation: 'Training kitchen staff & standardized recipes'
        },
        {
          type: 'financial',
          level: 'low',
          description: 'Slight cost increase per portion',
          mitigation: 'Optimize procurement & bulk buying'
        }
      ],
      timeline: [
        { phase: 'Menu Development', duration: '3 minggu', activities: ['Nutritionist consultation', 'Recipe testing'] },
        { phase: 'Staff Training', duration: '2 minggu', activities: ['Kitchen staff training', 'Recipe standardization'] },
        { phase: 'Pilot Program', duration: '2 minggu', activities: ['Trial in 2 SPPG', 'Feedback collection'] },
        { phase: 'Full Rollout', duration: '1 minggu', activities: ['All SPPG implementation'] }
      ],
      stakeholders: [
        { name: 'Nutritionist', role: 'Expert Advisor', involvement: 'high' },
        { name: 'Kitchen Staff', role: 'Implementers', involvement: 'high' },
        { name: 'Students', role: 'Beneficiaries', involvement: 'high' },
        { name: 'Parents', role: 'Stakeholders', involvement: 'medium' }
      ],
      successMetrics: [
        { metric: 'Nutritional Value', baseline: 100, target: 124, unit: 'index' },
        { metric: 'Menu Variety', baseline: 3, target: 10, unit: 'items' },
        { metric: 'Student Satisfaction', baseline: 75, target: 88, unit: '%' },
        { metric: 'Consumption Rate', baseline: 82, target: 93, unit: '%' }
      ],
      quickWins: true,
      strategicValue: 'medium',
      evidenceLevel: 'moderate'
    },
    {
      id: 'REC-007',
      title: 'Sistem Feedback Digital dari Sekolah dan Siswa',
      category: 'strategic',
      priority: 'medium',
      riskLevel: 'low',
      status: 'ready',
      implementationTime: '1 bulan',
      budget: 75000000,
      expectedImpact: {
        coverage: 1.8,
        quality: 14.2,
        efficiency: 8.5,
        equity: 4.3
      },
      affectedSchools: 1247,
      affectedStudents: 47891,
      description: 'Implementasi sistem feedback digital (mobile app & web) untuk sekolah dan siswa memberikan rating dan feedback real-time tentang kualitas makanan dan pelayanan.',
      rationale: [
        'Voice of customer penting untuk continuous improvement',
        'Feedback mechanism existing tidak efektif (response rate < 20%)',
        'Digital feedback meningkatkan transparency dan accountability',
        'Data berharga untuk quality control dan menu optimization'
      ],
      benefits: [
        'Real-time feedback dari 1000+ users daily',
        'Identifikasi masalah lebih cepat (< 24 jam)',
        'Data analytics untuk menu optimization',
        'Increased stakeholder engagement'
      ],
      risks: [
        {
          type: 'technical',
          level: 'low',
          description: 'Digital literacy varied among users',
          mitigation: 'Simple UI/UX & user training'
        }
      ],
      timeline: [
        { phase: 'App Development', duration: '2 minggu', activities: ['Mobile & web app dev', 'Testing'] },
        { phase: 'Pilot Launch', duration: '1 minggu', activities: ['10 schools pilot', 'Bug fixes'] },
        { phase: 'Full Rollout', duration: '1 minggu', activities: ['All schools launch', 'Marketing'] }
      ],
      stakeholders: [
        { name: 'Students', role: 'Primary Users', involvement: 'high' },
        { name: 'Teachers', role: 'Users', involvement: 'high' },
        { name: 'Management', role: 'Data Consumers', involvement: 'high' },
        { name: 'IT Support', role: 'Maintainers', involvement: 'medium' }
      ],
      successMetrics: [
        { metric: 'User Adoption', baseline: 0, target: 75, unit: '%' },
        { metric: 'Daily Feedback', baseline: 50, target: 800, unit: 'responses' },
        { metric: 'Response Time', baseline: 72, target: 12, unit: 'jam' },
        { metric: 'Satisfaction', baseline: 75, target: 85, unit: '%' }
      ],
      quickWins: true,
      strategicValue: 'medium',
      evidenceLevel: 'moderate'
    },
    {
      id: 'REC-008',
      title: 'Capacity Building: Rekrutmen 25 Pekerja Baru',
      category: 'operational',
      priority: 'medium',
      riskLevel: 'low',
      status: 'proposed',
      implementationTime: '2 bulan',
      budget: 375000000,
      expectedImpact: {
        coverage: 8.3,
        quality: 11.2,
        efficiency: 15.7,
        equity: 7.4
      },
      affectedSchools: 1247,
      affectedStudents: 47891,
      description: 'Rekrutmen dan onboarding 25 pekerja baru untuk mengatasi kekurangan SDM di SPPG dengan utilisasi tinggi (>90%) dan mempersiapkan ekspansi kapasitas.',
      rationale: [
        '3 SPPG memiliki utilisasi > 90% indicating overload',
        'Turnover rate 12% annually memerlukan pipeline recruitment',
        'Ekspansi capacity memerlukan additional workforce',
        'Quality improvement memerlukan adequate staffing'
      ],
      benefits: [
        'Pengurangan utilisasi SPPG overloaded ke level optimal',
        'Peningkatan quality melalui workload reduction',
        'Capacity untuk ekspansi future',
        '25 lapangan kerja baru untuk masyarakat lokal'
      ],
      risks: [
        {
          type: 'operational',
          level: 'low',
          description: 'Training & onboarding time',
          mitigation: 'Structured onboarding program 4 minggu'
        },
        {
          type: 'financial',
          level: 'low',
          description: 'Ongoing salary cost',
          mitigation: 'Built into operational budget'
        }
      ],
      timeline: [
        { phase: 'Recruitment', duration: '3 minggu', activities: ['Job posting', 'Screening', 'Interviews'] },
        { phase: 'Selection', duration: '1 minggu', activities: ['Background check', 'Offer letters'] },
        { phase: 'Onboarding', duration: '4 minggu', activities: ['Training', 'Mentoring', 'Certification'] }
      ],
      stakeholders: [
        { name: 'HR Department', role: 'Recruiters', involvement: 'high' },
        { name: 'SPPG Managers', role: 'Supervisors', involvement: 'high' },
        { name: 'New Hires', role: 'Employees', involvement: 'high' },
        { name: 'Local Community', role: 'Job Seekers', involvement: 'medium' }
      ],
      successMetrics: [
        { metric: 'Time to Hire', baseline: 0, target: 60, unit: 'hari' },
        { metric: 'Positions Filled', baseline: 0, target: 25, unit: 'orang' },
        { metric: 'Retention Rate', baseline: 88, target: 95, unit: '%' },
        { metric: 'Productivity', baseline: 100, target: 112, unit: 'index' }
      ],
      quickWins: false,
      strategicValue: 'medium',
      evidenceLevel: 'strong'
    },
    {
      id: 'REC-009',
      title: 'Kemitraan dengan Petani Lokal untuk Suplai Bahan Baku',
      category: 'policy',
      priority: 'low',
      riskLevel: 'medium',
      status: 'proposed',
      implementationTime: '6 bulan',
      budget: 320000000,
      expectedImpact: {
        coverage: 1.2,
        quality: 9.8,
        efficiency: 6.4,
        equity: 12.1
      },
      affectedSchools: 1247,
      affectedStudents: 47891,
      description: 'Membangun kemitraan strategis dengan petani lokal untuk suplai sayuran dan bahan pangan segar, mengurangi biaya procurement dan meningkatkan kesegaran bahan.',
      rationale: [
        'Local sourcing mengurangi biaya transport dan storage',
        'Kesegaran bahan meningkat dengan supply chain pendek',
        'Economic impact: empowerment petani lokal',
        'Sustainability: reduce carbon footprint'
      ],
      benefits: [
        'Penghematan biaya procurement 15-20%',
        'Kesegaran sayuran meningkat 30-40%',
        'Support ekonomi lokal dan petani',
        'Sustainable sourcing model'
      ],
      risks: [
        {
          type: 'operational',
          level: 'medium',
          description: 'Supply consistency & quality variability',
          mitigation: 'Contract farming dengan quality standards'
        },
        {
          type: 'seasonal',
          level: 'medium',
          description: 'Seasonal availability issues',
          mitigation: 'Diversified supplier base & backup suppliers'
        }
      ],
      timeline: [
        { phase: 'Farmer Identification', duration: '2 bulan', activities: ['Survey', 'Capacity assessment'] },
        { phase: 'Partnership Agreement', duration: '1 bulan', activities: ['Contract negotiation', 'Terms agreement'] },
        { phase: 'Pilot Program', duration: '2 bulan', activities: ['Trial supply', 'Quality monitoring'] },
        { phase: 'Full Implementation', duration: '1 bulan', activities: ['Scale up', 'Regular supply'] }
      ],
      stakeholders: [
        { name: 'Local Farmers', role: 'Suppliers', involvement: 'high' },
        { name: 'Procurement Team', role: 'Buyers', involvement: 'high' },
        { name: 'Quality Control', role: 'Inspectors', involvement: 'medium' },
        { name: 'Community Leaders', role: 'Facilitators', involvement: 'medium' }
      ],
      successMetrics: [
        { metric: 'Local Sourcing', baseline: 30, target: 70, unit: '%' },
        { metric: 'Cost Savings', baseline: 100, target: 118, unit: 'index' },
        { metric: 'Freshness Score', baseline: 7.2, target: 9.5, unit: '/10' },
        { metric: 'Farmer Income', baseline: 100, target: 135, unit: 'index' }
      ],
      quickWins: false,
      strategicValue: 'medium',
      evidenceLevel: 'moderate'
    },
    {
      id: 'REC-010',
      title: 'Upgrade Sistem Cold Chain untuk Preservasi Kualitas',
      category: 'infrastructure',
      priority: 'low',
      riskLevel: 'low',
      status: 'proposed',
      implementationTime: '3 bulan',
      budget: 450000000,
      expectedImpact: {
        coverage: 0.8,
        quality: 22.4,
        efficiency: 8.9,
        equity: 2.1
      },
      affectedSchools: 1247,
      affectedStudents: 47891,
      description: 'Upgrade infrastruktur cold storage dan refrigerated transport untuk memastikan cold chain integrity dari SPPG hingga sekolah, terutama untuk rute jarak jauh.',
      rationale: [
        'Quality degradation signifikan pada rute > 15 km',
        'Cold chain critical untuk food safety',
        'Investment in quality infrastructure long-term benefit',
        'Compliance dengan food safety regulations'
      ],
      benefits: [
        'Peningkatan food safety compliance 100%',
        'Extended shelf life bahan baku 40%',
        'Quality preservation untuk rute jauh',
        'Reduced food waste 25%'
      ],
      risks: [
        {
          type: 'financial',
          level: 'low',
          description: 'High upfront investment',
          mitigation: 'Phased implementation starting with priority routes'
        },
        {
          type: 'technical',
          level: 'low',
          description: 'Maintenance requirements',
          mitigation: 'Maintenance contract dengan vendor'
        }
      ],
      timeline: [
        { phase: 'Assessment', duration: '2 minggu', activities: ['Cold chain audit', 'Equipment sizing'] },
        { phase: 'Procurement', duration: '1 bulan', activities: ['Tender', 'Purchase'] },
        { phase: 'Installation', duration: '1.5 bulan', activities: ['Cold storage setup', 'Vehicle retrofit'] },
        { phase: 'Testing', duration: '2 minggu', activities: ['Temperature testing', 'Staff training'] }
      ],
      stakeholders: [
        { name: 'SPPG Managers', role: 'Users', involvement: 'high' },
        { name: 'Drivers', role: 'Operators', involvement: 'high' },
        { name: 'Vendors', role: 'Suppliers', involvement: 'medium' },
        { name: 'Quality Team', role: 'Monitors', involvement: 'medium' }
      ],
      successMetrics: [
        { metric: 'Temperature Compliance', baseline: 78, target: 98, unit: '%' },
        { metric: 'Food Safety Incidents', baseline: 8, target: 1, unit: 'per bulan' },
        { metric: 'Food Waste', baseline: 12, target: 9, unit: '%' },
        { metric: 'Quality Score', baseline: 78.5, target: 91.2, unit: 'poin' }
      ],
      quickWins: false,
      strategicValue: 'medium',
      evidenceLevel: 'strong'
    }
  ];

  // Filter recommendations
  const filteredRecommendations = recommendations.filter(rec => {
    const matchPriority = filterPriority === 'all' || rec.priority === filterPriority;
    const matchCategory = filterCategory === 'all' || rec.category === filterCategory;
    const matchRisk = filterRisk === 'all' || rec.riskLevel === filterRisk;
    return matchPriority && matchCategory && matchRisk;
  });

  // Sort recommendations
  const sortedRecommendations = [...filteredRecommendations].sort((a, b) => {
    if (sortBy === 'priority') {
      const priorityOrder = { high: 0, medium: 1, low: 2 };
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    } else if (sortBy === 'impact') {
      const avgImpactA = Object.values(a.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
      const avgImpactB = Object.values(b.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
      return avgImpactB - avgImpactA;
    } else if (sortBy === 'cost') {
      return a.budget - b.budget;
    } else if (sortBy === 'timeline') {
      return parseInt(a.implementationTime) - parseInt(b.implementationTime);
    }
    return 0;
  });

  // Calculate summary statistics
  const summaryStats = {
    totalRecommendations: recommendations.length,
    highPriority: recommendations.filter(r => r.priority === 'high').length,
    mediumPriority: recommendations.filter(r => r.priority === 'medium').length,
    lowPriority: recommendations.filter(r => r.priority === 'low').length,
    totalBudget: recommendations.reduce((sum, r) => sum + r.budget, 0),
    avgImpact: recommendations.reduce((sum, r) => {
      const avgImpact = Object.values(r.expectedImpact).reduce((s, v) => s + v, 0) / 4;
      return sum + avgImpact;
    }, 0) / recommendations.length,
    quickWins: recommendations.filter(r => r.quickWins).length,
    readyToImplement: recommendations.filter(r => r.status === 'ready').length
  };

  return (
    <div className="p-6 space-y-6">
      {/* Page Header */}
      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Rekomendasi Kebijakan</h2>
          <p className="text-sm text-gray-600 mt-1">
            Evidence-based policy recommendations untuk optimalisasi program MBG
          </p>
        </div>
        <div className="flex gap-2">
          <button 
            onClick={() => setShowExportModal(true)}
            className="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all flex items-center gap-2"
          >
            <FileText className="w-4 h-4" />
            Export Policy Brief
          </button>
          <button className="px-4 py-3 border border-gray-300 rounded-xl text-sm font-semibold hover:bg-gray-50 transition-colors">
            Print Report
          </button>
        </div>
      </div>

      {/* Executive Summary */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-8 text-white shadow-2xl">
        <div className="flex items-start gap-4 mb-6">
          <div className="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center flex-shrink-0">
            <Award className="w-8 h-8" />
          </div>
          <div className="flex-1">
            <h3 className="text-2xl font-black mb-2">Ringkasan Eksekutif</h3>
            <p className="text-blue-100 text-sm leading-relaxed">
              Analisis komprehensif menghasilkan <span className="font-bold text-white">{summaryStats.totalRecommendations} rekomendasi kebijakan</span> berbasis evidence untuk optimalisasi program Makanan Bergizi Gratis. 
              Rekomendasi mencakup <span className="font-bold text-white">{summaryStats.highPriority} prioritas tinggi</span>, dengan total investasi yang diperlukan 
              sebesar <span className="font-bold text-white">Rp {(summaryStats.totalBudget / 1000000000).toFixed(1)} miliar</span> untuk peningkatan coverage, 
              kualitas, efisiensi, dan pemerataan pelayanan.
            </p>
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <ExecutiveStat 
            label="Total Rekomendasi" 
            value={summaryStats.totalRecommendations}
            icon={Target}
          />
          <ExecutiveStat 
            label="Prioritas Tinggi" 
            value={summaryStats.highPriority}
            icon={AlertTriangle}
          />
          <ExecutiveStat 
            label="Quick Wins" 
            value={summaryStats.quickWins}
            icon={TrendingUp}
          />
          <ExecutiveStat 
            label="Ready to Go" 
            value={summaryStats.readyToImplement}
            icon={Activity}
          />
          <ExecutiveStat 
            label="Avg Impact" 
            value={`${summaryStats.avgImpact.toFixed(1)}%`}
            icon={Award}
          />
        </div>

        <div className="mt-6 p-4 bg-white bg-opacity-10 rounded-xl backdrop-blur-sm">
          <div className="flex items-start gap-3">
            <Shield className="w-5 h-5 mt-0.5 flex-shrink-0" />
            <div>
              <h4 className="font-bold text-sm mb-2">Rekomendasi Utama (Top Priority)</h4>
              <ol className="space-y-1 text-sm text-blue-50">
                <li>1. <span className="font-semibold">Pembangunan 3 SPPG baru</span> di wilayah prioritas untuk coverage 98.7%</li>
                <li>2. <span className="font-semibold">Optimasi rute distribusi</span> dengan network analysis (quick win)</li>
                <li>3. <span className="font-semibold">Peningkatan kapasitas SDM</span> melalui pelatihan 50 pekerja</li>
                <li>4. <span className="font-semibold">Perbaikan infrastruktur jalan</span> ke 12 sekolah terpencil</li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      {/* View Mode Selector */}
      <div className="bg-white rounded-xl border border-gray-200 p-4">
        <div className="flex gap-2 overflow-x-auto">
          <ViewModeButton
            label="Executive View"
            value="executive"
            active={viewMode}
            onClick={setViewMode}
            icon={Award}
          />
          <ViewModeButton
            label="Detailed Analysis"
            value="detailed"
            active={viewMode}
            onClick={setViewMode}
            icon={BarChart3}
          />
          <ViewModeButton
            label="Timeline View"
            value="timeline"
            active={viewMode}
            onClick={setViewMode}
            icon={Activity}
          />
          <ViewModeButton
            label="Impact Matrix"
            value="impact"
            active={viewMode}
            onClick={setViewMode}
            icon={Target}
          />
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white rounded-xl border border-gray-200 p-6">
        <div className="flex items-center gap-2 mb-4">
          <Settings className="w-5 h-5 text-gray-700" />
          <h3 className="text-lg font-bold text-gray-900">Filter Rekomendasi</h3>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
          {/* Priority Filter */}
          <div>
            <label className="text-xs font-semibold text-gray-700 block mb-2">Prioritas</label>
            <select
              value={filterPriority}
              onChange={(e) => setFilterPriority(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">Semua Prioritas</option>
              <option value="high">🔴 High Priority</option>
              <option value="medium">🟡 Medium Priority</option>
              <option value="low">🟢 Low Priority</option>
            </select>
          </div>

          {/* Category Filter */}
          <div>
            <label className="text-xs font-semibold text-gray-700 block mb-2">Kategori</label>
            <select
              value={filterCategory}
              onChange={(e) => setFilterCategory(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">Semua Kategori</option>
              <option value="infrastructure">🏗️ Infrastructure</option>
              <option value="operational">⚙️ Operational</option>
              <option value="strategic">🎯 Strategic</option>
              <option value="policy">📋 Policy</option>
            </select>
          </div>

          {/* Risk Filter */}
          <div>
            <label className="text-xs font-semibold text-gray-700 block mb-2">Risk Level</label>
            <select
              value={filterRisk}
              onChange={(e) => setFilterRisk(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">Semua Risk</option>
              <option value="low">🟢 Low Risk</option>
              <option value="medium">🟡 Medium Risk</option>
              <option value="high">🔴 High Risk</option>
            </select>
          </div>

          {/* Sort By */}
          <div>
            <label className="text-xs font-semibold text-gray-700 block mb-2">Urutkan</label>
            <select
              value={sortBy}
              onChange={(e) => setSortBy(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
            >
              <option value="priority">Prioritas</option>
              <option value="impact">Impact</option>
              <option value="cost">Budget</option>
              <option value="timeline">Timeline</option>
            </select>
          </div>

          {/* Results Count */}
          <div className="flex items-end">
            <div className="w-full px-4 py-2 bg-blue-50 border border-blue-200 rounded-lg text-center">
              <div className="text-xs text-blue-700 font-semibold mb-1">Hasil Filter</div>
              <div className="text-2xl font-black text-blue-900">{sortedRecommendations.length}</div>
            </div>
          </div>
        </div>
      </div>

      {/* Content based on view mode */}
      {viewMode === 'executive' && (
        <ExecutiveView 
          recommendations={sortedRecommendations}
          onSelectRecommendation={setSelectedRecommendation}
        />
      )}

      {viewMode === 'detailed' && (
        <DetailedView 
          recommendations={sortedRecommendations}
          onSelectRecommendation={setSelectedRecommendation}
        />
      )}

      {viewMode === 'timeline' && (
        <TimelineView 
          recommendations={sortedRecommendations}
        />
      )}

      {viewMode === 'impact' && (
        <ImpactMatrixView 
          recommendations={sortedRecommendations}
        />
      )}

      {/* Recommendation Detail Modal */}
      {selectedRecommendation && (
        <RecommendationDetailModal
          recommendation={selectedRecommendation}
          onClose={() => setSelectedRecommendation(null)}
        />
      )}

      {/* Export Modal */}
      {showExportModal && (
        <ExportModal
          recommendations={recommendations}
          onClose={() => setShowExportModal(false)}
        />
      )}

      {/* Output Info Panel */}
      <div className="bg-gradient-to-r from-green-600 to-green-700 rounded-xl p-6 text-white shadow-lg">
        <div className="flex items-start gap-4">
          <Award className="w-6 h-6 flex-shrink-0 mt-1" />
          <div>
            <h3 className="font-bold text-lg mb-2">Output Modul Rekomendasi Kebijakan</h3>
            <p className="text-green-100 text-sm leading-relaxed mb-3">
              Modul ini menghasilkan: (1) Evidence-based recommendations dengan strong scientific rationale dan data support,
              (2) Multi-criteria analysis mencakup impact, cost, risk, timeline untuk informed decision making,
              (3) Implementation roadmap detail dengan phasing, milestones, dan success metrics,
              (4) Risk assessment komprehensif dengan mitigation strategies untuk
              each action,
(5) Stakeholder mapping dan engagement plan untuk successful implementation,
(6) Success metrics dashboard dengan baseline dan target untuk monitoring dan evaluation.
</p>
<div className="flex flex-wrap gap-2">
<span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Evidence-Based Policy</span>
<span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Multi-Criteria Analysis</span>
<span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Risk Management</span>
<span className="px-3 py-1 bg-white bg-opacity-20 rounded-full text-xs font-semibold">Implementation Planning</span>
</div>
</div>
</div>
</div>
</div>
);
}
// ==============================================
// HELPER COMPONENTS
// ==============================================
function ExecutiveStat({ label, value, icon: Icon }) {
return (
<div className="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur-sm text-center">
<Icon className="w-6 h-6 mx-auto mb-2" />
<div className="text-2xl font-black mb-1">{value}</div>
<div className="text-xs text-blue-100">{label}</div>
</div>
);
}

// ==============================================
// EXECUTIVE VIEW
// ==============================================
function ExecutiveView({ recommendations, onSelectRecommendation }) {
return (
<div className="space-y-6">
{/* Priority Distribution */}
<div className="bg-white rounded-xl border border-gray-200 p-6">
<h3 className="text-lg font-bold text-gray-900 mb-6">Distribusi Prioritas Rekomendasi</h3>
<PriorityDistributionChart recommendations={recommendations} />
</div>
  {/* Quick Wins Section */}
  <div className="bg-gradient-to-r from-green-50 to-green-100 rounded-xl border border-green-200 p-6">
    <div className="flex items-center gap-3 mb-4">
      <div className="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center">
        <TrendingUp className="w-6 h-6 text-white" />
      </div>
      <div>
        <h3 className="text-lg font-bold text-green-900">Quick Wins</h3>
        <p className="text-sm text-gray-700">Rekomendasi dengan impact cepat dan implementasi mudah</p>
      </div>
    </div>
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      {recommendations.filter(r => r.quickWins).map((rec) => (
        <QuickWinCard key={rec.id} recommendation={rec} onClick={() => onSelectRecommendation(rec)} />
      ))}
    </div>
  </div>

  {/* All Recommendations Grid */}
  <div className="bg-white rounded-xl border border-gray-200 p-6">
    <h3 className="text-lg font-bold text-gray-900 mb-6">Semua Rekomendasi</h3>
    <div className="space-y-4">
      {recommendations.map((rec) => (
        <ExecutiveRecommendationCard 
          key={rec.id} 
          recommendation={rec}
          onClick={() => onSelectRecommendation(rec)}
        />
      ))}
    </div>
  </div>
</div>
);
}
function PriorityDistributionChart({ recommendations }) {
const high = recommendations.filter(r => r.priority === 'high').length;
const medium = recommendations.filter(r => r.priority === 'medium').length;
const low = recommendations.filter(r => r.priority === 'low').length;
const total = recommendations.length;
const data = [
{ label: 'High Priority', count: high, percentage: (high / total) * 100, color: 'bg-red-500' },
{ label: 'Medium Priority', count: medium, percentage: (medium / total) * 100, color: 'bg-yellow-500' },
{ label: 'Low Priority', count: low, percentage: (low / total) * 100, color: 'bg-green-500' }
];
return (
<div className="space-y-4">
{data.map((item, idx) => (
<div key={idx}>
<div className="flex items-center justify-between mb-2">
<span className="text-sm font-semibold text-gray-700">{item.label}</span>
<div className="flex items-center gap-2">
<span className="text-sm font-bold text-gray-900">{item.count} rekomendasi</span>
<span className="text-xs text-gray-500">({item.percentage.toFixed(1)}%)</span>
</div>
</div>
<div className="h-8 bg-gray-100 rounded-lg overflow-hidden">
<div
// ✅ BENAR - ada backtick
className={`h-full ${item.color} flex items-center justify-center text-white text-sm font-bold`}
style={{ width: `${item.percentage}%` }}
>
{item.count > 0 && item.count}
</div>
</div>
</div>
))}
</div>
);
}
function QuickWinCard({ recommendation, onClick }) {
return (
<div 
   onClick={onClick}
   className="bg-white rounded-xl border-2 border-green-300 p-4 hover:shadow-lg transition-all cursor-pointer"
 >
<div className="flex items-start gap-3">
<div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
<TrendingUp className="w-5 h-5 text-green-700" />
</div>
<div className="flex-1">
<h4 className="font-bold text-gray-900 text-sm mb-1">{recommendation.title}</h4>
<div className="flex items-center gap-2 text-xs text-gray-600 mb-2">
<span>⏱️ {recommendation.implementationTime}</span>
<span>•</span>
<span>💰 Rp {(recommendation.budget / 1000000).toFixed(0)}M</span>
</div>
<div className="flex gap-2">
<PriorityBadge priority={recommendation.priority} />
<CategoryBadge category={recommendation.category} />
</div>
</div>
</div>
</div>
);
}
function ExecutiveRecommendationCard({ recommendation, onClick }) {
const avgImpact = Object.values(recommendation.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
return (
<div 
   onClick={onClick}
   className="border border-gray-200 rounded-xl p-5 hover:shadow-lg hover:border-blue-300 transition-all cursor-pointer"
 >
<div className="flex items-start justify-between gap-4">
<div className="flex-1">
<div className="flex items-center gap-3 mb-2">
<h4 className="font-bold text-gray-900">{recommendation.title}</h4>
<PriorityBadge priority={recommendation.priority} />
</div>
      <p className="text-sm text-gray-600 mb-3 line-clamp-2">{recommendation.description}</p>
      
      <div className="flex flex-wrap gap-2 mb-3">
        <CategoryBadge category={recommendation.category} />
        <RiskBadge risk={recommendation.riskLevel} />
        {recommendation.quickWins && (
          <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold">
            ⚡ Quick Win
          </span>
        )}
        {recommendation.status === 'ready' && (
          <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-semibold">
            ✓ Ready to Go
          </span>
        )}
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
        <MetricMini label="Avg Impact" value={`${avgImpact.toFixed(1)}%`} />
        <MetricMini label="Timeline" value={recommendation.implementationTime} />
        <MetricMini label="Budget" value={`Rp ${(recommendation.budget / 1000000).toFixed(0)}M`} />
        <MetricMini label="Affected" value={`${recommendation.affectedSchools} sekolah`} />
      </div>
    </div>

    <ChevronRight className="w-5 h-5 text-gray-400 flex-shrink-0 mt-1" />
  </div>
</div>
);
}
// ==============================================
// DETAILED VIEW
// ==============================================
function DetailedView({ recommendations, onSelectRecommendation }) {
return (
<div className="space-y-6">
{recommendations.map((rec) => (
<DetailedRecommendationCard
key={rec.id}
recommendation={rec}
onClick={() => onSelectRecommendation(rec)}
/>
))}
</div>
);
}
function DetailedRecommendationCard({ recommendation, onClick }) {
const avgImpact = Object.values(recommendation.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
return (
<div className="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-lg transition-all">
{/* Header */}
<div className="p-6 border-b border-gray-200">
<div className="flex items-start justify-between gap-4 mb-4">
<div className="flex-1">
<div className="flex items-center gap-3 mb-2">
<span className="text-sm font-mono font-semibold text-blue-600">{recommendation.id}</span>
<PriorityBadge priority={recommendation.priority} />
<CategoryBadge category={recommendation.category} />
<RiskBadge risk={recommendation.riskLevel} />
</div>
<h3 className="text-xl font-bold text-gray-900 mb-2">{recommendation.title}</h3>
<p className="text-sm text-gray-600">{recommendation.description}</p>
</div>
<button
         onClick={onClick}
         className="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-semibold hover:bg-blue-100 transition-colors"
       >
Detail Lengkap →
</button>
</div>
    {/* Key Metrics */}
    <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
      <KeyMetric
        label="Timeline"
        value={recommendation.implementationTime}
        icon="⏱️"
      />
      <KeyMetric
        label="Budget"
        value={`Rp ${(recommendation.budget / 1000000).toFixed(0)}M`}
        icon="💰"
      />
      <KeyMetric
        label="Avg Impact"
        value={`${avgImpact.toFixed(1)}%`}
        icon="📈"
      />
      <KeyMetric
        label="Sekolah"
        value={recommendation.affectedSchools}
        icon="🏫"
      />
      <KeyMetric
        label="Siswa"
        value={recommendation.affectedStudents.toLocaleString()}
        icon="👥"
      />
    </div>
  </div>

  {/* Expected Impact */}
  <div className="p-6 border-b border-gray-200">
    <h4 className="text-sm font-bold text-gray-900 mb-4">Expected Impact</h4>
    <div className="grid grid-cols-4 gap-4">
      <ImpactBar label="Coverage" value={recommendation.expectedImpact.coverage} color="blue" />
      <ImpactBar label="Quality" value={recommendation.expectedImpact.quality} color="green" />
      <ImpactBar label="Efficiency" value={recommendation.expectedImpact.efficiency} color="purple" />
      <ImpactBar label="Equity" value={recommendation.expectedImpact.equity} color="orange" />
    </div>
  </div>

  {/* Benefits & Rationale */}
  <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <h4 className="text-sm font-bold text-gray-900 mb-3">Rationale</h4>
      <ul className="space-y-2">
        {recommendation.rationale.slice(0, 3).map((item, idx) => (
          <li key={idx} className="text-sm text-gray-700 flex items-start gap-2">
            <span className="text-blue-600 font-bold">•</span>
            <span>{item}</span>
          </li>
        ))}
      </ul>
    </div>
    <div>
      <h4 className="text-sm font-bold text-gray-900 mb-3">Key Benefits</h4>
      <ul className="space-y-2">
        {recommendation.benefits.slice(0, 3).map((item, idx) => (
          <li key={idx} className="text-sm text-gray-700 flex items-start gap-2">
            <span className="text-green-600 font-bold">✓</span>
            <span>{item}</span>
          </li>
        ))}
      </ul>
    </div>
  </div>

  {/* Success Metrics Preview */}
  <div className="p-6 bg-gray-50">
    <h4 className="text-sm font-bold text-gray-900 mb-3">Success Metrics (Sample)</h4>
    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
      {recommendation.successMetrics.slice(0, 4).map((metric, idx) => (
        <SuccessMetricCard key={idx} metric={metric} />
      ))}
    </div>
  </div>
</div>
);
}
function KeyMetric({ label, value, icon }) {
return (
<div className="text-center p-3 bg-gray-50 rounded-lg">
<div className="text-2xl mb-1">{icon}</div>
<div className="text-lg font-black text-gray-900 mb-1">{value}</div>
<div className="text-xs text-gray-600">{label}</div>
</div>
);
}
function ImpactBar({ label, value, color }) {
const colors = {
blue: 'bg-blue-500',
green: 'bg-green-500',
purple: 'bg-purple-500',
orange: 'bg-orange-500'
};
return (
<div>
<div className="flex justify-between text-xs mb-1">
<span className="font-semibold text-gray-700">{label}</span>
<span className="font-black text-gray-900">{value.toFixed(1)}%</span>
</div>
<div className="h-3 bg-gray-200 rounded-full overflow-hidden">
<div
className={`h-full ${colors[color]}`}
style={{ width: `${Math.min(value, 100)}%` }}
/>
</div>
</div>
);
}
function SuccessMetricCard({ metric }) {
const improvement = ((metric.target - metric.baseline) / metric.baseline * 100).toFixed(1);
return (
<div className="bg-white border border-gray-200 rounded-lg p-3">
<div className="text-xs text-gray-600 mb-2">{metric.metric}</div>
<div className="flex items-end justify-between">
<div>
<div className="text-xs text-gray-500">Baseline</div>
<div className="text-sm font-bold text-gray-900">{metric.baseline}</div>
</div>
<div className="text-right">
<div className="text-xs text-gray-500">Target</div>
<div className="text-sm font-bold text-green-600">{metric.target}</div>
</div>
</div>
<div className="text-xs text-center mt-2 text-green-600 font-semibold">
+{improvement}%
</div>
</div>
);
}
// ==============================================
// TIMELINE VIEW
// ==============================================
function TimelineView({ recommendations }) {
// Group by implementation time
const timelineGroups = {
immediate: recommendations.filter(r => r.implementationTime.includes('1') || r.implementationTime.includes('2')),
short: recommendations.filter(r => r.implementationTime.includes('3') || r.implementationTime.includes('4') || r.implementationTime.includes('5')),
medium: recommendations.filter(r => r.implementationTime.includes('6') || r.implementationTime.includes('7') || r.implementationTime.includes('8')),
long: recommendations.filter(r => parseInt(r.implementationTime) > 8)
};
return (
<div className="space-y-6">
{/* Timeline Summary */}
<div className="bg-white rounded-xl border border-gray-200 p-6">
<h3 className="text-lg font-bold text-gray-900 mb-6">Roadmap Implementasi</h3>
<div className="grid grid-cols-4 gap-4">
<TimelineBlock
         label="Immediate (1-2 bulan)"
         count={timelineGroups.immediate.length}
         color="red"
       />
<TimelineBlock
         label="Short-term (3-5 bulan)"
         count={timelineGroups.short.length}
         color="yellow"
       />
<TimelineBlock
         label="Medium-term (6-8 bulan)"
         count={timelineGroups.medium.length}
         color="blue"
       />
<TimelineBlock
         label="Long-term (>8 bulan)"
         count={timelineGroups.long.length}
         color="purple"
       />
</div>
</div>
  {/* Timeline Visualization */}
  {Object.entries(timelineGroups).map(([key, recs]) => 
    recs.length > 0 && (
      <TimelineGroup key={key} groupName={key} recommendations={recs} />
    )
  )}
</div>
);
}
function TimelineBlock({ label, count, color }) {
const colors = {
red: 'from-red-600 to-red-700',
yellow: 'from-yellow-600 to-yellow-700',
blue: 'from-blue-600 to-blue-700',
purple: 'from-purple-600 to-purple-700'
};
return (
<div className={`bg-gradient-to-r ${colors[color]} rounded-xl p-4 text-white text-center`}>
<div className="text-3xl font-black mb-2">{count}</div>
<div className="text-xs font-semibold">{label}</div>
</div>
);
}
function TimelineGroup({ groupName, recommendations }) {
const groupLabels = {
immediate: { title: 'Immediate Action (1-2 bulan)', icon: '🔴', color: 'red' },
short: { title: 'Short-term (3-5 bulan)', icon: '🟡', color: 'yellow' },
medium: { title: 'Medium-term (6-8 bulan)', icon: '🔵', color: 'blue' },
long: { title: 'Long-term (>8 bulan)', icon: '🟣', color: 'purple' }
};
const group = groupLabels[groupName];
return (
<div className="bg-white rounded-xl border border-gray-200 p-6">
<div className="flex items-center gap-2 mb-6">
<span className="text-2xl">{group.icon}</span>
<h3 className="text-lg font-bold text-gray-900">{group.title}</h3>
<span className="ml-auto text-sm font-semibold text-gray-600">
{recommendations.length} rekomendasi
</span>
</div>
  <div className="space-y-4">
    {recommendations.map((rec, idx) => (
      <TimelineCard key={rec.id} recommendation={rec} index={idx} />
    ))}
  </div>
</div>
);
}
function TimelineCard({ recommendation, index }) {
return (
<div className="flex items-start gap-4">
<div className="flex flex-col items-center">
<div className="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
{index + 1}
</div>
{index < 10 && <div className="w-0.5 h-16 bg-blue-200"></div>}
</div>
  <div className="flex-1 bg-gray-50 rounded-xl p-4">
    <div className="flex items-start justify-between gap-4 mb-2">
      <h5 className="font-bold text-gray-900">{recommendation.title}</h5>
      <PriorityBadge priority={recommendation.priority} />
    </div>
    
    <div className="flex flex-wrap gap-2 mb-3">
      <span className="text-xs px-2 py-1 bg-white border border-gray-200 rounded font-semibold text-gray-700">
        ⏱️ {recommendation.implementationTime}
      </span>
      <span className="text-xs px-2 py-1 bg-white border border-gray-200 rounded font-semibold text-gray-700">
        💰 Rp {(recommendation.budget / 1000000).toFixed(0)}M
      </span>
      <CategoryBadge category={recommendation.category} />
    </div>

    <div className="grid grid-cols-4 gap-2 text-xs">
      {recommendation.timeline.slice(0, 4).map((phase, idx) => (
        <div key={idx} className="bg-white p-2 rounded border border-gray-200">
          <div className="font-semibold text-gray-900 mb-1">{phase.phase}</div>
          <div className="text-gray-600">{phase.duration}</div>
        </div>
      ))}
    </div>
  </div>
</div>
);
}
// ==============================================
// IMPACT MATRIX VIEW
// ==============================================
function ImpactMatrixView({ recommendations }) {
return (
<div className="space-y-6">
{/* Matrix Explanation */}
<div className="bg-white rounded-xl border border-gray-200 p-6">
<h3 className="text-lg font-bold text-gray-900 mb-4">Impact vs Effort Matrix</h3>
<p className="text-sm text-gray-600 mb-6">
Rekomendasi dipetakan berdasarkan tingkat impact (sumbu Y) dan effort/cost (sumbu X) untuk membantu prioritisasi.
</p>
    {/* Matrix Grid */}
    <div className="grid grid-cols-2 gap-4 h-96">
      {/* High Impact, Low Effort - QUICK WINS */}
      <MatrixQuadrant
        title="Quick Wins"
        subtitle="High Impact, Low Effort"
        color="green"
        recommendations={recommendations.filter(r => {
          const avgImpact = Object.values(r.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
          return avgImpact > 15 && r.budget < 300000000;
        })}
      />

      {/* High Impact, High Effort - MAJOR PROJECTS */}
      <MatrixQuadrant
        title="Major Projects"
        subtitle="High Impact, High Effort"
        color="blue"
        recommendations={recommendations.filter(r => {
          const avgImpact = Object.values(r.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
          return avgImpact > 15 && r.budget >= 300000000;
        })}
      />

      {/* Low Impact, Low Effort - FILL INS */}
      <MatrixQuadrant
        title="Fill-Ins"
        subtitle="Low Impact, Low Effort"
        color="yellow"
        recommendations={recommendations.filter(r => {
          const avgImpact = Object.values(r.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
          return avgImpact <= 15 && r.budget < 300000000;
        })}
      />

      {/* Low Impact, High Effort - THANKLESS TASKS */}
      <MatrixQuadrant
        title="Reconsider"
        subtitle="Low Impact, High Effort"
        color="red"
        recommendations={recommendations.filter(r => {
          const avgImpact = Object.values(r.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
          return avgImpact <= 15 && r.budget >= 300000000;
        })}
      />
    </div>
  </div>

  {/* Impact Comparison Chart */}
  <div className="bg-white rounded-xl border border-gray-200 p-6">
    <h3 className="text-lg font-bold text-gray-900 mb-6">Perbandingan Multi-Dimensional Impact</h3>
    <ImpactComparisonChart recommendations={recommendations} />
  </div>
</div>
);
}
function MatrixQuadrant({ title, subtitle, color, recommendations }) {
const colorSchemes = {
green: 'from-green-50 to-green-100 border-green-200',
blue: 'from-blue-50 to-blue-100 border-blue-200',
yellow: 'from-yellow-50 to-yellow-100 border-yellow-200',
red: 'from-red-50 to-red-100 border-red-200'
};
return (
<div className={`bg-gradient-to-br ${colorSchemes[color]} border-2 rounded-xl p-4 overflow-y-auto`}>
<div className="mb-3">
<h4 className="font-bold text-gray-900">{title}</h4>
<p className="text-xs text-gray-600">{subtitle}</p>
<div className="text-2xl font-black text-gray-900 mt-2">{recommendations.length}</div>
</div>
  <div className="space-y-2">
    {recommendations.map(rec => {
      const avgImpact = Object.values(rec.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
      return (
        <div key={rec.id} className="bg-white rounded-lg p-3 shadow-sm">
          <div className="font-semibold text-sm text-gray-900 mb-1">{rec.title}</div>
          <div className="flex justify-between text-xs">
            <span className="text-gray-600">Impact: {avgImpact.toFixed(1)}%</span>
            <span className="text-gray-600">Rp {(rec.budget / 1000000).toFixed(0)}M</span>
          </div>
        </div>
      );
    })}
  </div>
</div>
);
}
function ImpactComparisonChart({ recommendations }) {
const topRecommendations = recommendations
.sort((a, b) => {
const avgA = Object.values(a.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
const avgB = Object.values(b.expectedImpact).reduce((sum, val) => sum + val, 0) / 4;
return avgB - avgA;
})
.slice(0, 8);
return (
<div className="space-y-4">
{topRecommendations.map((rec, idx) => (
<div key={rec.id}>
<div className="flex items-center justify-between mb-2">
<div className="flex-1">
<span className="text-sm font-semibold text-gray-900">{idx + 1}. {rec.title}</span>
</div>
</div>
<div className="grid grid-cols-4 gap-2">
<ImpactMiniBar label="Coverage" value={rec.expectedImpact.coverage} color="blue" />
<ImpactMiniBar label="Quality" value={rec.expectedImpact.quality} color="green" />
<ImpactMiniBar label="Efficiency" value={rec.expectedImpact.efficiency} color="purple" />
<ImpactMiniBar label="Equity" value={rec.expectedImpact.equity} color="orange" />
</div>
</div>
))}
</div>
);
}
function ImpactMiniBar({ label, value, color }) {
const colors = {
blue: 'bg-blue-500',
green: 'bg-green-500',
purple: 'bg-purple-500',
orange: 'bg-orange-500'
};
return (
<div>
<div className="flex justify-between text-xs mb-1">
<span className="text-gray-600">{label}</span>
<span className="font-bold text-gray-900">{value.toFixed(1)}%</span>
</div>
<div className="h-2 bg-gray-200 rounded-full overflow-hidden">
<div
className={`h-full ${colors[color]}`}
style={{ width: `${Math.min(value * 2, 100)}%` }}
/>
</div>
</div>
);
}
// ==============================================
// SHARED COMPONENTS (Badges, etc.)
// ==============================================
function PriorityBadge({ priority }) {
const config = {
high: { bg: 'bg-red-100', text: 'text-red-700', label: '🔴 High' },
medium: { bg: 'bg-yellow-100', text: 'text-yellow-700', label: '🟡 Medium' },
low: { bg: 'bg-green-100', text: 'text-green-700', label: '🟢 Low' }
};
const style = config[priority];
return (
<span className={`px-2 py-1 ${style.bg} ${style.text} rounded text-xs font-bold`}>
{style.label}
</span>
);
}
function CategoryBadge({ category }) {
const config = {
infrastructure: { icon: '🏗️', label: 'Infrastructure', color: 'bg-purple-100 text-purple-700' },
operational: { icon: '⚙️', label: 'Operational', color: 'bg-blue-100 text-blue-700' },
strategic: { icon: '🎯', label: 'Strategic', color: 'bg-green-100 text-green-700' },
policy: { icon: '📋', label: 'Policy', color: 'bg-orange-100 text-orange-700' }
};
const style = config[category];
return (
<span className={`px-2 py-1 ${style.color} rounded text-xs font-semibold`}>
{style.icon} {style.label}
</span>
);
}
function RiskBadge({ risk }) {
const config = {
low: { color: 'bg-green-100 text-green-700', label: 'Low Risk' },
medium: { color: 'bg-yellow-100 text-yellow-700', label: 'Med Risk' },
high: { color: 'bg-red-100 text-red-700', label: 'High Risk' }
};
const style = config[risk];
return (
<span className={`px-2 py-1 ${style.color} rounded text-xs font-semibold`}>
{style.label}
</span>
);
}
function MetricMini({ label, value }) {
return (
<div className="bg-gray-50 rounded p-2">
<div className="text-xs text-gray-600">{label}</div>
<div className="text-sm font-bold text-gray-900">{value}</div>
</div>
);
}
// ==============================================
// DETAIL MODAL (Shortened for space)
// ==============================================
function RecommendationDetailModal({ recommendation, onClose }) {
return (
<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
<div className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
{/* Header */}
<div className="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white sticky top-0 z-10">
<div className="flex items-start justify-between">
<div>
<div className="text-sm font-mono font-semibold text-blue-100 mb-2">{recommendation.id}</div>
<h2 className="text-2xl font-bold mb-2">{recommendation.title}</h2>
<div className="flex gap-2">
<PriorityBadge priority={recommendation.priority} />
<CategoryBadge category={recommendation.category} />
<RiskBadge risk={recommendation.riskLevel} />
</div>
</div>
<button onClick={onClose} className="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-colors">
<X className="w-6 h-6" />
</button>
</div>
</div>
    {/* Content */}
    <div className="p-6">
      <div className="text-sm text-gray-600 mb-6">{recommendation.description}</div>
      
      {/* Full content would go here - showing placeholder for space */}
      <div className="bg-gray-50 rounded-xl p-6 text-center">
        <BookOpen className="w-16 h-16 text-gray-400 mx-auto mb-4" />
        <p className="text-gray-600">
          Konten detail lengkap rekomendasi tersedia di implementasi penuh
        </p>
      </div>
    </div>
  </div>
</div>
);
}
// ==============================================
// EXPORT MODAL (Shortened)
// ==============================================
function ExportModal({ recommendations, onClose }) {
return (
<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
<div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
<div className="flex items-center justify-between mb-6">
<h3 className="text-xl font-bold text-gray-900">Export Policy Brief</h3>
<button onClick={onClose} className="text-gray-400 hover:text-gray-600">
<X className="w-6 h-6" />
</button>
</div>
    <div className="space-y-3">
      <button className="w-full px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-left transition-colors">
        <div className="font-semibold text-blue-900">📄 Export as PDF</div>
        <div className="text-xs text-gray-600 mt-1">Comprehensive policy document</div>
      </button>
      <button className="w-full px-4 py-3 bg-green-50 hover:bg-green-100 rounded-lg text-left transition-colors">
        <div className="font-semibold text-green-900">📊 Export as Excel</div>
        <div className="text-xs text-gray-600 mt-1">Data table for analysis</div>
      </button>
      <button className="w-full px-4 py-3 bg-purple-50 hover:bg-purple-100 rounded-lg text-left transition-colors">
        <div className="font-semibold text-purple-900">📑 Export as PowerPoint</div>
        <div className="text-xs text-gray-600 mt-1">Presentation slides</div>
      </button>
    </div>

    <button
      onClick={onClose}
      className="w-full mt-6 px-4 py-2 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50 transition-colors"
    >
      Cancel
    </button>
  </div>
</div>
);
}






function LaporanPage() {
  const [selectedReport, setSelectedReport] = useState('executive');
  const [selectedPeriod, setSelectedPeriod] = useState('semester1-2025');
  const [selectedKecamatan, setSelectedKecamatan] = useState('all');
  const [showFilters, setShowFilters] = useState(false);
  const [activeView, setActiveView] = useState('preview');
  const [showExportModal, setShowExportModal] = useState(false);
  const [selectedCharts, setSelectedCharts] = useState(['all']);
  const reportRef = useRef(null);

  // Data untuk visualisasi
  const kelayakanData = [
    { kecamatan: 'Bandung', layak: 45, waspada: 12, kritis: 3, total: 60, persentase: 75.0 },
    { kecamatan: 'Cimahi', layak: 38, waspada: 8, kritis: 2, total: 48, persentase: 79.2 },
    { kecamatan: 'Lembang', layak: 52, waspada: 15, kritis: 5, total: 72, persentase: 72.2 },
    { kecamatan: 'Cibeunying', layak: 42, waspada: 10, kritis: 3, total: 55, persentase: 76.4 },
    { kecamatan: 'Soreang', layak: 35, waspada: 9, kritis: 4, total: 48, persentase: 72.9 }
  ];

  // Data Tren Pelayanan Bulanan
  const trendData = [
    { bulan: 'Jul', kelayakan: 82.5, siswa: 335, sppg: 44, coverage: 88.2 },
    { bulan: 'Agu', kelayakan: 83.8, siswa: 338, sppg: 45, coverage: 89.1 },
    { bulan: 'Sep', kelayakan: 84.2, siswa: 340, sppg: 46, coverage: 89.8 },
    { bulan: 'Okt', kelayakan: 85.1, siswa: 341, sppg: 46, coverage: 90.5 },
    { bulan: 'Nov', kelayakan: 86.4, siswa: 342, sppg: 47, coverage: 91.2 },
    { bulan: 'Des', kelayakan: 87.3, siswa: 343, sppg: 47, coverage: 92.0 }
  ];

  // Data Distribusi Status
  const statusDistribusi = [
    { name: 'Layak', value: 212, color: '#10b981', persen: 75.4 },
    { name: 'Waspada', value: 54, color: '#f59e0b', persen: 19.2 },
    { name: 'Kritis', value: 17, color: '#ef4444', persen: 6.0 }
  ];

  // Data Kapasitas SPPG
  const kapasitasData = [
    { sppg: 'SPPG Bandung Pusat', kapasitas: 8500, terpakai: 7820, utilisasi: 92, status: 'Tinggi' },
    { sppg: 'SPPG Bandung Utara', kapasitas: 7200, terpakai: 6480, utilisasi: 90, status: 'Tinggi' },
    { sppg: 'SPPG Bandung Selatan', kapasitas: 6800, terpakai: 5440, utilisasi: 80, status: 'Optimal' },
    { sppg: 'SPPG Bandung Timur', kapasitas: 9000, terpakai: 7560, utilisasi: 84, status: 'Optimal' },
    { sppg: 'SPPG Bandung Barat', kapasitas: 6500, terpakai: 5200, utilisasi: 80, status: 'Optimal' },
    { sppg: 'SPPG Bandung Pusat 2', kapasitas: 7500, terpakai: 6000, utilisasi: 80, status: 'Optimal' }
  ];

  // Data Jarak Rata-rata
  const jarakData = [
    { kategori: '0-5 km', jumlah: 156, persen: 55.1, status: 'Ideal' },
    { kategori: '5-10 km', jumlah: 89, persen: 31.4, status: 'Baik' },
    { kategori: '10-15 km', jumlah: 28, persen: 9.9, status: 'Waspada' },
    { kategori: '>15 km', jumlah: 10, persen: 3.5, status: 'Kritis' }
  ];

  // Data Performa Radar
  const performaRadar = [
    { indicator: 'Kelayakan', value: 87.3, fullMark: 100 },
    { indicator: 'Coverage', value: 92.0, fullMark: 100 },
    { indicator: 'Kapasitas', value: 84.5, fullMark: 100 },
    { indicator: 'Aksesibilitas', value: 86.5, fullMark: 100 },
    { indicator: 'Efisiensi', value: 88.2, fullMark: 100 },
    { indicator: 'Pemerataan', value: 79.8, fullMark: 100 }
  ];

  // Data Rekomendasi
  const rekomendasiData = [
    {
      prioritas: 'Tinggi',
      wilayah: 'Lembang',
      masalah: 'Kapasitas SPPG tidak mencukupi untuk 5 sekolah',
      solusi: 'Penambahan 1 unit SPPG baru dengan kapasitas 8000 porsi/hari',
      dampak: 'Meningkatkan kelayakan dari 72.2% menjadi 89.5%',
      estimasi: '6-8 bulan',
      biaya: 'Rp 2.8M'
    },
    {
      prioritas: 'Tinggi',
      wilayah: 'Soreang',
      masalah: 'Jarak tempuh 4 sekolah >12 km dari SPPG terdekat',
      solusi: 'Relokasi SPPG atau penambahan satelit distribusi',
      dampak: 'Mengurangi waktu distribusi 35-40 menit',
      estimasi: '4-6 bulan',
      biaya: 'Rp 1.5M'
    },
    {
      prioritas: 'Sedang',
      wilayah: 'Bandung',
      masalah: 'Utilisasi SPPG mencapai 92% (mendekati maksimal)',
      solusi: 'Optimasi jadwal produksi dan routing distribusi',
      dampak: 'Efisiensi operasional +15%',
      estimasi: '2-3 bulan',
      biaya: 'Rp 500K'
    }
  ];

  const COLORS = ['#10b981', '#f59e0b', '#ef4444'];

  const handleExport = (format) => {
    alert(`Export laporan dalam format ${format.toUpperCase()}`);
    setShowExportModal(false);
  };

  const handlePrint = () => {
    window.print();
  };

  const StatCard = ({ icon: Icon, label, value, change, color, subtitle }) => (
    <div className="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow">
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            <div className={`w-10 h-10 rounded-lg ${color} flex items-center justify-center`}>
              <Icon className="w-5 h-5 text-white" />
            </div>
            <span className="text-sm text-gray-600 font-medium">{label}</span>
          </div>
          <div className="text-2xl font-bold text-gray-900 mb-1">{value}</div>
          <div className="text-xs text-gray-500">{subtitle}</div>
        </div>
        {change && (
          <div className={`text-xs font-semibold px-2 py-1 rounded ${
            change > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'
          }`}>
            {change > 0 ? '+' : ''}{change}%
          </div>
        )}
      </div>
    </div>
  );

  return (
    <div className="p-6">
      {/* Header */}
      <div className="mb-6">
        <div className="flex items-center justify-between mb-2">
          <div>
            <div className="flex items-center gap-2">
              <h1 className="text-2xl font-bold text-gray-900">Laporan & Visualisasi</h1>
              <span className="px-2 py-1 text-xs font-semibold bg-blue-50 text-blue-700 rounded">
                Live Data
              </span>
            </div>
            <p className="text-sm text-gray-600 mt-1">
              Optimalisasi Pelayanan Pemenuhan Gizi - Program MBG
            </p>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-600">Last Update</span>
            <span className="text-sm font-semibold text-gray-900">14 Des 2025, 09:30</span>
          </div>
        </div>

        {/* Action Buttons */}
        <div className="flex items-center gap-3 mt-4">
          <button
            onClick={() => setShowFilters(!showFilters)}
            className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            <Filter className="w-4 h-4" />
            <span className="text-sm font-medium">Filter</span>
            <ChevronDown className={`w-4 h-4 transition-transform ${showFilters ? 'rotate-180' : ''}`} />
          </button>

          <button
            onClick={() => setShowExportModal(true)}
            className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          >
            <Download className="w-4 h-4" />
            <span className="text-sm font-medium">Export Data</span>
          </button>

          <button
            onClick={handlePrint}
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            <Printer className="w-4 h-4" />
            <span className="text-sm font-medium">Print Preview</span>
          </button>

          <button className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            <Share2 className="w-4 h-4" />
            <span className="text-sm font-medium">Share</span>
          </button>
        </div>

        {/* Filter Panel */}
        {showFilters && (
          <div className="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div className="grid grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Periode Laporan</label>
                <select
                  value={selectedPeriod}
                  onChange={(e) => setSelectedPeriod(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="semester1-2025">Semester 1 - 2025</option>
                  <option value="semester2-2025">Semester 2 - 2025</option>
                  <option value="tahunan-2025">Tahunan - 2025</option>
                  <option value="custom">Custom Range</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Kecamatan</label>
                <select
                  value={selectedKecamatan}
                  onChange={(e) => setSelectedKecamatan(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="all">Semua Kecamatan</option>
                  <option value="bandung">Bandung</option>
                  <option value="cimahi">Cimahi</option>
                  <option value="lembang">Lembang</option>
                  <option value="cibeunying">Cibeunying</option>
                  <option value="soreang">Soreang</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Jenis Laporan</label>
                <select
                  value={selectedReport}
                  onChange={(e) => setSelectedReport(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="executive">Executive Summary</option>
                  <option value="detailed">Laporan Lengkap</option>
                  <option value="visualization">Visualisasi Data</option>
                  <option value="thematic">Peta Tematik</option>
                </select>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Report Content */}
      <div ref={reportRef} className="space-y-6">
        
        {/* Executive Summary Cards */}
        <div className="grid grid-cols-4 gap-4">
          <StatCard
            icon={Building2}
            label="Total Sekolah"
            value="1,247"
            subtitle="Sekolah sasaran aktif"
            change={1.2}
            color="bg-blue-500"
          />
          <StatCard
            icon={Users}
            label="Total Siswa MBG"
            value="342,891"
            subtitle="Penerima manfaat"
            change={0.8}
            color="bg-green-500"
          />
          <StatCard
            icon={Target}
            label="Tingkat Kelayakan"
            value="87.3%"
            subtitle="Standar pelayanan"
            change={0.9}
            color="bg-orange-500"
          />
          <StatCard
            icon={Activity}
            label="Coverage Area"
            value="92.0%"
            subtitle="Wilayah terlayani"
            change={1.1}
            color="bg-purple-500"
          />
        </div>

        {/* Main Charts Section */}
        <div className="grid grid-cols-2 gap-6">
          
          {/* Chart 1: Distribusi Status Kelayakan */}
          <div className="bg-white rounded-lg border border-gray-200 p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h3 className="text-lg font-semibold text-gray-900">Distribusi Status Kelayakan</h3>
                <p className="text-sm text-gray-600">Per kecamatan dalam wilayah studi</p>
              </div>
              <button className="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <Image className="w-4 h-4 text-gray-600" />
              </button>
            </div>

            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={kelayakanData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                <XAxis 
                  dataKey="kecamatan" 
                  tick={{ fontSize: 12 }}
                  angle={-45}
                  textAnchor="end"
                  height={80}
                />
                <YAxis tick={{ fontSize: 12 }} />
                <Tooltip 
                  contentStyle={{ 
                    backgroundColor: 'white', 
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '12px'
                  }}
                />
                <Legend 
                  wrapperStyle={{ fontSize: '12px' }}
                  iconType="circle"
                />
                <Bar dataKey="layak" fill="#10b981" name="Layak" radius={[4, 4, 0, 0]} />
                <Bar dataKey="waspada" fill="#f59e0b" name="Waspada" radius={[4, 4, 0, 0]} />
                <Bar dataKey="kritis" fill="#ef4444" name="Kritis" radius={[4, 4, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>

            <div className="mt-4 pt-4 border-t border-gray-200">
              <div className="flex items-center justify-between text-sm">
                <span className="text-gray-600">Rata-rata Kelayakan:</span>
                <span className="font-semibold text-gray-900">75.1%</span>
              </div>
            </div>
          </div>

          {/* Chart 2: Status Distribution Pie */}
          <div className="bg-white rounded-lg border border-gray-200 p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h3 className="text-lg font-semibold text-gray-900">Proporsi Status Global</h3>
                <p className="text-sm text-gray-600">Agregat seluruh sekolah sasaran</p>
              </div>
              <button className="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <Image className="w-4 h-4 text-gray-600" />
              </button>
            </div>

            <ResponsiveContainer width="100%" height={300}>
              <RechartsPie>
                <Pie
                  data={statusDistribusi}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  label={({ name, persen }) => `${name}: ${persen}%`}
                  outerRadius={100}
                  fill="#8884d8"
                  dataKey="value"
                >
                  {statusDistribusi.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip />
              </RechartsPie>
            </ResponsiveContainer>

            <div className="mt-4 space-y-2">
              {statusDistribusi.map((item, idx) => (
                <div key={idx} className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full" style={{ backgroundColor: item.color }}></div>
                    <span className="text-sm text-gray-700">{item.name}</span>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className="text-sm font-semibold text-gray-900">{item.value}</span>
                    <span className="text-xs text-gray-500">({item.persen}%)</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Trend Chart */}
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h3 className="text-lg font-semibold text-gray-900">Tren Pelayanan MBG</h3>
              <p className="text-sm text-gray-600">6 bulan terakhir (Jul - Des 2025)</p>
            </div>
            <div className="flex items-center gap-2">
              <button className="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <Image className="w-4 h-4 text-gray-600" />
              </button>
            </div>
          </div>

          <ResponsiveContainer width="100%" height={350}>
            <LineChart data={trendData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
              <XAxis 
                dataKey="bulan" 
                tick={{ fontSize: 12 }}
              />
              <YAxis 
                yAxisId="left"
                tick={{ fontSize: 12 }}
                label={{ value: 'Kelayakan (%)', angle: -90, position: 'insideLeft', style: { fontSize: 12 } }}
              />
              <YAxis 
                yAxisId="right"
                orientation="right"
                tick={{ fontSize: 12 }}
                label={{ value: 'Siswa (ribu)', angle: 90, position: 'insideRight', style: { fontSize: 12 } }}
              />
              <Tooltip 
                contentStyle={{ 
                  backgroundColor: 'white', 
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '12px'
                }}
              />
              <Legend 
                wrapperStyle={{ fontSize: '12px' }}
                iconType="line"
              />
              <Line 
                yAxisId="left"
                type="monotone" 
                dataKey="kelayakan" 
                stroke="#3b82f6" 
                strokeWidth={2.5}
                dot={{ r: 4 }}
                name="Tingkat Kelayakan (%)"
              />
              <Line 
                yAxisId="left"
                type="monotone" 
                dataKey="coverage" 
                stroke="#10b981" 
                strokeWidth={2.5}
                dot={{ r: 4 }}
                name="Coverage Area (%)"
              />
              <Line 
                yAxisId="right"
                type="monotone" 
                dataKey="siswa" 
                stroke="#8b5cf6" 
                strokeWidth={2}
                dot={{ r: 3 }}
                name="Total Siswa (ribu)"
                strokeDasharray="5 5"
              />
            </LineChart>
          </ResponsiveContainer>

          <div className="mt-4 pt-4 border-t border-gray-200 grid grid-cols-3 gap-4">
            <div className="text-center">
              <div className="text-sm text-gray-600">Improvement</div>
              <div className="text-xl font-bold text-green-600">+4.8%</div>
              <div className="text-xs text-gray-500">Jul → Des</div>
            </div>
            <div className="text-center">
              <div className="text-sm text-gray-600">Avg Growth</div>
              <div className="text-xl font-bold text-blue-600">+0.96%</div>
              <div className="text-xs text-gray-500">per bulan</div>
            </div>
            <div className="text-center">
              <div className="text-sm text-gray-600">Target 2026</div>
              <div className="text-xl font-bold text-purple-600">92.0%</div>
              <div className="text-xs text-gray-500">Kelayakan</div>
            </div>
          </div>
        </div>

        {/* Radar & Area Charts */}
        <div className="grid grid-cols-2 gap-6">
          
          {/* Radar Chart - Performance */}
          <div className="bg-white rounded-lg border border-gray-200 p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h3 className="text-lg font-semibold text-gray-900">Performa Multi-Dimensi</h3>
                <p className="text-sm text-gray-600">6 indikator kunci sistem MBG</p>
              </div>
              <button className="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <Image className="w-4 h-4 text-gray-600" />
              </button>
            </div>

            <ResponsiveContainer width="100%" height={300}>
              <RadarChart data={performaRadar}>
                <PolarGrid stroke="#e5e7eb" />
                <PolarAngleAxis 
                  dataKey="indicator" 
                  tick={{ fontSize: 11 }}
                />
                <PolarRadiusAxis 
                  angle={90} 
                  domain={[0, 100]}
                  tick={{ fontSize: 10 }}
                />
                <Radar 
                  name="Actual Performance" 
                  dataKey="value" 
                  stroke="#3b82f6" 
                  fill="#3b82f6" 
                  fillOpacity={0.6}
                />
                <Tooltip />
              </RadarChart>
            </ResponsiveContainer>

            <div className="mt-4 pt-4 border-t border-gray-200">
              <div className="text-sm text-gray-600 mb-2">Skor Rata-rata:</div>
              <div className="text-2xl font-bold text-gray-900">86.2 / 100</div>
            </div>
          </div>

          {/* Capacity Utilization */}
          <div className="bg-white rounded-lg border border-gray-200 p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h3 className="text-lg font-semibold text-gray-900">Utilisasi Kapasitas SPPG</h3>
                <p className="text-sm text-gray-600">6 unit SPPG aktif</p>
              </div>
              <button className="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <Image className="w-4 h-4 text-gray-600" />
              </button>
            </div>

            <div className="space-y-3">
              {kapasitasData.map((item, idx) => (
                <div key={idx} className="space-y-1">
                  <div className="flex items-center justify-between text-sm">
                    <span className="font-medium text-gray-900">{item.sppg}</span>
                    <span className="text-gray-600">{item.utilisasi}%</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2.5">
                    <div 
                      className={`h-2.5 rounded-full transition-all ${
                        item.utilisasi >= 90 ? 'bg-red-500' :
                        item.utilisasi >= 75 ? 'bg-green-500' :
                        'bg-blue-500'
                      }`}
                      style={{ width: `${item.utilisasi}%` }}
                    ></div>
                  </div>
                  <div className="flex items-center justify-between text-xs text-gray-500">
                    <span>{item.terpakai.toLocaleString()} / {item.kapasitas.toLocaleString()} porsi</span>
                    <span className={`px-2 py-0.5 rounded font-medium ${
                      item.status === 'Tinggi' ? 'bg-red-50 text-red-700' :
                      'bg-green-50 text-green-700'
                    }`}>
                      {item.status}
                    </span>
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between text-sm">
              <span className="text-gray-600">Rata-rata Utilisasi:</span>
              <span className="font-semibold text-gray-900">84.3%</span>
            </div>
          </div>
        </div>

        {/* Distance Analysis */}
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h3 className="text-lg font-semibold text-gray-900">Analisis Jarak Sekolah ke SPPG</h3>
              <p className="text-sm text-gray-600">Distribusi berdasarkan kategori jarak</p>
            </div>
            <button className="p-2 hover:bg-gray-100 rounded-lg transition-colors">
              <Image className="w-4 h-4 text-gray-600" />
            </button>
          </div>

          <ResponsiveContainer width="100%" height={250}>
            <AreaChart data={jarakData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
              <XAxis 
                dataKey="kategori" 
                tick={{ fontSize: 12 }}
              />
              <YAxis tick={{ fontSize: 12 }} />
              <Tooltip 
                contentStyle={{ 
                  backgroundColor: 'white', 
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '12px'
                }}
              />
              <Area 
                type="monotone" 
                dataKey="jumlah" 
                stroke="#3b82f6" 
                fill="#3b82f6" 
                fillOpacity={0.6}
                name="Jumlah Sekolah"
              />
            </AreaChart>
          </ResponsiveContainer>

          <div className="mt-4 grid grid-cols-4 gap-4">
            {jarakData.map((item, idx) => (
              <div key={idx} className="text-center p-3 bg-gray-50 rounded-lg">
                <div className="text-xs text-gray-600 mb-1">{item.kategori}</div>
                <div className="text-lg font-bold text-gray-900">{item.jumlah}</div>
                <div className="text-xs text-gray-500">{item.persen}%</div>
                <div className={`text-xs font-medium mt-1 ${
                  item.status === 'Ideal' ? 'text-green-600' :
                  item.status === 'Baik' ? 'text-blue-600' :
                  item.status === 'Waspada' ? 'text-yellow-600' :
                  'text-red-600'
                }`}>
                  {item.status}
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Rekomendasi Section */}
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h3 className="text-lg font-semibold text-gray-900">Rekomendasi Kebijakan</h3>
              <p className="text-sm text-gray-600">Berdasarkan analisis spasial dan kapasitas</p>
            </div>
          </div>

          <div className="space-y-4">
            {rekomendasiData.map((item, idx) => (
              <div key={idx} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div className="flex items-start gap-4">
                  <div className={`px-3 py-1 rounded-lg text-xs font-semibold ${
                    item.prioritas === 'Tinggi' ? 'bg-red-50 text-red-700' :
                    'bg-yellow-50 text-yellow-700'
                  }`}>
                    {item.prioritas}
                  </div>
                  
                  <div className="flex-1">
                    <div className="flex items-center justify-between mb-2">
                      <h4 className="text-base font-semibold text-gray-900">{item.wilayah}</h4>
                      <span className="text-sm text-gray-600">{item.estimasi}</span>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 mb-3">
                      <div>
                        <div className="text-xs text-gray-600 mb-1">Masalah:</div>
                        <div className="text-sm text-gray-900">{item.masalah}</div>
                      </div>
                      <div>
                        <div className="text-xs text-gray-600 mb-1">Solusi:</div>
                        <div className="text-sm text-gray-900">{item.solusi}</div>
                      </div>
                    </div>

                    <div className="flex items-center justify-between pt-3 border-t border-gray-200">
                      <div className="flex items-center gap-4">
                        <div className="text-xs">
                          <span className="text-gray-600">Dampak: </span>
                          <span className="font-medium text-green-600">{item.dampak}</span>
                        </div>
                        <div className="text-xs">
                          <span className="text-gray-600">Biaya: </span>
                          <span className="font-semibold text-gray-900">{item.biaya}</span>
                        </div>
                      </div>
                      <button className="px-3 py-1 text-xs font-medium text-blue-600 hover:bg-blue-50 rounded transition-colors">
                        Detail Analisis →
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Peta Tematik Preview */}
        <div className="bg-white rounded-lg border border-gray-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h3 className="text-lg font-semibold text-gray-900">Peta Tematik Kelayakan</h3>
              <p className="text-sm text-gray-600">Visualisasi spasial status pelayanan MBG</p>
            </div>
            <div className="flex items-center gap-2">
              <button className="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                <Eye className="w-4 h-4" />
                Lihat Peta Lengkap
              </button>
            </div>
          </div>

          <div className="bg-gradient-to-br from-blue-50 to-green-50 rounded-lg p-8 flex items-center justify-center">
            <div className="text-center">
              <MapPin className="w-16 h-16 text-blue-600 mx-auto mb-4" />
              <h4 className="text-lg font-semibold text-gray-900 mb-2">Preview Peta Tematik</h4>
              <p className="text-sm text-gray-600 mb-4 max-w-md">
                Peta menampilkan sebaran sekolah sasaran, lokasi SPPG, dan zona kelayakan pelayanan berdasarkan analisis spasial.
              </p>
              <div className="flex items-center justify-center gap-4 text-sm">
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded bg-green-500"></div>
                  <span>Layak</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded bg-yellow-500"></div>
                  <span>Waspada</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 rounded bg-red-500"></div>
                  <span>Kritis</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Footer Info */}
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 border border-blue-200">
          <div className="flex items-start gap-4">
            <div className="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center flex-shrink-0">
              <FileText className="w-5 h-5 text-white" />
            </div>
            <div className="flex-1">
              <h4 className="text-base font-semibold text-gray-900 mb-2">
                Catatan Metodologi Laporan
              </h4>
              <p className="text-sm text-gray-700 leading-relaxed mb-3">
                Laporan ini disusun berdasarkan analisis spasial menggunakan metode <span className="font-medium">Network Analysis</span> dan 
                <span className="font-medium"> Multi-Criteria Decision Making (MCDM)</span>. Data bersumber dari Dinas Pendidikan Kabupaten Bandung, 
                validasi lapangan, dan sistem monitoring real-time.
              </p>
              <div className="flex items-center gap-6 text-xs text-gray-600">
                <div>
                  <span className="font-medium">Dataset:</span> 1,247 sekolah, 47 SPPG
                </div>
                <div>
                  <span className="font-medium">Update:</span> Harian (otomatis)
                </div>
                <div>
                  <span className="font-medium">Validitas:</span> Desember 2025
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      {/* Export Modal */}
      {showExportModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-gray-900">Export Laporan</h3>
              <button 
                onClick={() => setShowExportModal(false)}
                className="p-1 hover:bg-gray-100 rounded transition-colors"
              >
                <X className="w-5 h-5 text-gray-500" />
              </button>
            </div>

            <p className="text-sm text-gray-600 mb-4">
              Pilih format export untuk laporan dan visualisasi
            </p>

            <div className="space-y-3">
              <button
                onClick={() => handleExport('pdf')}
                className="w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
              >
                <FileText className="w-5 h-5 text-red-600" />
                <div className="flex-1 text-left">
                  <div className="font-medium text-gray-900">PDF Document</div>
                  <div className="text-xs text-gray-600">Format standar, siap cetak</div>
                </div>
              </button>

              <button
                onClick={() => handleExport('excel')}
                className="w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors"
              >
                <FileSpreadsheet className="w-5 h-5 text-green-600" />
                <div className="flex-1 text-left">
                  <div className="font-medium text-gray-900">Excel Spreadsheet</div>
                  <div className="text-xs text-gray-600">Data lengkap, dapat diolah</div>
                </div>
              </button>

              <button
                onClick={() => handleExport('png')}
                className="w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors"
              >
                <Image className="w-5 h-5 text-purple-600" />
                <div className="flex-1 text-left">
                  <div className="font-medium text-gray-900">High-Res Images</div>
                  <div className="text-xs text-gray-600">Grafik individual, PNG/SVG</div>
                </div>
              </button>

              <button
                onClick={() => handleExport('csv')}
                className="w-full flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors"
              >
                <FileSpreadsheet className="w-5 h-5 text-orange-600" />
                <div className="flex-1 text-left">
                  <div className="font-medium text-gray-900">CSV Data</div>
                  <div className="text-xs text-gray-600">Raw data, universal format</div>
                </div>
              </button>
            </div>

            <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div className="flex items-start gap-2">
                <AlertCircle className="w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5" />
                <p className="text-xs text-yellow-800">
                  Export mencakup semua visualisasi dan data sesuai filter yang dipilih
                </p>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
function MonitoringPage() { return <div className="p-6">Monitoring (Part 13)</div>; }
function KualitasDataPage() { return <div className="p-6">Kualitas Data (Part 14)</div>; }
function SensitivitasPage() { return <div className="p-6">Sensitivitas (Part 15)</div>; }
function RisikoPage() { return <div className="p-6">Risiko (Part 16)</div>; }
function EquityPage() { return <div className="p-6">Equity (Part 17)</div>; }
function KinerjaPage() { return <div className="p-6">Kinerja (Part 18)</div>; }
function SkenarioPage() { return <div className="p-6">Skenario (Part 19)</div>; }
function BenchmarkingPage() { return <div className="p-6">Benchmarking (Part 20)</div>; }
function IndeksPage() { return <div className="p-6">Indeks (Part 21)</div>; }
function ProfilPage() { return <div className="p-6">Profil (Part 22)</div>; }
function HelpPage() { return <div className="p-6">Help (Part 23)</div>; }

// ==============================================
// LANDING MINI MAP COMPONENT
// ==============================================
/* global L */
function LandingMiniMap() {
  const mapRef = React.useRef(null);
  const mapInstanceRef = React.useRef(null);

  React.useEffect(() => {
    // Prevent re-initialization
    if (mapInstanceRef.current) return;

    // Check if Leaflet is loaded
    if (typeof L === 'undefined') {
      console.error('Leaflet not loaded! Add Leaflet script to HTML <head>');
      return;
    }

    // Initialize map
    const map = L.map(mapRef.current, {
      center: [-7.0050, 107.6500], // Center of Bandung
      zoom: 11,
      zoomControl: true,
      scrollWheelZoom: false, // Disable scroll zoom for landing page
      dragging: true,
      doubleClickZoom: true
    });

    mapInstanceRef.current = map;

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Add school markers
    dummySekolah.forEach(school => {
      const statusColor = {
        'Layak': '#22c55e',
        'Waspada': '#eab308',
        'Kritis': '#ef4444'
      };

      const color = statusColor[school.status];
      
      // Create circle marker
      const marker = L.circleMarker([school.lat, school.lng], {
        radius: 8,
        fillColor: color,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.85
      }).addTo(map);

      // Add popup
      marker.bindPopup(`
        <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-width: 200px;">
          <div style="font-weight: 700; font-size: 14px; color: #1f2937; margin-bottom: 8px;">
            ${school.nama}
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: #4b5563;">
            <div style="display: flex; justify-content: space-between;">
              <span>Status:</span>
              <span style="color: ${color}; font-weight: 600;">${school.status}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Jumlah Siswa:</span>
              <span style="font-weight: 600;">${school.siswa}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>SPPG Terdekat:</span>
              <span style="font-weight: 600; font-size: 11px;">${school.sppg}</span>
            </div>
          </div>
        </div>
      `, {
        maxWidth: 250,
        className: 'custom-popup'
      });
    });

    // Add SPPG markers
    dummySPPG.forEach(sppg => {
      // Create custom icon
      const icon = L.divIcon({
        className: 'custom-sppg-icon',
        html: `
          <div style="
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
          ">P</div>
        `,
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      });

      const marker = L.marker([sppg.lat, sppg.lng], { icon }).addTo(map);
      
      // Calculate utilization
      const utilization = ((sppg.produksi / sppg.kapasitas) * 100).toFixed(1);
      const utilizationColor = utilization > 90 ? '#ef4444' : utilization > 75 ? '#eab308' : '#22c55e';

      marker.bindPopup(`
        <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; min-width: 220px;">
          <div style="font-weight: 700; font-size: 14px; color: #1f2937; margin-bottom: 8px;">
            ${sppg.nama}
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: #4b5563;">
            <div style="display: flex; justify-content: space-between;">
              <span>Kapasitas:</span>
              <span style="font-weight: 600;">${sppg.kapasitas.toLocaleString()} porsi/hari</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Produksi:</span>
              <span style="font-weight: 600;">${sppg.produksi.toLocaleString()} porsi/hari</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 4px; padding-top: 6px; border-top: 1px solid #e5e7eb;">
              <span>Utilization Rate:</span>
              <span style="font-weight: 700; color: ${utilizationColor};">${utilization}%</span>
            </div>
          </div>
        </div>
      `, {
        maxWidth: 280,
        className: 'custom-popup'
      });

      // Add coverage circle (5km radius)
      L.circle([sppg.lat, sppg.lng], {
        radius: 5000, // 5km
        color: '#9333ea',
        fillColor: '#9333ea',
        fillOpacity: 0.1,
        weight: 2,
        dashArray: '5, 10'
      }).addTo(map);
    });

    // Cleanup function
    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, []);

  return (
    <div className="relative">
      {/* Map Container */}
      <div 
        ref={mapRef} 
        className="rounded-xl overflow-hidden border-2 border-gray-200 shadow-inner"
        style={{ height: '420px', width: '100%' }}
      ></div>
      
      {/* Floating Legend */}
      <div className="absolute top-4 right-4 bg-white bg-opacity-95 backdrop-blur-sm rounded-lg px-4 py-3 shadow-xl z-[1000] border border-gray-200">
        <div className="text-xs font-bold text-gray-800 mb-3 uppercase tracking-wide">Legend</div>
        <div className="space-y-2.5 text-xs">
          <div className="flex items-center gap-2.5">
            <div className="w-4 h-4 bg-green-500 rounded-full border-2 border-white shadow-sm"></div>
            <span className="text-gray-700 font-medium">Sekolah Layak</span>
          </div>
          <div className="flex items-center gap-2.5">
            <div className="w-4 h-4 bg-yellow-500 rounded-full border-2 border-white shadow-sm"></div>
            <span className="text-gray-700 font-medium">Sekolah Waspada</span>
          </div>
          <div className="flex items-center gap-2.5">
            <div className="w-4 h-4 bg-red-500 rounded-full border-2 border-white shadow-sm"></div>
            <span className="text-gray-700 font-medium">Sekolah Kritis</span>
          </div>
          <div className="border-t border-gray-200 my-2 pt-2">
            <div className="flex items-center gap-2.5">
              <div className="w-6 h-6 bg-gradient-to-br from-purple-600 to-purple-700 rounded-full border-2 border-white flex items-center justify-center shadow-sm">
                <span className="text-white text-[9px] font-bold">P</span>
              </div>
              <span className="text-gray-700 font-medium">SPPG (Produksi)</span>
            </div>
          </div>
        </div>
      </div>

      {/* Bottom Stats Bar */}
      <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 flex items-center justify-between text-xs font-semibold z-[1000] rounded-b-xl">
        <div className="flex items-center gap-6">
          <div className="flex items-center gap-2">
            <div className="w-2 h-2 bg-white rounded-full animate-pulse"></div>
            <span>Live Data</span>
          </div>
          <span>•</span>
          <span>{dummySekolah.length} Sekolah</span>
          <span>•</span>
          <span>{dummySPPG.length} SPPG Aktif</span>
        </div>
        <div className="text-xs opacity-75">
          Interactive WebGIS Platform
        </div>
      </div>
    </div>
  );
}